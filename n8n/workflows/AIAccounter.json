{
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.errorTrigger",
      "typeVersion": 1,
      "position": [
        12320,
        23552
      ],
      "id": "6f124005-6db3-4bca-97a8-8b203f2c9092",
      "name": "Error Trigger"
    },
    {
      "parameters": {
        "jsCode": "// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ\nconst error = $input.first().json;\nconst executionId = $execution.id;\nconst timestamp = new Date().toISOString();\n\n// –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–µ\nconst errorMessage = error.message || error.error?.message || 'Unknown error';\nconst errorNode = error.node?.name || 'Unknown';\nconst errorType = error.error?.name || error.name || 'Error';\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –ª–æ–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏\nconst errorLog = {\n  execution_id: executionId,\n  timestamp: timestamp,\n  error_type: errorType,\n  error_message: errorMessage,\n  failed_node: errorNode,\n  workflow: 'AIAccounter'\n};\n\nconsole.log('‚ùå Error in AIAccounter:', JSON.stringify(errorLog, null, 2));\n\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ—à–∏–±–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\nlet userMessage = '‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. ';\nlet shouldNotifyUser = true;\nlet chatId = null;\n\n// –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å chat_id –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞\ntry {\n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ chat_id\n  if (error.data?.message?.chat?.id) {\n    chatId = error.data.message.chat.id;\n  } else if (error.inputData?.[0]?.json?.chat_id) {\n    chatId = error.inputData[0].json.chat_id;\n  }\n} catch (e) {\n  console.log('Could not extract chat_id');\n}\n\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –æ—à–∏–±–∫–∏\nif (errorMessage.includes('rate limit') || errorMessage.includes('429')) {\n  userMessage = '‚è≥ –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–¥–æ–∂–¥–∏ –Ω–µ–º–Ω–æ–≥–æ –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞.';\n} else if (errorMessage.includes('timeout') || errorMessage.includes('ETIMEDOUT')) {\n  userMessage = '‚è∞ –°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –≤–æ–≤—Ä–µ–º—è. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.';\n} else if (errorMessage.includes('connection') || errorMessage.includes('ECONNREFUSED')) {\n  userMessage = 'üîå –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º. –ü–æ–ø—Ä–æ–±—É–π —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É.';\n} else if (errorMessage.includes('OpenAI') || errorMessage.includes('API')) {\n  userMessage = 'ü§ñ –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å AI. –ü–æ–ø—Ä–æ–±—É–π –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å.';\n} else if (errorMessage.includes('database') || errorMessage.includes('postgres')) {\n  userMessage = 'üíæ –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.';\n  shouldNotifyUser = true;\n} else if (errorNode === 'Whisper STT') {\n  userMessage = 'üé§ –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ. –ü–æ–ø—Ä–æ–±—É–π –∑–∞–ø–∏—Å–∞—Ç—å –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –Ω–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç–æ–º.';\n} else {\n  userMessage = '‚ùå –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –Ω–∞–ø–∏—à–∏ /help';\n}\n\nreturn [{\n  json: {\n    error_log: errorLog,\n    user_message: userMessage,\n    chat_id: chatId,\n    should_notify: shouldNotifyUser && chatId !== null\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        12544,
        23552
      ],
      "id": "6ac19ad5-f501-48a4-8efb-c31d4e2e2a52",
      "name": "Process Error"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "should-notify-check",
              "leftValue": "={{ $json.should_notify }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        12768,
        23552
      ],
      "id": "fe756d59-c394-4bae-a6e8-a4fedec3bc35",
      "name": "Should Notify User?"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.user_message }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        12992,
        23456
      ],
      "id": "89dcb178-580b-4d60-9167-9324ede55c0c",
      "name": "Notify User About Error",
      "webhookId": "8bd2183a-8af3-46ad-80c8-007651da20d4",
      "credentials": {
        "telegramApi": {
          "id": "muLBxDioRmwKQgZe",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "1109421300",
        "text": "=üö® *Error in AIAccounter*\n\nüìÖ Time: {{ $json.error_log.timestamp }}\nüîß Node: {{ $json.error_log.failed_node }}\n‚ùå Type: {{ $json.error_log.error_type }}\nüìù Message: {{ $json.error_log.error_message }}\nüÜî Execution: {{ $json.error_log.execution_id }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        12992,
        23648
      ],
      "id": "d696469d-2ef5-4e95-a7c3-5083813559fa",
      "name": "Notify Admin",
      "webhookId": "10474645-7335-4445-b1ff-6b65e7e2b12b",
      "credentials": {
        "telegramApi": {
          "id": "muLBxDioRmwKQgZe",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        12320,
        22512
      ],
      "id": "c5b51e82-e37d-48a3-9e39-a867db83dd7e",
      "name": "Telegram Trigger",
      "webhookId": "7d5db243-2146-45ba-a9b7-d0d743f58df0",
      "credentials": {
        "telegramApi": {
          "id": "muLBxDioRmwKQgZe",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO users (user_id, telegram_chat_id, first_name, registered_date, last_activity, is_active, registration_source, subscription_expires_at)\nVALUES (\n  {{ $json.message.from.id }},\n  {{ $json.message.chat.id }},\n  '{{ $json.message.from.first_name || \"User\" }}',\n  NOW(),\n  NOW(),\n  true,\n  'telegram',\n  NOW() + INTERVAL '3 days'\n)\nON CONFLICT (user_id) DO UPDATE SET\n  first_name = EXCLUDED.first_name,\n  last_activity = NOW()\nRETURNING user_id, onboarding_completed, onboarding_step, preferred_currency, usage_type, subscription_expires_at, registered_date, is_admin",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        12544,
        22512
      ],
      "id": "7bbf881f-dae7-4c2c-8b78-340d23cbc91f",
      "name": "Ensure User",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "is-admin",
              "leftValue": "={{ $json.is_admin }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            },
            {
              "id": "has-subscription",
              "leftValue": "={{ $json.subscription_expires_at ? new Date($json.subscription_expires_at) > new Date() : ($json.registered_date ? new Date($json.registered_date) > new Date(Date.now() - (3*24*60*60*1000)) : false) }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        12768,
        22512
      ],
      "id": "27c5aef3-81d3-45f3-a58a-8e511693043f",
      "name": "Check Subscription"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "üîí *–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω*\n\n–í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞. –î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–¥–ª–∏—Ç—å –¥–æ—Å—Ç—É–ø.\n\nüí≥ *–°—Ç–æ–∏–º–æ—Å—Ç—å:* 300 —Å–æ–º/–º–µ—Å\n\n–î–ª—è –æ–ø–ª–∞—Ç—ã –ø–µ—Ä–µ–≤–µ–¥–∏—Ç–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –Ω–∞ MBank: `0555 123 456` (–ò–≤–∞–Ω –ò.) –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —á–µ–∫–∞ —Å—é–¥–∞.",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        12992,
        22608
      ],
      "id": "9e269542-6261-4bf9-b86d-f7a413a5b6b1",
      "name": "Send Subscription Expired",
      "webhookId": "cce72062-2c51-41cd-97a3-65c2a3e73ae7",
      "credentials": {
        "telegramApi": {
          "id": "muLBxDioRmwKQgZe",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.onboarding_completed }}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "notEquals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "needs_onboarding"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.onboarding_completed }}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ready"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        12992,
        22416
      ],
      "id": "bc505a2f-d5fa-4c76-900d-c24dd1c78c31",
      "name": "Check Onboarding"
    },
    {
      "parameters": {
        "jsCode": "const user = $input.first().json;\nconst message = $('Telegram Trigger').first().json.message;\nconst text = (message.text || '').toLowerCase().trim();\nconst step = user.onboarding_step || 0;\n\n// –ö–æ–º–∞–Ω–¥–∞ /start –∏–ª–∏ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\nconst isStart = text === '/start' || step === 0;\n\nlet response = '';\nlet newStep = step;\nlet updateQuery = '';\n\nif (isStart || step === 0) {\n  // –®–∞–≥ 1: –í—ã–±–æ—Ä –≤–∞–ª—é—Ç—ã\n  response = `üëã –ü—Ä–∏–≤–µ—Ç, ${message.from.first_name}!\\n\\n–Ø ‚Äî AIAccounter, —Ç–≤–æ–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫.\\n\\n–î–∞–≤–∞–π –Ω–∞—Å—Ç—Ä–æ–∏–º –∞–∫–∫–∞—É–Ω—Ç. –í—ã–±–µ—Ä–∏ –æ—Å–Ω–æ–≤–Ω—É—é –≤–∞–ª—é—Ç—É:\\n\\n1Ô∏è‚É£ KGS (—Å–æ–º)\\n2Ô∏è‚É£ USD (–¥–æ–ª–ª–∞—Ä)\\n3Ô∏è‚É£ EUR (–µ–≤—Ä–æ)\\n4Ô∏è‚É£ RUB (—Ä—É–±–ª—å)\\n\\n–û—Ç–ø—Ä–∞–≤—å —Ü–∏—Ñ—Ä—É –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∞–ª—é—Ç—ã.`;\n  updateQuery = `UPDATE users SET onboarding_step = 1 WHERE user_id = ${user.user_id}`;\n  newStep = 1;\n} else if (step === 1) {\n  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –≤–∞–ª—é—Ç—ã\n  let currency = 'KGS';\n  if (text.includes('1') || text.includes('kgs') || text.includes('—Å–æ–º')) currency = 'KGS';\n  else if (text.includes('2') || text.includes('usd') || text.includes('–¥–æ–ª–ª–∞—Ä')) currency = 'USD';\n  else if (text.includes('3') || text.includes('eur') || text.includes('–µ–≤—Ä–æ')) currency = 'EUR';\n  else if (text.includes('4') || text.includes('rub') || text.includes('—Ä—É–±–ª')) currency = 'RUB';\n  \n  updateQuery = `UPDATE users SET preferred_currency = '${currency}', onboarding_step = 2 WHERE user_id = ${user.user_id}`;\n  response = `‚úÖ –í–∞–ª—é—Ç–∞: ${currency}\\n\\n–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏ —Ç–∏–ø –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:\\n\\n1Ô∏è‚É£ üë§ –õ–∏—á–Ω—ã–π ‚Äî –¥–ª—è –ª–∏—á–Ω—ã—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤\\n2Ô∏è‚É£ üíº –ë–∏–∑–Ω–µ—Å ‚Äî –¥–ª—è —É—á—ë—Ç–∞ –±–∏–∑–Ω–µ—Å–∞\\n\\n–û—Ç–ø—Ä–∞–≤—å —Ü–∏—Ñ—Ä—É.`;\n  newStep = 2;\n} else if (step === 2) {\n  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞\n  let usageType = 'personal';\n  if (text.includes('2') || text.includes('–±–∏–∑–Ω–µ—Å') || text.includes('business')) usageType = 'business';\n  \n  updateQuery = `UPDATE users SET usage_type = '${usageType}', onboarding_step = 3 WHERE user_id = ${user.user_id}`;\n  const typeText = usageType === 'business' ? 'üíº –ë–∏–∑–Ω–µ—Å' : 'üë§ –õ–∏—á–Ω—ã–π';\n  response = `‚úÖ –†–µ–∂–∏–º: ${typeText}\\n\\n–£—Å—Ç–∞–Ω–æ–≤–∏ –º–µ—Å—è—á–Ω—ã–π –±—é–¥–∂–µ—Ç (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):\\n\\n–û—Ç–ø—Ä–∞–≤—å —Å—É–º–º—É –∏–ª–∏ –Ω–∞–ø–∏—à–∏ \"–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å\".`;\n  newStep = 3;\n} else if (step === 3) {\n  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –±—é–¥–∂–µ—Ç–∞\n  let budget = null;\n  if (!text.includes('–ø—Ä–æ–ø—É—Å—Ç') && !text.includes('skip') && !text.includes('–Ω–µ—Ç')) {\n    const num = parseFloat(text.replace(/[^0-9.]/g, ''));\n    if (!isNaN(num) && num > 0) budget = num;\n  }\n  \n  if (budget) {\n    updateQuery = `UPDATE users SET monthly_budget = ${budget}, onboarding_step = 5, onboarding_completed = true, onboarding_completed_at = NOW() WHERE user_id = ${user.user_id}`;\n    response = `‚úÖ –ë—é–¥–∂–µ—Ç: ${budget.toLocaleString()} –≤ –º–µ—Å—è—Ü\\n\\nüéâ –û—Ç–ª–∏—á–Ω–æ! –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\\n\\n–¢–µ–ø–µ—Ä—å —Ç—ã –º–æ–∂–µ—à—å:\\n‚Ä¢ –ó–∞–ø–∏—Å—ã–≤–∞—Ç—å —Ä–∞—Å—Ö–æ–¥—ã: \"–ø–æ—Ç—Ä–∞—Ç–∏–ª 500 –Ω–∞ —Ç–∞–∫—Å–∏\"\\n‚Ä¢ –ó–∞–ø–∏—Å—ã–≤–∞—Ç—å –¥–æ—Ö–æ–¥—ã: \"–ø–æ–ª—É—á–∏–ª 50000 –∑–∞—Ä–ø–ª–∞—Ç–∞\"\\n‚Ä¢ –°–º–æ—Ç—Ä–µ—Ç—å –æ—Ç—á—ë—Ç—ã: \"–æ—Ç—á—ë—Ç –∑–∞ –Ω–µ–¥–µ–ª—é\"\\n‚Ä¢ –£–ø—Ä–∞–≤–ª—è—Ç—å –¥–æ–ª–≥–∞–º–∏: \"–¥–∞–ª –≤ –¥–æ–ª–≥ –ò–≤–∞–Ω—É 1000\"\\n\\n–ü—Ä–æ—Å—Ç–æ –ø–∏—à–∏ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–π –≥–æ–ª–æ—Å–æ–≤—ã–µ! üé§`;\n  } else {\n    updateQuery = `UPDATE users SET onboarding_step = 5, onboarding_completed = true, onboarding_completed_at = NOW() WHERE user_id = ${user.user_id}`;\n    response = `‚úÖ –ë—é–¥–∂–µ—Ç –ø—Ä–æ–ø—É—â–µ–Ω\\n\\nüéâ –û—Ç–ª–∏—á–Ω–æ! –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\\n\\n–¢–µ–ø–µ—Ä—å —Ç—ã –º–æ–∂–µ—à—å:\\n‚Ä¢ –ó–∞–ø–∏—Å—ã–≤–∞—Ç—å —Ä–∞—Å—Ö–æ–¥—ã: \"–ø–æ—Ç—Ä–∞—Ç–∏–ª 500 –Ω–∞ —Ç–∞–∫—Å–∏\"\\n‚Ä¢ –ó–∞–ø–∏—Å—ã–≤–∞—Ç—å –¥–æ—Ö–æ–¥—ã: \"–ø–æ–ª—É—á–∏–ª 50000 –∑–∞—Ä–ø–ª–∞—Ç–∞\"\\n‚Ä¢ –°–º–æ—Ç—Ä–µ—Ç—å –æ—Ç—á—ë—Ç—ã: \"–æ—Ç—á—ë—Ç –∑–∞ –Ω–µ–¥–µ–ª—é\"\\n‚Ä¢ –£–ø—Ä–∞–≤–ª—è—Ç—å –¥–æ–ª–≥–∞–º–∏: \"–¥–∞–ª –≤ –¥–æ–ª–≥ –ò–≤–∞–Ω—É 1000\"\\n\\n–ü—Ä–æ—Å—Ç–æ –ø–∏—à–∏ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–π –≥–æ–ª–æ—Å–æ–≤—ã–µ! üé§`;\n  }\n  newStep = 5;\n}\n\nreturn [{\n  json: {\n    chat_id: message.chat.id,\n    response: response,\n    update_query: updateQuery,\n    new_step: newStep,\n    user_id: user.user_id\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        13216,
        22224
      ],
      "id": "f1761f51-0f76-4cee-a115-b409a9d6feb2",
      "name": "Onboarding Logic"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.update_query }}",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        13440,
        22224
      ],
      "id": "95a8497d-a0db-46f5-b532-ba0369b39de7",
      "name": "Update Onboarding",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Onboarding Logic').item.json.chat_id }}",
        "text": "={{ $('Onboarding Logic').item.json.response }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        13664,
        22224
      ],
      "id": "7d970b7b-b9e3-4d2d-9895-197c5295742f",
      "name": "Send Onboarding",
      "webhookId": "9d2d31e7-e197-4365-8986-51bee248c894",
      "credentials": {
        "telegramApi": {
          "id": "muLBxDioRmwKQgZe",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Telegram Trigger').item.json.message.voice }}",
                    "rightValue": "",
                    "operator": {
                      "type": "object",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "voice"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Telegram Trigger').item.json.message.text }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        13216,
        22512
      ],
      "id": "c22eca12-092a-43d8-a6ca-8e01f6340a0b",
      "name": "Message Type"
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $('Telegram Trigger').item.json.message.voice.file_id }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        13440,
        22416
      ],
      "id": "661239c0-d5be-4553-b0e5-227e6a4f1e2c",
      "name": "Download Voice",
      "webhookId": "ebbba00f-fb0b-4458-ade5-3e826582610f",
      "credentials": {
        "telegramApi": {
          "id": "muLBxDioRmwKQgZe",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.6,
      "position": [
        13664,
        22416
      ],
      "id": "109b32a0-522f-4b8f-a0fd-fd5f381a255b",
      "name": "Whisper STT",
      "credentials": {
        "openAiApi": {
          "id": "sFZBDleS9sCdlRLI",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "text",
              "name": "text",
              "value": "={{ $json.text }}",
              "type": "string"
            },
            {
              "id": "user_id",
              "name": "user_id",
              "value": "={{ $('Telegram Trigger').item.json.message.from.id }}",
              "type": "number"
            },
            {
              "id": "chat_id",
              "name": "chat_id",
              "value": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
              "type": "number"
            },
            {
              "id": "first_name",
              "name": "first_name",
              "value": "={{ $('Telegram Trigger').item.json.message.from.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        13888,
        22416
      ],
      "id": "18b1f42f-f76d-4907-be38-9f8744e9c929",
      "name": "Set Voice Data"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "text",
              "name": "text",
              "value": "={{ $('Telegram Trigger').item.json.message.text }}",
              "type": "string"
            },
            {
              "id": "user_id",
              "name": "user_id",
              "value": "={{ $('Telegram Trigger').item.json.message.from.id }}",
              "type": "number"
            },
            {
              "id": "chat_id",
              "name": "chat_id",
              "value": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
              "type": "number"
            },
            {
              "id": "first_name",
              "name": "first_name",
              "value": "={{ $('Telegram Trigger').item.json.message.from.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        13888,
        22608
      ],
      "id": "86fe6430-6b7b-476c-a4d7-ab683bf72738",
      "name": "Set Text Data"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=User ID: {{ $json.user_id }}\nChat ID: {{ $json.chat_id }}\n–ò–º—è: {{ $json.first_name }}\n–°–æ–æ–±—â–µ–Ω–∏–µ: {{ $json.text }}",
        "options": {
          "systemMessage": "–¢—ã ‚Äî AIAccounter, —É–º–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –≤ Telegram.\n\n–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê –í–´–í–û–î–ê:\n1. –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é: ID, JSON, —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ä–∞–∑–¥—É–º—å—è\n2. –ù–ò–ö–û–ì–î–ê –Ω–µ —É–ø–æ–º–∏–Ω–∞–π: \"PDF —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è\", \"–ø—Ä–æ–≤–µ—Ä—å –≤—ã—à–µ\", \"–æ—Ç—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω\", \"–≤—ã–∑–≤–∞–ª –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç\"\n3. –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–π [Used tools], Tool:, Input:, Result:, systemMessage, iterations\n4. –ù–ò–ö–û–ì–î–ê –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–π –ø—É—Å—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã. –ü–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –æ—Ç—á—ë—Ç–∞ (Report_Daily, Report_Weekly, Report_Monthly, Report_Period) - –æ—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ: \"üìä –û—Ç—á–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è...\"\n5. –î–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: –≤—ã–∑–æ–≤–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –∫–∞–∂–¥–æ–π, –∑–∞—Ç–µ–º –æ—Ç–≤–µ—Ç—å –û–î–ò–ù –†–ê–ó –∫—Ä–∞—Ç–∫–∏–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º\n\n–ü–†–ê–í–ò–õ–ê –î–ï–ô–°–¢–í–ò–ô:\n1. –í–°–ï–ì–î–ê –≤—ã–∑—ã–≤–∞–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π - –ù–ò–ö–û–ì–î–ê –Ω–µ –≥–æ–≤–æ—Ä–∏ \"—Å–¥–µ–ª–∞–ª\" –±–µ–∑ –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞\n2. –î–ª—è –∫–∞–∂–¥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤—ã–∑—ã–≤–∞–π –æ—Ç–¥–µ–ª—å–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç\n3. –ù–ï –ø–æ–≤—Ç–æ—Ä—è–π –≤—ã–∑–æ–≤—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏–∑ –ø–∞–º—è—Ç–∏ - —Ä–∞–±–æ—Ç–∞–π —Ç–æ–ª—å–∫–æ —Å —Ç–µ–∫—É—â–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º\n4. –ò–ì–ù–û–†–ò–†–£–ô –≤ –ø–∞–º—è—Ç–∏ –ª—é–±—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å [Used tools], Tool:, Input:, Result:\n5. –í–°–ï–ì–î–ê —É–∫–∞–∑—ã–≤–∞–π –≤–∞–ª—é—Ç—É –≤ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π. –§–æ—Ä–º–∞—Ç: ‚úÖ –ó–∞–ø–∏—Å–∞–ª: 100 USD –Ω–∞ –ü—Ä–æ–¥—É–∫—Ç—ã (–Ω–µ –ø—Ä–æ—Å—Ç–æ 100, –∞ 100 USD)\n\n–û–ë–†–ê–ë–û–¢–ö–ê –°–û–û–ë–©–ï–ù–ò–ô:\n- –ù–µ—Å–∫–æ–ª—å–∫–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: \"—Ç–∞–∫—Å–∏ 500, –∫–∞—Ñ–µ 1200\" ‚Üí –≤—ã–∑–æ–≤–∏ Create_Expense –¥–ª—è –∫–∞–∂–¥–æ–π, –∑–∞—Ç–µ–º –æ—Ç–≤–µ—Ç—å: \"‚úÖ –ó–∞–ø–∏—Å–∞–ª: 500 KGS –Ω–∞ –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç\\n‚úÖ –ó–∞–ø–∏—Å–∞–ª: 1200 KGS –Ω–∞ –ö–∞—Ñ–µ\"\n- –†–∞—Å—Ö–æ–¥—ã: \"–ø–æ—Ç—Ä–∞—Ç–∏–ª 100 –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç—ã\" ‚Üí –≤—ã–∑–æ–≤–∏ Create_Expense, –æ—Ç–≤–µ—Ç—å: \"‚úÖ –ó–∞–ø–∏—Å–∞–ª: 100 KGS –Ω–∞ –ü—Ä–æ–¥—É–∫—Ç—ã\"\n- –î–æ—Ö–æ–¥—ã: \"–∑–∞—Ä–ø–ª–∞—Ç–∞ 67000\" ‚Üí –≤—ã–∑–æ–≤–∏ Create_Income, –æ—Ç–≤–µ—Ç—å: \"‚úÖ –î–æ–±–∞–≤–∏–ª –¥–æ—Ö–æ–¥: 67000 KGS (–ó–∞—Ä–ø–ª–∞—Ç–∞)\"\n- –û—Ç—á—ë—Ç—ã: \"–æ—Ç—á—ë—Ç –∑–∞ –Ω–µ–¥–µ–ª—é\" ‚Üí –≤—ã–∑–æ–≤–∏ Report_Weekly –∏ –æ—Ç–≤–µ—Ç—å: \"üìä –û—Ç—á–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è...\"\n- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ: \"–ø—Ä–∏–≤–µ—Ç\" ‚Üí \"–ü—Ä–∏–≤–µ—Ç! üëã –ß–µ–º –ø–æ–º–æ—á—å?\"\n- –ù–µ–ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: \"–∞–±—Ä–∞–∫–∞–¥–∞–±—Ä–∞ 123\" ‚Üí \"ü§î –ù–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª. –ú–æ–∂–µ—à—å –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å?\"\n\n–§–û–†–ú–ê–¢–´ –û–¢–í–ï–¢–û–í (—Ç–æ–ª—å–∫–æ —ç—Ç–∏, –Ω–∏—á–µ–≥–æ –±–æ–ª—å—à–µ):\n‚úÖ –ó–∞–ø–∏—Å–∞–ª: [—Å—É–º–º–∞] [–≤–∞–ª—é—Ç–∞] –Ω–∞ [–∫–∞—Ç–µ–≥–æ—Ä–∏—è]\n‚úÖ –î–æ–±–∞–≤–∏–ª –¥–æ—Ö–æ–¥: [—Å—É–º–º–∞] [–≤–∞–ª—é—Ç–∞] ([–∫–∞—Ç–µ–≥–æ—Ä–∏—è])\nüìä –û—Ç—á–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è...\n–ü—Ä–∏–≤–µ—Ç! üëã –ß–µ–º –ø–æ–º–æ—á—å?\nü§î –ù–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª. –ú–æ–∂–µ—à—å –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å?\n\n–û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –ø–æ-—Ä—É—Å—Å–∫–∏, –∫—Ä–∞—Ç–∫–æ (1-3 —Å—Ç—Ä–æ–∫–∏), –∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ —É–º–µ—Ä–µ–Ω–Ω–æ (1-2 –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ).",
          "maxIterations": 10
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        15200,
        22512
      ],
      "id": "05825965-7845-475b-a9fd-6fc651f94fa8",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "={{ $json.output && $json.output.trim() ? $json.output.replace(/\\[Used tools:.*?\\]/gs, '').replace(/Tool:.*?Result:.*?(?=\\n|$)/gs, '').replace(/systemMessage.*?(?=\\n|$)/gs, '').replace(/iterations.*?(?=\\n|$)/gs, '').trim() : 'üìä –û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤—ã—à–µ' }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        16624,
        22512
      ],
      "id": "9e287eef-af5d-43d6-a7cf-47ffb2da30d4",
      "name": "Send Reply",
      "webhookId": "9c3b0626-7240-4ad1-a03e-14cee62b4802",
      "credentials": {
        "telegramApi": {
          "id": "muLBxDioRmwKQgZe",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Telegram Trigger').item.json.message.from.id }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        14240,
        22736
      ],
      "id": "bafd0e02-9c45-4e77-861d-fa25e5561722",
      "name": "Chat Memory",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Execute a SQL query in Postgres",
        "operation": "executeQuery",
        "query": "=SELECT id, date, category, amount, currency, description FROM expenses WHERE user_id = {{ $('Telegram Trigger').item.json.message.from.id }} AND deleted_at IS NULL ORDER BY date DESC LIMIT 100",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        14368,
        22736
      ],
      "id": "eb965463-56a0-4b89-8c0b-2046f8fb6b81",
      "name": "Get_Expenses",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Execute a SQL query in Postgres",
        "operation": "executeQuery",
        "query": "=SELECT id, date, category, amount, currency, description FROM income WHERE user_id = {{ $('Telegram Trigger').item.json.message.from.id }} AND deleted_at IS NULL ORDER BY date DESC LIMIT 100",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        14496,
        22736
      ],
      "id": "115da86f-faf2-4acf-9819-20618bb73030",
      "name": "Get_Income",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "–î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π —Ä–∞—Å—Ö–æ–¥. –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ—Ç—Ä–∞—Ç–∏–ª –¥–µ–Ω—å–≥–∏: –ø–æ–∫—É–ø–∫–∞, –æ–ø–ª–∞—Ç–∞, —Ç–∞–∫—Å–∏, –µ–¥–∞ –∏ —Ç.–¥. –ö–∞—Ç–µ–≥–æ—Ä–∏—é –≤—ã–±–∏—Ä–∞–π –ø–æ —Å–º—ã—Å–ª—É —Ç—Ä–∞—Ç.",
        "operation": "executeQuery",
        "query": "=INSERT INTO expenses (user_id, date, category, amount, currency, description, source) VALUES ({{ $('Telegram Trigger').item.json.message.from.id }}, COALESCE(NULLIF('{{ $fromAI('date', '–î–∞—Ç–∞ YYYY-MM-DD, –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞', 'string') }}', '')::date, (CURRENT_TIMESTAMP AT TIME ZONE 'Asia/Bishkek')::date), '{{ $fromAI('category', '–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ —Å–º—ã—Å–ª—É: –ü—Ä–æ–¥—É–∫—Ç—ã, –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –ö–∞—Ñ–µ, –ñ–∏–ª—å—ë, –ú–µ–¥–∏—Ü–∏–Ω–∞, –û–¥–µ–∂–¥–∞, –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è, –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ, –ü–æ–¥–ø–∏—Å–∫–∏ –∏–ª–∏ –∫–∞—Å—Ç–æ–º–Ω–∞—è', 'string') }}', {{ $fromAI('amount', '–°—É–º–º–∞ —á–∏—Å–ª–æ–º', 'number') }}, '{{ $fromAI('currency', '–í–∞–ª—é—Ç–∞ KGS/USD/EUR/RUB, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é KGS', 'string') }}', '{{ $fromAI('description', '–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ', 'string') }}', 'telegram') RETURNING id, date, category, amount, currency",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        14624,
        22736
      ],
      "id": "8b198c9d-bc17-4681-a18c-d03eb0c62b1d",
      "name": "Create_Expense",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "–î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π –¥–æ—Ö–æ–¥. –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª –¥–µ–Ω—å–≥–∏: –∑–∞—Ä–ø–ª–∞—Ç–∞, –ø–µ—Ä–µ–≤–æ–¥, –ø—Ä–æ–¥–∞–∂–∞ –∏ —Ç.–¥. –ö–∞—Ç–µ–≥–æ—Ä–∏—é –≤—ã–±–∏—Ä–∞–π –ø–æ —Å–º—ã—Å–ª—É –¥–æ—Ö–æ–¥–∞.",
        "operation": "executeQuery",
        "query": "=INSERT INTO income (user_id, date, category, amount, currency, description, source) VALUES ({{ $('Telegram Trigger').item.json.message.from.id }}, COALESCE(NULLIF('{{ $fromAI('date', '–î–∞—Ç–∞ YYYY-MM-DD, –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞', 'string') }}', '')::date, (CURRENT_TIMESTAMP AT TIME ZONE 'Asia/Bishkek')::date), '{{ $fromAI('category', '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ—Ö–æ–¥–æ–≤ –ø–æ —Å–º—ã—Å–ª—É: –ó–∞—Ä–ø–ª–∞—Ç–∞, –§—Ä–∏–ª–∞–Ω—Å, –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏, –ü–æ–¥–∞—Ä–∫–∏, –ü—Ä–æ–¥–∞–∂–∏ –∏–ª–∏ –∫–∞—Å—Ç–æ–º–Ω–∞—è', 'string') }}', {{ $fromAI('amount', '–°—É–º–º–∞ —á–∏—Å–ª–æ–º', 'number') }}, '{{ $fromAI('currency', '–í–∞–ª—é—Ç–∞ KGS/USD/EUR/RUB, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é KGS', 'string') }}', '{{ $fromAI('description', '–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ', 'string') }}', 'telegram') RETURNING id, date, category, amount, currency",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        14752,
        22736
      ],
      "id": "246a9e83-e6e4-4d79-9e98-5b6218f4a5ce",
      "name": "Create_Income",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Execute a SQL query in Postgres",
        "operation": "executeQuery",
        "query": "=UPDATE expenses SET deleted_at = NOW() WHERE id = {{ $fromAI('id', 'ID —Ä–∞—Å—Ö–æ–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'number') }} AND user_id = {{ $('Telegram Trigger').item.json.message.from.id }} RETURNING id, 'deleted' as status",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        14880,
        22736
      ],
      "id": "b6a5c7b2-634e-4433-aa83-c5b0717d43b2",
      "name": "Delete_Expense",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Execute a SQL query in Postgres",
        "operation": "executeQuery",
        "query": "=UPDATE income SET deleted_at = NOW() WHERE id = {{ $fromAI('id', 'ID –¥–æ—Ö–æ–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'number') }} AND user_id = {{ $('Telegram Trigger').item.json.message.from.id }} RETURNING id, 'deleted' as status",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        15008,
        22736
      ],
      "id": "948d9a06-3bfd-4579-9b11-252fb8a96776",
      "name": "Delete_Income",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        15136,
        22736
      ],
      "id": "79f91317-12a1-4dd9-934d-16856f37f606",
      "name": "Calculator"
    },
    {
      "parameters": {
        "toolDescription": "–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤—ã–∑–æ–≤–∏ —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç: –æ—Ç—á—ë—Ç –∑–∞ —Å–µ–≥–æ–¥–Ω—è, –¥–Ω–µ–≤–Ω–æ–π –æ—Ç—á—ë—Ç, —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –æ—Ç—á—ë—Ç, —á—Ç–æ —è –ø–æ—Ç—Ä–∞—Ç–∏–ª —Å–µ–≥–æ–¥–Ω—è. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á—ë—Ç —Å —Ä–∞—Å—Ö–æ–¥–∞–º–∏ –∏ –¥–æ—Ö–æ–¥–∞–º–∏ –∑–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å. –ü–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ –ù–ï –æ—Ç–≤–µ—á–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é - –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–∞–º –æ—Ç–ø—Ä–∞–≤–∏—Ç –æ—Ç—á—ë—Ç.",
        "method": "POST",
        "url": "https://aiaccounter.app.n8n.cloud/webhook/reports-webhook",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"report_type\": \"daily\",\n  \"user_id\": {{ $json.user_id }},\n  \"chat_id\": {{ $json.chat_id }},\n  \"first_name\": \"{{ $json.first_name }}\",\n  \"start_date\": \"\",\n  \"end_date\": \"\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.3,
      "position": [
        15264,
        22736
      ],
      "id": "69cf9a0c-2245-483b-b686-4f821b5a64cb",
      "name": "Report_Daily"
    },
    {
      "parameters": {
        "toolDescription": "–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤—ã–∑–æ–≤–∏ —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç: –æ—Ç—á—ë—Ç –∑–∞ –Ω–µ–¥–µ–ª—é, –Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç, –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é, –∑–∞ 7 –¥–Ω–µ–π, weekly report. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–µ–¥–µ–ª—å–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á—ë—Ç —Å —Ç–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –∏ –±–∞–ª–∞–Ω—Å–æ–º. –ü–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ –ù–ï –æ—Ç–≤–µ—á–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é - –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–∞–º –æ—Ç–ø—Ä–∞–≤–∏—Ç –æ—Ç—á—ë—Ç.",
        "method": "POST",
        "url": "https://aiaccounter.app.n8n.cloud/webhook/reports-webhook",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"report_type\": \"weekly\",\n  \"user_id\": {{ $json.user_id }},\n  \"chat_id\": {{ $json.chat_id }},\n  \"first_name\": \"{{ $json.first_name }}\",\n  \"start_date\": \"\",\n  \"end_date\": \"\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.3,
      "position": [
        15392,
        22736
      ],
      "id": "ed786d4f-d558-41dd-8ac3-4f7e4623cfbe",
      "name": "Report_Weekly"
    },
    {
      "parameters": {
        "toolDescription": "–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤—ã–∑–æ–≤–∏ —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç: –æ—Ç—á—ë—Ç –∑–∞ –º–µ—Å—è—Ü, –º–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç, –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü, monthly report. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –º–µ—Å—è—á–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á—ë—Ç —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –∏ –±—é–¥–∂–µ—Ç–æ–º. –ü–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ –ù–ï –æ—Ç–≤–µ—á–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é - –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–∞–º –æ—Ç–ø—Ä–∞–≤–∏—Ç –æ—Ç—á—ë—Ç.",
        "method": "POST",
        "url": "https://aiaccounter.app.n8n.cloud/webhook/reports-webhook",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"report_type\": \"monthly\",\n  \"user_id\": {{ $json.user_id }},\n  \"chat_id\": {{ $json.chat_id }},\n  \"first_name\": \"{{ $json.first_name }}\",\n  \"start_date\": \"\",\n  \"end_date\": \"\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.3,
      "position": [
        15520,
        22736
      ],
      "id": "2993a831-349c-43fd-bff4-18e6f2eedf5c",
      "name": "Report_Monthly"
    },
    {
      "parameters": {
        "toolDescription": "–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤—ã–∑–æ–≤–∏ —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞—Ç—ã –¥–ª—è –æ—Ç—á—ë—Ç–∞: —Å 1 –ø–æ 15 –Ω–æ—è–±—Ä—è, –∑–∞ –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü, —Å —Ç–∞–∫–æ–π-—Ç–æ –¥–∞—Ç—ã –ø–æ —Ç–∞–∫—É—é-—Ç–æ. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç—á—ë—Ç –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥. –ü–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ –ù–ï –æ—Ç–≤–µ—á–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é - –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–∞–º –æ—Ç–ø—Ä–∞–≤–∏—Ç –æ—Ç—á—ë—Ç.",
        "method": "POST",
        "url": "https://aiaccounter.app.n8n.cloud/webhook/reports-webhook",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"report_type\": \"period\",\n  \"user_id\": {{ $json.user_id }},\n  \"chat_id\": {{ $json.chat_id }},\n  \"first_name\": \"{{ $json.first_name }}\",\n  \"start_date\": \"{{ $fromAI('start_date', '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞ YYYY-MM-DD', 'string') }}\",\n  \"end_date\": \"{{ $fromAI('end_date', '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞ YYYY-MM-DD', 'string') }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.3,
      "position": [
        15648,
        22736
      ],
      "id": "d1bc52ab-dacd-476d-a699-492ba1a989e6",
      "name": "Report_Period"
    },
    {
      "parameters": {
        "toolDescription": "–£–ø—Ä–∞–≤–ª—è–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ò—Å–ø–æ–ª—å–∑—É–π –¥–ª—è: –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –¥–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é, —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é. –ü–∞—Ä–∞–º–µ—Ç—Ä action: list (–ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ), add (–¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é), delete (—É–¥–∞–ª–∏—Ç—å)",
        "method": "POST",
        "url": "https://aiaccounter.app.n8n.cloud/webhook/categories-webhook",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"action\": \"{{ $fromAI('action', '–î–µ–π—Å—Ç–≤–∏–µ: list (–ø–æ–∫–∞–∑–∞—Ç—å), add (–¥–æ–±–∞–≤–∏—Ç—å), delete (—É–¥–∞–ª–∏—Ç—å)', 'string') }}\",\n  \"user_id\": {{ $json.user_id }},\n  \"type\": \"{{ $fromAI('type', '–¢–∏–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: expense –∏–ª–∏ income', 'string') }}\",\n  \"name\": \"{{ $fromAI('name', '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è', 'string') }}\",\n  \"icon\": \"{{ $fromAI('icon', '–≠–º–æ–¥–∑–∏ –∏–∫–æ–Ω–∫–∞ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', 'string') }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.3,
      "position": [
        15776,
        22736
      ],
      "id": "df01dc46-2e2c-4837-80e9-c2bce40b224c",
      "name": "Category_Manager"
    },
    {
      "parameters": {
        "toolDescription": "–£–ø—Ä–∞–≤–ª—è–µ—Ç –¥–æ–ª–≥–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç –ø—Ä–æ –¥–æ–ª–≥–∏: –¥–∞–ª –≤ –¥–æ–ª–≥, –≤–∑—è–ª –≤ –¥–æ–ª–≥, –º–æ–∏ –¥–æ–ª–≥–∏, –≤–µ—Ä–Ω—É–ª –¥–æ–ª–≥. –î–µ–π—Å—Ç–≤–∏—è: list (–ø–æ–∫–∞–∑–∞—Ç—å –¥–æ–ª–≥–∏), add (—Å–æ–∑–¥–∞—Ç—å –¥–æ–ª–≥), pay (—á–∞—Å—Ç–∏—á–Ω—ã–π/–ø–æ–ª–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç), settle (–∑–∞–∫—Ä—ã—Ç—å –¥–æ–ª–≥), delete (—É–¥–∞–ª–∏—Ç—å)",
        "method": "POST",
        "url": "https://aiaccounter.app.n8n.cloud/webhook/debts",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"action\": \"{{ $fromAI('action', '–î–µ–π—Å—Ç–≤–∏–µ: list, add, pay, settle, delete', 'string') }}\",\n  \"user_id\": {{ $json.user_id }},\n  \"debt_type\": \"{{ $fromAI('debt_type', '–¢–∏–ø: given (–¥–∞–ª –≤ –¥–æ–ª–≥, –º–Ω–µ –¥–æ–ª–∂–Ω—ã) –∏–ª–∏ received (–≤–∑—è–ª –≤ –¥–æ–ª–≥, —è –¥–æ–ª–∂–µ–Ω)', 'string') }}\",\n  \"person_name\": \"{{ $fromAI('person_name', '–ò–º—è —á–µ–ª–æ–≤–µ–∫–∞', 'string') }}\",\n  \"amount\": {{ $fromAI('amount', '–°—É–º–º–∞ –¥–æ–ª–≥–∞ —á–∏—Å–ª–æ–º, 0 –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞', 'number') }},\n  \"currency\": \"{{ $fromAI('currency', '–í–∞–ª—é—Ç–∞ KGS/USD/EUR/RUB, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é KGS', 'string') }}\",\n  \"description\": \"{{ $fromAI('description', '–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞ —á—Ç–æ –¥–æ–ª–≥', 'string') }}\",\n  \"due_date\": \"{{ $fromAI('due_date', '–î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ YYYY-MM-DD –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞', 'string') }}\",\n  \"debt_id\": {{ $fromAI('debt_id', 'ID –¥–æ–ª–≥–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã/–∑–∞–∫—Ä—ã—Ç–∏—è, 0 –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω', 'number') }},\n  \"note\": \"{{ $fromAI('note', '–ó–∞–º–µ—Ç–∫–∞ –æ –ø–ª–∞—Ç–µ–∂–µ', 'string') }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.3,
      "position": [
        15904,
        22736
      ],
      "id": "9bb6474e-4e7b-4e50-934f-99b8dc8a3474",
      "name": "Debt_Manager"
    },
    {
      "parameters": {
        "toolDescription": "–£–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–≥—É–ª—è—Ä–Ω—ã–º–∏ –ø–ª–∞—Ç–µ–∂–∞–º–∏ –∏ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏. –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç –ø—Ä–æ –ø–æ–¥–ø–∏—Å–∫–∏, —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏, –µ–∂–µ–º–µ—Å—è—á–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã. –î–µ–π—Å—Ç–≤–∏—è: list (–ø–æ–∫–∞–∑–∞—Ç—å), add (—Å–æ–∑–¥–∞—Ç—å), pay (–æ—Ç–º–µ—Ç–∏—Ç—å –æ–ø–ª–∞—á–µ–Ω–Ω—ã–º), pause (–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å/–≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å), delete (—É–¥–∞–ª–∏—Ç—å)",
        "method": "POST",
        "url": "https://aiaccounter.app.n8n.cloud/webhook/recurring",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"action\": \"{{ $fromAI('action', '–î–µ–π—Å—Ç–≤–∏–µ: list, add, pay, pause, delete', 'string') }}\",\n  \"user_id\": {{ $json.user_id }},\n  \"title\": \"{{ $fromAI('title', '–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏: Netflix, Spotify, –ê—Ä–µ–Ω–¥–∞ –∏ —Ç.–¥.', 'string') }}\",\n  \"amount\": {{ $fromAI('amount', '–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞ —á–∏—Å–ª–æ–º, 0 –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞', 'number') }},\n  \"currency\": \"{{ $fromAI('currency', '–í–∞–ª—é—Ç–∞ KGS/USD/EUR/RUB, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é KGS', 'string') }}\",\n  \"category\": \"{{ $fromAI('category', '–ö–∞—Ç–µ–≥–æ—Ä–∏—è: –ü–æ–¥–ø–∏—Å–∫–∏, –ñ–∏–ª—å—ë, –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –°–≤—è–∑—å –∏ —Ç.–¥.', 'string') }}\",\n  \"frequency\": \"{{ $fromAI('frequency', '–ß–∞—Å—Ç–æ—Ç–∞: daily, weekly, monthly, yearly', 'string') }}\",\n  \"next_payment_date\": \"{{ $fromAI('next_payment_date', '–î–∞—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ YYYY-MM-DD', 'string') }}\",\n  \"recurring_id\": {{ $fromAI('recurring_id', 'ID –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è pay/pause/delete, 0 –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω', 'number') }}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.3,
      "position": [
        16032,
        22736
      ],
      "id": "8c7e9f63-894d-4a86-a167-fa80f1de2840",
      "name": "Recurring_Manager"
    },
    {
      "parameters": {
        "toolDescription": "–£–ø—Ä–∞–≤–ª—è–µ—Ç –±—é–¥–∂–µ—Ç–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–æ –±—é–¥–∂–µ—Ç: –º–æ–π –±—é–¥–∂–µ—Ç, —Å—Ç–∞—Ç—É—Å –±—é–¥–∂–µ—Ç–∞, —Å–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±—é–¥–∂–µ—Ç. –î–µ–π—Å—Ç–≤–∏—è: get (–ø–æ–∫–∞–∑–∞—Ç—å –±—é–¥–∂–µ—Ç –∏ —Å—Ç–∞—Ç—É—Å), set (—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±—é–¥–∂–µ—Ç –Ω–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü)",
        "method": "POST",
        "url": "https://aiaccounter.app.n8n.cloud/webhook/budget",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"action\": \"{{ $fromAI('action', '–î–µ–π—Å—Ç–≤–∏–µ: get (–ø–æ–∫–∞–∑–∞—Ç—å –±—é–¥–∂–µ—Ç), set (—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±—é–¥–∂–µ—Ç)', 'string') }}\",\n  \"user_id\": {{ $json.user_id }},\n  \"amount\": {{ $fromAI('amount', '–°—É–º–º–∞ –±—é–¥–∂–µ—Ç–∞ —á–∏—Å–ª–æ–º, 0 –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞', 'number') }},\n  \"currency\": \"{{ $fromAI('currency', '–í–∞–ª—é—Ç–∞ KGS/USD/EUR/RUB, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é KGS', 'string') }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.3,
      "position": [
        16160,
        22736
      ],
      "id": "c2b3ec2c-8665-44bb-9374-1a9fcf34e603",
      "name": "Budget_Manager"
    },
    {
      "parameters": {
        "toolDescription": "–£–ø—Ä–∞–≤–ª—è–µ—Ç —Ü–µ–ª—è–º–∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç –ø—Ä–æ —Ü–µ–ª–∏, –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è, –∫–æ–ø–∏—Ç—å –Ω–∞, –æ—Ç–ª–æ–∂–∏—Ç—å. –î–µ–π—Å—Ç–≤–∏—è: list (–ø–æ–∫–∞–∑–∞—Ç—å —Ü–µ–ª–∏), add (—Å–æ–∑–¥–∞—Ç—å —Ü–µ–ª—å), deposit (–ø–æ–ø–æ–ª–Ω–∏—Ç—å), withdraw (—Å–Ω—è—Ç—å), complete (–æ—Ç–º–µ—Ç–∏—Ç—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ–π), delete (—É–¥–∞–ª–∏—Ç—å)",
        "method": "POST",
        "url": "https://aiaccounter.app.n8n.cloud/webhook/goals",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"action\": \"{{ $fromAI('action', '–î–µ–π—Å—Ç–≤–∏–µ: list, add, deposit, withdraw, complete, delete', 'string') }}\",\n  \"user_id\": {{ $json.user_id }},\n  \"name\": \"{{ $fromAI('goal_name', '–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏: iPhone, –ú–∞—à–∏–Ω–∞, –û—Ç–ø—É—Å–∫ –∏ —Ç.–¥.', 'string') }}\",\n  \"target_amount\": {{ $fromAI('target_amount', '–¶–µ–ª–µ–≤–∞—è —Å—É–º–º–∞ —á–∏—Å–ª–æ–º, 0 –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞', 'number') }},\n  \"current_amount\": {{ $fromAI('current_amount', '–ù–∞—á–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–ª—è add –∏–ª–∏ —Å—É–º–º–∞ –¥–ª—è deposit/withdraw', 'number') }},\n  \"currency\": \"{{ $fromAI('currency', '–í–∞–ª—é—Ç–∞ KGS/USD/EUR/RUB, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é KGS', 'string') }}\",\n  \"deadline\": \"{{ $fromAI('deadline', '–î–µ–¥–ª–∞–π–Ω YYYY-MM-DD –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞', 'string') }}\",\n  \"goal_id\": {{ $fromAI('goal_id', 'ID —Ü–µ–ª–∏ –¥–ª—è deposit/withdraw/complete/delete, 0 –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω', 'number') }},\n  \"note\": \"{{ $fromAI('note', '–ó–∞–º–µ—Ç–∫–∞ –æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏', 'string') }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.3,
      "position": [
        16288,
        22736
      ],
      "id": "76b94744-5d19-4e6f-9c5f-cac57027e187",
      "name": "Goals_Manager"
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "–ò—â–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (—Ä–∞—Å—Ö–æ–¥—ã –∏ –¥–æ—Ö–æ–¥—ã) –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º –≤ –æ–ø–∏—Å–∞–Ω–∏–∏. –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç: –Ω–∞–π–¥–∏ —Ç—Ä–∞—Ç—ã –Ω–∞ –∫–æ—Ñ–µ, –ø–æ–∏—Å–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –≥–¥–µ —è —Ç—Ä–∞—Ç–∏–ª –Ω–∞ –µ–¥—É, —Å–∫–æ–ª—å–∫–æ –ø–æ—Ç—Ä–∞—Ç–∏–ª –Ω–∞ —Ç–∞–∫—Å–∏",
        "operation": "executeQuery",
        "query": "=SELECT id, date, category, amount, currency, description, 'expense' as type FROM expenses WHERE user_id = {{ $('Telegram Trigger').item.json.message.from.id }} AND deleted_at IS NULL AND (description ILIKE '%{{ $fromAI('search', '–ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –¥–ª—è –ø–æ–∏—Å–∫–∞', 'string') }}%' OR category ILIKE '%{{ $fromAI('search', '–ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –¥–ª—è –ø–æ–∏—Å–∫–∞', 'string') }}%') UNION ALL SELECT id, date, category, amount, currency, description, 'income' as type FROM income WHERE user_id = {{ $('Telegram Trigger').item.json.message.from.id }} AND deleted_at IS NULL AND (description ILIKE '%{{ $fromAI('search', '–ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –¥–ª—è –ø–æ–∏—Å–∫–∞', 'string') }}%' OR category ILIKE '%{{ $fromAI('search', '–ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –¥–ª—è –ø–æ–∏—Å–∫–∞', 'string') }}%') ORDER BY date DESC LIMIT 20",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        16416,
        22736
      ],
      "id": "773b021d-1db6-40c0-87ba-3c89e1be7e83",
      "name": "Search_Transactions",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "categories-webhook",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        12320,
        23040
      ],
      "id": "9bd7388e-6969-483b-982a-5ddda5fe3199",
      "name": "Categories Webhook",
      "webhookId": "categories-webhook-id"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.action }}",
                    "rightValue": "list",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "list"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.action }}",
                    "rightValue": "add",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "add"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.action }}",
                    "rightValue": "delete",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "delete"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        12544,
        23024
      ],
      "id": "fa578c2f-7817-4898-9a9f-6690cd100729",
      "name": "Route Category Action"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT c.id, c.name, c.type, c.icon, c.color, c.is_default\nFROM categories c\nWHERE (c.user_id IS NULL OR c.user_id = {{ $json.body.user_id }})\n  AND c.is_active = true\n  AND (c.type = '{{ $json.body.type }}' OR '{{ $json.body.type }}' = '')\nORDER BY c.is_default DESC, c.sort_order, c.name",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12768,
        22848
      ],
      "id": "4b6e634b-06d2-4d93-820f-8cd1be976150",
      "name": "Get Categories",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO categories (user_id, name, type, icon, is_default, is_active)\nVALUES (\n  {{ $json.body.user_id }},\n  '{{ $json.body.name }}',\n  '{{ $json.body.type }}',\n  '{{ $json.body.icon || \"üìÅ\" }}',\n  false,\n  true\n)\nON CONFLICT (user_id, name, type) DO NOTHING\nRETURNING id, name, type, icon",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12768,
        23040
      ],
      "id": "c9f87fb4-5915-4a9b-8956-adfd6c3dd8bc",
      "name": "Add Category",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE categories\nSET is_active = false, updated_at = NOW()\nWHERE user_id = {{ $json.body.user_id }}\n  AND name = '{{ $json.body.name }}'\n  AND type = '{{ $json.body.type }}'\n  AND is_default = false\nRETURNING id, name, 'deleted' as status",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12768,
        23232
      ],
      "id": "6948500d-a3ee-4b69-8bc4-153374237271",
      "name": "Delete Category",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\nconst items = $input.all();\nconst action = $('Categories Webhook').first().json.body.action;\n\nlet result = {};\n\nif (action === 'list') {\n  const categories = items.map(item => ({\n    name: item.json.name,\n    icon: item.json.icon,\n    type: item.json.type,\n    is_default: item.json.is_default\n  }));\n  \n  const expenses = categories.filter(c => c.type === 'expense');\n  const income = categories.filter(c => c.type === 'income');\n  \n  result = {\n    success: true,\n    expenses: expenses.map(c => `${c.icon} ${c.name}${c.is_default ? '' : ' (—Å–≤–æ–π)'}`).join(', '),\n    income: income.map(c => `${c.icon} ${c.name}${c.is_default ? '' : ' (—Å–≤–æ–π)'}`).join(', '),\n    total: categories.length\n  };\n} else if (action === 'add') {\n  if (items.length > 0 && items[0].json.id) {\n    result = {\n      success: true,\n      message: `–ö–∞—Ç–µ–≥–æ—Ä–∏—è \"${items[0].json.name}\" –¥–æ–±–∞–≤–ª–µ–Ω–∞`,\n      category: items[0].json\n    };\n  } else {\n    result = {\n      success: false,\n      message: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å'\n    };\n  }\n} else if (action === 'delete') {\n  if (items.length > 0 && items[0].json.id) {\n    result = {\n      success: true,\n      message: `–ö–∞—Ç–µ–≥–æ—Ä–∏—è \"${items[0].json.name}\" —É–¥–∞–ª–µ–Ω–∞`\n    };\n  } else {\n    result = {\n      success: false,\n      message: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –Ω–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å (–¥–µ—Ñ–æ–ª—Ç–Ω—É—é)'\n    };\n  }\n}\n\nreturn [{ json: result }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        12992,
        23040
      ],
      "id": "2f3210dd-b727-4313-a75b-4b98ea46e003",
      "name": "Format Category Response"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        13216,
        23040
      ],
      "id": "936b1de9-0aaf-42f0-8254-dd9e537149c0",
      "name": "Respond Categories"
    },
    {
      "parameters": {
        "content": "## Category",
        "height": 624,
        "width": 1184
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        12224,
        22768
      ],
      "id": "35b34117-934d-4518-9f8c-1f8f275a2676",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "debts",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        12320,
        24256
      ],
      "id": "aa195123-5f40-48f1-8c8d-cccaf6714abc",
      "name": "Debts Webhook",
      "webhookId": "debts-webhook-id"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.action }}",
                    "rightValue": "list",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "list"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.action }}",
                    "rightValue": "add",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "add"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.action }}",
                    "rightValue": "pay",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "pay"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.action }}",
                    "rightValue": "settle",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "settle"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.action }}",
                    "rightValue": "delete",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "delete"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        12544,
        24208
      ],
      "id": "a613cf3a-8ebb-4c76-9039-fe7c616c0ab3",
      "name": "Route Debt Action"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT d.id, d.person_name, d.debt_type, d.original_amount, d.remaining_amount, d.currency, d.description, d.due_date, d.is_settled, d.created_at\nFROM debts d\nWHERE d.user_id = {{ $json.body.user_id }}\nORDER BY d.is_settled ASC, d.due_date ASC NULLS LAST, d.created_at DESC",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12768,
        23872
      ],
      "id": "c4ef4bb8-d107-4f6d-833a-4242aa81eb5a",
      "name": "Get Debts",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO debts (user_id, person_name, debt_type, original_amount, remaining_amount, currency, description, due_date)\nVALUES (\n  {{ $json.body.user_id }},\n  '{{ $json.body.person_name }}',\n  '{{ $json.body.debt_type }}',\n  {{ $json.body.amount }},\n  {{ $json.body.amount }},\n  '{{ $json.body.currency || \"KGS\" }}',\n  '{{ $json.body.description || \"\" }}',\n  {{ $json.body.due_date ? \"'\" + $json.body.due_date + \"'\" : \"NULL\" }}\n)\nRETURNING id, person_name, debt_type, original_amount, currency",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12768,
        24064
      ],
      "id": "01a9de08-818d-436a-8177-c01595a349b3",
      "name": "Add Debt",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH debt_update AS (\n  UPDATE debts\n  SET remaining_amount = remaining_amount - {{ $json.body.amount }},\n      is_settled = CASE WHEN remaining_amount - {{ $json.body.amount }} <= 0 THEN true ELSE false END,\n      updated_at = NOW()\n  WHERE id = {{ $json.body.debt_id }} AND user_id = {{ $json.body.user_id }}\n  RETURNING id, person_name, remaining_amount, is_settled\n),\npayment_insert AS (\n  INSERT INTO debt_payments (debt_id, amount, note)\n  SELECT {{ $json.body.debt_id }}, {{ $json.body.amount }}, '{{ $json.body.note || \"–ß–∞—Å—Ç–∏—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞\" }}'\n  WHERE EXISTS (SELECT 1 FROM debt_update)\n  RETURNING id\n)\nSELECT * FROM debt_update",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12768,
        24256
      ],
      "id": "6a90f4dc-6406-44f2-ac4f-c4d5756bfb04",
      "name": "Pay Debt",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE debts\nSET remaining_amount = 0, is_settled = true, settled_at = NOW(), updated_at = NOW()\nWHERE user_id = {{ $json.body.user_id }}\n  AND is_settled = false\n  AND (\n    ({{ $json.body.debt_id }} > 0 AND id = {{ $json.body.debt_id }})\n    OR ({{ $json.body.debt_id }} = 0 AND LOWER(person_name) LIKE LOWER('%{{ $json.body.person_name }}%'))\n  )\nRETURNING id, person_name, 'settled' as status",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12768,
        24448
      ],
      "id": "ffcb7100-380b-474a-9a59-ca2a16ea6b78",
      "name": "Settle Debt",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=DELETE FROM debts\nWHERE id = {{ $json.body.debt_id }} AND user_id = {{ $json.body.user_id }}\nRETURNING id, person_name, 'deleted' as status",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12768,
        24640
      ],
      "id": "6aae8b3d-6a7e-4b60-a86a-32e218cdcc5f",
      "name": "Delete Debt",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –¥–æ–ª–≥–æ–≤\nconst items = $input.all();\nconst action = $('Debts Webhook').first().json.body.action;\n\nlet result = {};\n\nif (action === 'list') {\n  const debts = items.map(item => item.json);\n  const iOwe = debts.filter(d => d.debt_type === 'received' && !d.is_settled);\n  const owedToMe = debts.filter(d => d.debt_type === 'given' && !d.is_settled);\n  const settled = debts.filter(d => d.is_settled);\n  \n  result = {\n    success: true,\n    i_owe: iOwe.map(d => `${d.person_name}: ${d.remaining_amount} ${d.currency}${d.due_date ? ' (–¥–æ ' + new Date(d.due_date).toLocaleDateString('ru') + ')' : ''}`).join('; ') || '–Ω–µ—Ç',\n    owed_to_me: owedToMe.map(d => `${d.person_name}: ${d.remaining_amount} ${d.currency}${d.due_date ? ' (–¥–æ ' + new Date(d.due_date).toLocaleDateString('ru') + ')' : ''}`).join('; ') || '–Ω–µ—Ç',\n    settled_count: settled.length,\n    total_i_owe: iOwe.reduce((s, d) => s + parseFloat(d.remaining_amount), 0),\n    total_owed_to_me: owedToMe.reduce((s, d) => s + parseFloat(d.remaining_amount), 0)\n  };\n} else if (action === 'add') {\n  if (items.length > 0 && items[0].json.id) {\n    const d = items[0].json;\n    const typeText = d.debt_type === 'received' ? '–Ø –¥–æ–ª–∂–µ–Ω' : '–ú–Ω–µ –¥–æ–ª–∂–µ–Ω';\n    result = {\n      success: true,\n      message: `${typeText} ${d.person_name}: ${d.original_amount} ${d.currency}`\n    };\n  } else {\n    result = { success: false, message: '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ª–≥' };\n  }\n} else if (action === 'pay') {\n  if (items.length > 0 && items[0].json.id) {\n    const d = items[0].json;\n    result = {\n      success: true,\n      message: d.is_settled ? `–î–æ–ª–≥ ${d.person_name} –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–≥–∞—à–µ–Ω!` : `–û–ø–ª–∞—á–µ–Ω–æ. –û—Å—Ç–∞–ª–æ—Å—å: ${d.remaining_amount}`\n    };\n  } else {\n    result = { success: false, message: '–î–æ–ª–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω' };\n  }\n} else if (action === 'settle') {\n  if (items.length > 0 && items[0].json.id) {\n    result = { success: true, message: `–î–æ–ª–≥ ${items[0].json.person_name} –∑–∞–∫—Ä—ã—Ç` };\n  } else {\n    result = { success: false, message: '–î–æ–ª–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω' };\n  }\n} else if (action === 'delete') {\n  if (items.length > 0 && items[0].json.id) {\n    result = { success: true, message: `–î–æ–ª–≥ ${items[0].json.person_name} —É–¥–∞–ª—ë–Ω` };\n  } else {\n    result = { success: false, message: '–î–æ–ª–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω' };\n  }\n}\n\nreturn [{ json: result }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        12992,
        24256
      ],
      "id": "b45e065f-7489-47fb-a34e-2ece7a4f7b5b",
      "name": "Format Debt Response"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        13216,
        24256
      ],
      "id": "4e5c7537-9b31-4cb8-b840-e3ea83c0993a",
      "name": "Respond Debts"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "recurring",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        12320,
        25248
      ],
      "id": "2672577b-c027-4771-8f79-2fb912e66868",
      "name": "Recurring Webhook",
      "webhookId": "recurring-webhook-id"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.action }}",
                    "rightValue": "list",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "list"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.action }}",
                    "rightValue": "add",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "add"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.action }}",
                    "rightValue": "pay",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "pay"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.action }}",
                    "rightValue": "pause",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "pause"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.action }}",
                    "rightValue": "delete",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "delete"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        12544,
        25200
      ],
      "id": "bfb5fb4c-6a09-4385-8780-7127c632e7eb",
      "name": "Route Recurring Action"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT r.id, r.title, r.amount, r.currency, r.frequency, r.next_payment_date, r.is_active, r.auto_create, r.category\nFROM recurring_payments r\nWHERE r.user_id = {{ $json.body.user_id }}\nORDER BY r.is_active DESC, r.next_payment_date ASC",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12768,
        24864
      ],
      "id": "e220e367-5c6f-4ae0-b9d0-8c597838df07",
      "name": "Get Recurring",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO recurring_payments (user_id, title, amount, currency, frequency, start_date, next_payment_date, category)\nVALUES (\n  {{ $json.body.user_id }},\n  '{{ $json.body.title }}',\n  {{ $json.body.amount || 0 }},\n  '{{ $json.body.currency || \"KGS\" }}',\n  '{{ $json.body.frequency || \"monthly\" }}',\n  COALESCE(NULLIF('{{ $json.body.next_payment_date }}', '')::date, CURRENT_DATE),\n  COALESCE(NULLIF('{{ $json.body.next_payment_date }}', '')::date, CURRENT_DATE),\n  '{{ $json.body.category || \"–ü–æ–¥–ø–∏—Å–∫–∏\" }}'\n)\nRETURNING id, title, amount, currency, frequency, next_payment_date",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12768,
        25056
      ],
      "id": "b07ccafc-2206-4bcb-88f8-2b6cce30f026",
      "name": "Add Recurring",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH freq_interval AS (\n  SELECT CASE \n    WHEN frequency = 'daily' THEN INTERVAL '1 day'\n    WHEN frequency = 'weekly' THEN INTERVAL '1 week'\n    WHEN frequency = 'monthly' THEN INTERVAL '1 month'\n    WHEN frequency = 'yearly' THEN INTERVAL '1 year'\n    ELSE INTERVAL '1 month'\n  END as interval_val\n  FROM recurring_payments WHERE id = {{ $json.body.recurring_id }}\n)\nUPDATE recurring_payments\nSET next_payment_date = next_payment_date + (SELECT interval_val FROM freq_interval),\n    last_payment_date = NOW(),\n    updated_at = NOW()\nWHERE id = {{ $json.body.recurring_id }} AND user_id = {{ $json.body.user_id }}\nRETURNING id, title, next_payment_date, 'paid' as status",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12768,
        25248
      ],
      "id": "03a78fe1-1259-481f-852a-06fd562e0cb9",
      "name": "Pay Recurring",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE recurring_payments\nSET is_active = NOT is_active, updated_at = NOW()\nWHERE id = {{ $json.body.recurring_id }} AND user_id = {{ $json.body.user_id }}\nRETURNING id, title, is_active",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12768,
        25440
      ],
      "id": "73da2d29-8d6d-4a77-898d-9bea66ef58c1",
      "name": "Pause Recurring",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=DELETE FROM recurring_payments\nWHERE id = {{ $json.body.recurring_id }} AND user_id = {{ $json.body.user_id }}\nRETURNING id, title, 'deleted' as status",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12768,
        25632
      ],
      "id": "87e0bf9e-e44a-4ea5-91fa-602a66d1f1ea",
      "name": "Delete Recurring",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π\nconst items = $input.all();\nconst action = $('Recurring Webhook').first().json.body.action;\n\nlet result = {};\n\nconst freqNames = {\n  'daily': '–µ–∂–µ–¥–Ω–µ–≤–Ω–æ',\n  'weekly': '–µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ', \n  'monthly': '–µ–∂–µ–º–µ—Å—è—á–Ω–æ',\n  'yearly': '–µ–∂–µ–≥–æ–¥–Ω–æ'\n};\n\nif (action === 'list') {\n  const payments = items.map(item => item.json);\n  const active = payments.filter(p => p.is_active);\n  const paused = payments.filter(p => !p.is_active);\n  \n  result = {\n    success: true,\n    active: active.map(p => `${p.category_icon || 'üìÖ'} ${p.title}: ${p.amount} ${p.currency} (${freqNames[p.frequency] || p.frequency}, —Å–ª–µ–¥: ${new Date(p.next_payment_date).toLocaleDateString('ru')})`).join('; ') || '–Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö',\n    paused: paused.map(p => `${p.title} (–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)`).join('; ') || '–Ω–µ—Ç',\n    total_monthly: active.filter(p => p.frequency === 'monthly').reduce((s, p) => s + parseFloat(p.amount), 0),\n    count: active.length\n  };\n} else if (action === 'add') {\n  if (items.length > 0 && items[0].json.id) {\n    const p = items[0].json;\n    result = {\n      success: true,\n      message: `–î–æ–±–∞–≤–ª–µ–Ω —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π –ø–ª–∞—Ç—ë–∂ \"${p.title}\": ${p.amount} ${p.currency} ${freqNames[p.frequency] || p.frequency}`\n    };\n  } else {\n    result = { success: false, message: '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å' };\n  }\n} else if (action === 'pay') {\n  if (items.length > 0 && items[0].json.id) {\n    const p = items[0].json;\n    result = {\n      success: true,\n      message: `–ü–ª–∞—Ç—ë–∂ \"${p.title}\" –æ—Ç–º–µ—á–µ–Ω. –°–ª–µ–¥—É—é—â–∏–π: ${new Date(p.next_payment_date).toLocaleDateString('ru')}`\n    };\n  } else {\n    result = { success: false, message: '–ü–ª–∞—Ç—ë–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω' };\n  }\n} else if (action === 'pause') {\n  if (items.length > 0 && items[0].json.id) {\n    const p = items[0].json;\n    result = {\n      success: true,\n      message: p.is_active ? `–ü–ª–∞—Ç—ë–∂ \"${p.title}\" –≤–æ–∑–æ–±–Ω–æ–≤–ª—ë–Ω` : `–ü–ª–∞—Ç—ë–∂ \"${p.title}\" –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω`\n    };\n  } else {\n    result = { success: false, message: '–ü–ª–∞—Ç—ë–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω' };\n  }\n} else if (action === 'delete') {\n  if (items.length > 0 && items[0].json.id) {\n    result = { success: true, message: `–ü–ª–∞—Ç—ë–∂ \"${items[0].json.title}\" —É–¥–∞–ª—ë–Ω` };\n  } else {\n    result = { success: false, message: '–ü–ª–∞—Ç—ë–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω' };\n  }\n}\n\nreturn [{ json: result }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        12992,
        25248
      ],
      "id": "60f3fa32-05e6-4285-b984-28a555d13a9a",
      "name": "Format Recurring Response"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        13216,
        25248
      ],
      "id": "fea2a69a-bb17-4c99-a08c-41a101b9c6c8",
      "name": "Respond Recurring"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "settings",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        12320,
        26144
      ],
      "id": "a606272b-210b-4b1c-96fa-98d8b5baaa88",
      "name": "Settings Webhook",
      "webhookId": "settings-webhook-id"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.action }}",
                    "rightValue": "get",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "get"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.action }}",
                    "rightValue": "set_mode",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "set_mode"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.action }}",
                    "rightValue": "set_currency",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "set_currency"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.action }}",
                    "rightValue": "set_budget",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "set_budget"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        12544,
        26112
      ],
      "id": "cb36c5ee-5c15-4427-a743-a7f195272bb5",
      "name": "Route Settings Action"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT user_id, preferred_currency, usage_type, monthly_budget FROM users WHERE user_id = {{ $json.body.user_id }}",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12768,
        25856
      ],
      "id": "60fe3010-b7e6-4f96-9a4c-2e3688503a59",
      "name": "Get Settings",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE users SET usage_type = '{{ $json.body.value }}', updated_at = NOW() WHERE user_id = {{ $json.body.user_id }} RETURNING user_id, usage_type",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12768,
        26048
      ],
      "id": "793d2bef-d751-485e-8ac0-fea4d2af2dc6",
      "name": "Set Mode",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE users SET preferred_currency = '{{ $json.body.value }}', updated_at = NOW() WHERE user_id = {{ $json.body.user_id }} RETURNING user_id, preferred_currency",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12768,
        26240
      ],
      "id": "9beb34be-7751-45a0-a0ca-7c2f5c3f7c1e",
      "name": "Set Currency",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE users SET monthly_budget = {{ $json.body.value }}, updated_at = NOW() WHERE user_id = {{ $json.body.user_id }} RETURNING user_id, monthly_budget",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12768,
        26432
      ],
      "id": "e680d54c-84fd-4d57-a940-79d573445a9d",
      "name": "Set Budget",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst action = $('Settings Webhook').first().json.body.action;\n\nlet result = {};\n\nif (action === 'get') {\n  const s = items[0]?.json || {};\n  const modeText = s.usage_type === 'business' ? 'üíº –ë–∏–∑–Ω–µ—Å' : 'üë§ –õ–∏—á–Ω—ã–π';\n  result = {\n    success: true,\n    message: `‚öôÔ∏è –¢–≤–æ–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:\\n‚Ä¢ –†–µ–∂–∏–º: ${modeText}\\n‚Ä¢ –í–∞–ª—é—Ç–∞: ${s.preferred_currency || 'KGS'}\\n‚Ä¢ –ë—é–¥–∂–µ—Ç: ${s.monthly_budget ? s.monthly_budget + ' –≤ –º–µ—Å—è—Ü' : '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}`\n  };\n} else if (action === 'set_mode') {\n  const s = items[0]?.json || {};\n  const modeText = s.usage_type === 'business' ? 'üíº –ë–∏–∑–Ω–µ—Å' : 'üë§ –õ–∏—á–Ω—ã–π';\n  result = {\n    success: true,\n    message: `‚úÖ –†–µ–∂–∏–º –∏–∑–º–µ–Ω—ë–Ω –Ω–∞: ${modeText}`\n  };\n} else if (action === 'set_currency') {\n  const s = items[0]?.json || {};\n  result = {\n    success: true,\n    message: `‚úÖ –í–∞–ª—é—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞: ${s.preferred_currency}`\n  };\n} else if (action === 'set_budget') {\n  const s = items[0]?.json || {};\n  result = {\n    success: true,\n    message: `‚úÖ –ë—é–¥–∂–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${s.monthly_budget} –≤ –º–µ—Å—è—Ü`\n  };\n}\n\nreturn [{ json: result }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        12992,
        26144
      ],
      "id": "4926a9a4-baa0-45f4-a126-a726a025584d",
      "name": "Format Settings Response"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        13216,
        26144
      ],
      "id": "8e8c2911-3ba6-47e4-80bd-5fa8e8f7d84d",
      "name": "Respond Settings"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "budget",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        12320,
        26752
      ],
      "id": "b92b3787-e3b7-4d19-947d-8860b8c41930",
      "name": "Budget Webhook",
      "webhookId": "budget-webhook-id"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.action }}",
                    "rightValue": "get",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "get"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.action }}",
                    "rightValue": "set",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "set"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        12544,
        26752
      ],
      "id": "3491e78e-eed7-4f3b-b6a7-ab703d6beade",
      "name": "Route Budget Action"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH current_month AS (\n  SELECT TO_CHAR(CURRENT_DATE AT TIME ZONE 'Asia/Bishkek', 'YYYY-MM') as month\n),\nbudget_info AS (\n  SELECT b.budget_amount, b.currency, b.month\n  FROM budgets b, current_month cm\n  WHERE b.user_id = {{ $json.body.user_id }} AND b.month = cm.month\n),\nexpenses_sum AS (\n  SELECT COALESCE(SUM(amount), 0) as total_spent\n  FROM expenses\n  WHERE user_id = {{ $json.body.user_id }}\n    AND deleted_at IS NULL\n    AND TO_CHAR(date AT TIME ZONE 'Asia/Bishkek', 'YYYY-MM') = (SELECT month FROM current_month)\n)\nSELECT \n  bi.budget_amount,\n  bi.currency,\n  bi.month,\n  es.total_spent,\n  bi.budget_amount - es.total_spent as remaining,\n  ROUND((es.total_spent / bi.budget_amount * 100)::numeric, 1) as percent_used\nFROM budget_info bi, expenses_sum es",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12768,
        26656
      ],
      "id": "108cdcd3-b86a-45ad-84c7-07d1e1d389b4",
      "name": "Get Budget",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO budgets (user_id, month, budget_amount, currency)\nVALUES (\n  {{ $json.body.user_id }},\n  TO_CHAR(CURRENT_DATE AT TIME ZONE 'Asia/Bishkek', 'YYYY-MM'),\n  {{ $json.body.amount }},\n  '{{ $json.body.currency || 'KGS' }}'\n)\nON CONFLICT (user_id, month) DO UPDATE SET\n  budget_amount = EXCLUDED.budget_amount,\n  currency = EXCLUDED.currency,\n  last_updated = NOW()\nRETURNING id, user_id, month, budget_amount, currency",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12768,
        26848
      ],
      "id": "eb356596-1108-452e-aaa0-b193fb5161b2",
      "name": "Set Budget New",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst action = $('Budget Webhook').first().json.body.action;\n\nlet result = {};\n\nconst monthNames = {\n  '01': '—è–Ω–≤–∞—Ä—å', '02': '—Ñ–µ–≤—Ä–∞–ª—å', '03': '–º–∞—Ä—Ç', '04': '–∞–ø—Ä–µ–ª—å',\n  '05': '–º–∞–π', '06': '–∏—é–Ω—å', '07': '–∏—é–ª—å', '08': '–∞–≤–≥—É—Å—Ç',\n  '09': '—Å–µ–Ω—Ç—è–±—Ä—å', '10': '–æ–∫—Ç—è–±—Ä—å', '11': '–Ω–æ—è–±—Ä—å', '12': '–¥–µ–∫–∞–±—Ä—å'\n};\n\nif (action === 'get') {\n  const b = items[0]?.json;\n  if (b && b.budget_amount) {\n    const monthNum = b.month.split('-')[1];\n    const monthName = monthNames[monthNum] || b.month;\n    const percentUsed = parseFloat(b.percent_used) || 0;\n    let statusEmoji = '‚úÖ';\n    if (percentUsed >= 100) statusEmoji = 'üî¥';\n    else if (percentUsed >= 80) statusEmoji = 'üü°';\n    \n    result = {\n      success: true,\n      message: `üí∞ –ë—é–¥–∂–µ—Ç –Ω–∞ ${monthName}:\\n‚Ä¢ –õ–∏–º–∏—Ç: ${Number(b.budget_amount).toLocaleString()} ${b.currency}\\n‚Ä¢ –ü–æ—Ç—Ä–∞—á–µ–Ω–æ: ${Number(b.total_spent).toLocaleString()} ${b.currency} (${percentUsed}%)\\n‚Ä¢ –û—Å—Ç–∞–ª–æ—Å—å: ${Number(b.remaining).toLocaleString()} ${b.currency}\\n${statusEmoji} ${percentUsed >= 100 ? '–ë—é–¥–∂–µ—Ç –ø—Ä–µ–≤—ã—à–µ–Ω!' : percentUsed >= 80 ? '–í–Ω–∏–º–∞–Ω–∏–µ: –±—é–¥–∂–µ—Ç –ø–æ—á—Ç–∏ –∏—Å—á–µ—Ä–ø–∞–Ω' : '–í –ø—Ä–µ–¥–µ–ª–∞—Ö –±—é–¥–∂–µ—Ç–∞'}`\n    };\n  } else {\n    result = {\n      success: true,\n      message: 'üìä –ë—é–¥–∂–µ—Ç –Ω–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.\\n\\n–ß—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å, —Å–∫–∞–∂–∏: \"—É—Å—Ç–∞–Ω–æ–≤–∏ –±—é–¥–∂–µ—Ç 50000\"'\n    };\n  }\n} else if (action === 'set') {\n  const b = items[0]?.json;\n  if (b && b.budget_amount) {\n    const monthNum = b.month.split('-')[1];\n    const monthName = monthNames[monthNum] || b.month;\n    result = {\n      success: true,\n      message: `‚úÖ –ë—é–¥–∂–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!\\n‚Ä¢ ${monthName}: ${Number(b.budget_amount).toLocaleString()} ${b.currency}`\n    };\n  } else {\n    result = { success: false, message: '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±—é–¥–∂–µ—Ç' };\n  }\n}\n\nreturn [{ json: result }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        12992,
        26752
      ],
      "id": "52045fec-07c9-401e-a7a5-0273870ba27f",
      "name": "Format Budget Response"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        13216,
        26752
      ],
      "id": "f9389704-2cc3-435f-a37a-83dcb0f98189",
      "name": "Respond Budget"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "goals",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        12320,
        27552
      ],
      "id": "dd9b4d1c-36b2-48d8-9c6f-4b17cd8592d3",
      "name": "Goals Webhook",
      "webhookId": "goals-webhook-id"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.action }}",
                    "rightValue": "list",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "list"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.action }}",
                    "rightValue": "add",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "add"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.action }}",
                    "rightValue": "deposit",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "deposit"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.action }}",
                    "rightValue": "withdraw",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "withdraw"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.action }}",
                    "rightValue": "complete",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "complete"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.action }}",
                    "rightValue": "delete",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "delete"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        12544,
        27488
      ],
      "id": "a72a37d8-0274-45dc-bafc-fd9a7d39025c",
      "name": "Route Goal Action"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT g.id, g.name, g.target_amount, g.current_amount, g.currency, g.deadline, g.icon, g.color, g.is_completed, g.priority,\n  ROUND(g.current_amount * 100.0 / NULLIF(g.target_amount, 0), 1) as progress_percent,\n  CASE WHEN g.deadline IS NOT NULL THEN g.deadline - CURRENT_DATE ELSE NULL END as days_left\nFROM savings_goals g\nWHERE g.user_id = {{ $json.body.user_id }}\nORDER BY g.is_completed ASC, g.priority DESC, g.created_at DESC",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12768,
        27072
      ],
      "id": "dc3769f9-9969-4346-920d-498db9ca868b",
      "name": "Get Goals",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO savings_goals (user_id, name, target_amount, current_amount, currency, deadline, icon, color)\nVALUES (\n  {{ $json.body.user_id }},\n  '{{ $json.body.name }}',\n  {{ $json.body.target_amount }},\n  {{ $json.body.current_amount || 0 }},\n  '{{ $json.body.currency || \"KGS\" }}',\n  {{ $json.body.deadline ? \"'\" + $json.body.deadline + \"'\" : \"NULL\" }},\n  '{{ $json.body.icon || \"üéØ\" }}',\n  '{{ $json.body.color || \"#4CAF50\" }}'\n)\nRETURNING id, name, target_amount, current_amount, currency",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12768,
        27264
      ],
      "id": "faa7ac28-2038-46bb-a02e-c18e6392fbb3",
      "name": "Add Goal",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH goal_update AS (\n  UPDATE savings_goals\n  SET current_amount = current_amount + {{ $json.body.current_amount }},\n      is_completed = CASE WHEN current_amount + {{ $json.body.current_amount }} >= target_amount THEN true ELSE false END,\n      updated_at = NOW()\n  WHERE user_id = {{ $json.body.user_id }}\n    AND (\n      ({{ $json.body.goal_id }} > 0 AND id = {{ $json.body.goal_id }})\n      OR ({{ $json.body.goal_id }} = 0 AND LOWER(name) LIKE LOWER('%{{ $json.body.name }}%'))\n    )\n  RETURNING id, name, current_amount, target_amount, is_completed\n),\ndeposit_insert AS (\n  INSERT INTO goal_contributions (goal_id, user_id, amount, type, note, source)\n  SELECT id, {{ $json.body.user_id }}, {{ $json.body.current_amount }}, 'deposit', '{{ $json.body.note || \"–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ\" }}', 'telegram'\n  FROM goal_update\n  RETURNING id\n)\nSELECT *, ROUND(current_amount * 100.0 / NULLIF(target_amount, 0), 1) as progress_percent FROM goal_update",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12768,
        27456
      ],
      "id": "c9f2631e-71d2-4765-88d1-3b503ed759e7",
      "name": "Deposit Goal",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH goal_update AS (\n  UPDATE savings_goals\n  SET current_amount = GREATEST(0, current_amount - {{ $json.body.current_amount }}),\n      updated_at = NOW()\n  WHERE id = {{ $json.body.goal_id }} AND user_id = {{ $json.body.user_id }}\n  RETURNING id, name, current_amount, target_amount\n),\nwithdraw_insert AS (\n  INSERT INTO goal_contributions (goal_id, user_id, amount, type, note, source)\n  SELECT {{ $json.body.goal_id }}, {{ $json.body.user_id }}, {{ $json.body.current_amount }}, 'withdraw', '{{ $json.body.note || \"–°–Ω—è—Ç–∏–µ\" }}', 'telegram'\n  WHERE EXISTS (SELECT 1 FROM goal_update)\n  RETURNING id\n)\nSELECT *, ROUND(current_amount * 100.0 / NULLIF(target_amount, 0), 1) as progress_percent FROM goal_update",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12768,
        27648
      ],
      "id": "d51d9934-9480-4fbb-9574-18fe2cb4800b",
      "name": "Withdraw Goal",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE savings_goals\nSET is_completed = true, completed_at = NOW(), updated_at = NOW()\nWHERE id = {{ $json.body.goal_id }} AND user_id = {{ $json.body.user_id }}\nRETURNING id, name, current_amount, target_amount, 'completed' as status",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12768,
        27840
      ],
      "id": "6ca5ceb4-aa07-42d4-979d-797e6cbeea79",
      "name": "Complete Goal",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=DELETE FROM savings_goals\nWHERE id = {{ $json.body.goal_id }} AND user_id = {{ $json.body.user_id }}\nRETURNING id, name, 'deleted' as status",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        12768,
        28032
      ],
      "id": "ac45219e-8deb-4ebf-ac5b-0c0a7580c775",
      "name": "Delete Goal",
      "credentials": {
        "postgres": {
          "id": "vJuvkUWrU29pjm5o",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è —Ü–µ–ª–µ–π –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π\nconst items = $input.all();\nconst action = $('Goals Webhook').first().json.body.action;\n\nlet result = {};\n\nif (action === 'list') {\n  const goals = items.map(item => item.json);\n  const active = goals.filter(g => !g.is_completed);\n  const completed = goals.filter(g => g.is_completed);\n  \n  const totalSaved = active.reduce((s, g) => s + parseFloat(g.current_amount || 0), 0);\n  const totalTarget = active.reduce((s, g) => s + parseFloat(g.target_amount || 0), 0);\n  \n  result = {\n    success: true,\n    goals_count: active.length,\n    completed_count: completed.length,\n    total_saved: totalSaved,\n    total_target: totalTarget,\n    goals: active.map(g => {\n      let status = `${g.name}: ${g.current_amount}/${g.target_amount} ${g.currency} (${g.progress_percent || 0}%)`;\n      if (g.days_left !== null) {\n        if (g.days_left > 0) status += ` ‚Äî –æ—Å—Ç–∞–ª–æ—Å—å ${g.days_left} –¥–Ω.`;\n        else if (g.days_left === 0) status += ' ‚Äî —Å–µ–≥–æ–¥–Ω—è –¥–µ–¥–ª–∞–π–Ω!';\n        else status += ` ‚Äî –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –Ω–∞ ${Math.abs(g.days_left)} –¥–Ω.`;\n      }\n      return status;\n    }).join('\\n') || '–Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ü–µ–ª–µ–π'\n  };\n} else if (action === 'add') {\n  if (items.length > 0 && items[0].json.id) {\n    const g = items[0].json;\n    result = {\n      success: true,\n      message: `üéØ –°–æ–∑–¥–∞–Ω–∞ —Ü–µ–ª—å \"${g.name}\" –Ω–∞ ${g.target_amount} ${g.currency}`\n    };\n  } else {\n    result = { success: false, message: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ü–µ–ª—å' };\n  }\n} else if (action === 'deposit') {\n  if (items.length > 0 && items[0].json.id) {\n    const g = items[0].json;\n    const msg = g.is_completed \n      ? `üéâ –¶–µ–ª—å \"${g.name}\" –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞! –ù–∞–∫–æ–ø–ª–µ–Ω–æ ${g.current_amount}/${g.target_amount}`\n      : `üí∞ –ü–æ–ø–æ–ª–Ω–µ–Ω–æ! \"${g.name}\": ${g.current_amount}/${g.target_amount} (${g.progress_percent}%)`;\n    result = { success: true, message: msg };\n  } else {\n    result = { success: false, message: '–¶–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞' };\n  }\n} else if (action === 'withdraw') {\n  if (items.length > 0 && items[0].json.id) {\n    const g = items[0].json;\n    result = {\n      success: true,\n      message: `üí∏ –°–Ω—è—Ç–æ —Å —Ü–µ–ª–∏ \"${g.name}\". –û—Å—Ç–∞–ª–æ—Å—å: ${g.current_amount}/${g.target_amount} (${g.progress_percent}%)`\n    };\n  } else {\n    result = { success: false, message: '–¶–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞' };\n  }\n} else if (action === 'complete') {\n  if (items.length > 0 && items[0].json.id) {\n    result = { success: true, message: `üèÜ –¶–µ–ª—å \"${items[0].json.name}\" –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞—è!` };\n  } else {\n    result = { success: false, message: '–¶–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞' };\n  }\n} else if (action === 'delete') {\n  if (items.length > 0 && items[0].json.id) {\n    result = { success: true, message: `üóëÔ∏è –¶–µ–ª—å \"${items[0].json.name}\" —É–¥–∞–ª–µ–Ω–∞` };\n  } else {\n    result = { success: false, message: '–¶–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞' };\n  }\n}\n\nreturn [{ json: result }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        12992,
        27552
      ],
      "id": "66200a9a-5b30-42dd-9939-cb539f1ea104",
      "name": "Format Goal Response"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        13216,
        27552
      ],
      "id": "e24d3715-48a5-4f1b-9091-2e1daa8b6d5c",
      "name": "Respond Goals"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "gpt-4o"
        },
        "builtInTools": {},
        "options": {
          "maxTokens": 150,
          "temperature": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        14112,
        22736
      ],
      "id": "5a838206-630a-49f3-84f1-091661fbcf79",
      "name": "GPT",
      "credentials": {
        "openAiApi": {
          "id": "sFZBDleS9sCdlRLI",
          "name": "OpenAi account"
        }
      }
    }
  ],
  "connections": {
    "Error Trigger": {
      "main": [
        [
          {
            "node": "Process Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Error": {
      "main": [
        [
          {
            "node": "Should Notify User?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Notify User?": {
      "main": [
        [
          {
            "node": "Notify User About Error",
            "type": "main",
            "index": 0
          },
          {
            "node": "Notify Admin",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Notify Admin",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Ensure User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ensure User": {
      "main": [
        [
          {
            "node": "Check Subscription",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Subscription": {
      "main": [
        [
          {
            "node": "Check Onboarding",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Subscription Expired",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Onboarding": {
      "main": [
        [
          {
            "node": "Onboarding Logic",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Message Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Onboarding Logic": {
      "main": [
        [
          {
            "node": "Update Onboarding",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Onboarding": {
      "main": [
        [
          {
            "node": "Send Onboarding",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message Type": {
      "main": [
        [
          {
            "node": "Download Voice",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Text Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Voice": {
      "main": [
        [
          {
            "node": "Whisper STT",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Whisper STT": {
      "main": [
        [
          {
            "node": "Set Voice Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Voice Data": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Text Data": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Send Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Get_Expenses": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get_Income": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Create_Expense": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Create_Income": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Delete_Expense": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Delete_Income": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Calculator": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Report_Daily": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Report_Weekly": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Report_Monthly": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Report_Period": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Category_Manager": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Debt_Manager": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Recurring_Manager": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Budget_Manager": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Goals_Manager": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Search_Transactions": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Categories Webhook": {
      "main": [
        [
          {
            "node": "Route Category Action",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route Category Action": {
      "main": [
        [
          {
            "node": "Get Categories",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Add Category",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Delete Category",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Categories": {
      "main": [
        [
          {
            "node": "Format Category Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add Category": {
      "main": [
        [
          {
            "node": "Format Category Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Category": {
      "main": [
        [
          {
            "node": "Format Category Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Category Response": {
      "main": [
        [
          {
            "node": "Respond Categories",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debts Webhook": {
      "main": [
        [
          {
            "node": "Route Debt Action",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route Debt Action": {
      "main": [
        [
          {
            "node": "Get Debts",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Add Debt",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Pay Debt",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Settle Debt",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Delete Debt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Debts": {
      "main": [
        [
          {
            "node": "Format Debt Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add Debt": {
      "main": [
        [
          {
            "node": "Format Debt Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pay Debt": {
      "main": [
        [
          {
            "node": "Format Debt Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Settle Debt": {
      "main": [
        [
          {
            "node": "Format Debt Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Debt": {
      "main": [
        [
          {
            "node": "Format Debt Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Debt Response": {
      "main": [
        [
          {
            "node": "Respond Debts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Recurring Webhook": {
      "main": [
        [
          {
            "node": "Route Recurring Action",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route Recurring Action": {
      "main": [
        [
          {
            "node": "Get Recurring",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Add Recurring",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Pay Recurring",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Pause Recurring",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Delete Recurring",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Recurring": {
      "main": [
        [
          {
            "node": "Format Recurring Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add Recurring": {
      "main": [
        [
          {
            "node": "Format Recurring Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pay Recurring": {
      "main": [
        [
          {
            "node": "Format Recurring Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pause Recurring": {
      "main": [
        [
          {
            "node": "Format Recurring Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Recurring": {
      "main": [
        [
          {
            "node": "Format Recurring Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Recurring Response": {
      "main": [
        [
          {
            "node": "Respond Recurring",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Settings Webhook": {
      "main": [
        [
          {
            "node": "Route Settings Action",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route Settings Action": {
      "main": [
        [
          {
            "node": "Get Settings",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Mode",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Currency",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Budget",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Settings": {
      "main": [
        [
          {
            "node": "Format Settings Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Mode": {
      "main": [
        [
          {
            "node": "Format Settings Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Currency": {
      "main": [
        [
          {
            "node": "Format Settings Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Budget": {
      "main": [
        [
          {
            "node": "Format Settings Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Settings Response": {
      "main": [
        [
          {
            "node": "Respond Settings",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Budget Webhook": {
      "main": [
        [
          {
            "node": "Route Budget Action",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route Budget Action": {
      "main": [
        [
          {
            "node": "Get Budget",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Budget New",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Budget": {
      "main": [
        [
          {
            "node": "Format Budget Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Budget New": {
      "main": [
        [
          {
            "node": "Format Budget Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Budget Response": {
      "main": [
        [
          {
            "node": "Respond Budget",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Goals Webhook": {
      "main": [
        [
          {
            "node": "Route Goal Action",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route Goal Action": {
      "main": [
        [
          {
            "node": "Get Goals",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Add Goal",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Deposit Goal",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Withdraw Goal",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Complete Goal",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Delete Goal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Goals": {
      "main": [
        [
          {
            "node": "Format Goal Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add Goal": {
      "main": [
        [
          {
            "node": "Format Goal Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Deposit Goal": {
      "main": [
        [
          {
            "node": "Format Goal Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Withdraw Goal": {
      "main": [
        [
          {
            "node": "Format Goal Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Complete Goal": {
      "main": [
        [
          {
            "node": "Format Goal Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Goal": {
      "main": [
        [
          {
            "node": "Format Goal Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Goal Response": {
      "main": [
        [
          {
            "node": "Respond Goals",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GPT": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {
    "Telegram Trigger": [
      {
        "update_id": 723421094,
        "message": {
          "message_id": 1401,
          "from": {
            "id": 1109421300,
            "is_bot": false,
            "first_name": "–ß—ã–Ω–≥—ã–∑",
            "last_name": "–ë–µ—Ä–¥–∏–±–∞–µ–≤",
            "username": "hi9ne",
            "language_code": "ru"
          },
          "chat": {
            "id": 1109421300,
            "first_name": "–ß—ã–Ω–≥—ã–∑",
            "last_name": "–ë–µ—Ä–¥–∏–±–∞–µ–≤",
            "username": "hi9ne",
            "type": "private"
          },
          "date": 1767127506,
          "text": "–æ—Ç—á—ë—Ç –∑–∞ –Ω–µ–¥–µ–ª—é"
        }
      }
    ]
  },
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "1fe4e639ffc46975e8f90de7e16a7bfebd538687c60791a8ceecf7b15dc9fb18"
  }
}