{
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 9 * * *"
            }
          ]
        }
      },
      "name": "Schedule: Daily 09:00",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        -896,
        168
      ],
      "id": "deb748c2-1431-4e74-b715-6f58cd3d99d1"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  rp.id as recurring_id,\n  rp.user_id,\n  rp.name as title,\n  rp.amount,\n  rp.currency,\n  rp.category,\n  rp.next_payment_date,\n  rp.next_payment_date - CURRENT_DATE as days_until_payment,\n  COALESCE(rp.reminder_days_before, 3) as reminder_days,\n  false as auto_create\nFROM recurring_payments rp\nWHERE rp.is_active = true\n  AND rp.next_payment_date - CURRENT_DATE <= COALESCE(rp.reminder_days_before, 3)\n  AND rp.next_payment_date >= CURRENT_DATE\n  AND (rp.last_reminded_at IS NULL \n       OR DATE(rp.last_reminded_at AT TIME ZONE 'Asia/Bishkek') < CURRENT_DATE)\nORDER BY rp.next_payment_date;",
        "options": {}
      },
      "name": "Get Pending Reminders",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -672,
        168
      ],
      "id": "e84c2aa8-9b9e-452a-a629-4ac4a292a21a",
      "credentials": {
        "postgres": {
          "id": "5T19Mbva6dh2EvkZ",
          "name": "Chyngyz account 2"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.length }}",
              "operation": "larger"
            }
          ]
        }
      },
      "name": "Ð•ÑÑ‚ÑŒ Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -448,
        168
      ],
      "id": "de92616f-5cbb-4514-952d-faa155ec895f"
    },
    {
      "parameters": {
        "options": {}
      },
      "name": "Split In Batches",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -224,
        72
      ],
      "id": "8e640759-6f22-45e6-a6a9-3a29bba921c0"
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first().json;\n\n// Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ\nconst daysUntil = item.days_until_payment;\nconst amount = parseFloat(item.amount).toLocaleString('ru-RU');\nconst currency = item.currency;\n\n// Ð˜ÐºÐ¾Ð½ÐºÐ¸ Ð²Ð°Ð»ÑŽÑ‚\nconst currencySymbols = {\n  'KGS': 'Ñ',\n  'USD': '$',\n  'EUR': 'â‚¬',\n  'RUB': 'â‚½'\n};\n\nconst symbol = currencySymbols[currency] || currency;\n\n// Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ‚ÐµÐºÑÑ‚Ð° Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ð´Ð½ÐµÐ¹\nlet dateText;\nlet urgencyIcon;\nif (daysUntil === 0) {\n  dateText = 'Ð¡Ð•Ð“ÐžÐ”ÐÐ¯';\n  urgencyIcon = 'ðŸš¨';\n} else if (daysUntil === 1) {\n  dateText = 'Ð—ÐÐ’Ð¢Ð Ð';\n  urgencyIcon = 'âš ï¸';\n} else {\n  dateText = `Ñ‡ÐµÑ€ÐµÐ· ${daysUntil} Ð´Ð½.`;\n  urgencyIcon = 'ðŸ””';\n}\n\nconst message = `${urgencyIcon} ÐÐ°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ðµ Ð¾ Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ðµ\\n\\n` +\n  `ðŸ’° ${item.title}\\n` +\n  `ðŸ’µ Ð¡ÑƒÐ¼Ð¼Ð°: ${amount} ${symbol}\\n` +\n  `ðŸ“‚ ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ: ${item.category}\\n` +\n  `ðŸ“… ÐžÐ¿Ð»Ð°Ñ‚Ð¸Ñ‚ÑŒ: ${dateText}\\n\\n` +\n  (item.auto_create ? 'âš¡ ÐÐ²Ñ‚Ð¾Ð¿Ð»Ð°Ñ‚ÐµÐ¶ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½\\n\\n' : '') +\n  `ID Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸: #${item.recurring_id}`;\n\nreturn {\n  json: {\n    user_id: item.user_id,\n    recurring_id: item.recurring_id,\n    message: message,\n    days_until: daysUntil\n  }\n};"
      },
      "name": "Format Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        0
      ],
      "id": "34d36042-7518-4cd1-bc16-60c56834ec4f"
    },
    {
      "parameters": {
        "chatId": "={{ $json.user_id }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "HTML"
        }
      },
      "name": "Send Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [
        224,
        0
      ],
      "id": "ece4989d-5d4f-4f09-b6a9-6ec12d062c05",
      "webhookId": "7f42e3f5-175a-4a1b-9638-4bdde53e0093",
      "credentials": {
        "telegramApi": {
          "id": "VsCo0z8ZzisDZOpw",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE recurring_payments SET last_reminded_at = NOW() WHERE id = {{ $json.recurring_id }};",
        "options": {}
      },
      "name": "Mark Sent",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        448,
        72
      ],
      "id": "1ba43863-555f-495c-89c8-035dba7baf55",
      "credentials": {
        "postgres": {
          "id": "5T19Mbva6dh2EvkZ",
          "name": "Chyngyz account 2"
        }
      }
    },
    {
      "parameters": {},
      "name": "No Data",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -224,
        312
      ],
      "id": "26cccce4-546d-4a55-84ad-735f519a6d56",
      "notes": "ÐÐµÑ‚ Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ð¹ Ð½Ð° ÑÐµÐ³Ð¾Ð´Ð½Ñ"
    },
    {
      "parameters": {
        "jsCode": "// Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ\nconst items = $input.all();\nconst totalSent = items.length;\n\nconst summary = `âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° recurring payments Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°\\n\\n` +\n  `ðŸ“Š ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ð¹: ${totalSent}\\n` +\n  `â° Ð’Ñ€ÐµÐ¼Ñ: ${new Date().toLocaleString('ru-RU', { timeZone: 'Asia/Bishkek' })}`;\n\nreturn {\n  json: {\n    total_sent: totalSent,\n    timestamp: new Date().toISOString(),\n    summary: summary\n  }\n};"
      },
      "name": "Summary",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        312
      ],
      "id": "9a156402-ac88-4284-81ec-cec3200835e7"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO notifications (user_id, type, title, message, is_read, created_at)\nVALUES (\n  1109421300,\n  'system',\n  'Recurring Payments Check',\n  '{{ $json.summary }}',\n  false,\n  NOW()\n);",
        "options": {}
      },
      "name": "Log to DB",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        224,
        312
      ],
      "id": "07c82ad7-95d0-436f-84ed-8a52a4e2f196",
      "credentials": {
        "postgres": {
          "id": "5T19Mbva6dh2EvkZ",
          "name": "Chyngyz account 2"
        }
      },
      "notes": "Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð´Ð»Ñ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°"
    }
  ],
  "connections": {
    "Schedule: Daily 09:00": {
      "main": [
        [
          {
            "node": "Get Pending Reminders",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Pending Reminders": {
      "main": [
        [
          {
            "node": "Ð•ÑÑ‚ÑŒ Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ð•ÑÑ‚ÑŒ Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ?": {
      "main": [
        [
          {
            "node": "Split In Batches",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split In Batches": {
      "main": [
        [
          {
            "node": "Format Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Message": {
      "main": [
        [
          {
            "node": "Send Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Telegram": {
      "main": [
        [
          {
            "node": "Mark Sent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark Sent": {
      "main": [
        [
          {
            "node": "Split In Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No Data": {
      "main": [
        [
          {
            "node": "Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Summary": {
      "main": [
        [
          {
            "node": "Log to DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "3bd415084c202701a4e18d9b066a68ad477720c950e1c2cba4cb2537b78acc07"
  }
}