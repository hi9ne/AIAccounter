{
  "name": "Budget Notifications",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 10,18 * * *"
            }
          ]
        }
      },
      "name": "Schedule: 10:00 & 18:00",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        -896,
        168
      ],
      "id": "budget-schedule-001"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH current_month AS (\n  SELECT TO_CHAR(CURRENT_DATE AT TIME ZONE 'Asia/Bishkek', 'YYYY-MM') as month\n),\nbudget_status AS (\n  SELECT \n    b.user_id,\n    b.budget_amount,\n    b.currency,\n    b.month,\n    COALESCE(SUM(e.amount), 0) as total_spent,\n    ROUND((COALESCE(SUM(e.amount), 0) / b.budget_amount * 100)::numeric, 1) as percent_used,\n    b.budget_amount - COALESCE(SUM(e.amount), 0) as remaining\n  FROM budgets b\n  CROSS JOIN current_month cm\n  LEFT JOIN expenses e ON e.user_id = b.user_id \n    AND e.deleted_at IS NULL\n    AND TO_CHAR(e.date AT TIME ZONE 'Asia/Bishkek', 'YYYY-MM') = cm.month\n  WHERE b.month = cm.month\n  GROUP BY b.user_id, b.budget_amount, b.currency, b.month\n),\nuser_notifications AS (\n  SELECT \n    bs.*,\n    u.first_name,\n    up.budget_alert_80_sent,\n    up.budget_alert_100_sent,\n    CASE \n      WHEN bs.percent_used >= 100 AND (up.budget_alert_100_sent IS NULL OR up.budget_alert_100_sent < DATE_TRUNC('month', CURRENT_DATE)) THEN 'exceeded'\n      WHEN bs.percent_used >= 80 AND bs.percent_used < 100 AND (up.budget_alert_80_sent IS NULL OR up.budget_alert_80_sent < DATE_TRUNC('month', CURRENT_DATE)) THEN 'warning'\n      ELSE NULL\n    END as alert_type\n  FROM budget_status bs\n  JOIN users u ON u.user_id = bs.user_id\n  LEFT JOIN user_preferences up ON up.user_id = bs.user_id\n)\nSELECT *\nFROM user_notifications\nWHERE alert_type IS NOT NULL;",
        "options": {}
      },
      "name": "Get Budget Alerts",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -672,
        168
      ],
      "id": "budget-get-alerts-001",
      "credentials": {
        "postgres": {
          "id": "5T19Mbva6dh2EvkZ",
          "name": "Chyngyz account 2"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check-has-alerts",
              "leftValue": "={{ $json.length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "name": "Ð•ÑÑ‚ÑŒ Ð°Ð»ÐµÑ€Ñ‚Ñ‹?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -448,
        168
      ],
      "id": "budget-if-alerts-001"
    },
    {
      "parameters": {
        "options": {}
      },
      "name": "Split In Batches",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -224,
        72
      ],
      "id": "budget-split-001"
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first().json;\n\nconst amount = parseFloat(item.budget_amount).toLocaleString('ru-RU');\nconst spent = parseFloat(item.total_spent).toLocaleString('ru-RU');\nconst remaining = parseFloat(item.remaining).toLocaleString('ru-RU');\nconst percent = item.percent_used;\nconst currency = item.currency;\nconst firstName = item.first_name || 'Ð”Ñ€ÑƒÐ³';\n\n// ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ñ Ð¼ÐµÑÑÑ†ÐµÐ²\nconst monthNames = {\n  '01': 'ÑÐ½Ð²Ð°Ñ€ÑŒ', '02': 'Ñ„ÐµÐ²Ñ€Ð°Ð»ÑŒ', '03': 'Ð¼Ð°Ñ€Ñ‚', '04': 'Ð°Ð¿Ñ€ÐµÐ»ÑŒ',\n  '05': 'Ð¼Ð°Ð¹', '06': 'Ð¸ÑŽÐ½ÑŒ', '07': 'Ð¸ÑŽÐ»ÑŒ', '08': 'Ð°Ð²Ð³ÑƒÑÑ‚',\n  '09': 'ÑÐµÐ½Ñ‚ÑÐ±Ñ€ÑŒ', '10': 'Ð¾ÐºÑ‚ÑÐ±Ñ€ÑŒ', '11': 'Ð½Ð¾ÑÐ±Ñ€ÑŒ', '12': 'Ð´ÐµÐºÐ°Ð±Ñ€ÑŒ'\n};\nconst monthNum = item.month.split('-')[1];\nconst monthName = monthNames[monthNum] || item.month;\n\nlet message;\nlet alertType = item.alert_type;\n\nif (alertType === 'exceeded') {\n  const overSpent = Math.abs(parseFloat(item.remaining)).toLocaleString('ru-RU');\n  message = `ðŸš¨ ${firstName}, Ð±ÑŽÐ´Ð¶ÐµÑ‚ Ð¿Ñ€ÐµÐ²Ñ‹ÑˆÐµÐ½!\\n\\n` +\n    `ðŸ“… ${monthName}\\n` +\n    `ðŸ’° Ð›Ð¸Ð¼Ð¸Ñ‚: ${amount} ${currency}\\n` +\n    `ðŸ’¸ ÐŸÐ¾Ñ‚Ñ€Ð°Ñ‡ÐµÐ½Ð¾: ${spent} ${currency} (${percent}%)\\n` +\n    `âŒ ÐŸÐµÑ€ÐµÑ€Ð°ÑÑ…Ð¾Ð´: ${overSpent} ${currency}\\n\\n` +\n    `ðŸ’¡ Ð¡Ð¾Ð²ÐµÑ‚: Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ ÑÐ¾ÐºÑ€Ð°Ñ‚Ð¸Ñ‚ÑŒ Ñ€Ð°ÑÑ…Ð¾Ð´Ñ‹ Ð¸Ð»Ð¸ ÑƒÐ²ÐµÐ»Ð¸Ñ‡ÑŒ Ð±ÑŽÐ´Ð¶ÐµÑ‚ Ð² Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¸`;\n} else if (alertType === 'warning') {\n  message = `âš ï¸ ${firstName}, Ð±ÑŽÐ´Ð¶ÐµÑ‚ Ð¿Ð¾Ñ‡Ñ‚Ð¸ Ð¸ÑÑ‡ÐµÑ€Ð¿Ð°Ð½!\\n\\n` +\n    `ðŸ“… ${monthName}\\n` +\n    `ðŸ’° Ð›Ð¸Ð¼Ð¸Ñ‚: ${amount} ${currency}\\n` +\n    `ðŸ’¸ ÐŸÐ¾Ñ‚Ñ€Ð°Ñ‡ÐµÐ½Ð¾: ${spent} ${currency} (${percent}%)\\n` +\n    `âœ… ÐžÑÑ‚Ð°Ð»Ð¾ÑÑŒ: ${remaining} ${currency}\\n\\n` +\n    `ðŸ’¡ Ð‘ÑƒÐ´ÑŒ Ð²Ð½Ð¸Ð¼Ð°Ñ‚ÐµÐ»ÑŒÐ½ÐµÐµ Ñ Ñ€Ð°ÑÑ…Ð¾Ð´Ð°Ð¼Ð¸ Ð´Ð¾ ÐºÐ¾Ð½Ñ†Ð° Ð¼ÐµÑÑÑ†Ð°!`;\n}\n\nreturn {\n  json: {\n    user_id: item.user_id,\n    message: message,\n    alert_type: alertType,\n    percent_used: percent\n  }\n};"
      },
      "name": "Format Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        0
      ],
      "id": "budget-format-001"
    },
    {
      "parameters": {
        "chatId": "={{ $json.user_id }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "HTML"
        }
      },
      "name": "Send Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [
        224,
        0
      ],
      "id": "budget-telegram-001",
      "credentials": {
        "telegramApi": {
          "id": "VsCo0z8ZzisDZOpw",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.alert_type === 'exceeded' ? \n  `UPDATE user_preferences SET budget_alert_100_sent = NOW() WHERE user_id = ${$json.user_id}; INSERT INTO user_preferences (user_id, budget_alert_100_sent) SELECT ${$json.user_id}, NOW() WHERE NOT EXISTS (SELECT 1 FROM user_preferences WHERE user_id = ${$json.user_id});` :\n  `UPDATE user_preferences SET budget_alert_80_sent = NOW() WHERE user_id = ${$json.user_id}; INSERT INTO user_preferences (user_id, budget_alert_80_sent) SELECT ${$json.user_id}, NOW() WHERE NOT EXISTS (SELECT 1 FROM user_preferences WHERE user_id = ${$json.user_id});`\n}}",
        "options": {}
      },
      "name": "Mark Alert Sent",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        448,
        72
      ],
      "id": "budget-mark-sent-001",
      "credentials": {
        "postgres": {
          "id": "5T19Mbva6dh2EvkZ",
          "name": "Chyngyz account 2"
        }
      }
    },
    {
      "parameters": {},
      "name": "No Alerts",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -224,
        312
      ],
      "id": "budget-no-alerts-001",
      "notes": "ÐÐµÑ‚ Ð°Ð»ÐµÑ€Ñ‚Ð¾Ð² Ð¾ Ð±ÑŽÐ´Ð¶ÐµÑ‚Ðµ"
    },
    {
      "parameters": {
        "jsCode": "// Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ\nconst items = $input.all();\nconst totalSent = items.length;\n\nconst summary = `âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð±ÑŽÐ´Ð¶ÐµÑ‚Ð¾Ð² Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°\\n\\n` +\n  `ðŸ“Š ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ Ð°Ð»ÐµÑ€Ñ‚Ð¾Ð²: ${totalSent}\\n` +\n  `â° Ð’Ñ€ÐµÐ¼Ñ: ${new Date().toLocaleString('ru-RU', { timeZone: 'Asia/Bishkek' })}`;\n\nreturn {\n  json: {\n    total_sent: totalSent,\n    timestamp: new Date().toISOString(),\n    summary: summary\n  }\n};"
      },
      "name": "Summary",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        312
      ],
      "id": "budget-summary-001"
    }
  ],
  "connections": {
    "Schedule: 10:00 & 18:00": {
      "main": [
        [
          {
            "node": "Get Budget Alerts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Budget Alerts": {
      "main": [
        [
          {
            "node": "Ð•ÑÑ‚ÑŒ Ð°Ð»ÐµÑ€Ñ‚Ñ‹?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ð•ÑÑ‚ÑŒ Ð°Ð»ÐµÑ€Ñ‚Ñ‹?": {
      "main": [
        [
          {
            "node": "Split In Batches",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Alerts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split In Batches": {
      "main": [
        [
          {
            "node": "Format Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Message": {
      "main": [
        [
          {
            "node": "Send Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Telegram": {
      "main": [
        [
          {
            "node": "Mark Alert Sent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark Alert Sent": {
      "main": [
        [
          {
            "node": "Split In Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No Alerts": {
      "main": [
        [
          {
            "node": "Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "3bd415084c202701a4e18d9b066a68ad477720c950e1c2cba4cb2537b78acc07"
  }
}
