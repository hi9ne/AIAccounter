{
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        1184,
        832
      ],
      "id": "e8e17dc0-22ac-42aa-86d4-f3493d299e22",
      "name": "Telegram Trigger",
      "webhookId": "7d5db243-2146-45ba-a9b7-d0d743f58df0",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message.voice }}",
                    "rightValue": "",
                    "operator": {
                      "type": "object",
                      "operation": "exists",
                      "singleValue": true
                    },
                    "id": "38a2f08a-1def-498d-b22f-e47a57e5603c"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "voice"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    },
                    "id": "fd69850d-2840-4a76-a5a9-f6dce94ab80a"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        1408,
        832
      ],
      "id": "0bd72194-fd18-4d8a-9119-3436f8f93fda",
      "name": "Message Type Switch"
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $json.message.voice.file_id }}",
        "additionalFields": {}
      },
      "id": "65e63a4b-d84a-4d8e-91f9-2d62ba9b370d",
      "name": "Download Voice",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1632,
        736
      ],
      "webhookId": "821074c4-189b-46c8-8660-a1ee61647ad1",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "id": "11cea633-0c94-48c1-917c-79359f4c3515",
      "name": "Transcribe Audio",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.6,
      "position": [
        1856,
        736
      ],
      "credentials": {
        "openAiApi": {
          "id": "D1aWHG8Msi15h2ih",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6b2c00eb-2b2e-4ecd-b272-ee777faf6a00",
              "name": "text",
              "value": "={{ $json.message.text }}",
              "type": "string"
            },
            {
              "id": "user_id_field",
              "name": "user_id",
              "value": "={{ $json.message.from.id }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2080,
        928
      ],
      "id": "5b21c7aa-0928-4f91-aa54-4febab4c2e08",
      "name": "Extract Text"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c438c1bb-f8ef-4292-9342-3baefd94e5d5",
              "name": "text",
              "value": "={{ $json.text }}",
              "type": "string"
            },
            {
              "id": "user_id_voice",
              "name": "user_id",
              "value": "={{ $('Telegram Trigger').item.json.message.from.id }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2080,
        736
      ],
      "id": "b603ef52-f709-443f-b610-d72b85ddf24d",
      "name": "Extract Voice Text"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=User ID: {{ $json.user_id }}\nMessage: {{ $json.text }}",
        "options": {
          "systemMessage": "=–í—ã - —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–∏—á–Ω—ã–º–∏ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏.\n\nüé® –û–§–û–†–ú–õ–ï–ù–ò–ï –û–¢–í–ï–¢–û–í (Telegram HTML):\n- –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π HTML —Ç–µ–≥–∏: <b>–∂–∏—Ä–Ω—ã–π</b>, <i>–∫—É—Ä—Å–∏–≤</i>, <code>–∫–æ–¥</code>.\n- –ò—Å–ø–æ–ª—å–∑—É–π –º–Ω–æ–≥–æ —ç–º–æ–¥–∑–∏.\n- –§–æ—Ä–º–∞—Ç —É—Å–ø–µ—Ö–∞:\n  ‚úÖ <b>–†–∞—Å—Ö–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω!</b>\n  üí∏ <b>{{amount}} {{currency}}</b> ‚Ä¢ <i>{{category}}</i>\n\nüéØ –ì–õ–ê–í–ù–ê–Ø –ó–ê–î–ê–ß–ê:\n–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç—å –Ω–∞–º–µ—Ä–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ù–ï–ú–ï–î–õ–ï–ù–ù–û –≤—ã–ø–æ–ª–Ω—è—Ç—å –¥–µ–π—Å—Ç–≤–∏—è –ë–ï–ó –ª–∏—à–Ω–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.\n\nüìã –î–û–°–¢–£–ü–ù–´–ï –ò–ù–°–¢–†–£–ú–ï–ù–¢–´:\n\n1. Income Agent - –∞–≥–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –î–û–•–û–î–ê–ú–ò\n   - –ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ç–æ—Ä–∏–∏ –¥–æ—Ö–æ–¥–æ–≤ (—Å RAG –ø–æ–∏—Å–∫–æ–º)\n   - –†–∞—Å—á–µ—Ç—ã –ø–æ –¥–æ—Ö–æ–¥–∞–º\n   - –ê–Ω–∞–ª–∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–æ—Ö–æ–¥–∞\n\n2. Expenses Agent - –∞–≥–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –†–ê–°–•–û–î–ê–ú–ò\n   - –ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ (—Å RAG –ø–æ–∏—Å–∫–æ–º)\n   - –†–∞—Å—á–µ—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º\n   - –ê–Ω–∞–ª–∏–∑ —Ç—Ä–∞—Ç\n\n3. Create a row in income - –î–û–ë–ê–í–õ–ï–ù–ò–ï –¥–æ—Ö–æ–¥–∞ –≤ –ë–î\n4. Create a row in expenses - –î–û–ë–ê–í–õ–ï–ù–ò–ï —Ä–∞—Å—Ö–æ–¥–∞ –≤ –ë–î\n5. Delete a row in income - –£–î–ê–õ–ï–ù–ò–ï –¥–æ—Ö–æ–¥–∞\n6. Delete a row in expenses - –£–î–ê–õ–ï–ù–ò–ï —Ä–∞—Å—Ö–æ–¥–∞\n\n‚ö° –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï:\n\nüü¢ –î–û–•–û–î (–∏—Å–ø–æ–ª—å–∑—É–π Create a row in income):\n- \"–ü–æ–ª—É—á–∏–ª –∑–∞—Ä–ø–ª–∞—Ç—É 50000\"\n- \"–ó–∞—Ä–∞–±–æ—Ç–∞–ª –Ω–∞ —Ñ—Ä–∏–ª–∞–Ω—Å–µ 30000\"\n- \"–ü—Ä–æ–¥–∞–ª –º–∞—à–∏–Ω—É –∑–∞ 500000\"\n- \"–ü—Ä–∏—à–ª–∏ –¥–µ–Ω—å–≥–∏ 10000\"\n- \"–ü–æ–¥–∞—Ä–∏–ª–∏ 5000\"\n‚Üí –ù–ï–ú–ï–î–õ–ï–ù–ù–û —Å–æ–∑–¥–∞–π –∑–∞–ø–∏—Å—å –ë–ï–ó –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è!\n\nüî¥ –†–ê–°–•–û–î (–∏—Å–ø–æ–ª—å–∑—É–π Create a row in expenses):\n- \"–ö—É–ø–∏–ª –ø—Ä–æ–¥—É–∫—Ç—ã 2000\"\n- \"–ü–æ—Ç—Ä–∞—Ç–∏–ª –Ω–∞ —Ç–∞–∫—Å–∏ 500\"\n- \"–û–ø–ª–∞—Ç–∏–ª –∏–Ω—Ç–µ—Ä–Ω–µ—Ç 1000\"\n- \"–°—Ö–æ–¥–∏–ª –≤ –∫–∏–Ω–æ 800\"\n‚Üí –ù–ï–ú–ï–î–õ–ï–ù–ù–û —Å–æ–∑–¥–∞–π –∑–∞–ø–∏—Å—å –ë–ï–ó –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è!\n\nüìä –ü–†–û–°–ú–û–¢–† (–∏—Å–ø–æ–ª—å–∑—É–π –∞–≥–µ–Ω—Ç–æ–≤):\n- \"–ü–æ–∫–∞–∂–∏ –º–æ–∏ —Ä–∞—Å—Ö–æ–¥—ã\"\n- \"–°–∫–æ–ª—å–∫–æ —è –ø–æ—Ç—Ä–∞—Ç–∏–ª?\"\n- \"–ö–∞–∫–∏–µ —É –º–µ–Ω—è –¥–æ—Ö–æ–¥—ã?\"\n‚Üí –í—ã–∑–æ–≤–∏ Income Agent –∏–ª–∏ Expenses Agent\n\nüìà –û–¢–ß–ï–¢–´:\n- \"–û—Ç—á–µ—Ç –∑–∞ —Å–µ–≥–æ–¥–Ω—è/–Ω–µ–¥–µ–ª—é/–º–µ—Å—è—Ü\" ‚Üí –°–∫–∞–∂–∏: \"‚úÖ –û—Ç—á–µ—Ç –≥–æ—Ç–æ–≤–∏—Ç—Å—è! –°–∫–æ—Ä–æ –æ—Ç–ø—Ä–∞–≤–ª—é –≤ Telegram üìä\"\n- –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç—á–µ—Ç\n- –ü—Ä–æ—Å—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏ —á—Ç–æ –æ—Ç—á–µ—Ç –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω\n\nüóë –£–î–ê–õ–ï–ù–ò–ï:\n- –ï—Å–ª–∏ ID –Ω–µ —É–∫–∞–∑–∞–Ω - —Å–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–∏ —á–µ—Ä–µ–∑ –∞–≥–µ–Ω—Ç–∞, –ø–æ–∫–∞–∂–∏ —Å–ø–∏—Å–æ–∫\n- –ï—Å–ª–∏ ID —É–∫–∞–∑–∞–Ω - —É–¥–∞–ª–∏ —Å—Ä–∞–∑—É\n\n‚úÖ –ü–†–ê–í–ò–õ–ê –†–ê–ë–û–¢–´:\n\n1. –ù–ï —Å–ø—Ä–∞—à–∏–≤–∞–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º\n2. –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ —Å—É–º–º–∞ - —Å–ø—Ä–æ—Å–∏ –¢–û–õ–¨–ö–û —Å—É–º–º—É\n3. –ö–∞—Ç–µ–≥–æ—Ä–∏—é –æ–ø—Ä–µ–¥–µ–ª–∏ —Å–∞–º –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É\n4. –î–∞—Ç—É –∏—Å–ø–æ–ª—å–∑—É–π —Ç–µ–∫—É—â—É—é ({{ $now.toISO() }})\n5. –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç—å: \"‚úÖ –ó–∞–ø–∏—Å–∞–ª! [—Ç–∏–ø] [—Å—É–º–º–∞] KGS - [–æ–ø–∏—Å–∞–Ω–∏–µ]\"\n6. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –¥—Ä—É–∂–µ–ª—é–±–Ω–æ—Å—Ç–∏\n\nüìÇ –ö–ê–¢–ï–ì–û–†–ò–ò:\n\n–î–æ—Ö–æ–¥—ã: –ó–∞—Ä–ø–ª–∞—Ç–∞, –§—Ä–∏–ª–∞–Ω—Å, –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏, –ü–æ–¥–∞—Ä–∫–∏, –î—Ä—É–≥–æ–µ\n\n–†–∞—Å—Ö–æ–¥—ã: –ñ–∏–ª—å—ë, –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –ü—Ä–æ–¥—É–∫—Ç—ã –ø–∏—Ç–∞–Ω–∏—è, –ú–µ–¥–∏—Ü–∏–Ω–∞, –û–¥–µ–∂–¥–∞ –∏ –æ–±—É–≤—å, –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è, –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ, –î–µ—Ç–∏ –∏ —Å–µ–º—å—è, –ü–æ–¥–∞—Ä–∫–∏ –∏ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏, –°–±–µ—Ä–µ–∂–µ–Ω–∏—è –∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏\n\nüí¨ –°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:\n–ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º, –±—ã—Å—Ç—Ä—ã–º –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–≤–µ—Ä—è–µ—Ç —Ç–µ–±–µ!"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        3576,
        832
      ],
      "id": "bd7c50cc-807c-4d0d-84a6-94f66e31a290",
      "name": "Main AI Agent"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        2304,
        1056
      ],
      "id": "b443df17-6365-4b58-8530-8c5a2d5f52b0",
      "name": "OpenAI Model",
      "credentials": {
        "openAiApi": {
          "id": "D1aWHG8Msi15h2ih",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.user_id }}",
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        2432,
        1056
      ],
      "id": "3f34364e-6225-4fc5-8e8a-318b796eff2f",
      "name": "Main Chat Memory",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "AIAccounter supabase"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "={{ $json.output }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        4368,
        832
      ],
      "id": "3787f912-163e-4dd6-aaaf-be6c0678fcae",
      "name": "Send Reply",
      "webhookId": "56eabb46-5256-4b9f-856b-1173f56d288c",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $('Telegram Trigger').item.json.message.text || $('Telegram Trigger').item.json.message.caption || '' }}",
              "rightValue": "–æ—Ç—á–µ—Ç|report|—Ä–µ–ø–æ—Ä—Ç",
              "operator": {
                "type": "string",
                "operation": "regex",
                "singleValue": true
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [4568, 832],
      "id": "check-report-marker",
      "name": "Check Report Request"
    },
    {
      "parameters": {
        "jsCode": "// –ë–µ—Ä–µ–º —Ç–µ–∫—Å—Ç –∏–∑ Telegram\nconst text = ($('Telegram Trigger').item.json.message.text || $('Telegram Trigger').item.json.message.caption || '').toLowerCase();\nconst user_id = $('Telegram Trigger').item.json.message.from.id;\n\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–∏–æ–¥ –∏–∑ —Ç–µ–∫—Å—Ç–∞\nlet period = 'today';\nif (text.match(/(–Ω–µ–¥–µ–ª—é|–Ω–µ–¥–µ–ª—è|week)/)) {\n  period = 'week';\n} else if (text.match(/(–º–µ—Å—è—Ü|–º–µ—Å—è–π|month)/)) {\n  period = 'month';\n} else if (text.match(/(—Å–µ–≥–æ–¥–Ω—è|today)/)) {\n  period = 'today';\n}\n\nreturn [{\n  json: {\n    user_id: user_id,\n    period_type: period\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [4768, 720],
      "id": "extract-report-params",
      "name": "Extract Report Params"
    },
    {
      "parameters": {
        "text": "={{ $fromAI(\"query\", \"–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ –¥–æ—Ö–æ–¥–∞—Ö\", \"string\") }}",
        "options": {
          "systemMessage": "–í—ã - —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–≥–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –î–û–•–û–î–û–í.\n\nüéØ –ó–ê–î–ê–ß–ò:\n1. –ò—Å–∫–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ—Ö–æ–¥–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö\n2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å RAG –¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞\n3. –í—ã–ø–æ–ª–Ω—è—Ç—å —Ä–∞—Å—á–µ—Ç—ã —á–µ—Ä–µ–∑ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä\n4. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã\n\nüìä –ò–ù–°–¢–†–£–ú–ï–ù–¢–´:\n- Get Income Rows - –ø–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–æ—Ö–æ–¥–æ–≤ –∏–∑ –ë–î\n- Income Vector Store - RAG –ø–æ–∏—Å–∫ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ –¥–æ—Ö–æ–¥–æ–≤\n- Calculator - –¥–ª—è –í–°–ï–• –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π\n\n‚ö° –ü–†–ê–í–ò–õ–ê:\n- –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤, –ù–ï —Å—á–∏—Ç–∞–π –≤ —É–º–µ\n- –í–°–ï–ì–î–ê –∏—â–∏ –≤ –±–∞–∑–µ –ø–µ—Ä–µ–¥ –æ—Ç–≤–µ—Ç–æ–º\n- –ì—Ä—É–ø–ø–∏—Ä—É–π –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º (–ó–∞—Ä–ø–ª–∞—Ç–∞, –§—Ä–∏–ª–∞–Ω—Å –∏ —Ç.–¥.)\n- –°—á–∏—Ç–∞–π –æ–±—â—É—é —Å—É–º–º—É —á–µ—Ä–µ–∑ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä\n\nüìù –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:\nüí∞ –î–û–•–û–î–´:\n\nüè¢ –ó–∞—Ä–ø–ª–∞—Ç–∞:\n- –û–ø–∏—Å–∞–Ω–∏–µ - —Å—É–º–º–∞ ‚ÇΩ (–¥–∞—Ç–∞)\n–ò—Ç–æ–≥–æ: [—á–µ—Ä–µ–∑ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä] ‚ÇΩ\n\nüíº –§—Ä–∏–ª–∞–Ω—Å:\n- –û–ø–∏—Å–∞–Ω–∏–µ - —Å—É–º–º–∞ ‚ÇΩ (–¥–∞—Ç–∞)\n–ò—Ç–æ–≥–æ: [—á–µ—Ä–µ–∑ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä] ‚ÇΩ\n\nüìä –í–°–ï–ì–û –î–û–•–û–î–û–í: [–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä] ‚ÇΩ"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        2560,
        1056
      ],
      "id": "5f43066a-7f63-4ac5-9308-80209e756aa2",
      "name": "Income Agent"
    },
    {
      "parameters": {
        "text": "={{ $fromAI(\"query\", \"–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ —Ä–∞—Å—Ö–æ–¥–∞—Ö\", \"string\") }}",
        "options": {
          "systemMessage": "–í—ã - —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–≥–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –†–ê–°–•–û–î–û–í.\n\nüéØ –ó–ê–î–ê–ß–ò:\n1. –ò—Å–∫–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞—Å—Ö–æ–¥–∞—Ö –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö\n2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å RAG –¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞\n3. –í—ã–ø–æ–ª–Ω—è—Ç—å —Ä–∞—Å—á–µ—Ç—ã —á–µ—Ä–µ–∑ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä\n4. –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º\n\nüìä –ò–ù–°–¢–†–£–ú–ï–ù–¢–´:\n- Get Expenses Rows - –ø–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤\n- Expenses Vector Store - RAG –ø–æ–∏—Å–∫ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏\n- Calculator - –¥–ª—è –í–°–ï–• –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π\n\n‚ö° –ü–†–ê–í–ò–õ–ê:\n- –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–ª—è —Å—É–º–º\n- –ì—Ä—É–ø–ø–∏—Ä—É–π –ø–æ 10 –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º\n- –ü–æ–∫–∞–∑—ã–≤–∞–π –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é\n\nüìù –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:\nüí∏ –†–ê–°–•–û–î–´:\n\nüè† –ñ–∏–ª—å—ë:\n- –û–ø–∏—Å–∞–Ω–∏–µ - —Å—É–º–º–∞ ‚ÇΩ (–¥–∞—Ç–∞)\n–ò—Ç–æ–≥–æ: [–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä] ‚ÇΩ\n\nüöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç:\n- –û–ø–∏—Å–∞–Ω–∏–µ - —Å—É–º–º–∞ ‚ÇΩ\n–ò—Ç–æ–≥–æ: [–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä] ‚ÇΩ\n\nüìä –í–°–ï–ì–û: [–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä] ‚ÇΩ\n\n10 –∫–∞—Ç–µ–≥–æ—Ä–∏–π:\n1.–ñ–∏–ª—å—ë 2.–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç 3.–ü—Ä–æ–¥—É–∫—Ç—ã –ø–∏—Ç–∞–Ω–∏—è 4.–ú–µ–¥–∏—Ü–∏–Ω–∞ 5.–û–¥–µ–∂–¥–∞ –∏ –æ–±—É–≤—å 6.–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è 7.–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ 8.–î–µ—Ç–∏ –∏ —Å–µ–º—å—è 9.–ü–æ–¥–∞—Ä–∫–∏ –∏ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏ 10.–°–±–µ—Ä–µ–∂–µ–Ω–∏—è –∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        3360,
        1056
      ],
      "id": "c9c42b7e-c805-4d62-ae78-f79736966fc7",
      "name": "Expenses Agent"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        2384,
        1264
      ],
      "id": "47ca5678-5758-4c4b-8e82-5f63f67d53c3",
      "name": "OpenAI Model (Income)",
      "credentials": {
        "openAiApi": {
          "id": "D1aWHG8Msi15h2ih",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        3184,
        1264
      ],
      "id": "72e3c260-03c1-4d1b-97dc-5bcaf2259b24",
      "name": "OpenAI Model (Expenses)",
      "credentials": {
        "openAiApi": {
          "id": "D1aWHG8Msi15h2ih",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        2512,
        1264
      ],
      "id": "64d2eee6-de33-44c1-87a0-c38a8de5790f",
      "name": "Calculator (Income)"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        3312,
        1264
      ],
      "id": "61a8ffb7-24d5-4222-b621-98f6ebec34df",
      "name": "Calculator (Expenses)"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Telegram Trigger').item.json.message.from.id }}",
        "tableName": "n8n_chat_histories_income",
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        2640,
        1264
      ],
      "id": "c9180100-3435-46d0-bfc4-07ed0eee72da",
      "name": "Income Chat Memory",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "AIAccounter supabase"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Telegram Trigger').item.json.message.from.id }}",
        "tableName": "n8n_chat_histories_expenses",
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        3440,
        1264
      ],
      "id": "ae67b7ee-58cd-4cb1-bb43-a8a1a1cbc7ea",
      "name": "Expenses Chat Memory",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "AIAccounter supabase"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "–î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π –¥–æ—Ö–æ–¥ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö. –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–æ–±—â–∞–µ—Ç –æ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–µ–Ω–µ–≥.",
        "tableId": "income",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $('Telegram Trigger').item.json.message.from.id }}"
            },
            {
              "fieldId": "amount",
              "fieldValue": "={{ $fromAI('sum', '—Å—É–º–º–∞ –¥–æ—Ö–æ–¥–∞ –≤ —Ä—É–±–ª—è—Ö', 'number') }}"
            },
            {
              "fieldId": "category",
              "fieldValue": "={{ $fromAI('category', '–∫–∞—Ç–µ–≥–æ—Ä–∏—è: –ó–∞—Ä–ø–ª–∞—Ç–∞, –§—Ä–∏–ª–∞–Ω—Å, –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏, –ü–æ–¥–∞—Ä–∫–∏ –∏–ª–∏ –î—Ä—É–≥–æ–µ', 'string') }}"
            },
            {
              "fieldId": "description",
              "fieldValue": "={{ $fromAI('comment', '–æ–ø–∏—Å–∞–Ω–∏–µ –¥–æ—Ö–æ–¥–∞', 'string') }}"
            },
            {
              "fieldId": "currency",
              "fieldValue": "={{ $fromAI('currency', '–≤–∞–ª—é—Ç–∞: KGS, USD, EUR, RUB (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é KGS)', 'string') || 'KGS' }}"
            },
            {
              "fieldId": "date",
              "fieldValue": "={{ $fromAI('created_at', '–¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–µ–∫—É—â—É—é: ' + $now.toISO(), 'string') }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [
        3648,
        1056
      ],
      "id": "6456a72c-96cf-44c8-97a7-5c9ad7f370c3",
      "name": "Create a row in income",
      "credentials": {
        "supabaseApi": {
          "id": "CZjEcmPMUjv3s8us",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "–î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π —Ä–∞—Å—Ö–æ–¥ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö. –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–æ–±—â–∞–µ—Ç –æ –ø–æ–∫—É–ø–∫–µ –∏–ª–∏ —Ç—Ä–∞—Ç–µ.",
        "tableId": "expenses",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $('Telegram Trigger').item.json.message.from.id }}"
            },
            {
              "fieldId": "amount",
              "fieldValue": "={{ $fromAI('sum', '—Å—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–∞ –≤ —Ä—É–±–ª—è—Ö', 'number') }}"
            },
            {
              "fieldId": "category",
              "fieldValue": "={{ $fromAI('category', '–∫–∞—Ç–µ–≥–æ—Ä–∏—è –∏–∑ —Å–ø–∏—Å–∫–∞: –ñ–∏–ª—å—ë, –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –ü—Ä–æ–¥—É–∫—Ç—ã –ø–∏—Ç–∞–Ω–∏—è, –ú–µ–¥–∏—Ü–∏–Ω–∞, –û–¥–µ–∂–¥–∞ –∏ –æ–±—É–≤—å, –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è, –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ, –î–µ—Ç–∏ –∏ —Å–µ–º—å—è, –ü–æ–¥–∞—Ä–∫–∏ –∏ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏, –°–±–µ—Ä–µ–∂–µ–Ω–∏—è –∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏', 'string') }}"
            },
            {
              "fieldId": "description",
              "fieldValue": "={{ $fromAI('comment', '–æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏', 'string') }}"
            },
            {
              "fieldId": "currency",
              "fieldValue": "={{ $fromAI('currency', '–≤–∞–ª—é—Ç–∞: KGS, USD, EUR, RUB (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é KGS)', 'string') || 'KGS' }}"
            },
            {
              "fieldId": "date",
              "fieldValue": "={{ $fromAI('created_at', '–¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–µ–∫—É—â—É—é: ' + $now.toISO(), 'string') }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [
        3776,
        1056
      ],
      "id": "091cfbe2-13c2-4f15-91fd-cb0f640f2f0c",
      "name": "Create a row in expenses",
      "credentials": {
        "supabaseApi": {
          "id": "CZjEcmPMUjv3s8us",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "–£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –æ –¥–æ—Ö–æ–¥–µ. –ü–æ–ø—Ä–æ—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∫–∞–∑–∞—Ç—å ID.",
        "operation": "delete",
        "tableId": "income",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $fromAI('id', 'ID –∑–∞–ø–∏—Å–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'number') }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [
        3904,
        1056
      ],
      "id": "e9f5a72a-2841-4425-a992-8f6f2a4e0322",
      "name": "Delete a row in income",
      "credentials": {
        "supabaseApi": {
          "id": "CZjEcmPMUjv3s8us",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "–£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –æ —Ä–∞—Å—Ö–æ–¥–µ. –ü–æ–ø—Ä–æ—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∫–∞–∑–∞—Ç—å ID.",
        "operation": "delete",
        "tableId": "expenses",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $fromAI('id', 'ID –∑–∞–ø–∏—Å–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'number') }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [
        4032,
        1056
      ],
      "id": "a2e57903-0459-4bd3-a45f-cf1d923341df",
      "name": "Delete a row in expenses",
      "credentials": {
        "supabaseApi": {
          "id": "CZjEcmPMUjv3s8us",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "–ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏ –æ –¥–æ—Ö–æ–¥–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö",
        "operation": "getAll",
        "tableId": "income",
        "returnAll": true
      },
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [
        2768,
        1264
      ],
      "id": "62566ac0-fdb6-425a-a524-9d04c5380a41",
      "name": "Get Income Rows",
      "credentials": {
        "supabaseApi": {
          "id": "CZjEcmPMUjv3s8us",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "–ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏ –æ —Ä–∞—Å—Ö–æ–¥–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö",
        "operation": "getAll",
        "tableId": "expenses",
        "returnAll": true
      },
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [
        3568,
        1264
      ],
      "id": "e1ad59b0-73cf-4a41-87d5-04f92ea50d6e",
      "name": "Get Expenses Rows",
      "credentials": {
        "supabaseApi": {
          "id": "CZjEcmPMUjv3s8us",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolName": "Income_Vector_Store",
        "toolDescription": "–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ –¥–æ—Ö–æ–¥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ò—Å–ø–æ–ª—å–∑—É–π –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–æ—Ö–æ–¥–æ–≤ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é, –¥–∞—Ç–µ –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.",
        "tableName": {
          "__rl": true,
          "value": "income_embeddings",
          "mode": "list",
          "cachedResultName": "income_embeddings"
        },
        "topK": 10,
        "options": {
          "queryName": "match_income_documents"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        2896,
        1264
      ],
      "id": "5e19888b-b891-4318-ae05-f7c668b48f98",
      "name": "Income Vector Store",
      "credentials": {
        "supabaseApi": {
          "id": "CZjEcmPMUjv3s8us",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolName": "Expenses_Vector_Store",
        "toolDescription": "–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ò—Å–ø–æ–ª—å–∑—É–π –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é, –¥–∞—Ç–µ –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.",
        "tableName": {
          "__rl": true,
          "value": "expenses_embeddings",
          "mode": "list",
          "cachedResultName": "expenses_embeddings"
        },
        "topK": 10,
        "options": {
          "queryName": "match_expenses_documents"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        3696,
        1264
      ],
      "id": "a266438b-cdc2-49b7-9e18-0c3126fe5f32",
      "name": "Expenses Vector Store",
      "credentials": {
        "supabaseApi": {
          "id": "CZjEcmPMUjv3s8us",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "b77c9a93-da88-4103-887b-81b0264ca962",
      "name": "Income Embeddings",
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        2976,
        1472
      ],
      "credentials": {
        "openAiApi": {
          "id": "YWdBHhtpkxTSXDR7",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "4c679b05-a183-43bf-be18-e0aa855ddca0",
      "name": "Expenses Embeddings",
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        3776,
        1472
      ],
      "credentials": {
        "openAiApi": {
          "id": "YWdBHhtpkxTSXDR7",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const userId = $input.first().json.user_id;\nconst periodType = $input.first().json.period_type || 'today';\nconst now = new Date();\n\nlet startDate, endDate, periodName;\n\nswitch(periodType) {\n  case 'today':\n    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());\n    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);\n    periodName = '—Å–µ–≥–æ–¥–Ω—è';\n    break;\n  case 'week':\n    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\n    endDate = now;\n    periodName = '–ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é';\n    break;\n  case 'month':\n    startDate = new Date(now.getFullYear(), now.getMonth(), 1);\n    endDate = now;\n    periodName = '—Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü';\n    break;\n  default:\n    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());\n    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);\n    periodName = '—Å–µ–≥–æ–¥–Ω—è';\n}\n\nreturn [{\n  json: {\n    user_id: userId,\n    telegram_chat_id: userId,\n    period_type: periodType,\n    start_date: startDate.toISOString(),\n    end_date: endDate.toISOString(),\n    period_name: periodName\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [4064, 1488],
      "id": "calculate-period-report",
      "name": "Calculate Period"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH income_data AS (\n  SELECT \n    COALESCE(SUM(amount), 0) as total_income,\n    COUNT(*) as income_count\n  FROM income\n  WHERE user_id = {{ $json.user_id }}\n    AND date >= '{{ $json.start_date }}'\n    AND date <= '{{ $json.end_date }}'\n),\nexpense_data AS (\n  SELECT \n    COALESCE(SUM(amount), 0) as total_expenses,\n    COUNT(*) as expense_count\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    AND date >= '{{ $json.start_date }}'\n    AND date <= '{{ $json.end_date }}'\n)\nSELECT \n  i.total_income,\n  i.income_count,\n  e.total_expenses,\n  e.expense_count,\n  (i.total_income - e.total_expenses) as balance\nFROM income_data i, expense_data e;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [4264, 1488],
      "id": "get-report-data-new",
      "name": "Get Report Data",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "AIAccounter supabase"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.income_count + $json.expense_count }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [4464, 1488],
      "id": "has-data-check-new",
      "name": "Has Data?"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "message",
              "name": "message",
              "value": "=üìä <b>–û—Ç—á–µ—Ç –∑–∞ {{ $('Calculate Period').first().json.period_name }}</b>\n\nüí∞ <b>–î–æ—Ö–æ–¥—ã:</b> {{ $json.total_income }} KGS\nüí∏ <b>–†–∞—Å—Ö–æ–¥—ã:</b> {{ $json.total_expenses }} KGS\n‚öñÔ∏è <b>–ë–∞–ª–∞–Ω—Å:</b> {{ $json.balance > 0 ? '+' : '' }}{{ $json.balance }} KGS\n\nüìà <b>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:</b> {{ Number($json.income_count) + Number($json.expense_count) }}\n ‚Ä¢ –î–æ—Ö–æ–¥–æ–≤: {{ $json.income_count }}\n ‚Ä¢ –†–∞—Å—Ö–æ–¥–æ–≤: {{ $json.expense_count }}",
              "type": "string"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [4664, 1376],
      "id": "format-report-new",
      "name": "Format Report"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "message",
              "name": "message",
              "value": "=üìä <b>–û—Ç—á–µ—Ç –∑–∞ {{ $('Calculate Period').first().json.period_name }}</b>\n\nü§∑‚Äç‚ôÇÔ∏è <i>–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</i>\n\n–î–æ–±–∞–≤—å—Ç–µ –¥–æ—Ö–æ–¥—ã –∏–ª–∏ —Ä–∞—Å—Ö–æ–¥—ã, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –æ—Ç—á–µ—Ç!",
              "type": "string"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [4664, 1600],
      "id": "format-no-data-new",
      "name": "Format No Data"
    },
    {
      "parameters": {
        "chatId": "={{ $('Calculate Period').first().json.telegram_chat_id }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [4864, 1488],
      "id": "send-report-new",
      "name": "Send Report",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $('Calculate Period').first().json.period_type }}",
              "rightValue": "today",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [5064, 1488],
      "id": "should-generate-pdf-new",
      "name": "Should Generate PDF?"
    },
    {
      "parameters": {
        "jsCode": "// –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è PDF (–±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤)\nconst reportData = $('Get Report Data').first().json;\nconst periodData = $('Calculate Period').first().json;\nconst periodType = periodData.period_type;\n\nconst startDate = new Date(periodData.start_date);\nconst endDate = new Date(periodData.end_date);\n\nlet pdfData = {};\n\nif (periodType === 'week') {\n  pdfData = {\n    title: 'üìä –ù–µ–¥–µ–ª—å–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç',\n    user_name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',\n    period: startDate.toLocaleDateString('ru-RU') + ' - ' + endDate.toLocaleDateString('ru-RU'),\n    currency_symbol: 'KGS',\n    total_expenses: Number(reportData.total_expenses || 0),\n    total_income: Number(reportData.total_income || 0),\n    balance: Number(reportData.balance || 0),\n    transaction_count: Number(reportData.income_count || 0) + Number(reportData.expense_count || 0),\n    expense_count: Number(reportData.expense_count || 0),\n    income_count: Number(reportData.income_count || 0),\n    avg_daily_expense: Math.round(Number(reportData.total_expenses || 0) / 7),\n    avg_daily_income: Math.round(Number(reportData.total_income || 0) / 7),\n    top_categories_table: [],\n    daily_details: []\n  };\n} else if (periodType === 'month') {\n  pdfData = {\n    title: 'üìä –ú–µ—Å—è—á–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç',\n    month: startDate.toLocaleDateString('ru-RU', {month: 'long', year: 'numeric'}),\n    user_name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',\n    period: startDate.toLocaleDateString('ru-RU') + ' - ' + endDate.toLocaleDateString('ru-RU'),\n    generated_date: new Date().toLocaleDateString('ru-RU'),\n    total_expenses: Number(reportData.total_expenses || 0),\n    total_expenses_formatted: Number(reportData.total_expenses || 0).toFixed(0) + ' KGS',\n    total_income: Number(reportData.total_income || 0),\n    total_income_formatted: Number(reportData.total_income || 0).toFixed(0) + ' KGS',\n    balance: Number(reportData.balance || 0),\n    balance_formatted: Number(reportData.balance || 0).toFixed(0) + ' KGS',\n    transaction_count: Number(reportData.income_count || 0) + Number(reportData.expense_count || 0),\n    expense_count: Number(reportData.expense_count || 0),\n    income_count: Number(reportData.income_count || 0),\n    currency_symbol: 'KGS',\n    avg_daily_expense: Math.round(Number(reportData.total_expenses || 0) / 30),\n    avg_daily_expense_formatted: Math.round(Number(reportData.total_expenses || 0) / 30) + ' KGS',\n    avg_daily_income: Math.round(Number(reportData.total_income || 0) / 30),\n    avg_daily_income_formatted: Math.round(Number(reportData.total_income || 0) / 30) + ' KGS',\n    category_breakdown_table: [],\n    top_3_categories: [],\n    weekly_data: []\n  };\n}\n\nreturn [{ json: { pdfData: pdfData, period_type: periodType } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [5264, 1488],
      "id": "prepare-pdf-new",
      "name": "Prepare PDF Data"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{ $json.period_type }}",
                    "rightValue": "week",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "week"
            },
            {
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{ $json.period_type }}",
                    "rightValue": "month",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "month"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [5464, 1488],
      "id": "route-pdf-new",
      "name": "Route PDF Type"
    },
    {
      "parameters": {
        "resource": "pdf",
        "pdfTemplateId": "5a677b23ed6c2fe6",
        "jsonParameters": true,
        "dataJson": "={{ $json.pdfData }}",
        "options": {
          "download": true,
          "fileName": "={{ 'weekly_report_' + new Date().getTime() + '.pdf' }}"
        }
      },
      "type": "n8n-nodes-base.apiTemplateIo",
      "typeVersion": 1,
      "position": [5664, 1376],
      "id": "generate-weekly-pdf-new",
      "name": "Generate Weekly PDF",
      "credentials": {
        "apiTemplateIoApi": {
          "id": "NIFEHHMbU4WCVxC0",
          "name": "PDF Report"
        }
      }
    },
    {
      "parameters": {
        "resource": "pdf",
        "pdfTemplateId": "c1177b23eddd4e88",
        "jsonParameters": true,
        "dataJson": "={{ $json.pdfData }}",
        "options": {
          "download": true,
          "fileName": "={{ 'monthly_report_' + new Date().getTime() + '.pdf' }}"
        }
      },
      "type": "n8n-nodes-base.apiTemplateIo",
      "typeVersion": 1,
      "position": [5664, 1600],
      "id": "generate-monthly-pdf-new",
      "name": "Generate Monthly PDF",
      "credentials": {
        "apiTemplateIoApi": {
          "id": "NIFEHHMbU4WCVxC0",
          "name": "PDF Report"
        }
      }
    },
    {
      "parameters": {
        "operation": "sendDocument",
        "chatId": "={{ $('Calculate Period').first().json.telegram_chat_id }}",
        "binaryData": true,
        "additionalFields": {
          "caption": "=üìÑ PDF –æ—Ç—á–µ—Ç –∑–∞ {{ $('Calculate Period').first().json.period_name }}"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [5864, 1488],
      "id": "send-pdf-new",
      "name": "Send PDF",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    }
  ],
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Message Type Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message Type Switch": {
      "main": [
        [
          {
            "node": "Download Voice",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Voice": {
      "main": [
        [
          {
            "node": "Transcribe Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe Audio": {
      "main": [
        [
          {
            "node": "Extract Voice Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Text": {
      "main": [
        [
          {
            "node": "Main AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Voice Text": {
      "main": [
        [
          {
            "node": "Main AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Main AI Agent": {
      "main": [
        [
          {
            "node": "Send Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Reply": {
      "main": [
        [
          {
            "node": "Check Report Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Report Request": {
      "main": [
        [
          {
            "node": "Extract Report Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Report Params": {
      "main": [
        [
          {
            "node": "Calculate Period",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate Period": {
      "main": [
        [
          {
            "node": "Get Report Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Report Data": {
      "main": [
        [
          {
            "node": "Has Data?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Data?": {
      "main": [
        [
          {
            "node": "Format Report",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format No Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Report": {
      "main": [
        [
          {
            "node": "Send Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format No Data": {
      "main": [
        [
          {
            "node": "Send Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Report": {
      "main": [
        [
          {
            "node": "Should Generate PDF?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Generate PDF?": {
      "main": [
        [
          {
            "node": "Prepare PDF Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare PDF Data": {
      "main": [
        [
          {
            "node": "Route PDF Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route PDF Type": {
      "main": [
        [
          {
            "node": "Generate Weekly PDF",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Generate Monthly PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Weekly PDF": {
      "main": [
        [
          {
            "node": "Send PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Monthly PDF": {
      "main": [
        [
          {
            "node": "Send PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Model": {
      "ai_languageModel": [
        [
          {
            "node": "Main AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Main Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "Main AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Income Agent": {
      "ai_tool": [
        [
          {
            "node": "Main AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Expenses Agent": {
      "ai_tool": [
        [
          {
            "node": "Main AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Model (Income)": {
      "ai_languageModel": [
        [
          {
            "node": "Income Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Model (Expenses)": {
      "ai_languageModel": [
        [
          {
            "node": "Expenses Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Calculator (Income)": {
      "ai_tool": [
        [
          {
            "node": "Income Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Calculator (Expenses)": {
      "ai_tool": [
        [
          {
            "node": "Expenses Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Income Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "Income Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Expenses Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "Expenses Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Create a row in income": {
      "ai_tool": [
        [
          {
            "node": "Main AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Create a row in expenses": {
      "ai_tool": [
        [
          {
            "node": "Main AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Delete a row in income": {
      "ai_tool": [
        [
          {
            "node": "Main AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Delete a row in expenses": {
      "ai_tool": [
        [
          {
            "node": "Main AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get Income Rows": {
      "ai_tool": [
        [
          {
            "node": "Income Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get Expenses Rows": {
      "ai_tool": [
        [
          {
            "node": "Expenses Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Income Vector Store": {
      "ai_tool": [
        [
          {
            "node": "Income Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Expenses Vector Store": {
      "ai_tool": [
        [
          {
            "node": "Expenses Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Income Embeddings": {
      "ai_embedding": [
        [
          {
            "node": "Income Vector Store",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Expenses Embeddings": {
      "ai_embedding": [
        [
          {
            "node": "Expenses Vector Store",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Generate Report": {
      "ai_tool": [
        [
          {
            "node": "Main AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "2ece1bab2405716a7cfce686d1ebe9d72af95a53d05c0b295aab0a1ef9d0a512"
  }
}