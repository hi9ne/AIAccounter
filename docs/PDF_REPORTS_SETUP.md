# ðŸ“Š PDF Reports Setup - Final Configuration

## âœ… Ð§Ñ‚Ð¾ Ð±Ñ‹Ð»Ð¾ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ (20 Ð½Ð¾ÑÐ±Ñ€Ñ 2025)

### ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð±Ñ‹Ð»Ð¸ Ñ€ÐµÑˆÐµÐ½Ñ‹:

1. **âŒ Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ñ Ð½ÐµÐ¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¹ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¾Ð¹**
   - Ð‘Ñ‹Ð»Ð¾: ÐºÐ¾Ð»Ð¾Ð½ÐºÐ° `content` Ð²Ð¼ÐµÑÑ‚Ð¾ `message`
   - Ð ÐµÑˆÐµÐ½Ð¸Ðµ: ÐŸÐµÑ€ÐµÑÐ¾Ð·Ð´Ð°Ð½Ð° Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¹ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¾Ð¹

2. **âŒ `user_id = null` Ð² Reports Agent**
   - ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°: `$('Telegram Trigger')` Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð² ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ðµ AI Tool
   - Ð ÐµÑˆÐµÐ½Ð¸Ðµ: ÐŸÐµÑ€ÐµÐ´Ð°Ñ‡Ð° Ñ‡ÐµÑ€ÐµÐ· Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚: `"User ID: 1109421300\nQuery: Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð·Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ"`

3. **âŒ Chat Memory Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð² AI Agent Tool**
   - ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°: `$input.first()` Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð² ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ðµ Memory Node
   - Ð ÐµÑˆÐµÐ½Ð¸Ðµ: **ÐŸÐ¾Ð»Ð½Ð¾Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ Chat Memory** (Ð½Ðµ Ð½ÑƒÐ¶Ð½Ð° Ð´Ð»Ñ Ð¾Ð´Ð½Ð¾Ñ€Ð°Ð·Ð¾Ð²Ð¾Ð¹ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸)

---

## ðŸ—ï¸ Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð°

### Workflow: Ai Financer

**Generate Report Tool:**
```json
{
  "workflowInputs": {
    "user_id": "={{ $json.user_id }}",  â† Ð˜Ð· ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð° Main AI Agent
    "query": "={{ $fromAI('query', '...', 'string') }}"
  }
}
```

### Workflow: Helper AI Financer

**Reports Agent (AI Agent Tool):**
```javascript
{
  "text": "=User ID: {{ $('When Called').item.json.user_id }}\nQuery: {{ $fromAI('query', '...') }}",
  "systemMessage": "Ð¢Ñ‹ Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð¿Ð¾Ð¼Ð¾Ñ‰Ð½Ð¸Ðº...
    1. Ð Ð°ÑÐ¿Ð¾Ð·Ð½Ð°Ñ‚ÑŒ user_id Ð¸Ð· Ð²Ñ…Ð¾Ð´Ð½Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
    2. Ð Ð°ÑÐ¿Ð¾Ð·Ð½Ð°Ñ‚ÑŒ Ð¿ÐµÑ€Ð¸Ð¾Ð´ Ð¸Ð· Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°
    3. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Get Report Data
    4. Ð¡Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ PDF"
}
```

**Get Report Data (Postgres Tool):**
```sql
WHERE user_id = {{ $fromAI("user_id", "User ID Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ", "number") }}
AND date >= TO_DATE('{{ $fromAI("start_date", "...", "string") }}', 'DD.MM.YYYY')
AND date <= TO_DATE('{{ $fromAI("end_date", "...", "string") }}', 'DD.MM.YYYY')
```

**Ð’Ð°Ð¶Ð½Ð¾:** 
- âŒ ÐÐ•Ð¢ Chat Memory (Ð½Ðµ Ð½ÑƒÐ¶Ð½Ð° Ð´Ð»Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð¾Ð²)
- âœ… user_id Ð¿ÐµÑ€ÐµÐ´Ð°ÐµÑ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚
- âœ… AI Agent Ð¸Ð·Ð²Ð»ÐµÐºÐ°ÐµÑ‚ user_id Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Ð² SQL

---

## ðŸ“ Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…

### Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð°: n8n_chat_histories_reports

**Ð¡Ð¾Ð·Ð´Ð°Ð½Ð° Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾:**
```sql
CREATE TABLE n8n_chat_histories_reports (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id VARCHAR(255) NOT NULL,
    type VARCHAR(50) NOT NULL,
    message TEXT NOT NULL,  -- âœ… ÐŸÑ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ðµ Ð¸Ð¼Ñ Ð´Ð»Ñ n8n!
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:** âœ… Ð¡Ð¾Ð·Ð´Ð°Ð½Ð°, Ð½Ð¾ **Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ** (Chat Memory ÑƒÐ´Ð°Ð»ÐµÐ½)

---

## ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ

### ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²:

```
1. "ÐžÑ‚Ñ‡ÐµÑ‚ Ð·Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ"
   â†’ ÐŸÐµÑ€Ð¸Ð¾Ð´: (today - 7 days) - today

2. "ÐžÑ‚Ñ‡ÐµÑ‚ Ð·Ð° Ð½Ð¾ÑÐ±Ñ€ÑŒ"
   â†’ ÐŸÐµÑ€Ð¸Ð¾Ð´: 01.11.2025 - 30.11.2025

3. "ÐžÑ‚Ñ‡ÐµÑ‚ Ð·Ð° ÑÐµÐ³Ð¾Ð´Ð½Ñ"
   â†’ ÐŸÐµÑ€Ð¸Ð¾Ð´: today - today

4. "ÐžÑ‚Ñ‡ÐµÑ‚ Ñ 1 Ð¿Ð¾ 15 Ð´ÐµÐºÐ°Ð±Ñ€Ñ"
   â†’ ÐŸÐµÑ€Ð¸Ð¾Ð´: 01.12.2025 - 15.12.2025

5. "ÐžÑ‚Ñ‡ÐµÑ‚ Ð·Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð¼ÐµÑÑÑ†"
   â†’ ÐŸÐµÑ€Ð¸Ð¾Ð´: (today - 30 days) - today
```

### ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼Ñ‹Ð¹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚:

```
ðŸ“Š ÐžÑ‚Ñ‡ÐµÑ‚ Ð·Ð° [Ð¿ÐµÑ€Ð¸Ð¾Ð´] Ð³Ð¾Ñ‚Ð¾Ð²!

ðŸ’° ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÐµÐ»Ð¸:
â€¢ Ð”Ð¾Ñ…Ð¾Ð´Ñ‹: XXXâ‚½
â€¢ Ð Ð°ÑÑ…Ð¾Ð´Ñ‹: XXXâ‚½
â€¢ Ð‘Ð°Ð»Ð°Ð½Ñ: XXXâ‚½

ðŸ“„ PDF Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½ Ð²Ñ‹ÑˆÐµ â¬†ï¸

[PDF Ñ„Ð°Ð¹Ð» Ñ Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ°Ð¼Ð¸ Ñ‡ÐµÑ€ÐµÐ· apiTemplate.io]
```

---

## ðŸ” Troubleshooting

### ÐžÑˆÐ¸Ð±ÐºÐ°: "user_id = null"
**ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð°:** Main AI Agent Ð½Ðµ Ð¿ÐµÑ€ÐµÐ´Ð°ÐµÑ‚ user_id Ð² ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ðµ  
**Ð ÐµÑˆÐµÐ½Ð¸Ðµ:** ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ, Ñ‡Ñ‚Ð¾ Extract Text/Extract Voice Text Ð¿ÐµÑ€ÐµÐ´Ð°ÑŽÑ‚ `user_id` Ð² `$json`

### ÐžÑˆÐ¸Ð±ÐºÐ°: "column 'message' does not exist"
**ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð°:** Ð¡Ñ‚Ð°Ñ€Ð°Ñ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹  
**Ð ÐµÑˆÐµÐ½Ð¸Ðµ:** Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸ÑŽ `fix_reports_chat_history_table`

### ÐžÑˆÐ¸Ð±ÐºÐ°: "WHERE user_id = AND"
**ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð°:** AI Agent Ð½Ðµ Ð¸Ð·Ð²Ð»ÐµÐº user_id Ð¸Ð· Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚Ð°  
**Ð ÐµÑˆÐµÐ½Ð¸Ðµ:** ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ, Ñ‡Ñ‚Ð¾ Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ÑÑ Ñ "User ID: XXX"

---

## ðŸ“Š ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸

### Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð½Ñ‹Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸:

1. `add_reports_chat_history.sql` - âœ… ÐŸÐµÑ€Ð²Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ (Ð½ÐµÐ¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð°Ñ)
2. `fix_reports_chat_history_table.sql` - âœ… Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ

**Ð¢ÐµÐºÑƒÑ‰Ð°Ñ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°:**
```sql
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'n8n_chat_histories_reports';

-- Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚:
-- id         | uuid
-- session_id | character varying
-- type       | character varying
-- message    | text           â† âœ… ÐŸÑ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾!
-- created_at | timestamp with time zone
```

---

## âœ… Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: Ð“ÐžÐ¢ÐžÐ’Ðž Ðš Ð ÐÐ‘ÐžÐ¢Ð•

**Ð”Ð°Ñ‚Ð°:** 20 Ð½Ð¾ÑÐ±Ñ€Ñ 2025  
**Ð’ÐµÑ€ÑÐ¸Ñ:** 1.0 (Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ)

**ÐŸÑ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾:**
- âœ… user_id Ð¿ÐµÑ€ÐµÐ´Ð°ÐµÑ‚ÑÑ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾
- âœ… SQL Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÑŽÑ‚ÑÑ
- âœ… ÐŸÐµÑ€Ð¸Ð¾Ð´Ñ‹ Ñ€Ð°ÑÐ¿Ð¾Ð·Ð½Ð°ÑŽÑ‚ÑÑ
- â³ PDF Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ (Ð¾Ð¶Ð¸Ð´Ð°ÐµÑ‚ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ)
