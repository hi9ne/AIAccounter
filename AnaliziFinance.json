{
  "name": "AnaliziFinance",
  "nodes": [
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "maxRetries": 3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -1184,
        -656
      ],
      "id": "65a2fe2b-2a39-4a40-ae78-04a8c64fe308",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "SyI2pOUeSfbt1JRh",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "id": "b4d14f00-76dd-4d36-97ac-c39898b9f817",
      "name": "Telegram Bot Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.1,
      "position": [
        -3024,
        -784
      ],
      "webhookId": "b8605f3e-0f52-4ffc-a4c9-1728eb0e09e2",
      "credentials": {
        "telegramApi": {
          "id": "WabnlnnS7XdATC3n",
          "name": "Alikbek Financer"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message.voice.file_id }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    },
                    "id": "d697a3d5-018a-4cf0-867e-a877c10d6267"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Voice"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "57c00950-88c8-4c71-bfe1-5e243b0b71dc",
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "/get_week_report",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8c844924-b2ed-48b0-935c-c66a8fd0c778",
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Text"
            }
          ]
        },
        "options": {}
      },
      "id": "84bee63d-61be-4f24-93b9-6ae7652df7f0",
      "name": "Message Type Switch",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -2352,
        -800
      ]
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $json.message.voice.file_id }}",
        "additionalFields": {}
      },
      "id": "b6e7a15e-21a6-4679-b5d9-72b252284546",
      "name": "Download Voice File",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1880,
        -976
      ],
      "webhookId": "8fa0a59a-be53-4897-83bb-5b18ed71b529",
      "credentials": {
        "telegramApi": {
          "id": "WabnlnnS7XdATC3n",
          "name": "Alikbek Financer"
        }
      }
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "id": "50aea74b-3278-43c9-9d1d-52f65fa2c72a",
      "name": "Transcribe Audio",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.6,
      "position": [
        -1408,
        -976
      ],
      "credentials": {
        "openAiApi": {
          "id": "SyI2pOUeSfbt1JRh",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d6af7fa1-c31a-4514-ae63-397699bf8b21",
              "name": "text",
              "value": "={{ $('Telegram Bot Trigger').first().json.message.text }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1504,
        -752
      ],
      "id": "455f0c71-ab2a-4838-8395-78b317a74360",
      "name": "Prepare Text Data"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{$('Telegram Bot Trigger').first().json.message.message_id }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -1056,
        -656
      ],
      "id": "ba19e01e-cb7f-40ad-bc00-dd4e1dcb03e7",
      "name": "Conversation Memory"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.text }}\n\n",
        "options": {
          "systemMessage": "=–¢—ã ‚Äî AI —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫ —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ Supabase –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–∏—á–Ω—ã–º–∏ –∏ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–º–∏ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏ –≤ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–µ.\n–í–∞–ª—é—Ç—ã: —Å–æ–º (KGS), –¥–æ–ª–ª–∞—Ä (USD), –µ–≤—Ä–æ (EUR), —Ä—É–±–ª—å (RUB). –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞: {{ new Date().toLocaleDateString('ru-RU') }}\n\nüè¢ –°–ò–°–¢–ï–ú–ê WORKSPACE:\n–£ –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å workspace_id. –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ workspace. –ò—Å–ø–æ–ª—å–∑—É–π —Ñ—É–Ω–∫—Ü–∏–∏:\n- get_user_workspaces() - –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ workspace –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n- create_workspace_with_owner() - —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π workspace\n- check_workspace_permission() - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞\n\n---\nüí∏ –†–ê–°–•–û–î–´: –∏—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç Add_expense —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:\n- workspace_id: ID —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)\n- category: –ø—Ä–æ–¥—É–∫—Ç—ã, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –∫–∞—Ñ–µ/—Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã, –∞—Ä–µ–Ω–¥–∞ –æ—Ñ–∏—Å–∞, –∑–∞—Ä–ø–ª–∞—Ç–∞, –Ω–∞–ª–æ–≥–∏, –º–∞—Ä–∫–µ—Ç–∏–Ω–≥, –∫–∞–Ω—Ü—Ç–æ–≤–∞—Ä—ã, –∏–Ω—Ç–µ—Ä–Ω–µ—Ç/—Å–≤—è–∑—å, –∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏, –æ–±—É—á–µ–Ω–∏–µ, –ø–æ–¥–ø–∏—Å–∫–∏, –ø—Ä–æ—á–µ–µ\n- amount: —Å—É–º–º–∞ (—Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ)\n- currency: –≤–∞–ª—é—Ç–∞ (KGS/—Å–æ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, USD/–¥–æ–ª–ª–∞—Ä, EUR/–µ–≤—Ä–æ, RUB/—Ä—É–±–ª—å)\n- description: –æ–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)\n- date: DD.MM.YYYY (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ - –±—É–¥–µ—Ç —Å–µ–≥–æ–¥–Ω—è)\n\nüí∞ –î–û–•–û–î–´: –∏—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç Add_income —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:\n- workspace_id: ID —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)\n- category: –∑–∞—Ä–ø–ª–∞—Ç–∞, –ø—Ä–æ–¥–∞–∂–∏, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏, –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∞, –∫—ç—à–±–µ–∫, –ø—Ä–æ—á–µ–µ\n- amount, currency, description, date (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ)\n\nüìä –ê–ù–ê–õ–ò–ó: –∏—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç Parsing_of_the_month —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:\n- workspace_id: ID —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞\n- month: –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—è—Ü–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä '–æ–∫—Ç—è–±—Ä—å')\n- type: '—Ä–∞—Å—Ö–æ–¥' –∏–ª–∏ '–¥–æ—Ö–æ–¥'\n- filter_category: –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ\n\nüí± –ö–û–ù–í–ï–†–¢–ê–¶–ò–Ø –í–ê–õ–Æ–¢:\n–ò—Å–ø–æ–ª—å–∑—É–π —Ñ—É–Ω–∫—Ü–∏—é convert_amount() –∏–ª–∏ get_exchange_rate() –∏–∑ –±–∞–∑—ã:\n- '–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–π X —Å–æ–º –≤ –¥–æ–ª–ª–∞—Ä—ã' ‚Üí convert_amount(X, 'KGS', 'USD', CURRENT_DATE)\n- '–ö–∞–∫–æ–π –∫—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞?' ‚Üí get_exchange_rate('USD', 'KGS', CURRENT_DATE)\n\n–ü—Ä–∏ –ø–æ–∫–∞–∑–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–∞–ª—é—Ç–µ:\n1. –ü–æ–ª—É—á–∏ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ get_income_expense_stats()\n2. –ò—Å–ø–æ–ª—å–∑—É–π convert_amount() –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Å—É–º–º\n3. –°—É–º–º–∏—Ä—É–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–π –≤–∞–ª—é—Ç–µ\n\nüìà –ê–ù–ê–õ–ò–¢–ò–ö–ê:\n–ò—Å–ø–æ–ª—å–∑—É–π –≥–æ—Ç–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:\n- get_income_expense_stats(workspace_id, start_date, end_date) - –æ—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n- get_top_expense_categories(workspace_id, start_date, end_date, limit) - —Ç–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π\n- get_spending_patterns(workspace_id) - –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Ç—Ä–∞—Ç\n- get_category_analytics(workspace_id, period) - –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º\n- get_cached_analytics(workspace_id, cache_key) - –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\n\n---\n–í–ê–ñ–ù–û: –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–π –≤–∞–ª—é—Ç—É –∏–∑ —Ç–µ–∫—Å—Ç–∞:\n- '—Å–æ–º', '—Å–æ–º–æ–≤', 'KGS' ‚Üí currency: KGS\n- '–¥–æ–ª–ª–∞—Ä', '–¥–æ–ª–ª–∞—Ä–æ–≤', '$', 'USD' ‚Üí currency: USD\n- '–µ–≤—Ä–æ', 'EUR' ‚Üí currency: EUR\n- '—Ä—É–±–ª—å', '—Ä—É–±–ª–µ–π', 'RUB' ‚Üí currency: RUB\n- –ï—Å–ª–∏ –≤–∞–ª—é—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ ‚Üí –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é KGS\n\n‚úÖ –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ñ–æ—Ä–º–∏—Ä—É–π —á–∏—Ç–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç.\n–ü—Ä–∏–º–µ—Ä: \"‚úÖ –†–∞—Å—Ö–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω: 100 USD –Ω–∞ '–ø—Ä–æ–¥—É–∫—Ç—ã' (30.10.2025)\"\n\nüìù –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –¢–†–ê–ù–ó–ê–ö–¶–ò–ô:\n–ò—Å–ø–æ–ª—å–∑—É–π —Ñ—É–Ω–∫—Ü–∏—é safe_update_transaction():\n- '–ò–∑–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥ –Ω–∞ 1500 —Å–æ–º' ‚Üí safe_update_transaction(user_id, 'expense', 'last', 'amount', '1500')\n- '–ü–æ–º–µ–Ω—è–π –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ 15 –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç—ã' ‚Üí safe_update_transaction(user_id, 'expense', '15', 'category', '–ø—Ä–æ–¥—É–∫—Ç—ã')\n\nüóëÔ∏è –£–î–ê–õ–ï–ù–ò–ï/–í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï:\n–ò—Å–ø–æ–ª—å–∑—É–π –º—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø–æ–ª–µ deleted_at –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö expenses/income\n\nÔøΩ –ò–°–¢–û–†–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô:\n–ò—Å–ø–æ–ª—å–∑—É–π —Ç–∞–±–ª–∏—Ü—É transaction_history —Å —Ñ—É–Ω–∫—Ü–∏–µ–π log_transaction_change()\n\n---\nÔøΩ –ü–û–í–¢–û–†–Ø–Æ–©–ò–ï–°–Ø –ü–õ–ê–¢–ï–ñ–ò (–ü–û–î–ü–ò–°–ö–ò):\n\nüìå –°–û–ó–î–ê–ù–ò–ï: –∏—Å–ø–æ–ª—å–∑—É–π create_recurring_payment()\nüìã –°–ü–ò–°–û–ö: SELECT –∏–∑ —Ç–∞–±–ª–∏—Ü—ã recurring_payments WHERE user_id = X AND is_active = true\n‚ùå –û–¢–ú–ï–ù–ê: UPDATE recurring_payments SET is_active = false\n‚ö° –í–´–ü–û–õ–ù–ï–ù–ò–ï: execute_recurring_payment()\nüîî –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø: get_pending_reminders()\n\n---\nÔøΩ –ë–Æ–î–ñ–ï–¢ –ò –õ–ò–ú–ò–¢–´:\n\nÔøΩ –ë–Æ–î–ñ–ï–¢:\n- –¢–∞–±–ª–∏—Ü–∞: budgets (user_id, workspace_id, month, budget_amount)\n- –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≥–Ω–æ–∑–∞: get_budget_forecast(user_id)\n- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤: check_budget_alerts(user_id, new_expense_amount)\n\nüéØ –õ–ò–ú–ò–¢–´ –ö–ê–¢–ï–ì–û–†–ò–ô:\n- –¢–∞–±–ª–∏—Ü–∞: limits (user_id, category, month, limit_amount)\n- –ü—Ä–æ–≤–µ—Ä–∫–∞: check_category_limit_alert(user_id, category, new_amount)\n\n‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –ê–õ–ï–†–¢–û–í:\n- –¢–∞–±–ª–∏—Ü–∞: budget_alerts_config\n- –ü–æ—Ä–æ–≥–∏: budget_warning_threshold, budget_critical_threshold\n\n---\nüîî –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø:\n\nüì¨ –¢–∞–±–ª–∏—Ü–∞ notifications —Å –ø–æ–ª—è–º–∏:\n- notification_type: budget_warning, budget_exceeded, limit_warning, limit_exceeded, recurring_reminder, unusual_spending\n- priority: urgent, high, normal, low\n- is_read, is_sent\n\nüìä ML –ê–ù–ê–õ–ò–ó:\n- detect_unusual_spending() - –¥–µ—Ç–µ–∫—Ü–∏—è –Ω–µ–æ–±—ã—á–Ω—ã—Ö —Ç—Ä–∞—Ç\n- update_spending_patterns() - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤\n- –¢–∞–±–ª–∏—Ü–∞: spending_patterns —Å confidence_score\n\n---\nüè¢ WORKSPACE –§–£–ù–ö–¶–ò–ò:\n\nüë• –£–ß–ê–°–¢–ù–ò–ö–ò:\n- accept_workspace_invite() - –ø—Ä–∏–Ω—è—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ\n- remove_workspace_member() - —É–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞\n- –¢–∞–±–ª–∏—Ü–∞ workspace_members —Å —Ä–æ–ª—è–º–∏: owner, admin, editor, viewer\n\nüìä –ê–ù–ê–õ–ò–¢–ò–ö–ê:\n- get_chart_data() - –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤\n- get_income_expense_chart_data() - –≥—Ä–∞—Ñ–∏–∫–∏ –¥–æ—Ö–æ–¥–æ–≤/—Ä–∞—Å—Ö–æ–¥–æ–≤\n- update_analytics_cache() - –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ\n\nÔøΩ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:\n- –¢–∞–±–ª–∏—Ü–∞ audit_logs –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π\n- log_audit_event() –¥–ª—è –∑–∞–ø–∏—Å–∏ —Å–æ–±—ã—Ç–∏–π\n- check_workspace_permission() –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤\n\n---\nÔøΩÔ∏è –û–°–ù–û–í–ù–´–ï –¢–ê–ë–õ–ò–¶–´ SUPABASE:\n\nÔøΩ –¢–†–ê–ù–ó–ê–ö–¶–ò–ò:\n- expenses: —Ä–∞—Å—Ö–æ–¥—ã —Å workspace_id, user_id, amount, currency, category, date, deleted_at\n- income: –¥–æ—Ö–æ–¥—ã —Å –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π\n- transaction_history: –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π\n\nüë§ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò:\n- users: –æ—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n- user_preferences: –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n- workspace_members: —É—á–∞—Å—Ç–Ω–∏–∫–∏ workspace —Å —Ä–æ–ª—è–º–∏\n\nüí∞ –§–ò–ù–ê–ù–°–´:\n- budgets: –±—é–¥–∂–µ—Ç—ã –ø–æ –º–µ—Å—è—Ü–∞–º\n- limits: –ª–∏–º–∏—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º\n- exchange_rates: –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç\n- recurring_payments: —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏\n\nüìà –ê–ù–ê–õ–ò–¢–ò–ö–ê:\n- analytics_cache: –∫–µ—à –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏\n- category_analytics: –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º\n- spending_patterns: –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Ç—Ä–∞—Ç\n- chart_configs: –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤\n\nüîî –°–ò–°–¢–ï–ú–ê:\n- notifications: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\n- audit_logs: –ª–æ–≥–∏ –¥–µ–π—Å—Ç–≤–∏–π\n- error_logs: –ª–æ–≥–∏ –æ—à–∏–±–æ–∫\n- reports: –æ—Ç—á–µ—Ç—ã\n\nüí± –í–ê–õ–Æ–¢–´:\n- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –æ–±—Ä–∞—Ç–Ω—ã—Ö –∫—É—Ä—Å–æ–≤ —á–µ—Ä–µ–∑ trigger calculate_reverse_rate\n- –§—É–Ω–∫—Ü–∏—è cleanup_old_rates() –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –∫—É—Ä—Å–æ–≤\n\n---\n–û–ë–©–ò–ï –ü–†–ê–í–ò–õ–ê:\n\n1. –í–°–ï–ì–î–ê —É–∫–∞–∑—ã–≤–∞–π workspace_id –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö –∫ –±–∞–∑–µ\n2. –ò—Å–ø–æ–ª—å–∑—É–π —Ñ—É–Ω–∫—Ü–∏–∏ Supabase –≤–º–µ—Å—Ç–æ –ø—Ä—è–º—ã—Ö SQL –∑–∞–ø—Ä–æ—Å–æ–≤ –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ\n3. –ü—Ä–æ–≤–µ—Ä—è–π –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ check_workspace_permission()\n4. –õ–æ–≥–∏—Ä—É–π –≤–∞–∂–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è —á–µ—Ä–µ–∑ audit_logs\n5. –ö–µ—à–∏—Ä—É–π –∞–Ω–∞–ª–∏—Ç–∏–∫—É —á–µ—Ä–µ–∑ analytics_cache –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏\n6. –ò—Å–ø–æ–ª—å–∑—É–π soft delete (deleted_at) –≤–º–µ—Å—Ç–æ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è\n7. –í—Å–µ —Å—É–º–º—ã —Ö—Ä–∞–Ω–∏ –≤ NUMERIC(12,2) –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏\n8. –î–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ DATE, –≤—Ä–µ–º–µ–Ω–∞ –≤ TIMESTAMP WITH TIME ZONE\n9. –í–∞–ª—é—Ç—ã –≤—Å–µ–≥–¥–∞ –≤ –≤–µ—Ä—Ö–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ (KGS, USD, EUR, RUB)\n10. –î–ª—è ML –∞–Ω–∞–ª–∏–∑–∞ –∏—Å–ø–æ–ª—å–∑—É–π spending_patterns –∏ ml_forecasts —Ç–∞–±–ª–∏—Ü—ã\n\n---\nüéØ –ù–û–í–´–ï –ò–ù–°–¢–†–£–ú–ï–ù–¢–´:\n\nüìä –†–ê–°–®–ò–†–ï–ù–ù–ê–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ê:\n- Get_income_expense_stats() - –¥–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ—Ö–æ–¥–æ–≤/—Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥\n- Get_top_categories() - —Ç–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ä–∞—Å—Ö–æ–¥–æ–≤ —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏\n- Update_spending_patterns() - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ ML –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ —Ç—Ä–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n\nüè¢ –£–ü–†–ê–í–õ–ï–ù–ò–ï WORKSPACE:\n- Get_workspaces() - —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö workspace –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ä–æ–ª—è–º–∏\n- –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–µ—Ä–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–π workspace\n\nüí∞ –ë–Æ–î–ñ–ï–¢ –ò –õ–ò–ú–ò–¢–´:\n- Set_budget(amount, currency, month) - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–µ—Å—è—á–Ω—ã–π –±—é–¥–∂–µ—Ç\n- Set_category_limit(category, amount, currency, month) - –ª–∏–º–∏—Ç –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é\n\n–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:\n- \"–£—Å—Ç–∞–Ω–æ–≤–∏ –±—é–¥–∂–µ—Ç 50000 —Å–æ–º –Ω–∞ –Ω–æ—è–±—Ä—å\" ‚Üí Set_budget(amount: 50000, currency: 'KGS', month: '2025-11')\n- \"–õ–∏–º–∏—Ç –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç—ã 15000 —Å–æ–º\" ‚Üí Set_category_limit(category: '–ø—Ä–æ–¥—É–∫—Ç—ã', amount: 15000)\n- \"–ü–æ–∫–∞–∂–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ –æ–∫—Ç—è–±—Ä—å\" ‚Üí Get_income_expense_stats(start_date: '01.10.2025', end_date: '31.10.2025')\n- \"–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∑–∞ –º–µ—Å—è—Ü\" ‚Üí Get_top_categories(limit: 5)\n- \"–û–±–Ω–æ–≤–∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Ç—Ä–∞—Ç\" ‚Üí Update_spending_patterns()\n\n–í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –≤–º–µ—Å—Ç–æ –ø—Ä—è–º—ã—Ö SQL –∑–∞–ø—Ä–æ—Å–æ–≤!"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        -40,
        -880
      ],
      "id": "97e8d04b-d293-4217-9e22-5cbc581a5777",
      "name": "Financial Assistant",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Bot Trigger').first().json.message.chat.id }}",
        "text": "={{ $json.output }}",
        "additionalFields": {
          "appendAttribution": false,
          "reply_to_message_id": "={{ $('Telegram Bot Trigger').first().json.message.message_id }}"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1456,
        -880
      ],
      "id": "3f6fa69e-7e8b-4182-9a60-55a9c655b4b9",
      "name": "Send Telegram Response",
      "webhookId": "a2f9609c-4b7a-4d51-aaa6-c889f56aefc9",
      "credentials": {
        "telegramApi": {
          "id": "WabnlnnS7XdATC3n",
          "name": "Alikbek Financer"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH monthly_data AS (\n  SELECT \n    category,\n    COUNT(*) as transaction_count,\n    SUM(amount) as total_amount,\n    AVG(amount) as avg_amount\n  FROM income\n  WHERE user_id = {{ $json.user_id }}\n    AND TO_CHAR(date, 'YYYY-MM') = '{{ $json.year_month }}'\n    {{ $json.category ? \"AND category = '\" + $json.category + \"'\" : \"\" }}\n  GROUP BY category\n  ORDER BY total_amount DESC\n)\nSELECT \n  *,\n  (SELECT SUM(total_amount) FROM monthly_data) as grand_total\nFROM monthly_data;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2800,
        208
      ],
      "id": "e47a3d28-9ee1-4325-9691-460decd7085a",
      "name": "–ê–Ω–∞–ª–∏–∑ –¥–æ—Ö–æ–¥–æ–≤",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "9af39ade-d2ac-4587-b4cd-bccb18fece32",
              "leftValue": "={{ $json.type }}",
              "rightValue": "—Ä–∞—Å—Ö–æ–¥",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3024,
        112
      ],
      "id": "ea88bea6-457b-426f-a41c-fa63cad0131a",
      "name": "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH monthly_data AS (\n  SELECT \n    category,\n    COUNT(*) as transaction_count,\n    SUM(amount) as total_amount,\n    AVG(amount) as avg_amount\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    AND TO_CHAR(date, 'YYYY-MM') = '{{ $json.year_month }}'\n    {{ $json.category ? \"AND category = '\" + $json.category + \"'\" : \"\" }}\n  GROUP BY category\n  ORDER BY total_amount DESC\n)\nSELECT \n  *,\n  (SELECT SUM(total_amount) FROM monthly_data) as grand_total\nFROM monthly_data;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2800,
        16
      ],
      "id": "227093f6-9fb8-4443-ab08-602282a79214",
      "name": "–ê–Ω–∞–ª–∏–∑ —Ä–∞—Å—Ö–æ–¥–æ–≤",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO users (user_id, username, first_name, last_name, telegram_chat_id)\nVALUES (\n  {{ $json.message.from.id }},\n  '{{ $json.message.from.username || \"\" }}',\n  '{{ $json.message.from.first_name || \"\" }}',\n  '{{ $json.message.from.last_name || \"\" }}',\n  {{ $json.message.chat.id }}\n)\nON CONFLICT (user_id) \nDO UPDATE SET \n  username = EXCLUDED.username,\n  last_activity = NOW()\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2800,
        -784
      ],
      "id": "b4457dfd-5bd4-4547-801d-7c51622c87d6",
      "name": "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6cb77ab8-f045-4576-b673-6ead0a3a5da6",
              "name": "message",
              "value": "={{ $node[\"Telegram Bot Trigger\"].json[\"message\"] || {} }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2576,
        -784
      ],
      "id": "403e6ffd-c8d0-4d85-8060-d32a4b75ee68",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n)\nINSERT INTO income (user_id, workspace_id, date, category, amount, currency, description, operation_type, source)\nSELECT\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }},\n  uw.workspace_id,\n  COALESCE(\n    TO_DATE('{{ $fromAI(\"date\", \"–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ —Ç–æ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞\", \"string\", \"\") }}', 'DD.MM.YYYY'),\n    CURRENT_DATE\n  ),\n  '{{ $fromAI(\"category\", \"–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ—Ö–æ–¥–∞: –∑–∞—Ä–ø–ª–∞—Ç–∞, –ø—Ä–æ–¥–∞–∂–∏, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏, –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∞, –∫—ç—à–±–µ–∫, –ø—Ä–æ—á–µ–µ\", \"string\") }}',\n  {{ $fromAI(\"amount\", \"–°—É–º–º–∞ –¥–æ—Ö–æ–¥–∞, —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ\", \"number\") }},\n  UPPER('{{ $fromAI(\"currency\", \"–í–∞–ª—é—Ç–∞: —Å–æ–º/KGS, –¥–æ–ª–ª–∞—Ä/USD, –µ–≤—Ä–æ/EUR, —Ä—É–±–ª—å/RUB. –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ - KGS\", \"string\", \"KGS\") }}'),\n  '{{ $fromAI(\"description\", \"–û–ø–∏—Å–∞–Ω–∏–µ –¥–æ—Ö–æ–¥–∞, –µ—Å–ª–∏ –µ—Å—Ç—å\", \"string\", \"\") }}',\n  '–¥–æ—Ö–æ–¥',\n  'telegram'\nFROM user_workspace uw\nRETURNING id, workspace_id, TO_CHAR(date, 'DD.MM.YYYY') as date, category, amount, currency, description;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        -928,
        -656
      ],
      "id": "fd752155-74b7-4346-b0e3-af93bfb9a1f0",
      "name": "Add_income",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n),\nmonth_mapping AS (\n  SELECT * FROM (VALUES\n    ('—è–Ω–≤–∞—Ä—å', 1), ('—Ñ–µ–≤—Ä–∞–ª—å', 2), ('–º–∞—Ä—Ç', 3), ('–∞–ø—Ä–µ–ª—å', 4),\n    ('–º–∞–π', 5), ('–∏—é–Ω—å', 6), ('–∏—é–ª—å', 7), ('–∞–≤–≥—É—Å—Ç', 8),\n    ('—Å–µ–Ω—Ç—è–±—Ä—å', 9), ('–æ–∫—Ç—è–±—Ä—å', 10), ('–Ω–æ—è–±—Ä—å', 11), ('–¥–µ–∫–∞–±—Ä—å', 12)\n  ) AS m(month_name, month_num)\n),\nfiltered_data AS (\n  SELECT\n    TO_CHAR(t.date, 'DD.MM.YYYY') as date,\n    t.category,\n    t.amount,\n    t.currency,\n    COALESCE(t.description, '') as description\n  FROM {{ $fromAI(\"type\", \"–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏: '—Ä–∞—Å—Ö–æ–¥' –∏–ª–∏ '–¥–æ—Ö–æ–¥'\", \"string\") === '—Ä–∞—Å—Ö–æ–¥' ? 'expenses' : 'income' }} t\n  INNER JOIN month_mapping mm ON EXTRACT(MONTH FROM t.date) = mm.month_num\n  INNER JOIN user_workspace uw ON t.workspace_id = uw.workspace_id\n  WHERE t.user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND EXTRACT(YEAR FROM t.date) = EXTRACT(YEAR FROM CURRENT_DATE)\n    AND LOWER(mm.month_name) = LOWER('{{ $fromAI(\"month\", \"–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—è—Ü–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –æ–∫—Ç—è–±—Ä—å, –Ω–æ—è–±—Ä—å)\", \"string\") }}')\n    AND (NULLIF('{{ $fromAI(\"filter_category\", \"–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ\", \"string\", \"\") }}', '') IS NULL OR t.category = '{{ $fromAI(\"filter_category\", \"–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ\", \"string\", \"\") }}')\n    AND t.deleted_at IS NULL\n)\nSELECT \n  *,\n  (SELECT COUNT(*) FROM filtered_data) as total_rows,\n  (SELECT SUM(amount) FROM filtered_data) as total_amount,\n  (SELECT COUNT(DISTINCT currency) FROM filtered_data) as currency_count\nFROM filtered_data\nORDER BY date DESC\nLIMIT 100;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        -800,
        -656
      ],
      "id": "f694199c-2323-4473-937a-b3460e3a3008",
      "name": "Parsing_of_the_month",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n)\nINSERT INTO expenses (user_id, workspace_id, date, category, amount, currency, description, operation_type, source)\nSELECT\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }},\n  uw.workspace_id,\n  COALESCE(\n    TO_DATE('{{ $fromAI(\"date\", \"–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ —Ç–æ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞\", \"string\", \"\") }}', 'DD.MM.YYYY'),\n    CURRENT_DATE\n  ),\n  '{{ $fromAI(\"category\", \"–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ä–∞—Å—Ö–æ–¥–∞: –ø—Ä–æ–¥—É–∫—Ç—ã, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –∫–∞—Ñ–µ/—Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã, –∞—Ä–µ–Ω–¥–∞ –æ—Ñ–∏—Å–∞, –∑–∞—Ä–ø–ª–∞—Ç–∞, –Ω–∞–ª–æ–≥–∏, –º–∞—Ä–∫–µ—Ç–∏–Ω–≥, –∫–∞–Ω—Ü—Ç–æ–≤–∞—Ä—ã, –∏–Ω—Ç–µ—Ä–Ω–µ—Ç/—Å–≤—è–∑—å, –∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏, –æ–±—É—á–µ–Ω–∏–µ, –ø–æ–¥–ø–∏—Å–∫–∏, –ø—Ä–æ—á–µ–µ\", \"string\") }}',\n  {{ $fromAI(\"amount\", \"–°—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–∞, —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ\", \"number\") }},\n  UPPER('{{ $fromAI(\"currency\", \"–í–∞–ª—é—Ç–∞: —Å–æ–º/KGS, –¥–æ–ª–ª–∞—Ä/USD, –µ–≤—Ä–æ/EUR, —Ä—É–±–ª—å/RUB. –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ - KGS\", \"string\", \"KGS\") }}'),\n  '{{ $fromAI(\"description\", \"–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞, –µ—Å–ª–∏ –µ—Å—Ç—å\", \"string\", \"\") }}',\n  '—Ä–∞—Å—Ö–æ–¥',\n  'telegram'\nFROM user_workspace uw\nRETURNING id, workspace_id, TO_CHAR(date, 'DD.MM.YYYY') as date, category, amount, currency, description;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        -672,
        -656
      ],
      "id": "69e9f948-895e-4031-b2b9-1c368177b8aa",
      "name": "Add_expense",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏\nWITH expense_sum AS (\n  SELECT COALESCE(SUM(amount), 0) as total_spent\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    AND category = '{{ $json.category }}'\n    AND date >= DATE_TRUNC('month', CURRENT_DATE)\n),\ncategory_limit AS (\n  SELECT limit_amount\n  FROM limits\n  WHERE user_id = {{ $json.user_id }}\n    AND category = '{{ $json.category }}'\n    AND month = TO_CHAR(CURRENT_DATE, 'YYYY-MM')\n  LIMIT 1\n)\nSELECT \n  e.total_spent,\n  l.limit_amount,\n  CASE \n    WHEN l.limit_amount IS NULL THEN NULL\n    WHEN e.total_spent > l.limit_amount THEN 'exceeded'\n    WHEN e.total_spent > (l.limit_amount * 0.8) THEN 'warning'\n    ELSE 'ok'\n  END as limit_status,\n  CASE\n    WHEN l.limit_amount IS NOT NULL THEN ROUND((e.total_spent / l.limit_amount) * 100)\n    ELSE NULL\n  END as percent_used\nFROM expense_sum e\nLEFT JOIN category_limit l ON true;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        -544,
        -656
      ],
      "id": "06e605ac-237d-46b4-a4e1-4a60fd76f817",
      "name": "Checking_limits",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        -416,
        -656
      ],
      "id": "37fd5867-d94f-4c5e-86dc-9186d4a15d13",
      "name": "Calc"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT \n  {{ $fromAI(\"amount\", \"–°—É–º–º–∞ –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏, —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ\", \"number\") }} as original_amount,\n  UPPER('{{ $fromAI(\"from_currency\", \"–ò–∑ –∫–∞–∫–æ–π –≤–∞–ª—é—Ç—ã –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å: —Å–æ–º/KGS, –¥–æ–ª–ª–∞—Ä/USD, –µ–≤—Ä–æ/EUR, —Ä—É–±–ª—å/RUB\", \"string\") }}') as from_currency,\n  UPPER('{{ $fromAI(\"to_currency\", \"–í –∫–∞–∫—É—é –≤–∞–ª—é—Ç—É –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å: —Å–æ–º/KGS, –¥–æ–ª–ª–∞—Ä/USD, –µ–≤—Ä–æ/EUR, —Ä—É–±–ª—å/RUB\", \"string\") }}') as to_currency,\n  get_exchange_rate(\n    UPPER('{{ $fromAI(\"from_currency\", \"–ò–∑ –∫–∞–∫–æ–π –≤–∞–ª—é—Ç—ã –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å: —Å–æ–º/KGS, –¥–æ–ª–ª–∞—Ä/USD, –µ–≤—Ä–æ/EUR, —Ä—É–±–ª—å/RUB\", \"string\") }}'),\n    UPPER('{{ $fromAI(\"to_currency\", \"–í –∫–∞–∫—É—é –≤–∞–ª—é—Ç—É –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å: —Å–æ–º/KGS, –¥–æ–ª–ª–∞—Ä/USD, –µ–≤—Ä–æ/EUR, —Ä—É–±–ª—å/RUB\", \"string\") }}'),\n    CURRENT_DATE\n  ) as rate,\n  convert_amount(\n    {{ $fromAI(\"amount\", \"–°—É–º–º–∞ –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏, —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ\", \"number\") }},\n    UPPER('{{ $fromAI(\"from_currency\", \"–ò–∑ –∫–∞–∫–æ–π –≤–∞–ª—é—Ç—ã –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å: —Å–æ–º/KGS, –¥–æ–ª–ª–∞—Ä/USD, –µ–≤—Ä–æ/EUR, —Ä—É–±–ª—å/RUB\", \"string\") }}'),\n    UPPER('{{ $fromAI(\"to_currency\", \"–í –∫–∞–∫—É—é –≤–∞–ª—é—Ç—É –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å: —Å–æ–º/KGS, –¥–æ–ª–ª–∞—Ä/USD, –µ–≤—Ä–æ/EUR, —Ä—É–±–ª—å/RUB\", \"string\") }}'),\n    CURRENT_DATE\n  ) as converted_amount,\n  TO_CHAR(CURRENT_DATE, 'DD.MM.YYYY') as conversion_date;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        -288,
        -656
      ],
      "id": "a68a759c-9a05-4be8-9c1e-11acbcff2e04",
      "name": "Convert_currency",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH latest_rates AS (\n  SELECT DISTINCT ON (from_currency, to_currency)\n    from_currency,\n    to_currency,\n    rate,\n    date,\n    source\n  FROM exchange_rates\n  WHERE from_currency IN ('KGS', 'USD', 'EUR', 'RUB')\n    AND to_currency IN ('KGS', 'USD', 'EUR', 'RUB')\n    AND from_currency != to_currency\n  ORDER BY from_currency, to_currency, date DESC\n)\nSELECT \n  from_currency,\n  to_currency,\n  rate,\n  TO_CHAR(date, 'DD.MM.YYYY') as rate_date,\n  source,\n  CASE \n    WHEN from_currency = 'USD' AND to_currency = 'KGS' THEN 'üíµ –î–æ–ª–ª–∞—Ä ‚Üí –°–æ–º'\n    WHEN from_currency = 'EUR' AND to_currency = 'KGS' THEN 'üí∂ –ï–≤—Ä–æ ‚Üí –°–æ–º'\n    WHEN from_currency = 'RUB' AND to_currency = 'KGS' THEN 'üí∑ –†—É–±–ª—å ‚Üí –°–æ–º'\n    ELSE from_currency || ' ‚Üí ' || to_currency\n  END as display_name\nFROM latest_rates\nORDER BY \n  CASE from_currency \n    WHEN 'USD' THEN 1 \n    WHEN 'EUR' THEN 2 \n    WHEN 'RUB' THEN 3 \n    ELSE 4 \n  END, to_currency;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        -160,
        -656
      ],
      "id": "75a9e5ee-41a0-4155-a64a-35976bb50a33",
      "name": "Get_exchange_rates",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM safe_update_transaction(\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }}::BIGINT,\n  '{{ $fromAI(\"transaction_type\", \"–¢–∏–ø: expense –∏–ª–∏ income (–ù–ï '—Ä–∞—Å—Ö–æ–¥' –∏–ª–∏ '–¥–æ—Ö–æ–¥'!)\", \"string\") }}',\n  '{{ $fromAI(\"transaction_id\", \"ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–ª–∏ 'last' –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–π\", \"string\") }}',\n  '{{ $fromAI(\"field\", \"–ü–æ–ª–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è: amount, category, description, date, currency\", \"string\") }}',\n  '{{ $fromAI(\"new_value\", \"–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–¥–ª—è –¥–∞—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–π DD.MM.YYYY)\", \"string\") }}'\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        -32,
        -656
      ],
      "id": "b14f6902-3522-408b-8e82-eb076a8ebfa8",
      "name": "Edit_transaction",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH found_transaction AS (\n  SELECT \n    CASE \n      WHEN LOWER('{{ $fromAI(\"transaction_id\", \"ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–ª–∏ 'last' –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–π\", \"string\") }}') = 'last' \n      THEN get_last_transaction({{ $('Telegram Bot Trigger').first().json.message.from.id }}, LOWER('{{ $fromAI(\"transaction_type\", \"–¢–∏–ø: expense –∏–ª–∏ income\", \"string\") }}'))\n      ELSE CAST(NULLIF('{{ $fromAI(\"transaction_id\", \"ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–ª–∏ 'last' –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–π\", \"string\") }}', 'last') AS INTEGER)\n    END as tid\n),\ndelete_expense AS (\n  UPDATE expenses\n  SET deleted_at = NOW(),\n      deleted_by = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n  WHERE id = (SELECT tid FROM found_transaction)\n    AND user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND deleted_at IS NULL\n    AND LOWER('{{ $fromAI(\"transaction_type\", \"–¢–∏–ø: expense –∏–ª–∏ income\", \"string\") }}') = 'expense'\n  RETURNING id, amount, category, currency, date\n),\ndelete_income AS (\n  UPDATE income\n  SET deleted_at = NOW(),\n      deleted_by = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n  WHERE id = (SELECT tid FROM found_transaction)\n    AND user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND deleted_at IS NULL\n    AND LOWER('{{ $fromAI(\"transaction_type\", \"–¢–∏–ø: expense –∏–ª–∏ income\", \"string\") }}') = 'income'\n  RETURNING id, amount, category, currency, date\n),\nlog_deletion AS (\n  SELECT log_transaction_change(\n    LOWER('{{ $fromAI(\"transaction_type\", \"–¢–∏–ø: expense –∏–ª–∏ income\", \"string\") }}'),\n    (SELECT tid FROM found_transaction),\n    'deleted',\n    NULL,\n    NULL,\n    NULL,\n    {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n  ) as history_id\n)\nSELECT \n  COALESCE(\n    (SELECT row_to_json(delete_expense.*) FROM delete_expense),\n    (SELECT row_to_json(delete_income.*) FROM delete_income)\n  ) as deleted_transaction,\n  (SELECT history_id FROM log_deletion) as history_id,\n  'deleted' as status;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        96,
        -656
      ],
      "id": "ea753789-e03f-43e8-a009-79b1d7706043",
      "name": "Delete_transaction",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH found_transaction AS (\n  SELECT \n    CASE \n      WHEN LOWER('{{ $fromAI(\"transaction_id\", \"ID —É–¥–∞–ª—ë–Ω–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–ª–∏ 'last'\", \"string\") }}') = 'last' \n      THEN get_last_transaction({{ $('Telegram Bot Trigger').first().json.message.from.id }}, LOWER('{{ $fromAI(\"transaction_type\", \"–¢–∏–ø: expense –∏–ª–∏ income\", \"string\") }}'))\n      ELSE CAST(NULLIF('{{ $fromAI(\"transaction_id\", \"ID —É–¥–∞–ª—ë–Ω–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–ª–∏ 'last'\", \"string\") }}', 'last') AS INTEGER)\n    END as tid\n),\nrestore_expense AS (\n  UPDATE expenses\n  SET deleted_at = NULL,\n      deleted_by = NULL\n  WHERE id = (SELECT tid FROM found_transaction)\n    AND user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND deleted_at IS NOT NULL\n    AND LOWER('{{ $fromAI(\"transaction_type\", \"–¢–∏–ø: expense –∏–ª–∏ income\", \"string\") }}') = 'expense'\n  RETURNING id, amount, category, currency, date\n),\nrestore_income AS (\n  UPDATE income\n  SET deleted_at = NULL,\n      deleted_by = NULL\n  WHERE id = (SELECT tid FROM found_transaction)\n    AND user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND deleted_at IS NOT NULL\n    AND LOWER('{{ $fromAI(\"transaction_type\", \"–¢–∏–ø: expense –∏–ª–∏ income\", \"string\") }}') = 'income'\n  RETURNING id, amount, category, currency, date\n),\nlog_restore AS (\n  SELECT log_transaction_change(\n    LOWER('{{ $fromAI(\"transaction_type\", \"–¢–∏–ø: expense –∏–ª–∏ income\", \"string\") }}'),\n    (SELECT tid FROM found_transaction),\n    'restored',\n    NULL,\n    NULL,\n    NULL,\n    {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n  ) as history_id\n)\nSELECT \n  COALESCE(\n    (SELECT row_to_json(restore_expense.*) FROM restore_expense),\n    (SELECT row_to_json(restore_income.*) FROM restore_income)\n  ) as restored_transaction,\n  (SELECT history_id FROM log_restore) as history_id,\n  'restored' as status;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        224,
        -656
      ],
      "id": "dd2b5a90-c69a-439b-8b70-f0cc48601a88",
      "name": "Restore_transaction",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH found_transaction AS (\n  SELECT \n    CASE \n      WHEN LOWER('{{ $fromAI(\"transaction_id\", \"ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–ª–∏ 'last'\", \"string\") }}') = 'last' \n      THEN get_last_transaction({{ $('Telegram Bot Trigger').first().json.message.from.id }}, LOWER('{{ $fromAI(\"transaction_type\", \"–¢–∏–ø: expense –∏–ª–∏ income\", \"string\") }}'))\n      ELSE CAST(NULLIF('{{ $fromAI(\"transaction_id\", \"ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–ª–∏ 'last'\", \"string\") }}', 'last') AS INTEGER)\n    END as tid\n)\nSELECT \n  id,\n  action,\n  field_changed,\n  old_value,\n  new_value,\n  changed_by,\n  TO_CHAR(changed_at, 'DD.MM.YYYY HH24:MI:SS') as changed_at\nFROM transaction_history\nWHERE transaction_type = LOWER('{{ $fromAI(\"transaction_type\", \"–¢–∏–ø: expense –∏–ª–∏ income\", \"string\") }}')\n  AND transaction_id = (SELECT tid FROM found_transaction)\nORDER BY changed_at DESC\nLIMIT 50;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        352,
        -656
      ],
      "id": "53dbd3e8-7069-4ca9-99bc-62b89451d043",
      "name": "Get_transaction_history",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM create_recurring_payment(\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }}::BIGINT,\n  '{{ $fromAI(\"title\", \"–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä Netflix, –ê—Ä–µ–Ω–¥–∞ –æ—Ñ–∏—Å–∞)\", \"string\") }}'::VARCHAR,\n  {{ $fromAI(\"amount\", \"–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞, —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ\", \"number\") }}::NUMERIC,\n  UPPER('{{ $fromAI(\"currency\", \"–í–∞–ª—é—Ç–∞: KGS/—Å–æ–º, USD/–¥–æ–ª–ª–∞—Ä, EUR/–µ–≤—Ä–æ, RUB/—Ä—É–±–ª—å\", \"string\") }}')::VARCHAR,\n  '{{ $fromAI(\"category\", \"–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ä–∞—Å—Ö–æ–¥–∞: –ø—Ä–æ–¥—É–∫—Ç—ã, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –∞—Ä–µ–Ω–¥–∞ –æ—Ñ–∏—Å–∞, –ø–æ–¥–ø–∏—Å–∫–∏ –∏ —Ç.–¥.\", \"string\") }}'::VARCHAR,\n  LOWER('{{ $fromAI(\"frequency\", \"–ß–∞—Å—Ç–æ—Ç–∞: daily (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ), weekly (–µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ), monthly (–µ–∂–µ–º–µ—Å—è—á–Ω–æ), yearly (–µ–∂–µ–≥–æ–¥–Ω–æ)\", \"string\") }}')::VARCHAR,\n  COALESCE(TO_DATE(NULLIF('{{ $fromAI(\"start_date\", \"–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–µ–≥–æ–¥–Ω—è)\", \"string\", \"\") }}', ''), 'DD.MM.YYYY'), CURRENT_DATE),\n  NULL::TEXT,\n  'expense'::VARCHAR,\n  {{ $fromAI(\"interval_value\", \"–ö–∞–∂–¥—ã–µ N –ø–µ—Ä–∏–æ–¥–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä 1 –¥–ª—è –∫–∞–∂–¥—ã–π –º–µ—Å—è—Ü, 2 –¥–ª—è –∫–∞–∂–¥—ã–µ 2 –Ω–µ–¥–µ–ª–∏)\", \"number\", 1) }}::INTEGER,\n  {{ $fromAI(\"remind_days_before\", \"–ó–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3)\", \"number\", 3) }}::INTEGER,\n  {{ $fromAI(\"auto_create\", \"–°–æ–∑–¥–∞–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: true –∏–ª–∏ false (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é false)\", \"boolean\", false) }}::BOOLEAN\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        480,
        -656
      ],
      "id": "439e1060-23c9-4d86-84a3-37ea30316fbe",
      "name": "Create_recurring_payment",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT \n  id,\n  title,\n  amount,\n  currency,\n  category,\n  frequency,\n  interval_value,\n  TO_CHAR(next_payment_date, 'DD.MM.YYYY') as next_payment_date,\n  remind_days_before,\n  auto_create,\n  total_executions,\n  TO_CHAR(created_at, 'DD.MM.YYYY') as created_at\nFROM recurring_payments\nWHERE user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n  AND is_active = true\n  AND (end_date IS NULL OR end_date >= CURRENT_DATE)\nORDER BY next_payment_date ASC;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        608,
        -656
      ],
      "id": "de4eaba6-63c5-44aa-bccc-56c97f3b11b8",
      "name": "List_recurring_payments",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE recurring_payments\nSET \n  is_active = false,\n  end_date = CURRENT_DATE,\n  updated_at = NOW()\nWHERE id = {{ $fromAI(\"payment_id\", \"ID –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è –æ—Ç–º–µ–Ω—ã\", \"number\") }}\n  AND user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n  AND is_active = true\nRETURNING \n  id,\n  title,\n  amount,\n  currency,\n  'cancelled' as status,\n  TO_CHAR(end_date, 'DD.MM.YYYY') as cancelled_date;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        736,
        -656
      ],
      "id": "f762c277-26b3-459e-ae4d-6797f0aa85df",
      "name": "Cancel_recurring_payment",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM get_budget_forecast(\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }}::BIGINT\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        864,
        -656
      ],
      "id": "bce21b0f-6ce1-40e9-bc9c-7d402299917f",
      "name": "Get_budget_forecast",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT \n  id,\n  notification_type,\n  title,\n  message,\n  priority,\n  is_read,\n  TO_CHAR(created_at, 'DD.MM.YYYY HH24:MI') as created_at,\n  related_transaction_id,\n  metadata\nFROM notifications\nWHERE user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n  AND ({{ $fromAI(\"unread_only\", \"–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ: true –∏–ª–∏ false\", \"boolean\", true) }} = false OR is_read = false)\nORDER BY \n  CASE priority \n    WHEN 'urgent' THEN 1 \n    WHEN 'high' THEN 2 \n    WHEN 'normal' THEN 3 \n    ELSE 4 \n  END,\n  created_at DESC\nLIMIT {{ $fromAI(\"limit\", \"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –ø–æ–∫–∞–∑–∞\", \"number\", 10) }};",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        992,
        -656
      ],
      "id": "8804e28a-ac2b-44a5-93f5-9dde9603bd74",
      "name": "Get_notifications",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO budget_alerts_config (\n  user_id,\n  budget_warning_threshold,\n  budget_critical_threshold,\n  category_warning_threshold,\n  category_critical_threshold,\n  max_alerts_per_day,\n  updated_at\n) VALUES (\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }},\n  {{ $fromAI(\"budget_warning\", \"–ü–æ—Ä–æ–≥ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –±—é–¥–∂–µ—Ç–µ –≤ % (–Ω–∞–ø—Ä–∏–º–µ—Ä 75, 80, 90)\", \"number\", 80) }},\n  {{ $fromAI(\"budget_critical\", \"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ä–æ–≥ –±—é–¥–∂–µ—Ç–∞ –≤ % (–æ–±—ã—á–Ω–æ 100)\", \"number\", 100) }},\n  {{ $fromAI(\"category_warning\", \"–ü–æ—Ä–æ–≥ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –¥–ª—è –ª–∏–º–∏—Ç–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –≤ %\", \"number\", 80) }},\n  {{ $fromAI(\"category_critical\", \"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ä–æ–≥ –¥–ª—è –ª–∏–º–∏—Ç–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –≤ %\", \"number\", 100) }},\n  {{ $fromAI(\"max_alerts_per_day\", \"–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –¥–µ–Ω—å\", \"number\", 5) }},\n  NOW()\n)\nON CONFLICT (user_id) \nDO UPDATE SET\n  budget_warning_threshold = EXCLUDED.budget_warning_threshold,\n  budget_critical_threshold = EXCLUDED.budget_critical_threshold,\n  category_warning_threshold = EXCLUDED.category_warning_threshold,\n  category_critical_threshold = EXCLUDED.category_critical_threshold,\n  max_alerts_per_day = EXCLUDED.max_alerts_per_day,\n  updated_at = NOW()\nRETURNING \n  user_id,\n  budget_warning_threshold,\n  budget_critical_threshold,\n  category_warning_threshold,\n  category_critical_threshold,\n  max_alerts_per_day,\n  'configured' as status;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        1120,
        -656
      ],
      "id": "0a7c58af-74ba-4f92-9cca-a6181117df1a",
      "name": "Configure_alerts",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n)\nSELECT * FROM get_income_expense_stats(\n  (SELECT workspace_id FROM user_workspace),\n  '{{ $fromAI(\"start_date\", \"–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∞—á–∞–ª–æ –º–µ—Å—è—Ü–∞)\", \"string\", DATE_TRUNC('month', CURRENT_DATE)::TEXT) }}'::DATE,\n  '{{ $fromAI(\"end_date\", \"–î–∞—Ç–∞ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–∏–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–µ–≥–æ–¥–Ω—è)\", \"string\", CURRENT_DATE::TEXT) }}'::DATE\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        1248,
        -656
      ],
      "id": "a2f8b5c3-9d4e-4f15-8a61-2b3c75e48901",
      "name": "Get_income_expense_stats",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n)\nSELECT * FROM get_top_expense_categories(\n  (SELECT workspace_id FROM user_workspace),\n  '{{ $fromAI(\"start_date\", \"–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∞—á–∞–ª–æ –º–µ—Å—è—Ü–∞)\", \"string\", DATE_TRUNC('month', CURRENT_DATE)::TEXT) }}'::DATE,\n  '{{ $fromAI(\"end_date\", \"–î–∞—Ç–∞ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–∏–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–µ–≥–æ–¥–Ω—è)\", \"string\", CURRENT_DATE::TEXT) }}'::DATE,\n  {{ $fromAI(\"limit\", \"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è –ø–æ–∫–∞–∑–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10)\", \"number\", 10) }}\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        1376,
        -656
      ],
      "id": "b3e9f7d2-8c5f-4e26-9b72-3d4f86e59f12",
      "name": "Get_top_categories",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM get_user_workspaces(\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }}::BIGINT\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        1504,
        -656
      ],
      "id": "c4f0a1e3-9e5f-4f37-8c83-4e5g97f6a023",
      "name": "Get_workspaces",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM update_spending_patterns(\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }}::BIGINT\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        1632,
        -656
      ],
      "id": "d5e1b2f4-ae6f-4e48-9d94-5f6ha8g7b134",
      "name": "Update_spending_patterns",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n)\nINSERT INTO budgets (user_id, workspace_id, month, budget_amount, currency)\nSELECT\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }},\n  uw.workspace_id,\n  COALESCE(\n    '{{ $fromAI(\"month\", \"–ú–µ—Å—è—Ü –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM (–Ω–∞–ø—Ä–∏–º–µ—Ä 2025-11), –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω - —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü\", \"string\", \"\") }}',\n    TO_CHAR(CURRENT_DATE, 'YYYY-MM')\n  ),\n  {{ $fromAI(\"amount\", \"–°—É–º–º–∞ –±—é–¥–∂–µ—Ç–∞, —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ\", \"number\") }},\n  UPPER('{{ $fromAI(\"currency\", \"–í–∞–ª—é—Ç–∞ –±—é–¥–∂–µ—Ç–∞: KGS/USD/EUR/RUB (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é KGS)\", \"string\", \"KGS\") }}')\nFROM user_workspace uw\nON CONFLICT (user_id, month) \nDO UPDATE SET \n  budget_amount = EXCLUDED.budget_amount,\n  currency = EXCLUDED.currency,\n  updated_at = NOW()\nRETURNING \n  id,\n  month,\n  budget_amount,\n  currency,\n  'budget_set' as status;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        1760,
        -656
      ],
      "id": "e6f2c3d5-bf7f-4f59-8e05-6g7hi9j8k245",
      "name": "Set_budget",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n)\nINSERT INTO limits (user_id, workspace_id, category, month, limit_amount, currency)\nSELECT\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }},\n  uw.workspace_id,\n  '{{ $fromAI(\"category\", \"–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–ª—è –ª–∏–º–∏—Ç–∞: –ø—Ä–æ–¥—É–∫—Ç—ã, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –∫–∞—Ñ–µ/—Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã –∏ —Ç.–¥.\", \"string\") }}',\n  COALESCE(\n    '{{ $fromAI(\"month\", \"–ú–µ—Å—è—Ü –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM (–Ω–∞–ø—Ä–∏–º–µ—Ä 2025-11), –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω - —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü\", \"string\", \"\") }}',\n    TO_CHAR(CURRENT_DATE, 'YYYY-MM')\n  ),\n  {{ $fromAI(\"amount\", \"–°—É–º–º–∞ –ª–∏–º–∏—Ç–∞, —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ\", \"number\") }},\n  UPPER('{{ $fromAI(\"currency\", \"–í–∞–ª—é—Ç–∞ –ª–∏–º–∏—Ç–∞: KGS/USD/EUR/RUB (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é KGS)\", \"string\", \"KGS\") }}')\nFROM user_workspace uw\nON CONFLICT (user_id, category, month) \nDO UPDATE SET \n  limit_amount = EXCLUDED.limit_amount,\n  currency = EXCLUDED.currency,\n  updated_at = NOW()\nRETURNING \n  id,\n  category,\n  month,\n  limit_amount,\n  currency,\n  'limit_set' as status;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        1888,
        -656
      ],
      "id": "f7g3d4e6-cg8f-4g60-9f16-7h8ij0k9l356",
      "name": "Set_category_limit",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.message.text }}",
        "options": {
          "systemMessage": "–¢—ã —Ñ–∏–Ω–∞–Ω—Å–∏—Å—Ç –∏ –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –æ—Ç—á–µ—Ç–∞–º –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—É /get_week_report. –¢—ã –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∞—Ç—å –û—Ç—á–µ—Ç—ã –∑–∞ –ø–æ—Å–ª–µ–Ω—é—é –Ω–µ–¥–µ–ª—é –∏—Å–ø–æ–ª—å–∑—É—è –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö Get_transaction_history1, –¥–µ–ª–∏—Ç—å —ç—Ç—É –Ω–µ–¥–µ–ª—é –Ω–∞ –¥–Ω–∏, –∏ —Å–∫–æ–ª—å–∫–æ –±—ã–ª–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ –≤ –∫–∞–∫–æ–π –¥–µ–Ω—å"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -1920,
        -544
      ],
      "id": "68c1d461-69c0-4dc3-ab9e-1820316ae87f",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -2128,
        -312
      ],
      "id": "d3d8ff01-953a-43bb-896f-d008c62def31",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "SyI2pOUeSfbt1JRh",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.message.text }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -2000,
        -208
      ],
      "id": "1bb999a7-a37c-4bc8-80b8-4edc5b67a2f8",
      "name": "Simple Memory"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        -1872,
        -312
      ],
      "id": "22957e54-22af-470b-ab90-edce09ca3310",
      "name": "Calculator"
    },
    {
      "parameters": {
        "resource": "pdf",
        "pdfTemplateId": "c1d77b23eda325b2",
        "jsonParameters": true,
        "propertiesJson": "{\n  \"name\": \"apitemplate.io\",\n  \"sales\": {\n    \"data\": [30,40,45,50,49,60,70,91,125],\n    \"categories\": [1991,1992,1993,1994,1995,1996,1997,1998,1999]\n  },\n  \"team\": {\n    \"data\": [44,55,13,43,22],\n    \"labels\": [\"Team A\",\"Team B\",\"Team C\",\"Team D\",\"Team E\"]\n  }\n}"
      },
      "type": "n8n-nodes-base.apiTemplateIo",
      "typeVersion": 1,
      "position": [
        -1408,
        -536
      ],
      "id": "33668895-83f2-45c2-804a-0b66019695ac",
      "name": "Create a pdf",
      "credentials": {
        "apiTemplateIoApi": {
          "id": "WCFzWPXSnueTP8ef",
          "name": "APITemplate.io Financer"
        }
      }
    },
    {
      "parameters": {
        "resource": "pdf",
        "pdfTemplateId": "c1d77b23eda325b2",
        "jsonParameters": true,
        "propertiesJson": "{\n  \"name\": \"apitemplate.io\",\n  \"sales\": {\n    \"data\": [30,40,45,50,49,60,70,91,125],\n    \"categories\": [1991,1992,1993,1994,1995,1996,1997,1998,1999]\n  },\n  \"team\": {\n    \"data\": [44,55,13,43,22],\n    \"labels\": [\"Team A\",\"Team B\",\"Team C\",\"Team D\",\"Team E\"]\n  }\n}"
      },
      "type": "n8n-nodes-base.apiTemplateIoTool",
      "typeVersion": 1,
      "position": [
        -3024,
        656
      ],
      "id": "31fa010a-3462-4268-99b7-3120343b46c2",
      "name": "Create a pdf in APITemplate.io",
      "credentials": {
        "apiTemplateIoApi": {
          "id": "WCFzWPXSnueTP8ef",
          "name": "APITemplate.io Financer"
        }
      }
    },
    {
      "parameters": {
        "description": "–ò—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—É—é –Ω–æ–¥—É –¥–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã —Å–≤–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∞–Ω–Ω—ã–µ –≤ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π json —Ñ–æ—Ä–º–∞—Ç",
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º JSON –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞\nlet jsonData = $input.item.json.body.data;\n\n// –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã JSON\nlet result = {\n  \"name\": jsonData.name,\n  \"sales\": {\n    \"data\": jsonData.sales.data,\n    \"categories\": jsonData.sales.categories\n  },\n  \"team\": {\n    \"data\": jsonData.team.data,\n    \"labels\": jsonData.team.labels\n  }\n};\n\nreturn result;"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        -1744,
        -312
      ],
      "id": "2d174262-76e5-427b-bc04-86c1737c3d39",
      "name": "Code Tool"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH week_range AS (\n  SELECT \n    DATE_TRUNC('week', CURRENT_DATE AT TIME ZONE 'Asia/Bishkek') as week_start,\n    DATE_TRUNC('week', CURRENT_DATE AT TIME ZONE 'Asia/Bishkek') + INTERVAL '6 days' as week_end\n),\nincome_sum AS (\n  SELECT COALESCE(SUM(amount), 0) as total\n  FROM income\n  WHERE user_id = {{ $('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è').item.json.user_id }}\n    AND date >= (SELECT week_start FROM week_range)::date\n    AND date <= (SELECT week_end FROM week_range)::date\n),\nexpense_sum AS (\n  SELECT COALESCE(SUM(amount), 0) as total\n  FROM expenses\n  WHERE user_id = {{ $('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è').item.json.user_id }}\n    AND date >= (SELECT week_start FROM week_range)::date\n    AND date <= (SELECT week_end FROM week_range)::date\n),\ntop_categories AS (\n  SELECT \n    category,\n    SUM(amount) as total,\n    COUNT(*) as count\n  FROM expenses\n  WHERE user_id = {{ $('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è').item.json.user_id }}\n    AND date >= (SELECT week_start FROM week_range)::date\n    AND date <= (SELECT week_end FROM week_range)::date\n  GROUP BY category\n  ORDER BY total DESC\n  LIMIT 3\n),\ntransaction_count AS (\n  SELECT \n    (SELECT COUNT(*) FROM income WHERE user_id = {{ $('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è').item.json.user_id }} \n     AND date >= (SELECT week_start FROM week_range)::date\n     AND date <= (SELECT week_end FROM week_range)::date) as income_count,\n    (SELECT COUNT(*) FROM expenses WHERE user_id = {{ $('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è').item.json.user_id }}\n     AND date >= (SELECT week_start FROM week_range)::date\n     AND date <= (SELECT week_end FROM week_range)::date) as expense_count\n)\nSELECT \n  TO_CHAR((SELECT week_start FROM week_range), 'DD.MM.YYYY') as week_start_formatted,\n  TO_CHAR((SELECT week_end FROM week_range), 'DD.MM.YYYY') as week_end_formatted,\n  (SELECT total FROM income_sum) as total_income,\n  (SELECT total FROM expense_sum) as total_expenses,\n  (SELECT total FROM income_sum) - (SELECT total FROM expense_sum) as profit,\n  (SELECT income_count FROM transaction_count) as income_count,\n  (SELECT expense_count FROM transaction_count) as expense_count,\n  (SELECT income_count + expense_count FROM transaction_count) as total_transactions,\n  COALESCE((SELECT JSON_AGG(JSON_BUILD_OBJECT(\n    'category', category,\n    'total', total,\n    'count', count\n  )) FROM top_categories), '[]'::json) as top_categories;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        -1488,
        -272
      ],
      "id": "f474a56f-229c-4160-99e1-d1adc70b4296",
      "name": "Get_week_statistic",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "fieldsToSummarize": {
          "values": [
            {}
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.summarize",
      "typeVersion": 1.1,
      "position": [
        -3024,
        432
      ],
      "id": "74046dbb-f83e-4c20-a742-4ad1558fa927",
      "name": "Summarize"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -3024,
        -208
      ],
      "id": "700d1e69-b971-46b3-8db9-a3248eb98b2c",
      "name": "Create a row"
    }
  ],
  "pinData": {},
  "connections": {
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Bot Trigger": {
      "main": [
        [
          {
            "node": "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message Type Switch": {
      "main": [
        [
          {
            "node": "Download Voice File",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Text Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Voice File": {
      "main": [
        [
          {
            "node": "Transcribe Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe Audio": {
      "main": [
        [
          {
            "node": "Financial Assistant",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Text Data": {
      "main": [
        [
          {
            "node": "Financial Assistant",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Conversation Memory": {
      "ai_memory": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Financial Assistant": {
      "main": [
        [
          {
            "node": "Send Telegram Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞": {
      "main": [
        [
          {
            "node": "–ê–Ω–∞–ª–∏–∑ —Ä–∞—Å—Ö–æ–¥–æ–≤",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "–ê–Ω–∞–ª–∏–∑ –¥–æ—Ö–æ–¥–æ–≤",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Message Type Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add_income": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Parsing_of_the_month": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Add_expense": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Checking_limits": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Calc": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Convert_currency": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get_exchange_rates": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Edit_transaction": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Delete_transaction": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Restore_transaction": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get_transaction_history": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Create_recurring_payment": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "List_recurring_payments": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Cancel_recurring_payment": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get_budget_forecast": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get_notifications": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Configure_alerts": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get_income_expense_stats": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get_top_categories": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get_workspaces": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Update_spending_patterns": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Set_budget": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Set_category_limit": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Calculator": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Create a pdf",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create a pdf in APITemplate.io": {
      "ai_tool": [
        []
      ]
    },
    "Code Tool": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get_week_statistic": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "452cf336-fb42-482f-a0c3-2bea20974d0e",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "bcdca7003a882ee2cf9d975eab94cc02ba456a1ed2ac37511421cb2edeb80c62"
  },
  "id": "2a2MkaY2pl1itHZ2",
  "tags": []
}