{
  "nodes": [
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "maxRetries": 3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        1344,
        2544
      ],
      "id": "6638560f-7db2-458f-9de6-49f65b5adca6",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "YWdBHhtpkxTSXDR7",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "updates": [
          "message",
          "callback_query"
        ],
        "additionalFields": {}
      },
      "id": "08e15c83-0e07-4ccf-8d04-1908eacf683d",
      "name": "Telegram Bot Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.1,
      "position": [
        -1344,
        1988
      ],
      "webhookId": "b8605f3e-0f52-4ffc-a4c9-1728eb0e09e2",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message.voice.file_id }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    },
                    "id": "d697a3d5-018a-4cf0-867e-a877c10d6267"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Voice"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "daily-report-cmd",
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "^(/daily_report|ежедневный отчёт|ежедневный отчет|отчёт за сегодня|отчет за сегодня|дейли|daily|^отчет$|^отчёт$)",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Daily Report"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "weekly-report-cmd",
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "^(/weekly_report|недельный отчёт|недельный отчет|отчет за неделю|отчёт за неделю)",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Weekly Report"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "monthly-report-cmd",
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "^(/monthly_report|месячный отчёт|месячный отчет|отчет за месяц|отчёт за месяц)",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Monthly Report"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "period-report-cmd",
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "^(отчет за период|отчёт за период|отчет с \\d|отчёт с \\d|период с)",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Period Report"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "profile-cmd",
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "^(/profile|профиль|мой профиль)",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Profile"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "categories-cmd",
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "^(/categories|категории|по категориям|отчет по категориям)",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Categories"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "budget-cmd",
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "^(/budget|бюджет|мой бюджет)",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Budget"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "balance-cmd",
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "^(/balance|баланс|мой баланс)",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Balance"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "settings-cmd",
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "^(/settings|настройки)",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Settings"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "currency-cmd",
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "^(/currency|валюты|курсы валют)",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Currency"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "help-cmd",
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "^(/help|помощь|справка)",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Help"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "text-fallback",
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Text"
            }
          ]
        },
        "options": {}
      },
      "id": "2e236487-1399-42e3-95a5-e7b4da69bbe2",
      "name": "Message Type Switch",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        224,
        2852
      ]
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $json.message.voice.file_id }}",
        "additionalFields": {}
      },
      "id": "f2a01955-3412-490f-8e29-8581c81f4837",
      "name": "Download Voice File",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        448,
        2208
      ],
      "webhookId": "8fa0a59a-be53-4897-83bb-5b18ed71b529",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "id": "b81eb12e-4dad-4974-a50f-29d0715cf76c",
      "name": "Transcribe Audio",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.6,
      "position": [
        672,
        2208
      ],
      "credentials": {
        "openAiApi": {
          "id": "YWdBHhtpkxTSXDR7",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d6af7fa1-c31a-4514-ae63-397699bf8b21",
              "name": "text",
              "value": "={{ $('Telegram Bot Trigger').first().json.message.text }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1120,
        4184
      ],
      "id": "ba3829a6-1734-4a61-a7f1-f0cc6b919778",
      "name": "Prepare Text Data"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{$('Telegram Bot Trigger').first().json.message.message_id }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        1472,
        2544
      ],
      "id": "1da1480d-781f-457f-9085-154caf4379c7",
      "name": "Conversation Memory"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.text }}\n\n",
        "options": {
          "systemMessage": "=Ты — AI финансовый помощник с доступом к Supabase базе данных для управления личными и корпоративными финансами в Кыргызстане.\n\n👤 ВАЛЮТА ПОЛЬЗОВАТЕЛЯ: {{ $json.preferred_currency || 'KGS' }}\n\n⚙️ ВАЖНЫЕ ПРАВИЛА:\n1. Workspace определяется АВТОМАТИЧЕСКИ - НЕ спрашивай пользователя \"в каком workspace\"\n2. Если валюта НЕ указана в сообщении - используй валюту пользователя (см. выше)\n3. СРАЗУ вызывай инструмент, НЕ спрашивай подтверждений\n4. НЕ спрашивай \"укажите валюту\" - используй валюту пользователя\n\nПримеры:\n- \"Прибыль 5000 с клиента\" → СРАЗУ вызов Add_income с валютой пользователя\n- \"Потратил 200 на такси\" → СРАЗУ вызов Add_expense с валютой пользователя\n- \"Получил 1000 долларов\" → вызов Add_income с currency: USD (явно указано)\n\n💸 РАСХОДЫ: Add_expense\n- amount: число\n- currency: если НЕ указана - используй валюту пользователя\n- category: продукты, транспорт, кафе/рестораны, зарплата, налоги, прочее\n- description: опционально\n- date: DD.MM.YYYY (опционально)\n\n💰 ДОХОДЫ: Add_income\n- amount: число\n- currency: если НЕ указана - используй валюту пользователя\n- category: зарплата, продажи, инвестиции, подработка, кэшбек, прочее\n- description: опционально\n- date: DD.MM.YYYY (опционально)\n\nВАЛЮТЫ: сом/KGS, доллар/USD, евро/EUR, рубль/RUB"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        2808,
        2320
      ],
      "id": "3172c917-09d2-41ee-b4a1-76139bd95392",
      "name": "Financial Assistant",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Bot Trigger').first().json.message.chat.id }}",
        "text": "={{ $json.output }}",
        "additionalFields": {
          "appendAttribution": false,
          "reply_to_message_id": "={{ $('Telegram Bot Trigger').first().json.message.message_id }}"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        4688,
        2320
      ],
      "id": "a5fe5983-02ad-4b47-85c1-ac5a25a49ea4",
      "name": "Send Telegram Response",
      "webhookId": "a2f9609c-4b7a-4d51-aaa6-c889f56aefc9",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH monthly_data AS (\n  SELECT \n    category,\n    COUNT(*) as transaction_count,\n    SUM(amount) as total_amount,\n    AVG(amount) as avg_amount\n  FROM income\n  WHERE user_id = {{ $json.user_id }}\n    AND TO_CHAR(date, 'YYYY-MM') = '{{ $json.year_month }}'\n    {{ $json.category ? \"AND category = '\" + $json.category + \"'\" : \"\" }}\n  GROUP BY category\n  ORDER BY total_amount DESC\n)\nSELECT \n  *,\n  (SELECT SUM(total_amount) FROM monthly_data) as grand_total\nFROM monthly_data;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1120,
        5836
      ],
      "id": "399cc67a-633a-4718-ae2c-e598210abcc2",
      "name": "Анализ доходов",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "9af39ade-d2ac-4587-b4cd-bccb18fece32",
              "leftValue": "={{ $json.type }}",
              "rightValue": "расход",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1344,
        5740
      ],
      "id": "a89215f7-afbd-4cee-ba38-a1e2730bf818",
      "name": "Проверка типа"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH monthly_data AS (\n  SELECT \n    category,\n    COUNT(*) as transaction_count,\n    SUM(amount) as total_amount,\n    AVG(amount) as avg_amount\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    AND TO_CHAR(date, 'YYYY-MM') = '{{ $json.year_month }}'\n    {{ $json.category ? \"AND category = '\" + $json.category + \"'\" : \"\" }}\n  GROUP BY category\n  ORDER BY total_amount DESC\n)\nSELECT \n  *,\n  (SELECT SUM(total_amount) FROM monthly_data) as grand_total\nFROM monthly_data;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1120,
        5644
      ],
      "id": "080e5cfc-3537-4f5c-9d2c-7ec80b8cf4da",
      "name": "Анализ расходов",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO users (user_id, username, first_name, last_name, telegram_chat_id)\nVALUES (\n  {{ $json.user_id || $json.message.from.id }},\n  '{{ ($json.username || $json.message.from.username) || \"\" }}',\n  '{{ ($json.first_name || $json.message.from.first_name) || \"\" }}',\n  '{{ ($json.last_name || $json.message.from.last_name) || \"\" }}',\n  {{ $json.chat_id || $json.message.chat.id }}\n)\nON CONFLICT (user_id) \nDO UPDATE SET \n  username = EXCLUDED.username,\n  last_activity = NOW()\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1120,
        1988
      ],
      "id": "8fe31e36-33f5-48fc-ba93-341fd21cd7da",
      "name": "Регистрация/обновление пользователя",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "AIAccounter supabase"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "callback-exists",
                    "leftValue": "={{ $('Telegram Bot Trigger').first().json.callback_query }}",
                    "rightValue": "",
                    "operator": {
                      "type": "object",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Callback Query"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "message-exists",
                    "leftValue": "={{ $('Telegram Bot Trigger').first().json.message }}",
                    "rightValue": "",
                    "operator": {
                      "type": "object",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Regular Message"
            }
          ]
        },
        "options": {}
      },
      "id": "6da30aef-429b-40bb-ac18-9ca6dcf2f66b",
      "name": "Update Type Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -896,
        1988
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "settings-menu",
                    "leftValue": "={{ $('Telegram Bot Trigger').first().json.callback_query.data }}",
                    "rightValue": "^settings_menu$",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Settings Menu"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "change-currency",
                    "leftValue": "={{ $('Telegram Bot Trigger').first().json.callback_query.data }}",
                    "rightValue": "^(change_currency|settings_currency)$",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Change Currency"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "set-budget",
                    "leftValue": "={{ $('Telegram Bot Trigger').first().json.callback_query.data }}",
                    "rightValue": "^(set_budget|settings_budget)$",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Set Budget"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "view-profile",
                    "leftValue": "={{ $('Telegram Bot Trigger').first().json.callback_query.data }}",
                    "rightValue": "^view_profile$",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "View Profile"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "view-categories",
                    "leftValue": "={{ $('Telegram Bot Trigger').first().json.callback_query.data }}",
                    "rightValue": "^view_categories$",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "View Categories"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "view-budget",
                    "leftValue": "={{ $('Telegram Bot Trigger').first().json.callback_query.data }}",
                    "rightValue": "^view_budget$",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "View Budget"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "monthly-report",
                    "leftValue": "={{ $('Telegram Bot Trigger').first().json.callback_query.data }}",
                    "rightValue": "^monthly_report$",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Monthly Report"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "currency-select",
                    "leftValue": "={{ $('Telegram Bot Trigger').first().json.callback_query.data }}",
                    "rightValue": "^currency_(KGS|USD|EUR|RUB)$",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Currency Selected"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "convert-currency",
                    "leftValue": "={{ $('Telegram Bot Trigger').first().json.callback_query.data }}",
                    "rightValue": "^convert_currency$",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Convert Currency"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "view-balance",
                    "leftValue": "={{ $('Telegram Bot Trigger').first().json.callback_query.data }}",
                    "rightValue": "^view_balance$",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "View Balance"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "view-currency-rates",
                    "leftValue": "={{ $('Telegram Bot Trigger').first().json.callback_query.data }}",
                    "rightValue": "^view_currency_rates$",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "View Currency Rates"
            }
          ]
        },
        "options": {}
      },
      "id": "84b480e6-b707-43a1-a849-38ad8af9af3f",
      "name": "Callback Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        0,
        336
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6cb77ab8-f045-4576-b673-6ead0a3a5da6",
              "name": "message",
              "value": "={{ $node[\"Telegram Bot Trigger\"].json[\"message\"] || {} }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -672,
        3392
      ],
      "id": "2bb9f7da-e216-40b0-ae85-bc1a4337e544",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM get_user_profile({{ $('Edit Fields').first().json.message.from.id }});",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -448,
        3392
      ],
      "id": "3d21b2e2-beed-4472-9257-fb6cce963086",
      "name": "Check Onboarding Status",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "onboarding-check",
              "leftValue": "={{ $json.onboarding_completed }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -224,
        3392
      ],
      "id": "8a324305-241f-4168-8fa1-ceb64a31f278",
      "name": "Onboarding Router"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "merge-message-field",
              "name": "message",
              "value": "={{ $('Edit Fields').first().json.message }}",
              "type": "object"
            },
            {
              "id": "merge-currency-field",
              "name": "preferred_currency",
              "value": "={{ $('Check Onboarding Status').first().json.preferred_currency || 'KGS' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        0,
        3028
      ],
      "id": "844b6a2d-b34b-4136-bd92-6036fae8cb0c",
      "name": "Merge Onboarding Complete"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Check Onboarding Status').first().json.onboarding_step }}",
                    "rightValue": "usage_type",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Usage Type"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Check Onboarding Status').first().json.onboarding_step }}",
                    "rightValue": "currency",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Currency"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Check Onboarding Status').first().json.onboarding_step }}",
                    "rightValue": "monthly_budget",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Monthly Budget"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Check Onboarding Status').first().json.onboarding_step }}",
                    "rightValue": "occupation",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Occupation"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Check Onboarding Status').first().json.onboarding_step }}",
                    "rightValue": "country",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Country"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        0,
        4144
      ],
      "id": "83e1ded7-5851-4f06-908c-91498b5c4ea3",
      "name": "Handle Onboarding Step"
    },
    {
      "parameters": {
        "jsCode": "const message = $('Edit Fields').first().json.message;\nconst text = message?.text || '';\nconst step = $('Check Onboarding Status').first().json.onboarding_step;\n\nlet answer = '';\nlet answer_normalized = '';\n\nswitch(step) {\n  case 'usage_type':\n    // Личное/Бизнес\n    answer = text.trim();\n    answer_normalized = answer.toLowerCase().includes('бизнес') ? 'business' : 'personal';\n    break;\n    \n  case 'currency':\n    // KGS/USD/EUR/RUB\n    const currencyMap = {\n      'сом': 'KGS',\n      'сомах': 'KGS',\n      'kgs': 'KGS',\n      'доллар': 'USD',\n      'долларах': 'USD',\n      'usd': 'USD',\n      'евро': 'EUR',\n      'eur': 'EUR',\n      'рубл': 'RUB',\n      'рублях': 'RUB',\n      'rub': 'RUB'\n    };\n    answer = text.trim();\n    answer_normalized = 'KGS'; // default\n    for (const [key, value] of Object.entries(currencyMap)) {\n      if (answer.toLowerCase().includes(key)) {\n        answer_normalized = value;\n        break;\n      }\n    }\n    break;\n    \n  case 'monthly_budget':\n    // Число\n    answer = text.trim();\n    const num = parseFloat(answer.replace(/[^0-9.]/g, ''));\n    answer_normalized = isNaN(num) ? '0' : num.toString();\n    break;\n    \n  case 'occupation':\n    // Текст\n    answer = text.trim();\n    answer_normalized = answer;\n    break;\n    \n  case 'country':\n    // Текст\n    answer = text.trim();\n    answer_normalized = answer;\n    break;\n    \n  default:\n    answer = text.trim();\n    answer_normalized = answer;\n}\n\nreturn {\n  json: {\n    user_id: message.from.id,\n    step: step,\n    answer: answer,\n    answer_normalized: answer_normalized,\n    message: message\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        224,
        4192
      ],
      "id": "29dd3530-4237-4783-afaa-924a9388b149",
      "name": "Parse Onboarding Answer"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM save_onboarding_answer(\n  {{ $json.user_id }},\n  '{{ $json.step }}',\n  '{{ $json.answer_normalized }}'\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        448,
        4192
      ],
      "id": "d35c3056-750d-41ee-82fa-8a30721b30ce",
      "name": "Save Onboarding Answer",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "onboarding-complete-check",
              "leftValue": "={{ $json.completed }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        672,
        4192
      ],
      "id": "7b7b7fe3-7560-45ee-a63d-39ba01a325dc",
      "name": "Check If Onboarding Completed"
    },
    {
      "parameters": {
        "chatId": "={{ $('Parse Onboarding Answer').first().json.user_id }}",
        "text": "=🎉 Отлично! Регистрация завершена!\n\n━━━━━━━━━━━━━━━━━━━\n📊 ВАШИ НАСТРОЙКИ:\n━━━━━━━━━━━━━━━━━━━\n\n💼 Тип использования:\n   {{ $('Save Onboarding Answer').first().json.usage_type === 'personal' ? '👤 Личные финансы' : '🏢 Бизнес' }}\n\n💰 Валюта:\n   {{ $('Save Onboarding Answer').first().json.preferred_currency }} ({{ $('Save Onboarding Answer').first().json.currency_symbol }})\n\n� Месячный бюджет:\n   {{ $('Save Onboarding Answer').first().json.monthly_budget }} {{ $('Save Onboarding Answer').first().json.currency_symbol }}\n\n� Род деятельности:\n   {{ $('Save Onboarding Answer').first().json.occupation }}\n\n🌍 Страна:\n   {{ $('Save Onboarding Answer').first().json.country }}\n\n━━━━━━━━━━━━━━━━━━━\n\n✨ Теперь можете пользоваться ботом!\n\n📝 Просто напишите:\n  • \"Потратил 500 на еду\"\n  • \"Получил 50000 зарплата\"\n  • \"Отчет за неделю\"\n\n❓ Нужна помощь? → /help",
        "additionalFields": {
          "disable_notification": false,
          "disable_web_page_preview": true
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        896,
        4080
      ],
      "id": "6714d8c6-5d27-43aa-83f7-dec42bb1e846",
      "name": "Send Completion Message",
      "webhookId": "77193ff3-f6ba-4e7d-b5e6-94e4679a13e8",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Parse Onboarding Answer').first().json.user_id }}",
        "text": "={{ $json.question_text }}",
        "additionalFields": {
          "disable_notification": false,
          "disable_web_page_preview": true
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1120,
        4988
      ],
      "id": "148ed0d1-266a-4a89-8295-30252580d5ab",
      "name": "Send Next Question",
      "webhookId": "7ba383a1-04f7-4e16-a633-3718d5e40bac",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\nconst step = data.next_step;\n\nlet questionText = '';\nlet keyboard = null;\n\nswitch(step) {\n  case 'usage_type':\n    questionText = '👋 Добро пожаловать!\\n\\nДавайте начнем с короткой анкеты.\\n\\n1️⃣ Для чего вы будете использовать бота?';\n    keyboard = {\n      keyboard: [[\n        { text: '👤 Личное' },\n        { text: '💼 Бизнес' }\n      ]],\n      resize_keyboard: true,\n      one_time_keyboard: true\n    };\n    break;\n    \n  case 'currency':\n    questionText = '2️⃣ В какой валюте вы хотите вести учёт?';\n    keyboard = {\n      keyboard: [[\n        { text: '🇰🇬 Сом (KGS)' },\n        { text: '🇺🇸 Доллар (USD)' }\n      ], [\n        { text: '🇪🇺 Евро (EUR)' },\n        { text: '🇷🇺 Рубль (RUB)' }\n      ]],\n      resize_keyboard: true,\n      one_time_keyboard: true\n    };\n    break;\n    \n  case 'monthly_budget':\n    questionText = '3️⃣ Какой у вас примерный месячный бюджет? (введите число)';\n    keyboard = {\n      keyboard: [[\n        { text: '10000' },\n        { text: '30000' },\n        { text: '50000' }\n      ], [\n        { text: '100000' },\n        { text: 'Не знаю / Пропустить' }\n      ]],\n      resize_keyboard: true,\n      one_time_keyboard: true\n    };\n    break;\n    \n  case 'occupation':\n    questionText = '4️⃣ Чем вы занимаетесь? (например: студент, фрилансер, предприниматель)';\n    keyboard = {\n      keyboard: [[\n        { text: 'Студент' },\n        { text: 'Работаю по найму' }\n      ], [\n        { text: 'Фрилансер' },\n        { text: 'Предприниматель' }\n      ], [\n        { text: 'Другое' }\n      ]],\n      resize_keyboard: true,\n      one_time_keyboard: true\n    };\n    break;\n    \n  case 'country':\n    questionText = '5️⃣ В какой стране вы находитесь?';\n    keyboard = {\n      keyboard: [[\n        { text: '🇰🇬 Кыргызстан' },\n        { text: '🇰🇿 Казахстан' }\n      ], [\n        { text: '🇷🇺 Россия' },\n        { text: '🇺🇿 Узбекистан' }\n      ], [\n        { text: 'Другая страна' }\n      ]],\n      resize_keyboard: true,\n      one_time_keyboard: true\n    };\n    break;\n    \n  default:\n    questionText = 'Ошибка: неизвестный шаг анкеты';\n}\n\nreturn {\n  json: {\n    question_text: questionText,\n    keyboard: keyboard ? JSON.stringify(keyboard) : null,\n    step: step\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        896,
        4384
      ],
      "id": "c82b9b15-481d-4411-9162-f441ca6049e8",
      "name": "Prepare Question"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM get_onboarding_step({{ $('Edit Fields').first().json.message.from.id }});",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        672,
        4432
      ],
      "id": "5b2ba58b-edd3-4879-8941-c89032a18e3c",
      "name": "Get Current Onboarding Question",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n)\nINSERT INTO income (user_id, workspace_id, date, category, amount, currency, description, operation_type, source)\nSELECT\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }},\n  uw.workspace_id,\n  CASE \n    WHEN '{{ $fromAI(\"date\", \"Дата операции в формате DD.MM.YYYY. Если дата НЕ указана в сообщении пользователя - верни пустую строку\", \"string\", \"\") }}' = '' THEN (NOW() AT TIME ZONE 'Asia/Bishkek')::DATE\n    ELSE TO_DATE('{{ $fromAI(\"date\", \"Дата операции в формате DD.MM.YYYY. Если дата НЕ указана в сообщении пользователя - верни пустую строку\", \"string\", \"\") }}', 'DD.MM.YYYY')\n  END,\n  '{{ $fromAI(\"category\", \"Категория дохода: зарплата, продажи, инвестиции, подработка, кэшбек, прочее\", \"string\") }}',\n  {{ $fromAI(\"amount\", \"Сумма дохода, только число\", \"number\") }},\n  UPPER('{{ $fromAI(\"currency\", \"Валюта: сом/KGS, доллар/USD, евро/EUR, рубль/RUB. Если не указана - KGS\", \"string\", \"KGS\") }}'),\n  '{{ $fromAI(\"description\", \"Описание дохода, если есть\", \"string\", \"\") }}',\n  'доход',\n  'telegram'\nFROM user_workspace uw\nRETURNING id, workspace_id, TO_CHAR(date, 'DD.MM.YYYY') as date, category, amount, currency, description;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        1600,
        2544
      ],
      "id": "08ad34fa-1299-466b-86db-50580bd31c3a",
      "name": "Add_income",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n),\nmonth_mapping AS (\n  SELECT * FROM (VALUES\n    ('январь', 1), ('февраль', 2), ('март', 3), ('апрель', 4),\n    ('май', 5), ('июнь', 6), ('июль', 7), ('август', 8),\n    ('сентябрь', 9), ('октябрь', 10), ('ноябрь', 11), ('декабрь', 12)\n  ) AS m(month_name, month_num)\n),\nfiltered_data AS (\n  SELECT\n    TO_CHAR(t.date, 'DD.MM.YYYY') as date,\n    t.category,\n    t.amount,\n    t.currency,\n    COALESCE(t.description, '') as description\n  FROM {{ $fromAI(\"type\", \"Тип операции: 'расход' или 'доход'\", \"string\") === 'расход' ? 'expenses' : 'income' }} t\n  INNER JOIN month_mapping mm ON EXTRACT(MONTH FROM t.date) = mm.month_num\n  INNER JOIN user_workspace uw ON t.workspace_id = uw.workspace_id\n  WHERE t.user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND EXTRACT(YEAR FROM t.date) = EXTRACT(YEAR FROM CURRENT_DATE)\n    AND LOWER(mm.month_name) = LOWER('{{ $fromAI(\"month\", \"Название месяца на русском языке (например: октябрь, ноябрь)\", \"string\") }}')\n    AND (NULLIF('{{ $fromAI(\"filter_category\", \"Категория для фильтрации опционально\", \"string\", \"\") }}', '') IS NULL OR t.category = '{{ $fromAI(\"filter_category\", \"Категория для фильтрации опционально\", \"string\", \"\") }}')\n    AND t.deleted_at IS NULL\n)\nSELECT \n  *,\n  (SELECT COUNT(*) FROM filtered_data) as total_rows,\n  (SELECT SUM(amount) FROM filtered_data) as total_amount,\n  (SELECT COUNT(DISTINCT currency) FROM filtered_data) as currency_count\nFROM filtered_data\nORDER BY date DESC\nLIMIT 100;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        1728,
        2544
      ],
      "id": "b9d2dd2d-1662-4689-9dd7-cb12700d78f3",
      "name": "Parsing_of_the_month",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n)\nINSERT INTO expenses (user_id, workspace_id, date, category, amount, currency, description, operation_type, source)\nSELECT\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }},\n  uw.workspace_id,\n  CASE \n    WHEN '{{ $fromAI(\"date\", \"Дата операции в формате DD.MM.YYYY. Если дата НЕ указана в сообщении пользователя - верни пустую строку\", \"string\", \"\") }}' = '' THEN (NOW() AT TIME ZONE 'Asia/Bishkek')::DATE\n    ELSE TO_DATE('{{ $fromAI(\"date\", \"Дата операции в формате DD.MM.YYYY. Если дата НЕ указана в сообщении пользователя - верни пустую строку\", \"string\", \"\") }}', 'DD.MM.YYYY')\n  END,\n  '{{ $fromAI(\"category\", \"Категория расхода: продукты, транспорт, кафе/рестораны, аренда офиса, зарплата, налоги, маркетинг, канцтовары, интернет/связь, коммунальные услуги, обучение, подписки, прочее\", \"string\") }}',\n  {{ $fromAI(\"amount\", \"Сумма расхода, только число\", \"number\") }},\n  UPPER('{{ $fromAI(\"currency\", \"Валюта: сом/KGS, доллар/USD, евро/EUR, рубль/RUB. Если не указана - KGS\", \"string\", \"KGS\") }}'),\n  '{{ $fromAI(\"description\", \"Описание расхода, если есть\", \"string\", \"\") }}',\n  'расход',\n  'telegram'\nFROM user_workspace uw\nRETURNING id, workspace_id, TO_CHAR(date, 'DD.MM.YYYY') as date, category, amount, currency, description;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        1856,
        2544
      ],
      "id": "40e6db9d-c385-4acc-9d93-ff6c108278f6",
      "name": "Add_expense",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Проверка лимита по категории\nWITH expense_sum AS (\n  SELECT COALESCE(SUM(amount), 0) as total_spent\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    AND category = '{{ $json.category }}'\n    AND date >= DATE_TRUNC('month', CURRENT_DATE)\n),\ncategory_limit AS (\n  SELECT limit_amount\n  FROM limits\n  WHERE user_id = {{ $json.user_id }}\n    AND category = '{{ $json.category }}'\n    AND month = TO_CHAR(CURRENT_DATE, 'YYYY-MM')\n  LIMIT 1\n)\nSELECT \n  e.total_spent,\n  l.limit_amount,\n  CASE \n    WHEN l.limit_amount IS NULL THEN NULL\n    WHEN e.total_spent > l.limit_amount THEN 'exceeded'\n    WHEN e.total_spent > (l.limit_amount * 0.8) THEN 'warning'\n    ELSE 'ok'\n  END as limit_status,\n  CASE\n    WHEN l.limit_amount IS NOT NULL THEN ROUND((e.total_spent / l.limit_amount) * 100)\n    ELSE NULL\n  END as percent_used\nFROM expense_sum e\nLEFT JOIN category_limit l ON true;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        1984,
        2544
      ],
      "id": "a2568aed-9f9f-4bb3-ac97-8280864cf4b2",
      "name": "Checking_limits",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        2112,
        2544
      ],
      "id": "5e7feaac-8c2d-4728-aa9b-71b6a12b80bf",
      "name": "Calc"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT \n  {{ $fromAI(\"amount\", \"Сумма для конвертации, только число\", \"number\") }} as original_amount,\n  UPPER('{{ $fromAI(\"from_currency\", \"Из какой валюты конвертировать: сом/KGS, доллар/USD, евро/EUR, рубль/RUB\", \"string\") }}') as from_currency,\n  UPPER('{{ $fromAI(\"to_currency\", \"В какую валюту конвертировать: сом/KGS, доллар/USD, евро/EUR, рубль/RUB\", \"string\") }}') as to_currency,\n  get_exchange_rate(\n    UPPER('{{ $fromAI(\"from_currency\", \"Из какой валюты конвертировать: сом/KGS, доллар/USD, евро/EUR, рубль/RUB\", \"string\") }}'),\n    UPPER('{{ $fromAI(\"to_currency\", \"В какую валюту конвертировать: сом/KGS, доллар/USD, евро/EUR, рубль/RUB\", \"string\") }}'),\n    CURRENT_DATE\n  ) as rate,\n  convert_amount(\n    {{ $fromAI(\"amount\", \"Сумма для конвертации, только число\", \"number\") }},\n    UPPER('{{ $fromAI(\"from_currency\", \"Из какой валюты конвертировать: сом/KGS, доллар/USD, евро/EUR, рубль/RUB\", \"string\") }}'),\n    UPPER('{{ $fromAI(\"to_currency\", \"В какую валюту конвертировать: сом/KGS, доллар/USD, евро/EUR, рубль/RUB\", \"string\") }}'),\n    CURRENT_DATE\n  ) as converted_amount,\n  TO_CHAR(CURRENT_DATE, 'DD.MM.YYYY') as conversion_date;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        2240,
        2544
      ],
      "id": "6eee67b6-385b-4707-8802-0e4179d4d070",
      "name": "Convert_currency",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH latest_rates AS (\n  SELECT DISTINCT ON (from_currency, to_currency)\n    from_currency,\n    to_currency,\n    rate,\n    date,\n    source\n  FROM exchange_rates\n  WHERE from_currency IN ('KGS', 'USD', 'EUR', 'RUB')\n    AND to_currency IN ('KGS', 'USD', 'EUR', 'RUB')\n    AND from_currency != to_currency\n  ORDER BY from_currency, to_currency, date DESC\n)\nSELECT \n  from_currency,\n  to_currency,\n  rate,\n  TO_CHAR(date, 'DD.MM.YYYY') as rate_date,\n  source,\n  CASE \n    WHEN from_currency = 'USD' AND to_currency = 'KGS' THEN '💵 Доллар → Сом'\n    WHEN from_currency = 'EUR' AND to_currency = 'KGS' THEN '💶 Евро → Сом'\n    WHEN from_currency = 'RUB' AND to_currency = 'KGS' THEN '💷 Рубль → Сом'\n    ELSE from_currency || ' → ' || to_currency\n  END as display_name\nFROM latest_rates\nORDER BY \n  CASE from_currency \n    WHEN 'USD' THEN 1 \n    WHEN 'EUR' THEN 2 \n    WHEN 'RUB' THEN 3 \n    ELSE 4 \n  END, to_currency;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        2368,
        2544
      ],
      "id": "afc297b3-acfb-422e-a89d-20cd3223bcd0",
      "name": "Get_exchange_rates",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM safe_update_transaction(\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }}::BIGINT,\n  '{{ $fromAI(\"transaction_type\", \"Тип: expense или income (НЕ 'расход' или 'доход'!)\", \"string\") }}',\n  '{{ $fromAI(\"transaction_id\", \"ID транзакции или 'last' для последней\", \"string\") }}',\n  '{{ $fromAI(\"field\", \"Поле для изменения: amount, category, description, date, currency\", \"string\") }}',\n  '{{ $fromAI(\"new_value\", \"Новое значение (для даты используй DD.MM.YYYY)\", \"string\") }}'\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        2496,
        2544
      ],
      "id": "baabff2e-de9e-4e8c-bf71-adc168510870",
      "name": "Edit_transaction",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH found_transaction AS (\n  SELECT \n    CASE \n      WHEN LOWER('{{ $fromAI(\"transaction_id\", \"ID транзакции или 'last' для последней\", \"string\") }}') = 'last' \n      THEN get_last_transaction({{ $('Telegram Bot Trigger').first().json.message.from.id }}, LOWER('{{ $fromAI(\"transaction_type\", \"Тип: expense или income\", \"string\") }}'))\n      ELSE CAST(NULLIF('{{ $fromAI(\"transaction_id\", \"ID транзакции или 'last' для последней\", \"string\") }}', 'last') AS INTEGER)\n    END as tid\n),\ndelete_expense AS (\n  UPDATE expenses\n  SET deleted_at = NOW(),\n      deleted_by = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n  WHERE id = (SELECT tid FROM found_transaction)\n    AND user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND deleted_at IS NULL\n    AND LOWER('{{ $fromAI(\"transaction_type\", \"Тип: expense или income\", \"string\") }}') = 'expense'\n  RETURNING id, amount, category, currency, date\n),\ndelete_income AS (\n  UPDATE income\n  SET deleted_at = NOW(),\n      deleted_by = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n  WHERE id = (SELECT tid FROM found_transaction)\n    AND user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND deleted_at IS NULL\n    AND LOWER('{{ $fromAI(\"transaction_type\", \"Тип: expense или income\", \"string\") }}') = 'income'\n  RETURNING id, amount, category, currency, date\n),\nlog_deletion AS (\n  SELECT log_transaction_change(\n    LOWER('{{ $fromAI(\"transaction_type\", \"Тип: expense или income\", \"string\") }}'),\n    (SELECT tid FROM found_transaction),\n    'deleted',\n    NULL,\n    NULL,\n    NULL,\n    {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n  ) as history_id\n)\nSELECT \n  COALESCE(\n    (SELECT row_to_json(delete_expense.*) FROM delete_expense),\n    (SELECT row_to_json(delete_income.*) FROM delete_income)\n  ) as deleted_transaction,\n  (SELECT history_id FROM log_deletion) as history_id,\n  'deleted' as status;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        2624,
        2544
      ],
      "id": "d3f8900d-eed8-46a8-a526-00c3b0ae3381",
      "name": "Delete_transaction",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH found_transaction AS (\n  SELECT \n    CASE \n      WHEN LOWER('{{ $fromAI(\"transaction_id\", \"ID удалённой транзакции или 'last'\", \"string\") }}') = 'last' \n      THEN get_last_transaction({{ $('Telegram Bot Trigger').first().json.message.from.id }}, LOWER('{{ $fromAI(\"transaction_type\", \"Тип: expense или income\", \"string\") }}'))\n      ELSE CAST(NULLIF('{{ $fromAI(\"transaction_id\", \"ID удалённой транзакции или 'last'\", \"string\") }}', 'last') AS INTEGER)\n    END as tid\n),\nrestore_expense AS (\n  UPDATE expenses\n  SET deleted_at = NULL,\n      deleted_by = NULL\n  WHERE id = (SELECT tid FROM found_transaction)\n    AND user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND deleted_at IS NOT NULL\n    AND LOWER('{{ $fromAI(\"transaction_type\", \"Тип: expense или income\", \"string\") }}') = 'expense'\n  RETURNING id, amount, category, currency, date\n),\nrestore_income AS (\n  UPDATE income\n  SET deleted_at = NULL,\n      deleted_by = NULL\n  WHERE id = (SELECT tid FROM found_transaction)\n    AND user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND deleted_at IS NOT NULL\n    AND LOWER('{{ $fromAI(\"transaction_type\", \"Тип: expense или income\", \"string\") }}') = 'income'\n  RETURNING id, amount, category, currency, date\n),\nlog_restore AS (\n  SELECT log_transaction_change(\n    LOWER('{{ $fromAI(\"transaction_type\", \"Тип: expense или income\", \"string\") }}'),\n    (SELECT tid FROM found_transaction),\n    'restored',\n    NULL,\n    NULL,\n    NULL,\n    {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n  ) as history_id\n)\nSELECT \n  COALESCE(\n    (SELECT row_to_json(restore_expense.*) FROM restore_expense),\n    (SELECT row_to_json(restore_income.*) FROM restore_income)\n  ) as restored_transaction,\n  (SELECT history_id FROM log_restore) as history_id,\n  'restored' as status;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        2752,
        2544
      ],
      "id": "7d7eb968-bff0-44f9-aa6c-00e5b294c4d1",
      "name": "Restore_transaction",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH found_transaction AS (\n  SELECT \n    CASE \n      WHEN LOWER('{{ $fromAI(\"transaction_id\", \"ID транзакции или 'last'\", \"string\") }}') = 'last' \n      THEN get_last_transaction({{ $('Telegram Bot Trigger').first().json.message.from.id }}, LOWER('{{ $fromAI(\"transaction_type\", \"Тип: expense или income\", \"string\") }}'))\n      ELSE CAST(NULLIF('{{ $fromAI(\"transaction_id\", \"ID транзакции или 'last'\", \"string\") }}', 'last') AS INTEGER)\n    END as tid\n)\nSELECT \n  id,\n  action,\n  field_changed,\n  old_value,\n  new_value,\n  changed_by,\n  TO_CHAR(changed_at, 'DD.MM.YYYY HH24:MI:SS') as changed_at\nFROM transaction_history\nWHERE transaction_type = LOWER('{{ $fromAI(\"transaction_type\", \"Тип: expense или income\", \"string\") }}')\n  AND transaction_id = (SELECT tid FROM found_transaction)\nORDER BY changed_at DESC\nLIMIT 50;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        2880,
        2544
      ],
      "id": "1f5d50f2-3ca0-4f4b-94d4-a7548a1a1d87",
      "name": "Get_transaction_history",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM create_recurring_payment(\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }}::BIGINT,\n  '{{ $fromAI(\"title\", \"Название платежа (например Netflix, Аренда офиса)\", \"string\") }}'::VARCHAR,\n  {{ $fromAI(\"amount\", \"Сумма платежа, только число\", \"number\") }}::NUMERIC,\n  UPPER('{{ $fromAI(\"currency\", \"Валюта: KGS/сом, USD/доллар, EUR/евро, RUB/рубль\", \"string\") }}')::VARCHAR,\n  '{{ $fromAI(\"category\", \"Категория расхода: продукты, транспорт, аренда офиса, подписки и т.д.\", \"string\") }}'::VARCHAR,\n  LOWER('{{ $fromAI(\"frequency\", \"Частота: daily (ежедневно), weekly (еженедельно), monthly (ежемесячно), yearly (ежегодно)\", \"string\") }}')::VARCHAR,\n  COALESCE(TO_DATE(NULLIF('{{ $fromAI(\"start_date\", \"Дата начала в формате DD.MM.YYYY (опционально, по умолчанию сегодня)\", \"string\", \"\") }}', ''), 'DD.MM.YYYY'), CURRENT_DATE),\n  NULL::TEXT,\n  'expense'::VARCHAR,\n  {{ $fromAI(\"interval_value\", \"Каждые N периодов (например 1 для каждый месяц, 2 для каждые 2 недели)\", \"number\", 1) }}::INTEGER,\n  {{ $fromAI(\"remind_days_before\", \"За сколько дней напоминать (по умолчанию 3)\", \"number\", 3) }}::INTEGER,\n  {{ $fromAI(\"auto_create\", \"Создавать транзакцию автоматически: true или false (по умолчанию false)\", \"boolean\", false) }}::BOOLEAN\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        3008,
        2544
      ],
      "id": "811acf31-0eb3-40eb-9529-8f8f443b690b",
      "name": "Create_recurring_payment",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT \n  id,\n  title,\n  amount,\n  currency,\n  category,\n  frequency,\n  interval_value,\n  TO_CHAR(next_payment_date, 'DD.MM.YYYY') as next_payment_date,\n  remind_days_before,\n  auto_create,\n  total_executions,\n  TO_CHAR(created_at, 'DD.MM.YYYY') as created_at\nFROM recurring_payments\nWHERE user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n  AND is_active = true\n  AND (end_date IS NULL OR end_date >= CURRENT_DATE)\nORDER BY next_payment_date ASC;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        3136,
        2544
      ],
      "id": "3a692fb4-514c-4d12-aa37-17158d1deac7",
      "name": "List_recurring_payments",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE recurring_payments\nSET \n  is_active = false,\n  end_date = CURRENT_DATE,\n  updated_at = NOW()\nWHERE id = {{ $fromAI(\"payment_id\", \"ID подписки для отмены\", \"number\") }}\n  AND user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n  AND is_active = true\nRETURNING \n  id,\n  title,\n  amount,\n  currency,\n  'cancelled' as status,\n  TO_CHAR(end_date, 'DD.MM.YYYY') as cancelled_date;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        3264,
        2544
      ],
      "id": "1b890fa1-9fcc-4dc0-8740-d9b9f7491c53",
      "name": "Cancel_recurring_payment",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM get_budget_forecast(\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }}::BIGINT\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        3392,
        2544
      ],
      "id": "0e09e54b-1885-4683-a287-11649563b02f",
      "name": "Get_budget_forecast",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT \n  id,\n  notification_type,\n  title,\n  message,\n  priority,\n  is_read,\n  TO_CHAR(created_at, 'DD.MM.YYYY HH24:MI') as created_at,\n  related_transaction_id,\n  metadata\nFROM notifications\nWHERE user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n  AND ({{ $fromAI(\"unread_only\", \"Показать только непрочитанные: true или false\", \"boolean\", true) }} = false OR is_read = false)\nORDER BY \n  CASE priority \n    WHEN 'urgent' THEN 1 \n    WHEN 'high' THEN 2 \n    WHEN 'normal' THEN 3 \n    ELSE 4 \n  END,\n  created_at DESC\nLIMIT {{ $fromAI(\"limit\", \"Количество уведомлений для показа\", \"number\", 10) }};",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        3520,
        2544
      ],
      "id": "23561bb3-f24b-4f2d-83b0-89b1cfc84c14",
      "name": "Get_notifications",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO budget_alerts_config (\n  user_id,\n  budget_warning_threshold,\n  budget_critical_threshold,\n  category_warning_threshold,\n  category_critical_threshold,\n  max_alerts_per_day,\n  updated_at\n) VALUES (\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }},\n  {{ $fromAI(\"budget_warning\", \"Порог предупреждения о бюджете в % (например 75, 80, 90)\", \"number\", 80) }},\n  {{ $fromAI(\"budget_critical\", \"Критический порог бюджета в % (обычно 100)\", \"number\", 100) }},\n  {{ $fromAI(\"category_warning\", \"Порог предупреждения для лимитов категорий в %\", \"number\", 80) }},\n  {{ $fromAI(\"category_critical\", \"Критический порог для лимитов категорий в %\", \"number\", 100) }},\n  {{ $fromAI(\"max_alerts_per_day\", \"Максимальное количество уведомлений в день\", \"number\", 5) }},\n  NOW()\n)\nON CONFLICT (user_id) \nDO UPDATE SET\n  budget_warning_threshold = EXCLUDED.budget_warning_threshold,\n  budget_critical_threshold = EXCLUDED.budget_critical_threshold,\n  category_warning_threshold = EXCLUDED.category_warning_threshold,\n  category_critical_threshold = EXCLUDED.category_critical_threshold,\n  max_alerts_per_day = EXCLUDED.max_alerts_per_day,\n  updated_at = NOW()\nRETURNING \n  user_id,\n  budget_warning_threshold,\n  budget_critical_threshold,\n  category_warning_threshold,\n  category_critical_threshold,\n  max_alerts_per_day,\n  'configured' as status;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        3648,
        2544
      ],
      "id": "866b0494-0feb-430a-900b-9955f47bf719",
      "name": "Configure_alerts",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n)\nSELECT * FROM get_income_expense_stats(\n  (SELECT workspace_id FROM user_workspace),\n  TO_DATE('{{ $fromAI(\"start_date\", \"Дата начала периода в формате DD.MM.YYYY (по умолчанию начало месяца)\", \"string\", TO_CHAR(DATE_TRUNC('month', CURRENT_DATE), 'DD.MM.YYYY')) }}', 'DD.MM.YYYY'),\n  TO_DATE('{{ $fromAI(\"end_date\", \"Дата конца периода в формате DD.MM.YYYY (по умолчанию сегодня)\", \"string\", TO_CHAR(CURRENT_DATE, 'DD.MM.YYYY')) }}', 'DD.MM.YYYY')\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        3776,
        2544
      ],
      "id": "f6813c04-664e-4b2b-b421-f7a09d8731e6",
      "name": "Get_income_expense_stats",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n)\nSELECT * FROM get_top_expense_categories(\n  (SELECT workspace_id FROM user_workspace),\n  TO_DATE('{{ $fromAI(\"start_date\", \"Дата начала периода в формате DD.MM.YYYY (по умолчанию начало месяца)\", \"string\", TO_CHAR(DATE_TRUNC('month', CURRENT_DATE), 'DD.MM.YYYY')) }}', 'DD.MM.YYYY'),\n  TO_DATE('{{ $fromAI(\"end_date\", \"Дата конца периода в формате DD.MM.YYYY (по умолчанию сегодня)\", \"string\", TO_CHAR(CURRENT_DATE, 'DD.MM.YYYY')) }}', 'DD.MM.YYYY'),\n  {{ $fromAI(\"limit\", \"Количество топ категорий для показа (по умолчанию 10)\", \"number\", 10) }}\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        3904,
        2544
      ],
      "id": "ee9cc2b3-8156-45fd-a0cc-d45cd6719a2a",
      "name": "Get_top_categories",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM get_user_workspaces(\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }}::BIGINT\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        4032,
        2544
      ],
      "id": "967e4aa2-581e-41b2-9eaa-8db80a9488d4",
      "name": "Get_workspaces",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM update_spending_patterns(\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }}::BIGINT\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        4160,
        2544
      ],
      "id": "8747750a-a707-485a-a629-7b19ccca1cf6",
      "name": "Update_spending_patterns",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n)\nINSERT INTO budgets (user_id, workspace_id, month, budget_amount, currency)\nSELECT\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }},\n  uw.workspace_id,\n  COALESCE(\n    '{{ $fromAI(\"month\", \"Месяц в формате YYYY-MM (например 2025-11), если не указан - текущий месяц\", \"string\", \"\") }}',\n    TO_CHAR(CURRENT_DATE, 'YYYY-MM')\n  ),\n  {{ $fromAI(\"amount\", \"Сумма бюджета, только число\", \"number\") }},\n  UPPER('{{ $fromAI(\"currency\", \"Валюта бюджета: KGS/USD/EUR/RUB (по умолчанию KGS)\", \"string\", \"KGS\") }}')\nFROM user_workspace uw\nON CONFLICT (user_id, month) \nDO UPDATE SET \n  budget_amount = EXCLUDED.budget_amount,\n  currency = EXCLUDED.currency,\n  updated_at = NOW()\nRETURNING \n  id,\n  month,\n  budget_amount,\n  currency,\n  'budget_set' as status;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        4288,
        2544
      ],
      "id": "a02b992d-f3e9-417b-8122-636b2b9b0d20",
      "name": "Set_budget",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n)\nINSERT INTO limits (user_id, workspace_id, category, month, limit_amount, currency)\nSELECT\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }},\n  uw.workspace_id,\n  '{{ $fromAI(\"category\", \"Категория для лимита: продукты, транспорт, кафе/рестораны и т.д.\", \"string\") }}',\n  COALESCE(\n    '{{ $fromAI(\"month\", \"Месяц в формате YYYY-MM (например 2025-11), если не указан - текущий месяц\", \"string\", \"\") }}',\n    TO_CHAR(CURRENT_DATE, 'YYYY-MM')\n  ),\n  {{ $fromAI(\"amount\", \"Сумма лимита, только число\", \"number\") }},\n  UPPER('{{ $fromAI(\"currency\", \"Валюта лимита: KGS/USD/EUR/RUB (по умолчанию KGS)\", \"string\", \"KGS\") }}')\nFROM user_workspace uw\nON CONFLICT (user_id, category, month) \nDO UPDATE SET \n  limit_amount = EXCLUDED.limit_amount,\n  currency = EXCLUDED.currency,\n  updated_at = NOW()\nRETURNING \n  id,\n  category,\n  month,\n  limit_amount,\n  currency,\n  'limit_set' as status;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        4416,
        2544
      ],
      "id": "37f69207-9782-4473-bb85-17116e982064",
      "name": "Set_category_limit",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 21 * * *"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        896,
        4576
      ],
      "id": "d879e023-5267-41c0-8639-94498e04f074",
      "name": "Daily Report Trigger"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 0 31 2 *"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        896,
        4768
      ],
      "id": "76e03fcc-1d23-4c06-a33e-62e37fbd6aea",
      "name": "Weekly Report Trigger"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 0 31 2 *"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        896,
        4960
      ],
      "id": "cf311ef0-eaea-4b70-8413-861485220665",
      "name": "Monthly Report Trigger",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Получить всех активных пользователей для отправки ежедневного отчета\nSELECT DISTINCT\n  u.user_id,\n  u.telegram_chat_id,\n  u.first_name,\n  w.id as workspace_id\nFROM users u\nJOIN workspace_members wm ON u.user_id = wm.user_id\nJOIN workspaces w ON wm.workspace_id = w.id\nWHERE u.telegram_chat_id IS NOT NULL\n  AND wm.is_active = true\n  AND w.is_active = true\n  AND u.last_activity >= NOW() - INTERVAL '7 days'\nORDER BY u.user_id;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1120,
        3344
      ],
      "id": "4b34a945-c6e6-4822-849c-c1d4dff71d62",
      "name": "Get Active Users",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Получить данные за сегодня для пользователя\nWITH today_expenses AS (\n  SELECT \n    COALESCE(SUM(amount), 0) as total_expenses,\n    COUNT(*) as expense_count,\n    json_agg(\n      json_build_object(\n        'category', category,\n        'amount', amount,\n        'currency', currency,\n        'description', description\n      ) ORDER BY amount DESC\n    ) as expenses_detail\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    {{ $json.workspace_id ? 'AND workspace_id = ' + $json.workspace_id : '' }}\n    AND DATE(date) = (NOW() AT TIME ZONE 'Asia/Bishkek')::DATE\n    AND deleted_at IS NULL\n),\ntoday_income AS (\n  SELECT \n    COALESCE(SUM(amount), 0) as total_income,\n    COUNT(*) as income_count\n  FROM income\n  WHERE user_id = {{ $json.user_id }}\n    {{ $json.workspace_id ? 'AND workspace_id = ' + $json.workspace_id : '' }}\n    AND DATE(date) = (NOW() AT TIME ZONE 'Asia/Bishkek')::DATE\n    AND deleted_at IS NULL\n),\nmonth_stats AS (\n  SELECT \n    COALESCE(SUM(amount), 0) as month_expenses\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    {{ $json.workspace_id ? 'AND workspace_id = ' + $json.workspace_id : '' }}\n    AND DATE_TRUNC('month', date) = DATE_TRUNC('month', (NOW() AT TIME ZONE 'Asia/Bishkek')::DATE)\n    AND deleted_at IS NULL\n),\nbudget_info AS (\n  SELECT budget_amount, currency\n  FROM budgets\n  WHERE user_id = {{ $json.user_id }}\n    {{ $json.workspace_id ? 'AND workspace_id = ' + $json.workspace_id : '' }}\n    AND month = TO_CHAR((NOW() AT TIME ZONE 'Asia/Bishkek')::DATE, 'YYYY-MM')\n  LIMIT 1\n)\nSELECT \n  {{ $json.user_id }} as user_id,\n  {{ $json.telegram_chat_id }} as chat_id,\n  '{{ $json.first_name }}' as user_name,\n  te.total_expenses,\n  te.expense_count,\n  te.expenses_detail,\n  ti.total_income,\n  ti.income_count,\n  ms.month_expenses,\n  bi.budget_amount,\n  COALESCE(bi.currency, 'KGS') as budget_currency,\n  CASE \n    WHEN bi.budget_amount > 0 THEN ROUND((ms.month_expenses / bi.budget_amount) * 100, 1)\n    ELSE 0\n  END as budget_used_percent\nFROM today_expenses te\nCROSS JOIN today_income ti\nCROSS JOIN month_stats ms\nLEFT JOIN budget_info bi ON true;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2872,
        3692
      ],
      "id": "95cf563a-1945-4418-9494-2ad601702ac8",
      "name": "Get Daily Stats",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Создай краткий ежедневный финансовый отчет на основе этих данных:\n\n👤 Пользователь: {{ $json.user_name }}\n📅 Дата: {{ new Date().toLocaleDateString('ru-RU') }}\n\n💸 СЕГОДНЯ:\n- Расходы: {{ $json.total_expenses }} сом ({{ $json.expense_count }} транзакций)\n- Доходы: {{ $json.total_income }} сом ({{ $json.income_count }} транзакций)\n- Баланс дня: {{ $json.total_income - $json.total_expenses }} сом\n\n📊 МЕСЯЦ:\n- Потрачено: {{ $json.month_expenses }} сом\n- Бюджет: {{ $json.budget_amount || 'не установлен' }} {{ $json.budget_currency || '' }}\n- Использовано бюджета: {{ $json.budget_used_percent }}%\n\n📋 Детали расходов за сегодня:\n{{ JSON.stringify($json.expenses_detail, null, 2) }}\n\nНапиши:\n1. Краткий итог дня (2-3 предложения)\n2. Анализ трат (что заметил)\n3. Один полезный совет или рекомендацию\n\nФормат: дружелюбный, мотивирующий, с эмодзи. Максимум 10 строк.",
        "options": {
          "systemMessage": "Ты финансовый аналитик, который делает краткие ежедневные отчеты. Говори по-русски, используй эмодзи, будь позитивным и мотивирующим."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        4624,
        3692
      ],
      "id": "027b6589-c2c5-4372-9c7c-f35cb72cbfd2",
      "name": "Daily Report AI"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        4696,
        3916
      ],
      "id": "391ea85d-fdb4-4428-97f9-a2506392c5f5",
      "name": "OpenAI Daily Model",
      "credentials": {
        "openAiApi": {
          "id": "YWdBHhtpkxTSXDR7",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Get Daily Stats').first().json.chat_id }}",
        "text": "=🌙 *Ежедневный отчет*\n\n{{ $('Daily Report AI').first().json.output }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        4976,
        3692
      ],
      "id": "7ca79884-cd03-496c-bea4-15bceb6188fe",
      "name": "Send Daily Report",
      "webhookId": "daily-report-send",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Получить данные за неделю для отчета\nWITH week_expenses AS (\n  SELECT \n    DATE(date) as expense_date,\n    category,\n    SUM(amount) as daily_total,\n    currency,\n    COUNT(*) as transaction_count\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    {{ $json.workspace_id ? 'AND workspace_id = ' + $json.workspace_id : '' }}\n    AND DATE(date) >= CURRENT_DATE - INTERVAL '7 days'\n    AND DATE(date) <= CURRENT_DATE\n    AND deleted_at IS NULL\n  GROUP BY DATE(date), category, currency\n  ORDER BY DATE(date) DESC, daily_total DESC\n),\nweek_income AS (\n  SELECT \n    DATE(date) as income_date,\n    category,\n    SUM(amount) as daily_total,\n    currency\n  FROM income\n  WHERE user_id = {{ $json.user_id }}\n    {{ $json.workspace_id ? 'AND workspace_id = ' + $json.workspace_id : '' }}\n    AND DATE(date) >= CURRENT_DATE - INTERVAL '7 days'\n    AND DATE(date) <= CURRENT_DATE\n    AND deleted_at IS NULL\n  GROUP BY DATE(date), category, currency\n  ORDER BY DATE(date) DESC\n),\nweek_summary AS (\n  SELECT \n    COALESCE(SUM(we.daily_total), 0) as total_expenses,\n    COALESCE(SUM(wi.daily_total), 0) as total_income,\n    (SELECT COUNT(*) FROM expenses WHERE user_id = {{ $json.user_id }} {{ $json.workspace_id ? 'AND workspace_id = ' + $json.workspace_id : '' }} AND DATE(date) >= CURRENT_DATE - INTERVAL '7 days' AND DATE(date) <= CURRENT_DATE AND deleted_at IS NULL) as expense_count,\n    (SELECT COUNT(*) FROM income WHERE user_id = {{ $json.user_id }} {{ $json.workspace_id ? 'AND workspace_id = ' + $json.workspace_id : '' }} AND DATE(date) >= CURRENT_DATE - INTERVAL '7 days' AND DATE(date) <= CURRENT_DATE AND deleted_at IS NULL) as income_count\n  FROM week_expenses we\n  FULL OUTER JOIN week_income wi ON we.expense_date = wi.income_date\n),\ntop_categories AS (\n  SELECT \n    category,\n    SUM(amount) as category_total,\n    ROUND((SUM(amount) / NULLIF((SELECT SUM(amount) FROM expenses WHERE user_id = {{ $json.user_id }} {{ $json.workspace_id ? 'AND workspace_id = ' + $json.workspace_id : '' }} AND DATE(date) >= CURRENT_DATE - INTERVAL '7 days' AND DATE(date) <= CURRENT_DATE AND deleted_at IS NULL), 0)) * 100, 1) as percentage\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    {{ $json.workspace_id ? 'AND workspace_id = ' + $json.workspace_id : '' }}\n    AND DATE(date) >= CURRENT_DATE - INTERVAL '7 days'\n    AND DATE(date) <= CURRENT_DATE\n    AND deleted_at IS NULL\n  GROUP BY category\n  ORDER BY category_total DESC\n  LIMIT 5\n)\nSELECT \n  {{ $json.user_id }} as user_id,\n  {{ $json.telegram_chat_id }} as chat_id,\n  '{{ $json.first_name }}' as user_name,\n  {{ $json.workspace_id || 0 }} as workspace_id,\n  (SELECT json_agg(row_to_json(we.*)) FROM week_expenses we) as expenses_by_day,\n  (SELECT json_agg(row_to_json(wi.*)) FROM week_income wi) as income_by_day,\n  ws.total_expenses,\n  ws.total_income,\n  ws.expense_count,\n  ws.income_count,\n  (SELECT json_agg(row_to_json(tc.*)) FROM top_categories tc) as top_categories,\n  TO_CHAR(CURRENT_DATE - INTERVAL '7 days', 'DD.MM.YYYY') as period_start,\n  TO_CHAR(CURRENT_DATE, 'DD.MM.YYYY') as period_end\nFROM week_summary ws;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        672,
        2544
      ],
      "id": "e568b3de-23ba-467e-b1d9-1cf1f46f0062",
      "name": "Get Weekly Data",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Подготовка данных для недельного PDF отчета\nconst data = $input.first().json;\n\n// Функция форматирования валюты\nfunction formatCurrency(amount, symbol = 'сом') {\n  return `${Math.round(amount)} ${symbol}`;\n}\n\n// Форматируем данные по дням для графика\nconst expensesByDay = data.expenses_by_day || [];\nconst incomeByDay = data.income_by_day || [];\n\n// Создаем массив дат и сумм для графика\nconst dates = [];\nconst expensesData = [];\nconst incomeData = [];\n\n// Группируем расходы по дням\nconst expenseMap = {};\nexpensesByDay.forEach(exp => {\n  const date = new Date(exp.expense_date).toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });\n  if (!expenseMap[date]) {\n    expenseMap[date] = 0;\n  }\n  expenseMap[date] += parseFloat(exp.daily_total || 0);\n});\n\n// Группируем доходы по дням\nconst incomeMap = {};\nincomeByDay.forEach(inc => {\n  const date = new Date(inc.income_date).toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });\n  if (!incomeMap[date]) {\n    incomeMap[date] = 0;\n  }\n  incomeMap[date] += parseFloat(inc.daily_total || 0);\n});\n\n// Получаем все уникальные даты\nconst allDates = [...new Set([...Object.keys(expenseMap), ...Object.keys(incomeMap)])];\nallDates.sort();\n\n// Заполняем массивы для графика\nallDates.forEach(date => {\n  dates.push(date);\n  expensesData.push(Math.round(expenseMap[date] || 0));\n  incomeData.push(Math.round(incomeMap[date] || 0));\n});\n\n// Топ категорий расходов с форматированием\nconst topCategories = (data.top_categories || []).map(cat => {\n  const value = Math.round(parseFloat(cat.category_total || 0));\n  return {\n    label: cat.category,\n    value: value,\n    value_formatted: formatCurrency(value),\n    percentage: parseFloat(cat.percentage || 0)\n  };\n});\n\n// Данные для круговой диаграммы\nconst categoryLabels = topCategories.map(c => c.label);\nconst categoryValues = topCategories.map(c => c.value);\n\n// Рассчитываем основные показатели\nconst totalExpenses = Math.round(parseFloat(data.total_expenses || 0));\nconst totalIncome = Math.round(parseFloat(data.total_income || 0));\nconst balance = totalIncome - totalExpenses;\nconst avgDailyExpense = Math.round(totalExpenses / 7);\nconst avgDailyIncome = Math.round(totalIncome / 7);\n\n// Итоговые данные\nconst result = {\n  // Заголовок и период\n  title: `📊 Недельный финансовый отчет`,\n  user_name: data.user_name || 'Пользователь',\n  period: `${data.period_start} - ${data.period_end}`,\n  currency_symbol: 'сом',\n  \n  // Основные показатели (числа для графиков)\n  total_expenses: totalExpenses,\n  total_income: totalIncome,\n  balance: balance,\n  transaction_count: parseInt(data.expense_count || 0) + parseInt(data.income_count || 0),\n  expense_count: parseInt(data.expense_count || 0),\n  income_count: parseInt(data.income_count || 0),\n  avg_daily_expense: avgDailyExpense,\n  avg_daily_income: avgDailyIncome,\n  \n  // Форматированные значения (для отображения)\n  total_expenses_formatted: formatCurrency(totalExpenses),\n  total_income_formatted: formatCurrency(totalIncome),\n  balance_formatted: formatCurrency(balance),\n  avg_daily_expense_formatted: formatCurrency(avgDailyExpense),\n  avg_daily_income_formatted: formatCurrency(avgDailyIncome),\n  \n  // График доходов/расходов по дням\n  daily_chart: {\n    labels: dates,\n    datasets: [\n      {\n        label: 'Расходы',\n        data: expensesData,\n        backgroundColor: 'rgba(255, 99, 132, 0.8)',\n        borderColor: 'rgb(255, 99, 132)'\n      },\n      {\n        label: 'Доходы',\n        data: incomeData,\n        backgroundColor: 'rgba(75, 192, 192, 0.8)',\n        borderColor: 'rgb(75, 192, 192)'\n      }\n    ]\n  },\n  \n  // Круговая диаграмма топ категорий\n  category_chart: {\n    labels: categoryLabels,\n    data: categoryValues\n  },\n  \n  // Таблица топ категорий (с форматированием)\n  top_categories_table: topCategories,\n  \n  // Детальная информация по дням\n  daily_details: allDates.map(date => ({\n    date: date,\n    expenses: expenseMap[date] || 0,\n    income: incomeMap[date] || 0,\n    balance: (incomeMap[date] || 0) - (expenseMap[date] || 0)\n  }))\n};\n\nreturn [{ json: result }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        896,
        2544
      ],
      "id": "991d215e-b2d0-4d97-b1cc-b674f4051903",
      "name": "Format Weekly Data"
    },
    {
      "parameters": {
        "resource": "pdf",
        "pdfTemplateId": "5a677b23ed6c2fe6",
        "jsonParameters": true,
        "propertiesJson": "={{ JSON.stringify($json) }}"
      },
      "type": "n8n-nodes-base.apiTemplateIo",
      "typeVersion": 1,
      "position": [
        1120,
        3536
      ],
      "id": "11bf37d8-6075-4521-b29c-b730eb5d2afe",
      "name": "Generate Weekly PDF",
      "credentials": {
        "apiTemplateIoApi": {
          "id": "NIFEHHMbU4WCVxC0",
          "name": "PDF Report"
        }
      }
    },
    {
      "parameters": {
        "operation": "sendDocument",
        "chatId": "={{ $('Get Weekly Data').first().json.chat_id }}",
        "file": "={{ $json.download_url }}",
        "additionalFields": {
          "caption": "=📊 *Недельный отчет*\n\n📅 Период: {{ $('Format Weekly Data').first().json.period }}\n👤 {{ $('Format Weekly Data').first().json.user_name }}\n\n💸 Расходы: {{ $('Format Weekly Data').first().json.total_expenses_formatted }}\n💰 Доходы: {{ $('Format Weekly Data').first().json.total_income_formatted }}\n📈 Баланс: {{ $('Format Weekly Data').first().json.balance_formatted }}\n\n📝 Транзакций: {{ $('Format Weekly Data').first().json.transaction_count }}\n📊 Среднее в день: {{ $('Format Weekly Data').first().json.avg_daily_expense_formatted }}",
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2872,
        3884
      ],
      "id": "f3ce4d54-b3a2-48a5-997a-9ba1460ba993",
      "name": "Send Weekly PDF",
      "webhookId": "weekly-pdf-send",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Получить данные за месяц для отчета\nWITH month_expenses AS (\n  SELECT \n    DATE(date) as expense_date,\n    category,\n    SUM(amount) as daily_total,\n    currency,\n    COUNT(*) as transaction_count\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    {{ $json.workspace_id ? 'AND workspace_id = ' + $json.workspace_id : '' }}\n    AND DATE_TRUNC('month', date) = DATE_TRUNC('month', (NOW() AT TIME ZONE 'Asia/Bishkek')::DATE)\n    AND deleted_at IS NULL\n  GROUP BY DATE(date), category, currency\n  ORDER BY DATE(date) DESC, daily_total DESC\n),\nmonth_income AS (\n  SELECT \n    DATE(date) as income_date,\n    category,\n    SUM(amount) as daily_total,\n    currency\n  FROM income\n  WHERE user_id = {{ $json.user_id }}\n    {{ $json.workspace_id ? 'AND workspace_id = ' + $json.workspace_id : '' }}\n    AND DATE_TRUNC('month', date) = DATE_TRUNC('month', (NOW() AT TIME ZONE 'Asia/Bishkek')::DATE)\n    AND deleted_at IS NULL\n  GROUP BY DATE(date), category, currency\n  ORDER BY DATE(date) DESC\n),\nmonth_summary AS (\n  SELECT \n    COALESCE(SUM(amount), 0) as total_expenses,\n    COUNT(*) as expense_count\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    {{ $json.workspace_id ? 'AND workspace_id = ' + $json.workspace_id : '' }}\n    AND DATE_TRUNC('month', date) = DATE_TRUNC('month', (NOW() AT TIME ZONE 'Asia/Bishkek')::DATE)\n    AND deleted_at IS NULL\n),\nmonth_income_summary AS (\n  SELECT \n    COALESCE(SUM(amount), 0) as total_income,\n    COUNT(*) as income_count\n  FROM income\n  WHERE user_id = {{ $json.user_id }}\n    {{ $json.workspace_id ? 'AND workspace_id = ' + $json.workspace_id : '' }}\n    AND DATE_TRUNC('month', date) = DATE_TRUNC('month', (NOW() AT TIME ZONE 'Asia/Bishkek')::DATE)\n    AND deleted_at IS NULL\n),\ncategory_breakdown AS (\n  SELECT \n    category,\n    SUM(amount) as category_total,\n    COUNT(*) as category_count,\n    ROUND(AVG(amount), 2) as avg_transaction,\n    ROUND((SUM(amount) / NULLIF((SELECT total_expenses FROM month_summary), 0)) * 100, 1) as percentage\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    {{ $json.workspace_id ? 'AND workspace_id = ' + $json.workspace_id : '' }}\n    AND DATE_TRUNC('month', date) = DATE_TRUNC('month', (NOW() AT TIME ZONE 'Asia/Bishkek')::DATE)\n    AND deleted_at IS NULL\n  GROUP BY category\n  ORDER BY category_total DESC\n),\nbudget_comparison AS (\n  SELECT \n    budget_amount,\n    currency,\n    (SELECT total_expenses FROM month_summary) as actual_expenses,\n    CASE \n      WHEN budget_amount > 0 THEN ROUND(((SELECT total_expenses FROM month_summary) / budget_amount) * 100, 1)\n      ELSE 0\n    END as budget_used_percent\n  FROM budgets\n  WHERE user_id = {{ $json.user_id }}\n    {{ $json.workspace_id ? 'AND workspace_id = ' + $json.workspace_id : '' }}\n    AND month = TO_CHAR((NOW() AT TIME ZONE 'Asia/Bishkek')::DATE, 'YYYY-MM')\n  LIMIT 1\n)\nSELECT \n  {{ $json.user_id }} as user_id,\n  {{ $json.telegram_chat_id }} as chat_id,\n  '{{ $json.first_name }}' as user_name,\n  {{ $json.workspace_id || 0 }} as workspace_id,\n  ms.total_expenses,\n  mis.total_income,\n  ms.expense_count,\n  mis.income_count,\n  (SELECT json_agg(row_to_json(me.*)) FROM month_expenses me) as expenses_by_day,\n  (SELECT json_agg(row_to_json(mi.*)) FROM month_income mi) as income_by_day,\n  (SELECT json_agg(row_to_json(cb.*)) FROM category_breakdown cb) as category_breakdown,\n  bc.budget_amount,\n  bc.currency as budget_currency,\n  bc.budget_used_percent,\n  TO_CHAR(DATE_TRUNC('month', (NOW() AT TIME ZONE 'Asia/Bishkek')::DATE), 'DD.MM.YYYY') as period_start,\n  TO_CHAR(DATE_TRUNC('month', (NOW() AT TIME ZONE 'Asia/Bishkek')::DATE) + INTERVAL '1 month' - INTERVAL '1 day', 'DD.MM.YYYY') as period_end,\n  TO_CHAR(DATE_TRUNC('month', (NOW() AT TIME ZONE 'Asia/Bishkek')::DATE), 'Month YYYY') as month_name\nFROM month_summary ms\nCROSS JOIN month_income_summary mis\nLEFT JOIN budget_comparison bc ON true;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        672,
        960
      ],
      "id": "a91b6a46-4310-405e-8f68-56da9e086ab0",
      "name": "Get Monthly Data",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Подготовка данных для месячного PDF отчета\nconst data = $input.first().json;\n\n// Функция форматирования валюты\nfunction formatCurrency(amount, symbol = 'сом') {\n  return `${Math.round(amount)} ${symbol}`;\n}\n\n// Форматируем категории с детализацией\nconst categoryBreakdown = (data.category_breakdown || []).map(cat => {\n  const total = Math.round(parseFloat(cat.category_total || 0));\n  return {\n    category: cat.category,\n    amount: total,\n    amount_formatted: formatCurrency(total),\n    count: parseInt(cat.category_count || 0),\n    percentage: parseFloat(cat.percentage || 0)\n  };\n});\n\n// Топ 5 категорий для графиков\nconst topCategories = categoryBreakdown.slice(0, 5).map(cat => ({\n  category: cat.category,\n  amount: cat.amount,\n  percentage: cat.percentage\n}));\n\n// Данные по неделям (группировка по неделям)\nconst expensesByDay = data.expenses_by_day || [];\nconst incomeByDay = data.income_by_day || [];\n\n// Группируем по неделям (примерно 7 дней в неделе)\nconst weeklyData = [];\nconst daysInMonth = 30;\nfor (let week = 1; week <= 4; week++) {\n  const startDay = (week - 1) * 7 + 1;\n  const endDay = Math.min(week * 7, daysInMonth);\n  \n  let weekExpenses = 0;\n  let weekIncome = 0;\n  \n  expensesByDay.forEach(exp => {\n    const day = new Date(exp.expense_date).getDate();\n    if (day >= startDay && day <= endDay) {\n      weekExpenses += parseFloat(exp.daily_total || 0);\n    }\n  });\n  \n  incomeByDay.forEach(inc => {\n    const day = new Date(inc.income_date).getDate();\n    if (day >= startDay && day <= endDay) {\n      weekIncome += parseFloat(inc.daily_total || 0);\n    }\n  });\n  \n  weeklyData.push({\n    label: `Неделя ${week}`,\n    expenses: Math.round(weekExpenses),\n    income: Math.round(weekIncome)\n  });\n}\n\n// Расчет основных показателей\nconst totalExpenses = Math.round(parseFloat(data.total_expenses || 0));\nconst totalIncome = Math.round(parseFloat(data.total_income || 0));\nconst balance = totalIncome - totalExpenses;\nconst transactionCount = parseInt(data.expense_count || 0) + parseInt(data.income_count || 0);\n\n// Расчет бюджета\nconst budgetAmount = Math.round(parseFloat(data.budget_amount || 0));\nconst budgetUsedPercent = budgetAmount > 0 ? Math.round((totalExpenses / budgetAmount) * 100) : 0;\nconst budgetRemaining = budgetAmount - totalExpenses;\n\n// Средние показатели\nconst avgDailyExpense = Math.round(totalExpenses / daysInMonth);\nconst avgDailyIncome = Math.round(totalIncome / daysInMonth);\n\n// Прогноз на следующий месяц (простая экстраполяция)\nconst forecastExpense = Math.round(totalExpenses * 1.05); // +5%\nconst forecastIncome = Math.round(totalIncome * 1.03); // +3%\nconst forecastBalance = forecastIncome - forecastExpense;\n\n// Итоговые данные\nconst result = {\n  // Заголовок\n  period: `${data.period_start || '01.10.2025'} - ${data.period_end || '31.10.2025'}`,\n  user_name: data.user_name || 'Пользователь',\n  currency_symbol: 'сом',\n  \n  // Основные показатели (числа для графиков)\n  total_expenses: totalExpenses,\n  total_income: totalIncome,\n  balance: balance,\n  transaction_count: transactionCount,\n  \n  // Форматированные основные показатели\n  total_expenses_formatted: formatCurrency(totalExpenses),\n  total_income_formatted: formatCurrency(totalIncome),\n  balance_formatted: formatCurrency(balance),\n  \n  // Бюджет\n  budget_amount: budgetAmount,\n  budget_used: totalExpenses,\n  budget_used_percent: budgetUsedPercent,\n  budget_remaining: budgetRemaining,\n  \n  // Форматированный бюджет\n  budget_amount_formatted: formatCurrency(budgetAmount),\n  budget_used_formatted: formatCurrency(totalExpenses),\n  budget_remaining_formatted: formatCurrency(budgetRemaining),\n  \n  // Средние показатели\n  avg_daily_expense: avgDailyExpense,\n  avg_daily_income: avgDailyIncome,\n  \n  // Форматированные средние\n  avg_daily_expense_formatted: formatCurrency(avgDailyExpense),\n  avg_daily_income_formatted: formatCurrency(avgDailyIncome),\n  \n  // Прогноз\n  forecast_expense: forecastExpense,\n  forecast_income: forecastIncome,\n  forecast_balance: forecastBalance,\n  \n  // Форматированный прогноз\n  forecast_expense_formatted: formatCurrency(forecastExpense),\n  forecast_income_formatted: formatCurrency(forecastIncome),\n  forecast_balance_formatted: formatCurrency(forecastBalance),\n  \n  // Данные по неделям для area chart\n  weekly_data: weeklyData,\n  \n  // Топ 5 категорий для графиков\n  top_categories: topCategories,\n  \n  // Детальная таблица категорий\n  expense_breakdown: categoryBreakdown\n};\n\nreturn [{ json: result }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        896,
        960
      ],
      "id": "da6d4ccc-71b7-4afe-99da-164d5c3a1a3c",
      "name": "Format Monthly Data"
    },
    {
      "parameters": {
        "resource": "pdf",
        "pdfTemplateId": "c1177b23eddd4e88",
        "jsonParameters": true,
        "propertiesJson": "={{ JSON.stringify($json) }}"
      },
      "type": "n8n-nodes-base.apiTemplateIo",
      "typeVersion": 1,
      "position": [
        1120,
        960
      ],
      "id": "04d1f492-23dd-4ae0-ac95-a9d86ae24b98",
      "name": "Generate Monthly PDF",
      "credentials": {
        "apiTemplateIoApi": {
          "id": "NIFEHHMbU4WCVxC0",
          "name": "Weekly report"
        }
      }
    },
    {
      "parameters": {
        "operation": "sendDocument",
        "chatId": "={{ $('Get Monthly Data').first().json.chat_id }}",
        "file": "={{ $json.download_url }}",
        "additionalFields": {
          "caption": "=📊 *Месячный отчет* - {{ $('Format Monthly Data').first().json.month }}\n\n📅 Период: {{ $('Format Monthly Data').first().json.period }}\n👤 {{ $('Format Monthly Data').first().json.user_name }}\n\n💸 Расходы: {{ $('Format Monthly Data').first().json.total_expenses_formatted }}\n💰 Доходы: {{ $('Format Monthly Data').first().json.total_income_formatted }}\n📈 Баланс: {{ $('Format Monthly Data').first().json.balance_formatted }}\n\n💼 Бюджет: {{ $('Format Monthly Data').first().json.budget_amount_formatted }}\n📊 Использовано: {{ $('Format Monthly Data').first().json.budget_used_percent }}%\n{{ $('Format Monthly Data').first().json.budget_status }}\n\n📝 Транзакций: {{ $('Format Monthly Data').first().json.transaction_count }}",
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2872,
        960
      ],
      "id": "71ba5971-93b0-4222-bdfd-0e55d6940906",
      "name": "Send Monthly PDF",
      "webhookId": "monthly-pdf-send",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.text }}",
        "options": {
          "systemMessage": "=Ты финансовый помощник, который помогает пользователю получать отчеты за указанный период. \n\nКогда пользователь просит отчет за период, ты должен:\n1. Распознать даты начала и конца периода из текста\n2. Использовать инструмент Get_period_report_data для получения данных\n3. Сформировать краткий текстовый ответ с основными цифрами\n4. Сгенерировать PDF через инструмент Generate_period_pdf\n\nПримеры запросов:\n- 'отчет за период с 1 октября по 31 октября'\n- 'отчет с 15.10.2025 по 20.10.2025'\n- 'покажи отчет за последний месяц'\n- 'отчет за октябрь'\n\nТекущая дата: {{ new Date().toLocaleDateString('ru-RU') }}"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        2808,
        3292
      ],
      "id": "2ee1ade6-d4b7-44af-9cd7-447370dec69e",
      "name": "Period Report Agent"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "period-text-field",
              "name": "text",
              "value": "={{ $('Telegram Bot Trigger').first().json.message.text }}",
              "type": "string"
            },
            {
              "id": "period-user-id",
              "name": "user_id",
              "value": "={{ $('Telegram Bot Trigger').first().json.message.from.id }}",
              "type": "number"
            },
            {
              "id": "period-chat-id",
              "name": "chat_id",
              "value": "={{ $('Telegram Bot Trigger').first().json.message.chat.id }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1120,
        4480
      ],
      "id": "02dc9fb0-b8fa-4b28-bbe6-270f65e30b55",
      "name": "Prepare Period Request"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n),\nperiod_expenses AS (\n  SELECT \n    DATE(date) as expense_date,\n    category,\n    SUM(amount) as daily_total,\n    currency,\n    COUNT(*) as transaction_count,\n    json_agg(\n      json_build_object(\n        'amount', amount,\n        'description', description,\n        'date', TO_CHAR(date, 'DD.MM.YYYY')\n      )\n    ) as transactions\n  FROM expenses\n  WHERE user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND workspace_id = (SELECT workspace_id FROM user_workspace)\n    AND date >= TO_DATE('{{ $fromAI(\"start_date\", \"Дата начала периода в формате DD.MM.YYYY\", \"string\") }}', 'DD.MM.YYYY')\n    AND date <= TO_DATE('{{ $fromAI(\"end_date\", \"Дата окончания периода в формате DD.MM.YYYY\", \"string\") }}', 'DD.MM.YYYY')\n    AND deleted_at IS NULL\n  GROUP BY DATE(date), category, currency\n  ORDER BY DATE(date) DESC\n),\nperiod_income AS (\n  SELECT \n    DATE(date) as income_date,\n    category,\n    SUM(amount) as daily_total,\n    currency\n  FROM income\n  WHERE user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND workspace_id = (SELECT workspace_id FROM user_workspace)\n    AND date >= TO_DATE('{{ $fromAI(\"start_date\", \"Дата начала периода в формате DD.MM.YYYY\", \"string\") }}', 'DD.MM.YYYY')\n    AND date <= TO_DATE('{{ $fromAI(\"end_date\", \"Дата окончания периода в формате DD.MM.YYYY\", \"string\") }}', 'DD.MM.YYYY')\n    AND deleted_at IS NULL\n  GROUP BY DATE(date), category, currency\n),\nperiod_summary AS (\n  SELECT \n    COALESCE(SUM(amount), 0) as total_expenses,\n    COUNT(*) as expense_count\n  FROM expenses\n  WHERE user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND workspace_id = (SELECT workspace_id FROM user_workspace)\n    AND date >= TO_DATE('{{ $fromAI(\"start_date\", \"Дата начала периода в формате DD.MM.YYYY\", \"string\") }}', 'DD.MM.YYYY')\n    AND date <= TO_DATE('{{ $fromAI(\"end_date\", \"Дата окончания периода в формате DD.MM.YYYY\", \"string\") }}', 'DD.MM.YYYY')\n    AND deleted_at IS NULL\n),\nperiod_income_summary AS (\n  SELECT \n    COALESCE(SUM(amount), 0) as total_income,\n    COUNT(*) as income_count\n  FROM income\n  WHERE user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND workspace_id = (SELECT workspace_id FROM user_workspace)\n    AND date >= TO_DATE('{{ $fromAI(\"start_date\", \"Дата начала периода в формате DD.MM.YYYY\", \"string\") }}', 'DD.MM.YYYY')\n    AND date <= TO_DATE('{{ $fromAI(\"end_date\", \"Дата окончания периода в формате DD.MM.YYYY\", \"string\") }}', 'DD.MM.YYYY')\n    AND deleted_at IS NULL\n),\ncategory_totals AS (\n  SELECT \n    category,\n    SUM(amount) as category_total,\n    ROUND((SUM(amount) / (SELECT total_expenses FROM period_summary)) * 100, 1) as percentage\n  FROM expenses\n  WHERE user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND workspace_id = (SELECT workspace_id FROM user_workspace)\n    AND date >= TO_DATE('{{ $fromAI(\"start_date\", \"Дата начала периода в формате DD.MM.YYYY\", \"string\") }}', 'DD.MM.YYYY')\n    AND date <= TO_DATE('{{ $fromAI(\"end_date\", \"Дата окончания периода в формате DD.MM.YYYY\", \"string\") }}', 'DD.MM.YYYY')\n    AND deleted_at IS NULL\n  GROUP BY category\n  ORDER BY category_total DESC\n)\nSELECT \n  {{ $('Telegram Bot Trigger').first().json.message.from.id }} as user_id,\n  {{ $('Telegram Bot Trigger').first().json.message.chat.id }} as chat_id,\n  (SELECT workspace_id FROM user_workspace) as workspace_id,\n  ps.total_expenses,\n  pis.total_income,\n  ps.expense_count,\n  pis.income_count,\n  (SELECT json_agg(row_to_json(pe.*)) FROM period_expenses pe) as expenses_by_day,\n  (SELECT json_agg(row_to_json(pi.*)) FROM period_income pi) as income_by_day,\n  (SELECT json_agg(row_to_json(ct.*)) FROM category_totals ct) as category_totals,\n  '{{ $fromAI(\"start_date\", \"Дата начала периода в формате DD.MM.YYYY\", \"string\") }}' as period_start,\n  '{{ $fromAI(\"end_date\", \"Дата окончания периода в формате DD.MM.YYYY\", \"string\") }}' as period_end\nFROM period_summary ps\nCROSS JOIN period_income_summary pis;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        2880,
        3516
      ],
      "id": "7437bb51-4397-46bc-b45a-0f400992331e",
      "name": "Get_period_report_data",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "resource": "pdf",
        "pdfTemplateId": "49c77b23ede0d4e6",
        "jsonParameters": true,
        "propertiesJson": "=// Получаем данные из Get_period_report_data\nconst data = $('Get_period_report_data').first().json;\n\n// Функция форматирования валюты\nfunction formatCurrency(amount, symbol = 'сом') {\n  return `${Math.round(amount)} ${symbol}`;\n}\n\n// Рассчитываем период дней\nconst startDate = new Date(data.period_start.split('.').reverse().join('-'));\nconst endDate = new Date(data.period_end.split('.').reverse().join('-'));\nconst periodDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;\n\n// Основные показатели\nconst totalExpenses = Math.round(parseFloat(data.total_expenses || 0));\nconst totalIncome = Math.round(parseFloat(data.total_income || 0));\nconst balance = totalIncome - totalExpenses;\nconst transactionCount = parseInt(data.expense_count || 0) + parseInt(data.income_count || 0);\n\n// Аналитические метрики\nconst avgExpensePerDay = Math.round(totalExpenses / periodDays);\nconst avgIncomePerDay = Math.round(totalIncome / periodDays);\n\n// Находим максимальный расход\nconst expensesByDay = data.expenses_by_day || [];\nlet maxExpense = 0;\nexpensesByDay.forEach(exp => {\n  const daily = parseFloat(exp.daily_total || 0);\n  if (daily > maxExpense) maxExpense = daily;\n});\nmaxExpense = Math.round(maxExpense);\n\n// Форматируем daily_data для графика\nconst dailyMap = {};\nexpensesByDay.forEach(exp => {\n  const date = new Date(exp.expense_date).toLocaleDateString('ru-RU', {day: '2-digit', month: '2-digit'});\n  if (!dailyMap[date]) dailyMap[date] = {date, expenses: 0, income: 0};\n  dailyMap[date].expenses += parseFloat(exp.daily_total || 0);\n});\n\nconst incomeByDay = data.income_by_day || [];\nincomeByDay.forEach(inc => {\n  const date = new Date(inc.income_date).toLocaleDateString('ru-RU', {day: '2-digit', month: '2-digit'});\n  if (!dailyMap[date]) dailyMap[date] = {date, expenses: 0, income: 0};\n  dailyMap[date].income += parseFloat(inc.daily_total || 0);\n});\n\nconst dailyData = Object.values(dailyMap).map(d => ({\n  date: d.date,\n  expenses: Math.round(d.expenses),\n  income: Math.round(d.income)\n}));\n\n// Форматируем категории\nconst categoryTotals = (data.category_totals || []).map(cat => ({\n  category: cat.category,\n  category_total: Math.round(parseFloat(cat.category_total || 0)),\n  category_total_formatted: formatCurrency(parseFloat(cat.category_total || 0)),\n  percentage: parseFloat(cat.percentage || 0)\n}));\n\n// Собираем все транзакции для таблицы\nconst allTransactions = [];\n\n// Добавляем расходы\nexpensesByDay.forEach(exp => {\n  const transactions = exp.transactions || [];\n  transactions.forEach(tx => {\n    allTransactions.push({\n      date: tx.date,\n      category: exp.category,\n      description: tx.description || 'Без описания',\n      type: 'expense',\n      amount: Math.round(parseFloat(tx.amount || 0)),\n      amount_formatted: formatCurrency(parseFloat(tx.amount || 0))\n    });\n  });\n});\n\n// Добавляем доходы\nincomeByDay.forEach(inc => {\n  const date = new Date(inc.income_date).toLocaleDateString('ru-RU', {day: '2-digit', month: '2-digit'});\n  allTransactions.push({\n    date: date,\n    category: inc.category,\n    description: inc.category,\n    type: 'income',\n    amount: Math.round(parseFloat(inc.daily_total || 0)),\n    amount_formatted: formatCurrency(parseFloat(inc.daily_total || 0))\n  });\n});\n\n// Сортируем транзакции по дате (новые первые)\nallTransactions.sort((a, b) => {\n  const dateA = a.date.split('.').reverse().join('');\n  const dateB = b.date.split('.').reverse().join('');\n  return dateB.localeCompare(dateA);\n});\n\n// Формируем итоговый объект\nJSON.stringify({\n  user_name: 'Пользователь',\n  period_start: data.period_start,\n  period_end: data.period_end,\n  period_days: periodDays,\n  currency_symbol: 'сом',\n  \n  // Основные метрики\n  total_expenses: totalExpenses,\n  total_expenses_formatted: formatCurrency(totalExpenses),\n  total_income: totalIncome,\n  total_income_formatted: formatCurrency(totalIncome),\n  balance: balance,\n  balance_formatted: formatCurrency(balance),\n  transaction_count: transactionCount,\n  \n  // Аналитика\n  avg_expense_per_day: avgExpensePerDay,\n  avg_expense_per_day_formatted: formatCurrency(avgExpensePerDay),\n  avg_income_per_day: avgIncomePerDay,\n  avg_income_per_day_formatted: formatCurrency(avgIncomePerDay),\n  max_expense: maxExpense,\n  max_expense_formatted: formatCurrency(maxExpense),\n  \n  // Данные для графиков\n  daily_data: dailyData,\n  category_totals: categoryTotals,\n  \n  // Таблица транзакций\n  all_transactions: allTransactions.slice(0, 50) // Ограничиваем 50 транзакциями\n});"
      },
      "type": "n8n-nodes-base.apiTemplateIoTool",
      "typeVersion": 1,
      "position": [
        3008,
        3516
      ],
      "id": "9b4b77ef-62e8-42a5-8c90-23bd0f88ce39",
      "name": "Generate_period_pdf",
      "credentials": {
        "apiTemplateIoApi": {
          "id": "NIFEHHMbU4WCVxC0",
          "name": "Weekly report"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        2752,
        3516
      ],
      "id": "55f5ac68-1346-4f6a-987d-51ebd7c2e590",
      "name": "OpenAI Period Model",
      "credentials": {
        "openAiApi": {
          "id": "YWdBHhtpkxTSXDR7",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Bot Trigger').first().json.message.chat.id }}",
        "text": "={{ $json.output }}",
        "additionalFields": {
          "appendAttribution": false,
          "reply_to_message_id": "={{ $('Telegram Bot Trigger').first().json.message.message_id }}"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        4688,
        3396
      ],
      "id": "19d420a2-8b80-4b81-9748-592b1c12b864",
      "name": "Send Period Response",
      "webhookId": "period-response-send",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "voice-weekly",
                    "leftValue": "={{ $json.text }}",
                    "rightValue": "(недельный отчет|недельный отчёт|отчет за неделю|отчёт за неделю)",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Weekly Report Voice"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "voice-monthly",
                    "leftValue": "={{ $json.text }}",
                    "rightValue": "(месячный отчет|месячный отчёт|отчет за месяц|отчёт за месяц)",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Monthly Report Voice"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "voice-period",
                    "leftValue": "={{ $json.text }}",
                    "rightValue": "(отчет за период|отчёт за период|отчет с|отчёт с)",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Period Report Voice"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "voice-other",
                    "leftValue": "={{ $json.text }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Regular Voice"
            }
          ]
        },
        "options": {}
      },
      "id": "97ad0e9b-02f7-4cfe-82da-d9a7713a9543",
      "name": "Voice Command Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        896,
        2176
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "voice-text-assign",
              "name": "text",
              "value": "={{ $json.text }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1120,
        1932
      ],
      "id": "cb7261ee-de28-41f3-ba5c-e4f369b4a08c",
      "name": "Prepare Voice as Text"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "user-id-assign",
              "name": "user_id",
              "value": "={{ $('Telegram Bot Trigger').first().json.message.from.id }}",
              "type": "number"
            },
            {
              "id": "chat-id-assign",
              "name": "telegram_chat_id",
              "value": "={{ $('Telegram Bot Trigger').first().json.message.chat.id }}",
              "type": "number"
            },
            {
              "id": "first-name-assign",
              "name": "first_name",
              "value": "={{ $('Telegram Bot Trigger').first().json.message.from.first_name }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1120,
        4724
      ],
      "id": "81827bee-a690-4906-9e83-86a1af77dd97",
      "name": "Prepare User for Daily"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "user-id-assign-weekly",
              "name": "user_id",
              "value": "={{ $('Telegram Bot Trigger').first().json.message.from.id }}",
              "type": "number"
            },
            {
              "id": "chat-id-assign-weekly",
              "name": "telegram_chat_id",
              "value": "={{ $('Telegram Bot Trigger').first().json.message.chat.id }}",
              "type": "number"
            },
            {
              "id": "first-name-assign-weekly",
              "name": "first_name",
              "value": "={{ $('Telegram Bot Trigger').first().json.message.from.first_name }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        448,
        2544
      ],
      "id": "29fc4c96-78db-4597-b3ce-01494cba25f0",
      "name": "Prepare User for Weekly"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "user-id-assign-monthly",
              "name": "user_id",
              "value": "={{ $('Telegram Bot Trigger').first().json.message.from.id }}",
              "type": "number"
            },
            {
              "id": "chat-id-assign-monthly",
              "name": "telegram_chat_id",
              "value": "={{ $('Telegram Bot Trigger').first().json.message.chat.id }}",
              "type": "number"
            },
            {
              "id": "first-name-assign-monthly",
              "name": "first_name",
              "value": "={{ $('Telegram Bot Trigger').first().json.message.from.first_name }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        448,
        2736
      ],
      "id": "7cd22716-52c1-4472-857d-978ba7d82462",
      "name": "Prepare User for Monthly"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT \n  u.user_id,\n  u.first_name,\n  u.username,\n  u.preferred_currency,\n  CASE u.preferred_currency\n    WHEN 'KGS' THEN 'сом'\n    WHEN 'USD' THEN '$'\n    WHEN 'EUR' THEN '€'\n    WHEN 'RUB' THEN '₽'\n    ELSE 'сом'\n  END as currency_symbol,\n  u.usage_type,\n  u.occupation,\n  u.country,\n  TO_CHAR(u.registered_date, 'DD.MM.YYYY') as member_since,\n  (\n    SELECT COUNT(*) FROM expenses \n    WHERE user_id = u.user_id AND deleted_at IS NULL\n  ) as total_expenses_count,\n  (\n    SELECT COUNT(*) FROM income \n    WHERE user_id = u.user_id AND deleted_at IS NULL\n  ) as total_income_count,\n  (\n    SELECT budget_amount FROM budgets \n    WHERE user_id = u.user_id \n    AND month = TO_CHAR(CURRENT_DATE, 'YYYY-MM')\n    LIMIT 1\n  ) as current_budget,\n  (\n    SELECT w.name FROM workspaces w\n    JOIN workspace_members wm ON w.id = wm.workspace_id\n    WHERE wm.user_id = u.user_id AND wm.is_active = true AND w.is_active = true\n    ORDER BY wm.joined_at DESC\n    LIMIT 1\n  ) as active_workspace\nFROM users u\nWHERE u.user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }};",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        448,
        2928
      ],
      "id": "3a1f6cf2-f966-4813-a251-ba71d2936a7b",
      "name": "Get Profile Data",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Bot Trigger').first().json.message.chat.id || $('Telegram Bot Trigger').first().json.callback_query.message.chat.id }}",
        "text": "=👤 *Мой профиль*\n\n📛 Имя: {{ $json.first_name }}\n{{ $json.username ? '🔗 Username: @' + $json.username : '' }}\n💼 Тип: {{ $json.usage_type === 'business' ? 'Бизнес' : 'Личное' }}\n{{ $json.occupation ? '💡 Сфера: ' + $json.occupation : '' }}\n{{ $json.country ? '🌍 Страна: ' + $json.country : '' }}\n{{ $json.active_workspace ? '🏢 Рабочее пространство: ' + $json.active_workspace : '' }}\n\n💰 Валюта: {{ $json.preferred_currency }} {{ $json.currency_symbol }}\n{{ $json.current_budget ? '📊 Бюджет на месяц: ' + $json.current_budget + ' ' + $json.currency_symbol : '📊 Бюджет: не установлен' }}\n\n📈 Статистика:\n• Транзакций расходов: {{ $json.total_expenses_count || 0 }}\n• Транзакций доходов: {{ $json.total_income_count || 0 }}\n\n📅 С нами с: {{ $json.member_since }}",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "⚙️ Настройки",
                    "additionalFields": {
                      "callback_data": "settings_menu"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "💱 Сменить валюту",
                    "additionalFields": {
                      "callback_data": "change_currency"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "📊 Установить бюджет",
                    "additionalFields": {
                      "callback_data": "set_budget"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        672,
        2928
      ],
      "id": "96ace4f2-096c-4a47-87ae-a62094536c46",
      "name": "Send Profile",
      "webhookId": "d11bc65d-ff99-43b0-a95f-94f1db693900",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH category_stats AS (\n  SELECT \n    category,\n    COUNT(*) as transaction_count,\n    SUM(amount) as total_amount,\n    currency,\n    ROUND(AVG(amount), 2) as avg_amount,\n    MIN(amount) as min_amount,\n    MAX(amount) as max_amount,\n    ROUND(\n      (SUM(amount) / NULLIF(\n        (SELECT SUM(amount) FROM expenses \n         WHERE user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }} \n         AND DATE_TRUNC('month', date) = DATE_TRUNC('month', CURRENT_DATE)\n         AND deleted_at IS NULL), 0\n      )) * 100, 1\n    ) as percentage\n  FROM expenses\n  WHERE user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND DATE_TRUNC('month', date) = DATE_TRUNC('month', CURRENT_DATE)\n    AND deleted_at IS NULL\n  GROUP BY category, currency\n  ORDER BY total_amount DESC\n),\nmonth_total AS (\n  SELECT \n    SUM(amount) as total,\n    COUNT(*) as count,\n    COUNT(DISTINCT category) as unique_categories\n  FROM expenses\n  WHERE user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND DATE_TRUNC('month', date) = DATE_TRUNC('month', CURRENT_DATE)\n    AND deleted_at IS NULL\n)\nSELECT \n  (SELECT json_agg(row_to_json(cs.*) ORDER BY cs.total_amount DESC) FROM category_stats cs) as categories,\n  mt.total as month_total,\n  mt.count as month_count,\n  mt.unique_categories,\n  TO_CHAR(CURRENT_DATE, 'Month YYYY') as current_month\nFROM month_total mt;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        448,
        3120
      ],
      "id": "3ea79a3e-73d1-4994-8f41-cc84274b06dc",
      "name": "Get Categories Data",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Bot Trigger').first().json.message.chat.id || $('Telegram Bot Trigger').first().json.callback_query.message.chat.id }}",
        "text": "=📂 *Отчет по категориям*\n📅 Период: {{ $json.current_month }}\n\n💰 Всего потрачено: {{ Math.round($json.month_total || 0) }} сом\n📝 Транзакций: {{ $json.month_count || 0 }}\n🏷️ Категорий: {{ $json.unique_categories || 0 }}\n\n{{ ($json.categories || []).length > 0 ? '📊 *Детализация:*\\n\\n' + ($json.categories || []).map((cat, idx) => {\n  const emoji = ['🥇', '🥈', '🥉', '4️⃣', '5️⃣', '6️⃣', '7️⃣', '8️⃣', '9️⃣', '🔟'][idx] || '▫️';\n  const bar = '█'.repeat(Math.min(Math.round((cat.percentage || 0) / 5), 20));\n  return `${emoji} *${cat.category}*\\n   💸 ${Math.round(cat.total_amount)} ${cat.currency} (${cat.percentage}%)\\n   📊 ${bar}\\n   📝 ${cat.transaction_count} транзакций • Средний чек: ${Math.round(cat.avg_amount)} ${cat.currency}`;\n}).join('\\n\\n') : '📭 Нет данных за текущий месяц' }}\n\n💡 *Совет:* Используйте команду /budget для установки лимитов по категориям",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "💵 Бюджет",
                    "additionalFields": {
                      "callback_data": "view_budget"
                    }
                  },
                  {
                    "text": "💎 Баланс",
                    "additionalFields": {
                      "callback_data": "view_balance"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        672,
        3120
      ],
      "id": "27fb3a40-c8f2-4fb4-ba55-1fe195d97fca",
      "name": "Send Categories Report",
      "webhookId": "categories-send",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH current_budget AS (\n  SELECT \n    budget_amount,\n    currency,\n    month\n  FROM budgets\n  WHERE user_id = {{ $json.user_id || $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND month = TO_CHAR(CURRENT_DATE, 'YYYY-MM')\n  LIMIT 1\n),\nmonth_expenses AS (\n  SELECT \n    COALESCE(SUM(amount), 0) as total_spent,\n    COUNT(*) as transaction_count\n  FROM expenses\n  WHERE user_id = {{ $json.user_id || $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND DATE_TRUNC('month', date) = DATE_TRUNC('month', CURRENT_DATE)\n    AND deleted_at IS NULL\n),\ndays_data AS (\n  SELECT \n    EXTRACT(DAY FROM CURRENT_DATE) as current_day,\n    EXTRACT(DAY FROM (DATE_TRUNC('month', CURRENT_DATE) + INTERVAL '1 month' - INTERVAL '1 day')::DATE) as days_in_month\n)\nSELECT \n  cb.budget_amount,\n  cb.currency,\n  cb.month,\n  me.total_spent,\n  me.transaction_count,\n  CASE \n    WHEN cb.budget_amount > 0 THEN cb.budget_amount - me.total_spent\n    ELSE 0\n  END as remaining,\n  CASE \n    WHEN cb.budget_amount > 0 THEN ROUND((me.total_spent / cb.budget_amount) * 100, 1)\n    ELSE 0\n  END as used_percent,\n  CASE \n    WHEN cb.budget_amount > 0 AND dd.days_in_month > dd.current_day \n    THEN ROUND((cb.budget_amount - me.total_spent) / (dd.days_in_month - dd.current_day), 2)\n    ELSE 0\n  END as daily_budget_remaining,\n  dd.current_day,\n  dd.days_in_month,\n  CASE \n    WHEN cb.budget_amount IS NULL THEN false\n    ELSE true\n  END as has_budget\nFROM current_budget cb\nCROSS JOIN month_expenses me\nCROSS JOIN days_data dd;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        672,
        768
      ],
      "id": "c9175831-c78f-4673-ad18-9db33b1c26d5",
      "name": "Get Budget Data",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Bot Trigger').first().json.message.chat.id || $('Telegram Bot Trigger').first().json.callback_query.message.chat.id }}",
        "text": "={{ $json.has_budget ? \n  `💵 *Мой бюджет*\\n📅 Месяц: ${$json.month}\\n\\n💰 Бюджет: ${Math.round($json.budget_amount)} ${$json.currency}\\n💸 Потрачено: ${Math.round($json.total_spent)} ${$json.currency}\\n💎 Осталось: ${Math.round($json.remaining)} ${$json.currency}\\n\\n📊 Использовано: ${$json.used_percent}%\\n${'█'.repeat(Math.min(Math.round($json.used_percent / 5), 20))}${'░'.repeat(Math.max(0, 20 - Math.round($json.used_percent / 5)))}\\n\\n📝 Транзакций: ${$json.transaction_count}\\n📆 День ${$json.current_day} из ${$json.days_in_month}\\n💡 Можно тратить: ${Math.round($json.daily_budget_remaining)} ${$json.currency}/день\\n\\n${\n    $json.used_percent > 100 ? '⚠️ *Бюджет превышен!*' :\n    $json.used_percent > 90 ? '🟠 *Осторожно, бюджет почти исчерпан*' :\n    $json.used_percent > 75 ? '🟡 *Расходы выше нормы*' :\n    '🟢 *Все в порядке*'\n  }` \n  : \n  '💵 *Бюджет не установлен*\\n\\n📊 Установите месячный бюджет для контроля расходов.\\n\\n💡 Напишите: \"Установить бюджет 50000 сом\"'\n}}",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "={{ $json.has_budget ? '✏️ Изменить бюджет' : '➕ Установить бюджет' }}",
                    "additionalFields": {
                      "callback_data": "set_budget"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "📂 Категории",
                    "additionalFields": {
                      "callback_data": "view_categories"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        896,
        768
      ],
      "id": "85513ce8-88c5-4c1b-97d3-481ea9e89ee7",
      "name": "Send Budget Info",
      "webhookId": "budget-send",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH total_income AS (\n  SELECT COALESCE(SUM(amount), 0) as total\n  FROM income\n  WHERE user_id = {{ $json.user_id || $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND deleted_at IS NULL\n),\ntotal_expenses AS (\n  SELECT COALESCE(SUM(amount), 0) as total\n  FROM expenses\n  WHERE user_id = {{ $json.user_id || $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND deleted_at IS NULL\n),\nmonth_income AS (\n  SELECT COALESCE(SUM(amount), 0) as total\n  FROM income\n  WHERE user_id = {{ $json.user_id || $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND DATE_TRUNC('month', date) = DATE_TRUNC('month', CURRENT_DATE)\n    AND deleted_at IS NULL\n),\nmonth_expenses AS (\n  SELECT COALESCE(SUM(amount), 0) as total\n  FROM expenses\n  WHERE user_id = {{ $json.user_id || $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND DATE_TRUNC('month', date) = DATE_TRUNC('month', CURRENT_DATE)\n    AND deleted_at IS NULL\n),\nuser_currency AS (\n  SELECT preferred_currency\n  FROM users\n  WHERE user_id = {{ $json.user_id || $('Telegram Bot Trigger').first().json.message.from.id }}\n)\nSELECT \n  ti.total as total_income,\n  te.total as total_expenses,\n  ti.total - te.total as balance,\n  mi.total as month_income,\n  me.total as month_expenses,\n  mi.total - me.total as month_balance,\n  uc.preferred_currency,\n  CASE uc.preferred_currency\n    WHEN 'KGS' THEN 'сом'\n    WHEN 'USD' THEN '$'\n    WHEN 'EUR' THEN '€'\n    WHEN 'RUB' THEN '₽'\n    ELSE 'сом'\n  END as currency_symbol\nFROM total_income ti\nCROSS JOIN total_expenses te\nCROSS JOIN month_income mi\nCROSS JOIN month_expenses me\nCROSS JOIN user_currency uc;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        448,
        1152
      ],
      "id": "034a98e6-2fbf-493d-8367-ba876bb2f348",
      "name": "Get Balance Data",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Bot Trigger').first().json.message.chat.id || $('Telegram Bot Trigger').first().json.callback_query.message.chat.id }}",
        "text": "=💎 *Мой баланс*\n\n📊 *ЗА ВСЕ ВРЕМЯ:*\n💰 Доходы: {{ Math.round($json.total_income) }} {{ $json.currency_symbol }}\n💸 Расходы: {{ Math.round($json.total_expenses) }} {{ $json.currency_symbol }}\n{{ $json.balance >= 0 ? '✅' : '⚠️' }} *Баланс: {{ Math.round($json.balance) }} {{ $json.currency_symbol }}*\n\n📅 *ТЕКУЩИЙ МЕСЯЦ:*\n💰 Доходы: {{ Math.round($json.month_income) }} {{ $json.currency_symbol }}\n💸 Расходы: {{ Math.round($json.month_expenses) }} {{ $json.currency_symbol }}\n{{ $json.month_balance >= 0 ? '✅' : '⚠️' }} Баланс: {{ Math.round($json.month_balance) }} {{ $json.currency_symbol }}\n\n{{ $json.month_balance < 0 ? '⚠️ *Внимание:* Расходы превышают доходы' : $json.month_balance === 0 ? '⚖️ Доходы равны расходам' : '🎉 Отличная работа! Есть профицит' }}",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "⚙️ Настройки",
                    "additionalFields": {
                      "callback_data": "settings_menu"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "💱 Сменить валюту",
                    "additionalFields": {
                      "callback_data": "change_currency"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "📊 Установить бюджет",
                    "additionalFields": {
                      "callback_data": "set_budget"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        672,
        1152
      ],
      "id": "a2b9da37-7d2f-4428-8f0b-0027446677ef",
      "name": "Send Balance",
      "webhookId": "balance-send",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Bot Trigger').first().json.message.chat.id }}",
        "text": "⚙️ *Настройки*\n\nВыберите, что хотите настроить:",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "💱 Валюта",
                    "additionalFields": {
                      "callback_data": "settings_currency"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "💵 Бюджет",
                    "additionalFields": {
                      "callback_data": "settings_budget"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "🏢 Рабочие пространства",
                    "additionalFields": {
                      "callback_data": "settings_workspaces"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "👤 Профиль",
                    "additionalFields": {
                      "callback_data": "view_profile"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        448,
        3312
      ],
      "id": "3cd7034a-4d26-4181-adef-c4163dcebed5",
      "name": "Send Settings Menu",
      "webhookId": "settings-send",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH latest_date AS (\n  SELECT MAX(date) as max_date FROM exchange_rates\n)\nSELECT \n  er.date,\n  er.to_currency as target_currency,\n  er.rate,\n  TO_CHAR(er.date, 'DD.MM.YYYY') as formatted_date\nFROM exchange_rates er\nCROSS JOIN latest_date ld\nWHERE er.date = ld.max_date\nORDER BY \n  CASE er.to_currency\n    WHEN 'USD' THEN 1\n    WHEN 'EUR' THEN 2\n    WHEN 'RUB' THEN 3\n    WHEN 'KZT' THEN 4\n    ELSE 5\n  END;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        448,
        1536
      ],
      "id": "1d48b030-08eb-4d2b-8d50-963d92fdd43b",
      "name": "Get Currency Rates",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Bot Trigger').first().json.message.chat.id || $('Telegram Bot Trigger').first().json.callback_query.message.chat.id }}",
        "text": "=💱 *Курсы валют*\n📅 На {{ $first($json).formatted_date }}\n\n{{ $json.map(rate => {\n  const flags = {USD: '🇺🇸', EUR: '🇪🇺', RUB: '🇷🇺', KZT: '🇰🇿'};\n  const names = {USD: 'Доллар США', EUR: 'Евро', RUB: 'Российский рубль', KZT: 'Казахстанский тенге'};\n  return `${flags[rate.target_currency] || '💰'} *${names[rate.target_currency] || rate.target_currency}*\\n   1 ${rate.target_currency} = ${rate.rate} KGS`;\n}).join('\\n\\n') }}\n\n💡 Курсы обновляются ежедневно в 10:00",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "🔄 Конвертировать",
                    "additionalFields": {
                      "callback_data": "convert_currency"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        672,
        1536
      ],
      "id": "6ae3952a-dc8b-4f5a-a039-09de26096efe",
      "name": "Send Currency Rates",
      "webhookId": "currency-send",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "resource": "callback",
        "queryId": "={{ $('Telegram Bot Trigger').first().json.callback_query.id }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        224,
        0
      ],
      "id": "18a17d42-5178-4b4c-a8dd-f6238f30cab3",
      "name": "Answer Callback Settings",
      "webhookId": "64dfba3a-e24e-41a8-9610-7507d2f7886e",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $('Telegram Bot Trigger').first().json.callback_query.message.chat.id }}",
        "messageId": "={{ $('Telegram Bot Trigger').first().json.callback_query.message.message_id }}",
        "replyMarkup": "inlineKeyboard",
        "text": "⚙️ *Настройки*\n\nВыберите, что хотите настроить:",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "💱 Валюта",
                    "additionalFields": {
                      "callback_data": "settings_currency"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "💵 Бюджет",
                    "additionalFields": {
                      "callback_data": "settings_budget"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "🏢 Рабочие пространства",
                    "additionalFields": {
                      "callback_data": "settings_workspaces"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "👤 Профиль",
                    "additionalFields": {
                      "callback_data": "view_profile"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        448,
        0
      ],
      "id": "99812cc5-353d-4576-b18b-3858e7686d9b",
      "name": "Show Settings Menu",
      "webhookId": "1d270968-6a0f-40ae-8dc7-367aca29ef4d",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "resource": "callback",
        "queryId": "={{ $('Telegram Bot Trigger').first().json.callback_query.id }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        224,
        192
      ],
      "id": "2dec0d4a-b5fe-4683-ae97-2cfe08c4efed",
      "name": "Answer Callback Currency",
      "webhookId": "d7a36860-7019-448a-8503-c38689da1a70",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $('Telegram Bot Trigger').first().json.callback_query.message.chat.id }}",
        "messageId": "={{ $('Telegram Bot Trigger').first().json.callback_query.message.message_id }}",
        "replyMarkup": "inlineKeyboard",
        "text": "💱 *Выберите валюту для учёта*\n\nТекущая валюта будет использоваться по умолчанию для всех транзакций:",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "🇰🇬 KGS (сом)",
                    "additionalFields": {
                      "callback_data": "currency_KGS"
                    }
                  },
                  {
                    "text": "🇺🇸 USD",
                    "additionalFields": {
                      "callback_data": "currency_USD"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "🇪🇺 EUR",
                    "additionalFields": {
                      "callback_data": "currency_EUR"
                    }
                  },
                  {
                    "text": "🇷🇺 RUB",
                    "additionalFields": {
                      "callback_data": "currency_RUB"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "◀️ Назад",
                    "additionalFields": {
                      "callback_data": "settings_menu"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        448,
        192
      ],
      "id": "f76981ff-dd8a-4b03-8c20-52ac7b739970",
      "name": "Show Currency Selection",
      "webhookId": "9ace66a1-46af-4823-bb74-f109fde7efa1",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "resource": "callback",
        "queryId": "={{ $('Telegram Bot Trigger').first().json.callback_query.id }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        448,
        384
      ],
      "id": "f824ca40-35d2-4b42-8e70-290c4f1912e5",
      "name": "Answer Currency Updated",
      "webhookId": "9ff5eba6-13b7-4841-8fa2-c52cb6eb2af9",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE users \nSET preferred_currency = '{{ $('Telegram Bot Trigger').first().json.callback_query.data.replace('currency_', '') }}'\nWHERE user_id = {{ $('Telegram Bot Trigger').first().json.callback_query.from.id }}\nRETURNING \n  preferred_currency,\n  CASE preferred_currency\n    WHEN 'KGS' THEN '🇰🇬 Сом'\n    WHEN 'USD' THEN '🇺🇸 Доллар'\n    WHEN 'EUR' THEN '🇪🇺 Евро'\n    WHEN 'RUB' THEN '🇷🇺 Рубль'\n    ELSE preferred_currency\n  END as currency_name;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        224,
        384
      ],
      "id": "5d511fea-91aa-4144-bf7e-48749d87f3f6",
      "name": "Update User Currency",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $('Telegram Bot Trigger').first().json.callback_query.message.chat.id }}",
        "messageId": "={{ $('Telegram Bot Trigger').first().json.callback_query.message.message_id }}",
        "replyMarkup": "inlineKeyboard",
        "text": "=✅ *Валюта обновлена!*\n\nВаша новая валюта: {{ $json.currency_name }}\n\nВсе новые транзакции будут использовать эту валюту по умолчанию.",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "◀️ Назад к настройкам",
                    "additionalFields": {
                      "callback_data": "settings_menu"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "👤 Мой профиль",
                    "additionalFields": {
                      "callback_data": "view_profile"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        672,
        384
      ],
      "id": "99d8e135-8f2c-4fe0-b76c-5bce1ce69170",
      "name": "Show Currency Updated",
      "webhookId": "fcdc314f-f8a7-4191-83a0-52122c7be119",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "resource": "callback",
        "queryId": "={{ $('Telegram Bot Trigger').first().json.callback_query.id }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        224,
        576
      ],
      "id": "53b10a53-c8c8-4566-9077-a6439e8019d6",
      "name": "Answer Callback Budget",
      "webhookId": "5c728211-690d-4e07-9bfa-37bd7aca25bf",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $('Telegram Bot Trigger').first().json.callback_query.message.chat.id }}",
        "messageId": "={{ $('Telegram Bot Trigger').first().json.callback_query.message.message_id }}",
        "replyMarkup": "inlineKeyboard",
        "text": "💵 *Установка бюджета*\n\nНапишите сообщение в формате:\n`Установить бюджет 50000`\n\nили\n\n`Бюджет на январь 2025: 75000 сом`\n\nБот автоматически создаст бюджет.",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "◀️ Назад",
                    "additionalFields": {
                      "callback_data": "settings_menu"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        448,
        576
      ],
      "id": "e02691e3-d5af-40a1-a8e6-19d3690cd870",
      "name": "Show Budget Instructions",
      "webhookId": "3aa18912-8c98-4a1d-9916-9f514fab3e39",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "resource": "callback",
        "queryId": "={{ $('Telegram Bot Trigger').first().json.callback_query.id }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        448,
        1728
      ],
      "id": "86ce42dc-7992-489e-ad6f-26510c7a4b37",
      "name": "Answer Callback Profile",
      "webhookId": "3f9db63f-fc82-4e8f-a007-0d321f621427",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT \n  u.user_id,\n  u.first_name,\n  u.username,\n  u.preferred_currency,\n  CASE u.preferred_currency\n    WHEN 'KGS' THEN 'сом'\n    WHEN 'USD' THEN '$'\n    WHEN 'EUR' THEN '€'\n    WHEN 'RUB' THEN '₽'\n    ELSE 'сом'\n  END as currency_symbol,\n  u.usage_type,\n  u.occupation,\n  u.country,\n  TO_CHAR(u.registered_date, 'DD.MM.YYYY') as member_since,\n  (\n    SELECT COUNT(*) FROM expenses \n    WHERE user_id = u.user_id AND deleted_at IS NULL\n  ) as total_expenses_count,\n  (\n    SELECT COUNT(*) FROM income \n    WHERE user_id = u.user_id AND deleted_at IS NULL\n  ) as total_income_count,\n  (\n    SELECT budget_amount FROM budgets \n    WHERE user_id = u.user_id \n    AND month = TO_CHAR(CURRENT_DATE, 'YYYY-MM')\n    LIMIT 1\n  ) as current_budget,\n  (\n    SELECT w.name FROM workspaces w\n    JOIN workspace_members wm ON w.id = wm.workspace_id\n    WHERE wm.user_id = u.user_id AND wm.is_active = true AND w.is_active = true\n    ORDER BY wm.joined_at DESC\n    LIMIT 1\n  ) as active_workspace\nFROM users u\nWHERE u.user_id = {{ $json.user_id }};",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        672,
        1728
      ],
      "id": "d0be2b2f-9da0-49c9-a1b0-54a60fa57d2f",
      "name": "Get Profile for Callback",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $('Telegram Bot Trigger').first().json.callback_query.message.chat.id }}",
        "messageId": "={{ $('Telegram Bot Trigger').first().json.callback_query.message.message_id }}",
        "replyMarkup": "inlineKeyboard",
        "text": "=👤 *Мой профиль*\n\n📛 Имя: {{ $json.first_name }}\n{{ $json.username ? '🔗 Username: @' + $json.username : '' }}\n💼 Тип: {{ $json.usage_type === 'business' ? 'Бизнес' : 'Личное' }}\n{{ $json.occupation ? '💡 Сфера: ' + $json.occupation : '' }}\n{{ $json.country ? '🌍 Страна: ' + $json.country : '' }}\n{{ $json.active_workspace ? '🏢 Workspace: ' + $json.active_workspace : '' }}\n\n💰 Валюта: {{ $json.preferred_currency }} {{ $json.currency_symbol }}\n{{ $json.current_budget ? '📊 Бюджет: ' + $json.current_budget + ' ' + $json.currency_symbol : '📊 Бюджет: не установлен' }}\n\n📈 Статистика:\n• Расходов: {{ $json.total_expenses_count || 0 }}\n• Доходов: {{ $json.total_income_count || 0 }}\n\n📅 С нами с: {{ $json.member_since }}",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "⚙️ Настройки",
                    "additionalFields": {
                      "callback_data": "settings_menu"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "💱 Сменить валюту",
                    "additionalFields": {
                      "callback_data": "change_currency"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "📊 Установить бюджет",
                    "additionalFields": {
                      "callback_data": "set_budget"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        896,
        1728
      ],
      "id": "9b250496-2f0d-4e4a-b58d-20db0a3cdb96",
      "name": "Show Profile Callback",
      "webhookId": "7418ebae-4a44-4f59-9158-b3eb65ed6531",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "resource": "callback",
        "queryId": "={{ $('Telegram Bot Trigger').first().json.callback_query.id }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        448,
        1920
      ],
      "id": "93348b11-a674-4a1a-84e3-6df0c8691987",
      "name": "Answer Callback Categories",
      "webhookId": "25212d82-f10f-4822-9c6c-03b065cf557f",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH category_stats AS (\n  SELECT \n    category,\n    COUNT(*) as transaction_count,\n    SUM(amount) as total_amount,\n    currency,\n    ROUND(AVG(amount), 2) as avg_amount,\n    ROUND(\n      (SUM(amount) / NULLIF(\n        (SELECT SUM(amount) FROM expenses \n         WHERE user_id = {{ $json.user_id }} \n         AND DATE_TRUNC('month', date) = DATE_TRUNC('month', CURRENT_DATE)\n         AND deleted_at IS NULL), 0\n      )) * 100, 1\n    ) as percentage\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    AND DATE_TRUNC('month', date) = DATE_TRUNC('month', CURRENT_DATE)\n    AND deleted_at IS NULL\n  GROUP BY category, currency\n  ORDER BY total_amount DESC\n  LIMIT 5\n),\nmonth_total AS (\n  SELECT \n    SUM(amount) as total,\n    COUNT(*) as count\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    AND DATE_TRUNC('month', date) = DATE_TRUNC('month', CURRENT_DATE)\n    AND deleted_at IS NULL\n),\nunique_cats AS (\n  SELECT COUNT(DISTINCT category) as unique_count\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    AND DATE_TRUNC('month', date) = DATE_TRUNC('month', CURRENT_DATE)\n    AND deleted_at IS NULL\n)\nSELECT \n  (SELECT json_agg(row_to_json(cs.*) ORDER BY cs.total_amount DESC) FROM category_stats cs) as categories,\n  mt.total as month_total,\n  mt.count as month_count,\n  uc.unique_count as unique_categories,\n  TO_CHAR(CURRENT_DATE, 'Month YYYY') as current_month\nFROM month_total mt\nCROSS JOIN unique_cats uc;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        672,
        1920
      ],
      "id": "3c63dadb-9dc8-4577-befd-2e44890adf80",
      "name": "Get Categories for Callback",
      "credentials": {
        "postgres": {
          "id": "TKaoUfPabvnDB4Ak",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Bot Trigger').first().json.message.chat.id || $('Telegram Bot Trigger').first().json.callback_query.message.chat.id }}",
        "text": "=📂 *Топ категорий*\n📅 {{ $json.current_month }}\n\n💰 Всего: {{ Math.round($json.month_total || 0) }} сом\n\n{{ ($json.categories || []).length > 0 ? ($json.categories || []).slice(0, 5).map((cat, idx) => {\n  const emoji = ['🥇', '🥈', '🥉', '4️⃣', '5️⃣'][idx];\n  return `${emoji} *${cat.category}*: ${Math.round(cat.total_amount)} ${cat.currency} (${cat.percentage}%)`;\n}).join('\\n') : '📭 Нет данных' }}\n\n💡 Используйте /categories для полного отчёта",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "💵 Бюджет",
                    "additionalFields": {
                      "callback_data": "view_budget"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        896,
        1920
      ],
      "id": "2b55a327-bc9f-43ff-814d-ef960bab3a07",
      "name": "Send Categories Callback",
      "webhookId": "callback-categories",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "resource": "callback",
        "queryId": "={{ $('Telegram Bot Trigger').first().json.callback_query.id }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        224,
        768
      ],
      "id": "ca8a4f79-0224-4f76-92dd-df7b709f870b",
      "name": "Answer Callback View Budget",
      "webhookId": "3d43b623-2882-4e12-a689-f8f156a16766",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "user-id",
              "name": "user_id",
              "value": "={{ $('Telegram Bot Trigger').first().json.callback_query.from.id }}",
              "type": "number"
            },
            {
              "id": "chat-id",
              "name": "chat_id",
              "value": "={{ $('Telegram Bot Trigger').first().json.callback_query.message.chat.id }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        448,
        768
      ],
      "id": "26d06682-e7a2-4bbc-8cf4-3d11cf9a9d99",
      "name": "Prepare Budget Callback"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "user-id-balance",
              "name": "user_id",
              "value": "={{ $('Telegram Bot Trigger').first().json.callback_query.from.id }}",
              "type": "number"
            },
            {
              "id": "chat-id-balance",
              "name": "chat_id",
              "value": "={{ $('Telegram Bot Trigger').first().json.callback_query.message.chat.id }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        224,
        1152
      ],
      "id": "33f9eb75-7c53-48d8-ad69-f80f5b150b3e",
      "name": "Prepare Balance Callback"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "user-id-currency-rates",
              "name": "user_id",
              "value": "={{ $('Telegram Bot Trigger').first().json.callback_query.from.id }}",
              "type": "number"
            },
            {
              "id": "chat-id-currency-rates",
              "name": "chat_id",
              "value": "={{ $('Telegram Bot Trigger').first().json.callback_query.message.chat.id }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        224,
        1536
      ],
      "id": "cc23e0d2-7218-459f-b4d0-6b2cec715deb",
      "name": "Prepare Currency Rates Callback"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "user-id-profile",
              "name": "user_id",
              "value": "={{ $('Telegram Bot Trigger').first().json.callback_query.from.id }}",
              "type": "number"
            },
            {
              "id": "chat-id-profile",
              "name": "chat_id",
              "value": "={{ $('Telegram Bot Trigger').first().json.callback_query.message.chat.id }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        224,
        1728
      ],
      "id": "3ddbbd12-bd78-4110-8bbe-19bf648199ec",
      "name": "Prepare Profile Callback"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "user-id-categories",
              "name": "user_id",
              "value": "={{ $('Telegram Bot Trigger').first().json.callback_query.from.id }}",
              "type": "number"
            },
            {
              "id": "chat-id-categories",
              "name": "chat_id",
              "value": "={{ $('Telegram Bot Trigger').first().json.callback_query.message.chat.id }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        224,
        1920
      ],
      "id": "a0cf5d35-42d4-4d0a-af17-84de92bb3efa",
      "name": "Prepare Categories Callback"
    },
    {
      "parameters": {
        "resource": "callback",
        "queryId": "={{ $('Telegram Bot Trigger').first().json.callback_query.id }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        224,
        960
      ],
      "id": "e2200aa2-bfa3-4750-9b71-70eeb3ac7186",
      "name": "Answer Callback Monthly",
      "webhookId": "25d1d416-b111-42d2-af0f-6b7c4e18a6f0",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "user-id-monthly",
              "name": "user_id",
              "value": "={{ $('Telegram Bot Trigger').first().json.callback_query.from.id }}",
              "type": "number"
            },
            {
              "id": "chat-id-monthly",
              "name": "telegram_chat_id",
              "value": "={{ $('Telegram Bot Trigger').first().json.callback_query.message.chat.id }}",
              "type": "number"
            },
            {
              "id": "first-name-monthly",
              "name": "first_name",
              "value": "={{ $('Telegram Bot Trigger').first().json.callback_query.from.first_name }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        448,
        960
      ],
      "id": "d237f91c-3d46-482b-8973-359378e08366",
      "name": "Prepare Monthly Callback"
    },
    {
      "parameters": {
        "resource": "callback",
        "queryId": "={{ $('Telegram Bot Trigger').first().json.callback_query.id }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        224,
        1344
      ],
      "id": "9d82d51b-4047-4dae-a78f-d57df3efb4dc",
      "name": "Answer Callback Convert",
      "webhookId": "9a6bffe7-9680-491e-a897-f192b9cd322b",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $('Telegram Bot Trigger').first().json.callback_query.message.chat.id }}",
        "messageId": "={{ $('Telegram Bot Trigger').first().json.callback_query.message.message_id }}",
        "replyMarkup": "inlineKeyboard",
        "text": "💱 *Конвертер валют*\n\nНапишите сообщение в формате:\n`Конвертировать 1000 USD в KGS`\n\nили\n\n`Сколько будет 50 евро в сомах`\n\nБот автоматически выполнит конвертацию по актуальному курсу.",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "💱 Курсы валют",
                    "additionalFields": {
                      "callback_data": "view_currency_rates"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        448,
        1344
      ],
      "id": "3d15f28b-6cec-45cf-a065-0277b46e0ff7",
      "name": "Show Convert Instructions",
      "webhookId": "8f4771ff-a194-44ef-8088-2eef287aa514",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Bot Trigger').first().json.message.chat.id }}",
        "text": "❓ *Справка по командам*\n\n📊 *ОТЧЁТЫ:*\n/daily_report - Отчёт за сегодня\n/weekly_report - Отчёт за неделю\n/monthly_report - Отчёт за месяц\n/categories - По категориям\n\n💰 *ФИНАНСЫ:*\n/budget - Мой бюджет\n/balance - Баланс доходов/расходов\n/currency - Курсы валют\n\n👤 *ПРОФИЛЬ:*\n/profile - Мой профиль\n/settings - Настройки бота\n\n💡 *СОВЕТЫ:*\n• Пишите расходы естественным языком: \"Потратил 500 на такси\"\n• Доходы: \"Получил 5000 с клиента\"\n• Бюджет: \"Установить бюджет 50000\"\n• Конвертация: \"Сколько будет 100 USD в сомах\"\n\n🎙 Можно отправлять голосовые сообщения!",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "👤 Профиль",
                    "additionalFields": {
                      "callback_data": "view_profile"
                    }
                  },
                  {
                    "text": "⚙️ Настройки",
                    "additionalFields": {
                      "callback_data": "settings_menu"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "💵 Бюджет",
                    "additionalFields": {
                      "callback_data": "view_budget"
                    }
                  },
                  {
                    "text": "💎 Баланс",
                    "additionalFields": {
                      "callback_data": "view_balance"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        448,
        3504
      ],
      "id": "2149f342-ba8c-43bd-9b77-2745b53f7099",
      "name": "Send Help",
      "webhookId": "help-send",
      "credentials": {
        "telegramApi": {
          "id": "KYHLugYerbTJeC9p",
          "name": "AIAccounter"
        }
      }
    }
  ],
  "connections": {
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Bot Trigger": {
      "main": [
        [
          {
            "node": "Регистрация/обновление пользователя",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message Type Switch": {
      "main": [
        [
          {
            "node": "Download Voice File",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare User for Daily",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare User for Weekly",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare User for Monthly",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Period Request",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Profile Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Categories Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Budget Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Balance Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Settings Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Currency Rates",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Help",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Text Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Voice File": {
      "main": [
        [
          {
            "node": "Transcribe Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe Audio": {
      "main": [
        [
          {
            "node": "Voice Command Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Text Data": {
      "main": [
        [
          {
            "node": "Financial Assistant",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Conversation Memory": {
      "ai_memory": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Financial Assistant": {
      "main": [
        [
          {
            "node": "Send Telegram Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Проверка типа": {
      "main": [
        [
          {
            "node": "Анализ расходов",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Анализ доходов",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Регистрация/обновление пользователя": {
      "main": [
        [
          {
            "node": "Update Type Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Type Router": {
      "main": [
        [
          {
            "node": "Callback Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Callback Router": {
      "main": [
        [
          {
            "node": "Answer Callback Settings",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Callback Currency",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Callback Budget",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Profile Callback",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Categories Callback",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Callback View Budget",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Callback Monthly",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update User Currency",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Callback Convert",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Balance Callback",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Currency Rates Callback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Check Onboarding Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Onboarding Status": {
      "main": [
        [
          {
            "node": "Onboarding Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Onboarding Router": {
      "main": [
        [
          {
            "node": "Merge Onboarding Complete",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Handle Onboarding Step",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Onboarding Complete": {
      "main": [
        [
          {
            "node": "Message Type Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Handle Onboarding Step": {
      "main": [
        [
          {
            "node": "Parse Onboarding Answer",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Parse Onboarding Answer",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Parse Onboarding Answer",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Parse Onboarding Answer",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Parse Onboarding Answer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Onboarding Answer": {
      "main": [
        [
          {
            "node": "Save Onboarding Answer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Onboarding Answer": {
      "main": [
        [
          {
            "node": "Check If Onboarding Completed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check If Onboarding Completed": {
      "main": [
        [
          {
            "node": "Send Completion Message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Question",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Question": {
      "main": [
        [
          {
            "node": "Send Next Question",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Current Onboarding Question": {
      "main": [
        [
          {
            "node": "Prepare Question",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add_income": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Parsing_of_the_month": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Add_expense": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Checking_limits": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Calc": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Convert_currency": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get_exchange_rates": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Edit_transaction": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Delete_transaction": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Restore_transaction": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get_transaction_history": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Create_recurring_payment": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "List_recurring_payments": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Cancel_recurring_payment": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get_budget_forecast": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get_notifications": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Configure_alerts": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get_income_expense_stats": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get_top_categories": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get_workspaces": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Update_spending_patterns": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Set_budget": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Set_category_limit": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Daily Report Trigger": {
      "main": [
        [
          {
            "node": "Get Active Users",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Weekly Report Trigger": {
      "main": [
        [
          {
            "node": "Get Active Users",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Monthly Report Trigger": {
      "main": [
        [
          {
            "node": "Get Active Users",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Active Users": {
      "main": [
        [
          {
            "node": "Get Daily Stats",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Daily Stats": {
      "main": [
        [
          {
            "node": "Daily Report AI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Daily Report AI": {
      "main": [
        [
          {
            "node": "Send Daily Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Daily Model": {
      "ai_languageModel": [
        [
          {
            "node": "Daily Report AI",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Get Weekly Data": {
      "main": [
        [
          {
            "node": "Format Weekly Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Weekly Data": {
      "main": [
        [
          {
            "node": "Generate Weekly PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Weekly PDF": {
      "main": [
        [
          {
            "node": "Send Weekly PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Monthly Data": {
      "main": [
        [
          {
            "node": "Format Monthly Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Monthly Data": {
      "main": [
        [
          {
            "node": "Generate Monthly PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Monthly PDF": {
      "main": [
        [
          {
            "node": "Send Monthly PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Period Report Agent": {
      "main": [
        [
          {
            "node": "Send Period Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Period Request": {
      "main": [
        [
          {
            "node": "Period Report Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get_period_report_data": {
      "ai_tool": [
        [
          {
            "node": "Period Report Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Generate_period_pdf": {
      "ai_tool": [
        [
          {
            "node": "Period Report Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Period Model": {
      "ai_languageModel": [
        [
          {
            "node": "Period Report Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Voice Command Router": {
      "main": [
        [
          {
            "node": "Get Active Users",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Active Users",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Voice as Text",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Voice as Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Voice as Text": {
      "main": [
        [
          {
            "node": "Period Report Agent",
            "type": "main",
            "index": 0
          },
          {
            "node": "Financial Assistant",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare User for Daily": {
      "main": [
        [
          {
            "node": "Get Daily Stats",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare User for Weekly": {
      "main": [
        [
          {
            "node": "Get Weekly Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare User for Monthly": {
      "main": [
        [
          {
            "node": "Get Monthly Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Profile Data": {
      "main": [
        [
          {
            "node": "Send Profile",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Categories Data": {
      "main": [
        [
          {
            "node": "Send Categories Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Budget Data": {
      "main": [
        [
          {
            "node": "Send Budget Info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Balance Data": {
      "main": [
        [
          {
            "node": "Send Balance",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Currency Rates": {
      "main": [
        [
          {
            "node": "Send Currency Rates",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Callback Settings": {
      "main": [
        [
          {
            "node": "Show Settings Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Callback Currency": {
      "main": [
        [
          {
            "node": "Show Currency Selection",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Currency Updated": {
      "main": [
        [
          {
            "node": "Show Currency Updated",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update User Currency": {
      "main": [
        [
          {
            "node": "Answer Currency Updated",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Callback Budget": {
      "main": [
        [
          {
            "node": "Show Budget Instructions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Callback Profile": {
      "main": [
        [
          {
            "node": "Get Profile for Callback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Profile for Callback": {
      "main": [
        [
          {
            "node": "Show Profile Callback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Callback Categories": {
      "main": [
        [
          {
            "node": "Get Categories for Callback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Categories for Callback": {
      "main": [
        [
          {
            "node": "Send Categories Callback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Callback View Budget": {
      "main": [
        [
          {
            "node": "Prepare Budget Callback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Budget Callback": {
      "main": [
        [
          {
            "node": "Get Budget Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Balance Callback": {
      "main": [
        [
          {
            "node": "Get Balance Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Currency Rates Callback": {
      "main": [
        [
          {
            "node": "Get Currency Rates",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Profile Callback": {
      "main": [
        [
          {
            "node": "Answer Callback Profile",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Categories Callback": {
      "main": [
        [
          {
            "node": "Answer Callback Categories",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Callback Monthly": {
      "main": [
        [
          {
            "node": "Prepare Monthly Callback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Monthly Callback": {
      "main": [
        [
          {
            "node": "Get Monthly Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Callback Convert": {
      "main": [
        [
          {
            "node": "Show Convert Instructions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "2ece1bab2405716a7cfce686d1ebe9d72af95a53d05c0b295aab0a1ef9d0a512"
  }
}