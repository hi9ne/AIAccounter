{
    "nodes":  [
                  {
                      "parameters":  {
                                         "model":  {
                                                       "__rl":  true,
                                                       "value":  "gpt-4o-mini",
                                                       "mode":  "list",
                                                       "cachedResultName":  "gpt-4o-mini"
                                                   },
                                         "options":  {
                                                         "maxRetries":  3
                                                     }
                                     },
                      "type":  "@n8n/n8n-nodes-langchain.lmChatOpenAi",
                      "typeVersion":  1.2,
                      "position":  [
                                       752,
                                       160
                                   ],
                      "id":  "93fb1cd1-c0bd-4941-b00c-ceaf7b55d5ac",
                      "name":  "OpenAI Chat Model",
                      "credentials":  {
                                          "openAiApi":  {
                                                            "id":  "SyI2pOUeSfbt1JRh",
                                                            "name":  "AIAccounter"
                                                        }
                                      }
                  },
                  {
                      "parameters":  {
                                         "updates":  [
                                                         "message"
                                                     ],
                                         "additionalFields":  {

                                                              }
                                     },
                      "id":  "42e54c46-7c81-4d95-91be-052ba0328ddb",
                      "name":  "Telegram Bot Trigger",
                      "type":  "n8n-nodes-base.telegramTrigger",
                      "typeVersion":  1.1,
                      "position":  [
                                       -1088,
                                       32
                                   ],
                      "webhookId":  "b8605f3e-0f52-4ffc-a4c9-1728eb0e09e2",
                      "credentials":  {
                                          "telegramApi":  {
                                                              "id":  "WabnlnnS7XdATC3n",
                                                              "name":  "Alikbek Financer"
                                                          }
                                      }
                  },
                  {
                      "parameters":  {
                                         "rules":  {
                                                       "values":  [
                                                                      {
                                                                          "conditions":  {
                                                                                             "options":  {
                                                                                                             "caseSensitive":  true,
                                                                                                             "leftValue":  "",
                                                                                                             "typeValidation":  "strict",
                                                                                                             "version":  2
                                                                                                         },
                                                                                             "conditions":  [
                                                                                                                {
                                                                                                                    "leftValue":  "={{ $json.message.voice.file_id }}",
                                                                                                                    "rightValue":  "",
                                                                                                                    "operator":  {
                                                                                                                                     "type":  "string",
                                                                                                                                     "operation":  "exists",
                                                                                                                                     "singleValue":  true
                                                                                                                                 },
                                                                                                                    "id":  "d697a3d5-018a-4cf0-867e-a877c10d6267"
                                                                                                                }
                                                                                                            ],
                                                                                             "combinator":  "and"
                                                                                         },
                                                                          "renameOutput":  true,
                                                                          "outputKey":  "Voice"
                                                                      },
                                                                      {
                                                                          "conditions":  {
                                                                                             "options":  {
                                                                                                             "caseSensitive":  false,
                                                                                                             "leftValue":  "",
                                                                                                             "typeValidation":  "strict",
                                                                                                             "version":  2
                                                                                                         },
                                                                                             "conditions":  [
                                                                                                                {
                                                                                                                    "id":  "daily-report-cmd",
                                                                                                                    "leftValue":  "={{ $json.message.text }}",
                                                                                                                    "rightValue":  "^(ежедневный отчёт|ежедневный отчет|отчёт за сегодня|отчет за сегодня|дейли|daily|^отчет$|^отчёт$)",
                                                                                                                    "operator":  {
                                                                                                                                     "type":  "string",
                                                                                                                                     "operation":  "regex"
                                                                                                                                 }
                                                                                                                }
                                                                                                            ],
                                                                                             "combinator":  "and"
                                                                                         },
                                                                          "renameOutput":  true,
                                                                          "outputKey":  "Daily Report"
                                                                      },
                                                                      {
                                                                          "conditions":  {
                                                                                             "options":  {
                                                                                                             "caseSensitive":  false,
                                                                                                             "leftValue":  "",
                                                                                                             "typeValidation":  "strict",
                                                                                                             "version":  2
                                                                                                         },
                                                                                             "conditions":  [
                                                                                                                {
                                                                                                                    "id":  "weekly-report-cmd",
                                                                                                                    "leftValue":  "={{ $json.message.text }}",
                                                                                                                    "rightValue":  "^(/weekly_report|недельный отчёт|недельный отчет|отчет за неделю|отчёт за неделю)",
                                                                                                                    "operator":  {
                                                                                                                                     "type":  "string",
                                                                                                                                     "operation":  "regex"
                                                                                                                                 }
                                                                                                                }
                                                                                                            ],
                                                                                             "combinator":  "and"
                                                                                         },
                                                                          "renameOutput":  true,
                                                                          "outputKey":  "Weekly Report"
                                                                      },
                                                                      {
                                                                          "conditions":  {
                                                                                             "options":  {
                                                                                                             "caseSensitive":  false,
                                                                                                             "leftValue":  "",
                                                                                                             "typeValidation":  "strict",
                                                                                                             "version":  2
                                                                                                         },
                                                                                             "conditions":  [
                                                                                                                {
                                                                                                                    "id":  "monthly-report-cmd",
                                                                                                                    "leftValue":  "={{ $json.message.text }}",
                                                                                                                    "rightValue":  "^(/monthly_report|месячный отчёт|месячный отчет|отчет за месяц|отчёт за месяц)",
                                                                                                                    "operator":  {
                                                                                                                                     "type":  "string",
                                                                                                                                     "operation":  "regex"
                                                                                                                                 }
                                                                                                                }
                                                                                                            ],
                                                                                             "combinator":  "and"
                                                                                         },
                                                                          "renameOutput":  true,
                                                                          "outputKey":  "Monthly Report"
                                                                      },
                                                                      {
                                                                          "conditions":  {
                                                                                             "options":  {
                                                                                                             "caseSensitive":  false,
                                                                                                             "leftValue":  "",
                                                                                                             "typeValidation":  "strict",
                                                                                                             "version":  2
                                                                                                         },
                                                                                             "conditions":  [
                                                                                                                {
                                                                                                                    "id":  "period-report-cmd",
                                                                                                                    "leftValue":  "={{ $json.message.text }}",
                                                                                                                    "rightValue":  "^(отчет за период|отчёт за период|отчет с \\d|отчёт с \\d|период с)",
                                                                                                                    "operator":  {
                                                                                                                                     "type":  "string",
                                                                                                                                     "operation":  "regex"
                                                                                                                                 }
                                                                                                                }
                                                                                                            ],
                                                                                             "combinator":  "and"
                                                                                         },
                                                                          "renameOutput":  true,
                                                                          "outputKey":  "Period Report"
                                                                      },
                                                                      {
                                                                          "conditions":  {
                                                                                             "options":  {
                                                                                                             "caseSensitive":  true,
                                                                                                             "leftValue":  "",
                                                                                                             "typeValidation":  "strict",
                                                                                                             "version":  2
                                                                                                         },
                                                                                             "conditions":  [
                                                                                                                {
                                                                                                                    "id":  "text-fallback",
                                                                                                                    "leftValue":  "={{ $json.message.text }}",
                                                                                                                    "rightValue":  "",
                                                                                                                    "operator":  {
                                                                                                                                     "type":  "string",
                                                                                                                                     "operation":  "exists",
                                                                                                                                     "singleValue":  true
                                                                                                                                 }
                                                                                                                }
                                                                                                            ],
                                                                                             "combinator":  "and"
                                                                                         },
                                                                          "renameOutput":  true,
                                                                          "outputKey":  "Text"
                                                                      }
                                                                  ]
                                                   },
                                         "options":  {

                                                     }
                                     },
                      "id":  "054f1261-076b-4f08-946e-6c5ac2672e37",
                      "name":  "Message Type Switch",
                      "type":  "n8n-nodes-base.switch",
                      "typeVersion":  3.2,
                      "position":  [
                                       -416,
                                       16
                                   ]
                  },
                  {
                      "parameters":  {
                                         "resource":  "file",
                                         "fileId":  "={{ $json.message.voice.file_id }}",
                                         "additionalFields":  {

                                                              }
                                     },
                      "id":  "448a77fd-85de-40b3-87c6-2eaf363618d0",
                      "name":  "Download Voice File",
                      "type":  "n8n-nodes-base.telegram",
                      "typeVersion":  1.2,
                      "position":  [
                                       64,
                                       -160
                                   ],
                      "webhookId":  "8fa0a59a-be53-4897-83bb-5b18ed71b529",
                      "credentials":  {
                                          "telegramApi":  {
                                                              "id":  "WabnlnnS7XdATC3n",
                                                              "name":  "Alikbek Financer"
                                                          }
                                      }
                  },
                  {
                      "parameters":  {
                                         "resource":  "audio",
                                         "operation":  "transcribe",
                                         "options":  {

                                                     }
                                     },
                      "id":  "c9cf8898-0bed-4b1c-b450-3a2beb89954b",
                      "name":  "Transcribe Audio",
                      "type":  "@n8n/n8n-nodes-langchain.openAi",
                      "typeVersion":  1.6,
                      "position":  [
                                       528,
                                       -160
                                   ],
                      "credentials":  {
                                          "openAiApi":  {
                                                            "id":  "SyI2pOUeSfbt1JRh",
                                                            "name":  "AIAccounter"
                                                        }
                                      }
                  },
                  {
                      "parameters":  {
                                         "assignments":  {
                                                             "assignments":  [
                                                                                 {
                                                                                     "id":  "d6af7fa1-c31a-4514-ae63-397699bf8b21",
                                                                                     "name":  "text",
                                                                                     "value":  "={{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.text }}",
                                                                                     "type":  "string"
                                                                                 }
                                                                             ]
                                                         },
                                         "includeOtherFields":  true,
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.set",
                      "typeVersion":  3.4,
                      "position":  [
                                       528,
                                       32
                                   ],
                      "id":  "c28a8557-ed9a-499d-803e-5b03e2710218",
                      "name":  "Prepare Text Data"
                  },
                  {
                      "parameters":  {
                                         "sessionIdType":  "customKey",
                                         "sessionKey":  "={{$(\u0027Telegram Bot Trigger\u0027).first().json.message.message_id }}"
                                     },
                      "type":  "@n8n/n8n-nodes-langchain.memoryBufferWindow",
                      "typeVersion":  1.3,
                      "position":  [
                                       880,
                                       160
                                   ],
                      "id":  "d94ff864-a4e8-424b-ac20-d2216ce3de7a",
                      "name":  "Conversation Memory"
                  },
                  {
                      "parameters":  {
                                         "promptType":  "define",
                                         "text":  "={{ $json.text }}\n\n",
                                         "options":  {
                                                         "systemMessage":  "=Ты — AI финансовый помощник с доступом к Supabase базе данных для управления личными и корпоративными финансами в Кыргызстане.\n\n👤 ВАЛЮТА ПОЛЬЗОВАТЕЛЯ: {{ $json.preferred_currency || \u0027KGS\u0027 }}\n\n⚙️ ВАЖНЫЕ ПРАВИЛА:\n1. Workspace определяется АВТОМАТИЧЕСКИ - НЕ спрашивай пользователя \"в каком workspace\"\n2. Если валюта НЕ указана в сообщении - используй валюту пользователя (см. выше)\n3. СРАЗУ вызывай инструмент, НЕ спрашивай подтверждений\n4. НЕ спрашивай \"укажите валюту\" - используй валюту пользователя\n\nПримеры:\n- \"Прибыль 5000 с клиента\" → СРАЗУ вызов Add_income с валютой пользователя\n- \"Потратил 200 на такси\" → СРАЗУ вызов Add_expense с валютой пользователя\n- \"Получил 1000 долларов\" → вызов Add_income с currency: USD (явно указано)\n\n💸 РАСХОДЫ: Add_expense\n- amount: число\n- currency: если НЕ указана - используй валюту пользователя\n- category: продукты, транспорт, кафе/рестораны, зарплата, налоги, прочее\n- description: опционально\n- date: DD.MM.YYYY (опционально)\n\n💰 ДОХОДЫ: Add_income\n- amount: число\n- currency: если НЕ указана - используй валюту пользователя\n- category: зарплата, продажи, инвестиции, подработка, кэшбек, прочее\n- description: опционально\n- date: DD.MM.YYYY (опционально)\n\nВАЛЮТЫ: сом/KGS, доллар/USD, евро/EUR, рубль/RUB"
                                                     }
                                     },
                      "type":  "@n8n/n8n-nodes-langchain.agent",
                      "typeVersion":  1.7,
                      "position":  [
                                       2224,
                                       -64
                                   ],
                      "id":  "be9ba531-5b63-4547-a8a0-6ee5270e28d3",
                      "name":  "Financial Assistant",
                      "onError":  "continueErrorOutput"
                  },
                  {
                      "parameters":  {
                                         "chatId":  "={{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.chat.id }}",
                                         "text":  "={{ $json.output }}",
                                         "additionalFields":  {
                                                                  "appendAttribution":  false,
                                                                  "reply_to_message_id":  "={{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.message_id }}"
                                                              }
                                     },
                      "type":  "n8n-nodes-base.telegram",
                      "typeVersion":  1.2,
                      "position":  [
                                       4032,
                                       -64
                                   ],
                      "id":  "81d9fe3d-d21a-473d-b3e3-f6d489fd2880",
                      "name":  "Send Telegram Response",
                      "webhookId":  "a2f9609c-4b7a-4d51-aaa6-c889f56aefc9",
                      "credentials":  {
                                          "telegramApi":  {
                                                              "id":  "WabnlnnS7XdATC3n",
                                                              "name":  "Alikbek Financer"
                                                          }
                                      }
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "WITH monthly_data AS (\n  SELECT \n    category,\n    COUNT(*) as transaction_count,\n    SUM(amount) as total_amount,\n    AVG(amount) as avg_amount\n  FROM income\n  WHERE user_id = {{ $json.user_id }}\n    AND TO_CHAR(date, \u0027YYYY-MM\u0027) = \u0027{{ $json.year_month }}\u0027\n    {{ $json.category ? \"AND category = \u0027\" + $json.category + \"\u0027\" : \"\" }}\n  GROUP BY category\n  ORDER BY total_amount DESC\n)\nSELECT \n  *,\n  (SELECT SUM(total_amount) FROM monthly_data) as grand_total\nFROM monthly_data;",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgres",
                      "typeVersion":  2.6,
                      "position":  [
                                       -864,
                                       1024
                                   ],
                      "id":  "99b72a7d-9f35-410c-b5fd-f711ec06cfe5",
                      "name":  "Анализ доходов",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "conditions":  {
                                                            "options":  {
                                                                            "caseSensitive":  true,
                                                                            "leftValue":  "",
                                                                            "typeValidation":  "strict",
                                                                            "version":  2
                                                                        },
                                                            "conditions":  [
                                                                               {
                                                                                   "id":  "9af39ade-d2ac-4587-b4cd-bccb18fece32",
                                                                                   "leftValue":  "={{ $json.type }}",
                                                                                   "rightValue":  "расход",
                                                                                   "operator":  {
                                                                                                    "type":  "string",
                                                                                                    "operation":  "equals",
                                                                                                    "name":  "filter.operator.equals"
                                                                                                }
                                                                               }
                                                                           ],
                                                            "combinator":  "and"
                                                        },
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.if",
                      "typeVersion":  2.2,
                      "position":  [
                                       -1088,
                                       928
                                   ],
                      "id":  "af909326-07ca-4025-91b6-d22c81e42261",
                      "name":  "Проверка типа"
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "WITH monthly_data AS (\n  SELECT \n    category,\n    COUNT(*) as transaction_count,\n    SUM(amount) as total_amount,\n    AVG(amount) as avg_amount\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    AND TO_CHAR(date, \u0027YYYY-MM\u0027) = \u0027{{ $json.year_month }}\u0027\n    {{ $json.category ? \"AND category = \u0027\" + $json.category + \"\u0027\" : \"\" }}\n  GROUP BY category\n  ORDER BY total_amount DESC\n)\nSELECT \n  *,\n  (SELECT SUM(total_amount) FROM monthly_data) as grand_total\nFROM monthly_data;",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgres",
                      "typeVersion":  2.6,
                      "position":  [
                                       -864,
                                       832
                                   ],
                      "id":  "4f597868-0cc7-47c7-bd83-0fef71d8e4ad",
                      "name":  "Анализ расходов",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "INSERT INTO users (user_id, username, first_name, last_name, telegram_chat_id)\nVALUES (\n  {{ $json.message.from.id }},\n  \u0027{{ $json.message.from.username || \"\" }}\u0027,\n  \u0027{{ $json.message.from.first_name || \"\" }}\u0027,\n  \u0027{{ $json.message.from.last_name || \"\" }}\u0027,\n  {{ $json.message.chat.id }}\n)\nON CONFLICT (user_id) \nDO UPDATE SET \n  username = EXCLUDED.username,\n  last_activity = NOW()\nRETURNING *;",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgres",
                      "typeVersion":  2.6,
                      "position":  [
                                       -864,
                                       32
                                   ],
                      "id":  "7ad7337c-c2f8-477f-9056-fbb738782de0",
                      "name":  "Регистрация/обновление пользователя",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      },
                      "onError":  "continueRegularOutput"
                  },
                  {
                      "parameters":  {
                                         "assignments":  {
                                                             "assignments":  [
                                                                                 {
                                                                                     "id":  "6cb77ab8-f045-4576-b673-6ead0a3a5da6",
                                                                                     "name":  "message",
                                                                                     "value":  "={{ $node[\"Telegram Bot Trigger\"].json[\"message\"] || {} }}",
                                                                                     "type":  "object"
                                                                                 }
                                                                             ]
                                                         },
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.set",
                      "typeVersion":  3.4,
                      "position":  [
                                       -640,
                                       32
                                   ],
                      "id":  "71e38656-63ae-44a6-b757-c7bafec41aee",
                      "name":  "Edit Fields"
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "=SELECT * FROM get_user_profile({{ $(\u0027Edit Fields\u0027).first().json.message.from.id }});",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgres",
                      "typeVersion":  2.6,
                      "position":  [
                                       -440,
                                       32
                                   ],
                      "id":  "check-onboarding-node",
                      "name":  "Check Onboarding Status",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "conditions":  {
                                                            "options":  {
                                                                            "caseSensitive":  true,
                                                                            "leftValue":  "",
                                                                            "typeValidation":  "strict"
                                                                        },
                                                            "conditions":  [
                                                                               {
                                                                                   "id":  "onboarding-check",
                                                                                   "leftValue":  "={{ $json.onboarding_completed }}",
                                                                                   "rightValue":  true,
                                                                                   "operator":  {
                                                                                                    "type":  "boolean",
                                                                                                    "operation":  "equals"
                                                                                                }
                                                                               }
                                                                           ],
                                                            "combinator":  "and"
                                                        },
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.if",
                      "typeVersion":  2.2,
                      "position":  [
                                       -240,
                                       32
                                   ],
                      "id":  "onboarding-router-node",
                      "name":  "Onboarding Router"
                  },
                  {
                      "parameters":  {
                                         "assignments":  {
                                                             "assignments":  [
                                                                                 {
                                                                                     "id":  "merge-message-field",
                                                                                     "name":  "message",
                                                                                     "value":  "={{ $(\u0027Edit Fields\u0027).first().json.message }}",
                                                                                     "type":  "object"
                                                                                 },
                                                                                 {
                                                                                     "id":  "merge-currency-field",
                                                                                     "name":  "preferred_currency",
                                                                                     "value":  "={{ $(\u0027Check Onboarding Status\u0027).first().json.preferred_currency || \u0027KGS\u0027 }}",
                                                                                     "type":  "string"
                                                                                 }
                                                                             ]
                                                         },
                                         "options":  {}
                                     },
                      "type":  "n8n-nodes-base.set",
                      "typeVersion":  3.4,
                      "position":  [-40, -120],
                      "id":  "merge-onboarding-complete-node",
                      "name":  "Merge Onboarding Complete"
                  },
                  {
                      "parameters":  {
                                         "rules":  {
                                                       "values":  [
                                                                      {
                                                                          "conditions":  {
                                                                                             "options":  {
                                                                                                             "caseSensitive":  false,
                                                                                                             "leftValue":  "",
                                                                                                             "typeValidation":  "strict"
                                                                                                         },
                                                                                             "conditions":  [
                                                                                                                {
                                                                                                                    "leftValue":  "={{ $(\u0027Check Onboarding Status\u0027).first().json.onboarding_step }}",
                                                                                                                    "rightValue":  "usage_type",
                                                                                                                    "operator":  {
                                                                                                                                     "type":  "string",
                                                                                                                                     "operation":  "equals"
                                                                                                                                 }
                                                                                                                }
                                                                                                            ],
                                                                                             "combinator":  "and"
                                                                                         },
                                                                          "renameOutput":  true,
                                                                          "outputKey":  "Usage Type"
                                                                      },
                                                                      {
                                                                          "conditions":  {
                                                                                             "options":  {
                                                                                                             "caseSensitive":  false,
                                                                                                             "leftValue":  "",
                                                                                                             "typeValidation":  "strict"
                                                                                                         },
                                                                                             "conditions":  [
                                                                                                                {
                                                                                                                    "leftValue":  "={{ $(\u0027Check Onboarding Status\u0027).first().json.onboarding_step }}",
                                                                                                                    "rightValue":  "currency",
                                                                                                                    "operator":  {
                                                                                                                                     "type":  "string",
                                                                                                                                     "operation":  "equals"
                                                                                                                                 }
                                                                                                                }
                                                                                                            ],
                                                                                             "combinator":  "and"
                                                                                         },
                                                                          "renameOutput":  true,
                                                                          "outputKey":  "Currency"
                                                                      },
                                                                      {
                                                                          "conditions":  {
                                                                                             "options":  {
                                                                                                             "caseSensitive":  false,
                                                                                                             "leftValue":  "",
                                                                                                             "typeValidation":  "strict"
                                                                                                         },
                                                                                             "conditions":  [
                                                                                                                {
                                                                                                                    "leftValue":  "={{ $(\u0027Check Onboarding Status\u0027).first().json.onboarding_step }}",
                                                                                                                    "rightValue":  "monthly_budget",
                                                                                                                    "operator":  {
                                                                                                                                     "type":  "string",
                                                                                                                                     "operation":  "equals"
                                                                                                                                 }
                                                                                                                }
                                                                                                            ],
                                                                                             "combinator":  "and"
                                                                                         },
                                                                          "renameOutput":  true,
                                                                          "outputKey":  "Monthly Budget"
                                                                      },
                                                                      {
                                                                          "conditions":  {
                                                                                             "options":  {
                                                                                                             "caseSensitive":  false,
                                                                                                             "leftValue":  "",
                                                                                                             "typeValidation":  "strict"
                                                                                                         },
                                                                                             "conditions":  [
                                                                                                                {
                                                                                                                    "leftValue":  "={{ $(\u0027Check Onboarding Status\u0027).first().json.onboarding_step }}",
                                                                                                                    "rightValue":  "occupation",
                                                                                                                    "operator":  {
                                                                                                                                     "type":  "string",
                                                                                                                                     "operation":  "equals"
                                                                                                                                 }
                                                                                                                }
                                                                                                            ],
                                                                                             "combinator":  "and"
                                                                                         },
                                                                          "renameOutput":  true,
                                                                          "outputKey":  "Occupation"
                                                                      },
                                                                      {
                                                                          "conditions":  {
                                                                                             "options":  {
                                                                                                             "caseSensitive":  false,
                                                                                                             "leftValue":  "",
                                                                                                             "typeValidation":  "strict"
                                                                                                         },
                                                                                             "conditions":  [
                                                                                                                {
                                                                                                                    "leftValue":  "={{ $(\u0027Check Onboarding Status\u0027).first().json.onboarding_step }}",
                                                                                                                    "rightValue":  "country",
                                                                                                                    "operator":  {
                                                                                                                                     "type":  "string",
                                                                                                                                     "operation":  "equals"
                                                                                                                                 }
                                                                                                                }
                                                                                                            ],
                                                                                             "combinator":  "and"
                                                                                         },
                                                                          "renameOutput":  true,
                                                                          "outputKey":  "Country"
                                                                      }
                                                                  ]
                                                   },
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.switch",
                      "typeVersion":  3.2,
                      "position":  [
                                       -40,
                                       360
                                   ],
                      "id":  "handle-onboarding-node",
                      "name":  "Handle Onboarding Step"
                  },
                  {
                      "parameters":  {
                                         "jsCode":  "const message = $(\u0027Edit Fields\u0027).first().json.message;\nconst text = message?.text || \u0027\u0027;\nconst step = $(\u0027Check Onboarding Status\u0027).first().json.onboarding_step;\n\nlet answer = \u0027\u0027;\nlet answer_normalized = \u0027\u0027;\n\nswitch(step) {\n  case \u0027usage_type\u0027:\n    // Личное/Бизнес\n    answer = text.trim();\n    answer_normalized = answer.toLowerCase().includes(\u0027бизнес\u0027) ? \u0027business\u0027 : \u0027personal\u0027;\n    break;\n    \n  case \u0027currency\u0027:\n    // KGS/USD/EUR/RUB\n    const currencyMap = {\n      \u0027сом\u0027: \u0027KGS\u0027,\n      \u0027сомах\u0027: \u0027KGS\u0027,\n      \u0027kgs\u0027: \u0027KGS\u0027,\n      \u0027доллар\u0027: \u0027USD\u0027,\n      \u0027долларах\u0027: \u0027USD\u0027,\n      \u0027usd\u0027: \u0027USD\u0027,\n      \u0027евро\u0027: \u0027EUR\u0027,\n      \u0027eur\u0027: \u0027EUR\u0027,\n      \u0027рубл\u0027: \u0027RUB\u0027,\n      \u0027рублях\u0027: \u0027RUB\u0027,\n      \u0027rub\u0027: \u0027RUB\u0027\n    };\n    answer = text.trim();\n    answer_normalized = \u0027KGS\u0027; // default\n    for (const [key, value] of Object.entries(currencyMap)) {\n      if (answer.toLowerCase().includes(key)) {\n        answer_normalized = value;\n        break;\n      }\n    }\n    break;\n    \n  case \u0027monthly_budget\u0027:\n    // Число\n    answer = text.trim();\n    const num = parseFloat(answer.replace(/[^0-9.]/g, \u0027\u0027));\n    answer_normalized = isNaN(num) ? \u00270\u0027 : num.toString();\n    break;\n    \n  case \u0027occupation\u0027:\n    // Текст\n    answer = text.trim();\n    answer_normalized = answer;\n    break;\n    \n  case \u0027country\u0027:\n    // Текст\n    answer = text.trim();\n    answer_normalized = answer;\n    break;\n    \n  default:\n    answer = text.trim();\n    answer_normalized = answer;\n}\n\nreturn {\n  json: {\n    user_id: message.from.id,\n    step: step,\n    answer: answer,\n    answer_normalized: answer_normalized,\n    message: message\n  }\n};"
                                     },
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  2,
                      "position":  [
                                       160,
                                       360
                                   ],
                      "id":  "parse-onboarding-answer-node",
                      "name":  "Parse Onboarding Answer"
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "=SELECT * FROM save_onboarding_answer(\n  {{ $json.user_id }},\n  \u0027{{ $json.step }}\u0027,\n  \u0027{{ $json.answer_normalized }}\u0027\n);",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgres",
                      "typeVersion":  2.6,
                      "position":  [
                                       360,
                                       360
                                   ],
                      "id":  "save-onboarding-answer-node",
                      "name":  "Save Onboarding Answer",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "conditions":  {
                                                            "options":  {
                                                                            "caseSensitive":  true,
                                                                            "leftValue":  "",
                                                                            "typeValidation":  "strict"
                                                                        },
                                                            "conditions":  [
                                                                               {
                                                                                   "id":  "onboarding-complete-check",
                                                                                   "leftValue":  "={{ $json.completed }}",
                                                                                   "rightValue":  true,
                                                                                   "operator":  {
                                                                                                    "type":  "boolean",
                                                                                                    "operation":  "equals"
                                                                                                }
                                                                               }
                                                                           ],
                                                            "combinator":  "and"
                                                        },
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.if",
                      "typeVersion":  2.2,
                      "position":  [
                                       560,
                                       360
                                   ],
                      "id":  "check-if-completed-node",
                      "name":  "Check If Onboarding Completed"
                  },
                  {
                      "parameters":  {
                                         "chatId":  "={{ $(\u0027Parse Onboarding Answer\u0027).first().json.user_id }}",
                                         "text":  "=🎉 Отлично! Регистрация завершена!\n\n━━━━━━━━━━━━━━━━━━━\n📊 ВАШИ НАСТРОЙКИ:\n━━━━━━━━━━━━━━━━━━━\n\n💼 Тип использования:\n   {{ $(\u0027Save Onboarding Answer\u0027).first().json.usage_type === \u0027personal\u0027 ? \u0027👤 Личные финансы\u0027 : \u0027🏢 Бизнес\u0027 }}\n\n💰 Валюта:\n   {{ $(\u0027Save Onboarding Answer\u0027).first().json.preferred_currency }} ({{ $(\u0027Save Onboarding Answer\u0027).first().json.currency_symbol }})\n\n� Месячный бюджет:\n   {{ $(\u0027Save Onboarding Answer\u0027).first().json.monthly_budget }} {{ $(\u0027Save Onboarding Answer\u0027).first().json.currency_symbol }}\n\n� Род деятельности:\n   {{ $(\u0027Save Onboarding Answer\u0027).first().json.occupation }}\n\n🌍 Страна:\n   {{ $(\u0027Save Onboarding Answer\u0027).first().json.country }}\n\n━━━━━━━━━━━━━━━━━━━\n\n✨ Теперь можете пользоваться ботом!\n\n📝 Просто напишите:\n  • \"Потратил 500 на еду\"\n  • \"Получил 50000 зарплата\"\n  • \"Отчет за неделю\"\n\n❓ Нужна помощь? → /help",
                                         "additionalFields":  {
                                                                  "disable_web_page_preview":  true,
                                                                  "disable_notification":  false
                                                              }
                                     },
                      "type":  "n8n-nodes-base.telegram",
                      "typeVersion":  1.2,
                      "position":  [
                                       760,
                                       280
                                   ],
                      "id":  "send-completion-message-node",
                      "name":  "Send Completion Message",
                      "credentials":  {
                                          "telegramApi":  {
                                                              "id":  "WabnlnnS7XdATC3n",
                                                              "name":  "Alikbek Financer"
                                                          }
                                      }
                  },
                  {
                      "parameters":  {
                                         "chatId":  "={{ $(\u0027Parse Onboarding Answer\u0027).first().json.user_id }}",
                                         "text":  "={{ $json.question_text }}",
                                         "replyMarkup":  "={{ $json.keyboard ? \u0027forceReply\u0027 : \u0027none\u0027 }}",
                                         "additionalFields":  {
                                                                  "reply_markup":  "={{ $json.keyboard || undefined }}",
                                                                  "disable_web_page_preview":  true,
                                                                  "disable_notification":  false
                                                              }
                                     },
                      "type":  "n8n-nodes-base.telegram",
                      "typeVersion":  1.2,
                      "position":  [
                                       760,
                                       440
                                   ],
                      "id":  "send-next-question-node",
                      "name":  "Send Next Question",
                      "credentials":  {
                                          "telegramApi":  {
                                                              "id":  "WabnlnnS7XdATC3n",
                                                              "name":  "Alikbek Financer"
                                                          }
                                      }
                  },
                  {
                      "parameters":  {
                                         "jsCode":  "const data = $input.first().json;\nconst step = data.next_step;\n\nlet questionText = \u0027\u0027;\nlet keyboard = null;\n\nswitch(step) {\n  case \u0027usage_type\u0027:\n    questionText = \u0027👋 Добро пожаловать!\\n\\nДавайте начнем с короткой анкеты.\\n\\n1️⃣ Для чего вы будете использовать бота?\u0027;\n    keyboard = {\n      keyboard: [[\n        { text: \u0027👤 Личное\u0027 },\n        { text: \u0027💼 Бизнес\u0027 }\n      ]],\n      resize_keyboard: true,\n      one_time_keyboard: true\n    };\n    break;\n    \n  case \u0027currency\u0027:\n    questionText = \u00272️⃣ В какой валюте вы хотите вести учёт?\u0027;\n    keyboard = {\n      keyboard: [[\n        { text: \u0027🇰🇬 Сом (KGS)\u0027 },\n        { text: \u0027🇺🇸 Доллар (USD)\u0027 }\n      ], [\n        { text: \u0027🇪🇺 Евро (EUR)\u0027 },\n        { text: \u0027🇷🇺 Рубль (RUB)\u0027 }\n      ]],\n      resize_keyboard: true,\n      one_time_keyboard: true\n    };\n    break;\n    \n  case \u0027monthly_budget\u0027:\n    questionText = \u00273️⃣ Какой у вас примерный месячный бюджет? (введите число)\u0027;\n    keyboard = {\n      keyboard: [[\n        { text: \u002710000\u0027 },\n        { text: \u002730000\u0027 },\n        { text: \u002750000\u0027 }\n      ], [\n        { text: \u0027100000\u0027 },\n        { text: \u0027Не знаю / Пропустить\u0027 }\n      ]],\n      resize_keyboard: true,\n      one_time_keyboard: true\n    };\n    break;\n    \n  case \u0027occupation\u0027:\n    questionText = \u00274️⃣ Чем вы занимаетесь? (например: студент, фрилансер, предприниматель)\u0027;\n    keyboard = {\n      keyboard: [[\n        { text: \u0027Студент\u0027 },\n        { text: \u0027Работаю по найму\u0027 }\n      ], [\n        { text: \u0027Фрилансер\u0027 },\n        { text: \u0027Предприниматель\u0027 }\n      ], [\n        { text: \u0027Другое\u0027 }\n      ]],\n      resize_keyboard: true,\n      one_time_keyboard: true\n    };\n    break;\n    \n  case \u0027country\u0027:\n    questionText = \u00275️⃣ В какой стране вы находитесь?\u0027;\n    keyboard = {\n      keyboard: [[\n        { text: \u0027🇰🇬 Кыргызстан\u0027 },\n        { text: \u0027🇰🇿 Казахстан\u0027 }\n      ], [\n        { text: \u0027🇷🇺 Россия\u0027 },\n        { text: \u0027🇺🇿 Узбекистан\u0027 }\n      ], [\n        { text: \u0027Другая страна\u0027 }\n      ]],\n      resize_keyboard: true,\n      one_time_keyboard: true\n    };\n    break;\n    \n  default:\n    questionText = \u0027Ошибка: неизвестный шаг анкеты\u0027;\n}\n\nreturn {\n  json: {\n    question_text: questionText,\n    keyboard: keyboard ? JSON.stringify(keyboard) : null,\n    step: step\n  }\n};"
                                     },
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  2,
                      "position":  [
                                       560,
                                       440
                                   ],
                      "id":  "prepare-question-node",
                      "name":  "Prepare Question"
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "=SELECT * FROM get_onboarding_step({{ $(\u0027Edit Fields\u0027).first().json.message.from.id }});",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgres",
                      "typeVersion":  2.6,
                      "position":  [
                                       -40,
                                       200
                                   ],
                      "id":  "get-current-question-node",
                      "name":  "Get Current Onboarding Question",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n)\nINSERT INTO income (user_id, workspace_id, date, category, amount, currency, description, operation_type, source)\nSELECT\n  {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }},\n  uw.workspace_id,\n  CASE \n    WHEN \u0027{{ $fromAI(\"date\", \"Дата операции в формате DD.MM.YYYY. Если дата НЕ указана в сообщении пользователя - верни пустую строку\", \"string\", \"\") }}\u0027 = \u0027\u0027 THEN (NOW() AT TIME ZONE \u0027Asia/Bishkek\u0027)::DATE\n    ELSE TO_DATE(\u0027{{ $fromAI(\"date\", \"Дата операции в формате DD.MM.YYYY. Если дата НЕ указана в сообщении пользователя - верни пустую строку\", \"string\", \"\") }}\u0027, \u0027DD.MM.YYYY\u0027)\n  END,\n  \u0027{{ $fromAI(\"category\", \"Категория дохода: зарплата, продажи, инвестиции, подработка, кэшбек, прочее\", \"string\") }}\u0027,\n  {{ $fromAI(\"amount\", \"Сумма дохода, только число\", \"number\") }},\n  UPPER(\u0027{{ $fromAI(\"currency\", \"Валюта: сом/KGS, доллар/USD, евро/EUR, рубль/RUB. Если не указана - KGS\", \"string\", \"KGS\") }}\u0027),\n  \u0027{{ $fromAI(\"description\", \"Описание дохода, если есть\", \"string\", \"\") }}\u0027,\n  \u0027доход\u0027,\n  \u0027telegram\u0027\nFROM user_workspace uw\nRETURNING id, workspace_id, TO_CHAR(date, \u0027DD.MM.YYYY\u0027) as date, category, amount, currency, description;",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgresTool",
                      "typeVersion":  2.6,
                      "position":  [
                                       1008,
                                       160
                                   ],
                      "id":  "2208d832-bc4b-4faf-9b1e-13f4b579257b",
                      "name":  "Add_income",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n),\nmonth_mapping AS (\n  SELECT * FROM (VALUES\n    (\u0027январь\u0027, 1), (\u0027февраль\u0027, 2), (\u0027март\u0027, 3), (\u0027апрель\u0027, 4),\n    (\u0027май\u0027, 5), (\u0027июнь\u0027, 6), (\u0027июль\u0027, 7), (\u0027август\u0027, 8),\n    (\u0027сентябрь\u0027, 9), (\u0027октябрь\u0027, 10), (\u0027ноябрь\u0027, 11), (\u0027декабрь\u0027, 12)\n  ) AS m(month_name, month_num)\n),\nfiltered_data AS (\n  SELECT\n    TO_CHAR(t.date, \u0027DD.MM.YYYY\u0027) as date,\n    t.category,\n    t.amount,\n    t.currency,\n    COALESCE(t.description, \u0027\u0027) as description\n  FROM {{ $fromAI(\"type\", \"Тип операции: \u0027расход\u0027 или \u0027доход\u0027\", \"string\") === \u0027расход\u0027 ? \u0027expenses\u0027 : \u0027income\u0027 }} t\n  INNER JOIN month_mapping mm ON EXTRACT(MONTH FROM t.date) = mm.month_num\n  INNER JOIN user_workspace uw ON t.workspace_id = uw.workspace_id\n  WHERE t.user_id = {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}\n    AND EXTRACT(YEAR FROM t.date) = EXTRACT(YEAR FROM CURRENT_DATE)\n    AND LOWER(mm.month_name) = LOWER(\u0027{{ $fromAI(\"month\", \"Название месяца на русском языке (например: октябрь, ноябрь)\", \"string\") }}\u0027)\n    AND (NULLIF(\u0027{{ $fromAI(\"filter_category\", \"Категория для фильтрации опционально\", \"string\", \"\") }}\u0027, \u0027\u0027) IS NULL OR t.category = \u0027{{ $fromAI(\"filter_category\", \"Категория для фильтрации опционально\", \"string\", \"\") }}\u0027)\n    AND t.deleted_at IS NULL\n)\nSELECT \n  *,\n  (SELECT COUNT(*) FROM filtered_data) as total_rows,\n  (SELECT SUM(amount) FROM filtered_data) as total_amount,\n  (SELECT COUNT(DISTINCT currency) FROM filtered_data) as currency_count\nFROM filtered_data\nORDER BY date DESC\nLIMIT 100;",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgresTool",
                      "typeVersion":  2.6,
                      "position":  [
                                       1136,
                                       160
                                   ],
                      "id":  "4272e08c-07e7-4163-b75a-d67207502193",
                      "name":  "Parsing_of_the_month",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n)\nINSERT INTO expenses (user_id, workspace_id, date, category, amount, currency, description, operation_type, source)\nSELECT\n  {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }},\n  uw.workspace_id,\n  CASE \n    WHEN \u0027{{ $fromAI(\"date\", \"Дата операции в формате DD.MM.YYYY. Если дата НЕ указана в сообщении пользователя - верни пустую строку\", \"string\", \"\") }}\u0027 = \u0027\u0027 THEN (NOW() AT TIME ZONE \u0027Asia/Bishkek\u0027)::DATE\n    ELSE TO_DATE(\u0027{{ $fromAI(\"date\", \"Дата операции в формате DD.MM.YYYY. Если дата НЕ указана в сообщении пользователя - верни пустую строку\", \"string\", \"\") }}\u0027, \u0027DD.MM.YYYY\u0027)\n  END,\n  \u0027{{ $fromAI(\"category\", \"Категория расхода: продукты, транспорт, кафе/рестораны, аренда офиса, зарплата, налоги, маркетинг, канцтовары, интернет/связь, коммунальные услуги, обучение, подписки, прочее\", \"string\") }}\u0027,\n  {{ $fromAI(\"amount\", \"Сумма расхода, только число\", \"number\") }},\n  UPPER(\u0027{{ $fromAI(\"currency\", \"Валюта: сом/KGS, доллар/USD, евро/EUR, рубль/RUB. Если не указана - KGS\", \"string\", \"KGS\") }}\u0027),\n  \u0027{{ $fromAI(\"description\", \"Описание расхода, если есть\", \"string\", \"\") }}\u0027,\n  \u0027расход\u0027,\n  \u0027telegram\u0027\nFROM user_workspace uw\nRETURNING id, workspace_id, TO_CHAR(date, \u0027DD.MM.YYYY\u0027) as date, category, amount, currency, description;",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgresTool",
                      "typeVersion":  2.6,
                      "position":  [
                                       1264,
                                       160
                                   ],
                      "id":  "81e22fd9-965a-4f94-9f5d-7dccd54a4b6c",
                      "name":  "Add_expense",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "-- Проверка лимита по категории\nWITH expense_sum AS (\n  SELECT COALESCE(SUM(amount), 0) as total_spent\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    AND category = \u0027{{ $json.category }}\u0027\n    AND date \u003e= DATE_TRUNC(\u0027month\u0027, CURRENT_DATE)\n),\ncategory_limit AS (\n  SELECT limit_amount\n  FROM limits\n  WHERE user_id = {{ $json.user_id }}\n    AND category = \u0027{{ $json.category }}\u0027\n    AND month = TO_CHAR(CURRENT_DATE, \u0027YYYY-MM\u0027)\n  LIMIT 1\n)\nSELECT \n  e.total_spent,\n  l.limit_amount,\n  CASE \n    WHEN l.limit_amount IS NULL THEN NULL\n    WHEN e.total_spent \u003e l.limit_amount THEN \u0027exceeded\u0027\n    WHEN e.total_spent \u003e (l.limit_amount * 0.8) THEN \u0027warning\u0027\n    ELSE \u0027ok\u0027\n  END as limit_status,\n  CASE\n    WHEN l.limit_amount IS NOT NULL THEN ROUND((e.total_spent / l.limit_amount) * 100)\n    ELSE NULL\n  END as percent_used\nFROM expense_sum e\nLEFT JOIN category_limit l ON true;",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgresTool",
                      "typeVersion":  2.6,
                      "position":  [
                                       1392,
                                       160
                                   ],
                      "id":  "cf03a04c-f106-489f-86c4-4c63e00ca967",
                      "name":  "Checking_limits",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {

                                     },
                      "type":  "@n8n/n8n-nodes-langchain.toolCalculator",
                      "typeVersion":  1,
                      "position":  [
                                       1520,
                                       160
                                   ],
                      "id":  "dca47059-6491-4a57-abc3-06675e42a639",
                      "name":  "Calc"
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "=SELECT \n  {{ $fromAI(\"amount\", \"Сумма для конвертации, только число\", \"number\") }} as original_amount,\n  UPPER(\u0027{{ $fromAI(\"from_currency\", \"Из какой валюты конвертировать: сом/KGS, доллар/USD, евро/EUR, рубль/RUB\", \"string\") }}\u0027) as from_currency,\n  UPPER(\u0027{{ $fromAI(\"to_currency\", \"В какую валюту конвертировать: сом/KGS, доллар/USD, евро/EUR, рубль/RUB\", \"string\") }}\u0027) as to_currency,\n  get_exchange_rate(\n    UPPER(\u0027{{ $fromAI(\"from_currency\", \"Из какой валюты конвертировать: сом/KGS, доллар/USD, евро/EUR, рубль/RUB\", \"string\") }}\u0027),\n    UPPER(\u0027{{ $fromAI(\"to_currency\", \"В какую валюту конвертировать: сом/KGS, доллар/USD, евро/EUR, рубль/RUB\", \"string\") }}\u0027),\n    CURRENT_DATE\n  ) as rate,\n  convert_amount(\n    {{ $fromAI(\"amount\", \"Сумма для конвертации, только число\", \"number\") }},\n    UPPER(\u0027{{ $fromAI(\"from_currency\", \"Из какой валюты конвертировать: сом/KGS, доллар/USD, евро/EUR, рубль/RUB\", \"string\") }}\u0027),\n    UPPER(\u0027{{ $fromAI(\"to_currency\", \"В какую валюту конвертировать: сом/KGS, доллар/USD, евро/EUR, рубль/RUB\", \"string\") }}\u0027),\n    CURRENT_DATE\n  ) as converted_amount,\n  TO_CHAR(CURRENT_DATE, \u0027DD.MM.YYYY\u0027) as conversion_date;",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgresTool",
                      "typeVersion":  2.6,
                      "position":  [
                                       1648,
                                       160
                                   ],
                      "id":  "28493685-51e8-4f2f-8adf-ae837898bbe4",
                      "name":  "Convert_currency",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "=WITH latest_rates AS (\n  SELECT DISTINCT ON (from_currency, to_currency)\n    from_currency,\n    to_currency,\n    rate,\n    date,\n    source\n  FROM exchange_rates\n  WHERE from_currency IN (\u0027KGS\u0027, \u0027USD\u0027, \u0027EUR\u0027, \u0027RUB\u0027)\n    AND to_currency IN (\u0027KGS\u0027, \u0027USD\u0027, \u0027EUR\u0027, \u0027RUB\u0027)\n    AND from_currency != to_currency\n  ORDER BY from_currency, to_currency, date DESC\n)\nSELECT \n  from_currency,\n  to_currency,\n  rate,\n  TO_CHAR(date, \u0027DD.MM.YYYY\u0027) as rate_date,\n  source,\n  CASE \n    WHEN from_currency = \u0027USD\u0027 AND to_currency = \u0027KGS\u0027 THEN \u0027💵 Доллар → Сом\u0027\n    WHEN from_currency = \u0027EUR\u0027 AND to_currency = \u0027KGS\u0027 THEN \u0027💶 Евро → Сом\u0027\n    WHEN from_currency = \u0027RUB\u0027 AND to_currency = \u0027KGS\u0027 THEN \u0027💷 Рубль → Сом\u0027\n    ELSE from_currency || \u0027 → \u0027 || to_currency\n  END as display_name\nFROM latest_rates\nORDER BY \n  CASE from_currency \n    WHEN \u0027USD\u0027 THEN 1 \n    WHEN \u0027EUR\u0027 THEN 2 \n    WHEN \u0027RUB\u0027 THEN 3 \n    ELSE 4 \n  END, to_currency;",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgresTool",
                      "typeVersion":  2.6,
                      "position":  [
                                       1776,
                                       160
                                   ],
                      "id":  "a75df156-38cd-4e39-b8af-38b91c5b0e9d",
                      "name":  "Get_exchange_rates",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "=SELECT * FROM safe_update_transaction(\n  {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}::BIGINT,\n  \u0027{{ $fromAI(\"transaction_type\", \"Тип: expense или income (НЕ \u0027расход\u0027 или \u0027доход\u0027!)\", \"string\") }}\u0027,\n  \u0027{{ $fromAI(\"transaction_id\", \"ID транзакции или \u0027last\u0027 для последней\", \"string\") }}\u0027,\n  \u0027{{ $fromAI(\"field\", \"Поле для изменения: amount, category, description, date, currency\", \"string\") }}\u0027,\n  \u0027{{ $fromAI(\"new_value\", \"Новое значение (для даты используй DD.MM.YYYY)\", \"string\") }}\u0027\n);",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgresTool",
                      "typeVersion":  2.6,
                      "position":  [
                                       1904,
                                       160
                                   ],
                      "id":  "a1c8a433-cac6-490b-b6b0-b77a8ef7cbe0",
                      "name":  "Edit_transaction",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "=WITH found_transaction AS (\n  SELECT \n    CASE \n      WHEN LOWER(\u0027{{ $fromAI(\"transaction_id\", \"ID транзакции или \u0027last\u0027 для последней\", \"string\") }}\u0027) = \u0027last\u0027 \n      THEN get_last_transaction({{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}, LOWER(\u0027{{ $fromAI(\"transaction_type\", \"Тип: expense или income\", \"string\") }}\u0027))\n      ELSE CAST(NULLIF(\u0027{{ $fromAI(\"transaction_id\", \"ID транзакции или \u0027last\u0027 для последней\", \"string\") }}\u0027, \u0027last\u0027) AS INTEGER)\n    END as tid\n),\ndelete_expense AS (\n  UPDATE expenses\n  SET deleted_at = NOW(),\n      deleted_by = {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}\n  WHERE id = (SELECT tid FROM found_transaction)\n    AND user_id = {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}\n    AND deleted_at IS NULL\n    AND LOWER(\u0027{{ $fromAI(\"transaction_type\", \"Тип: expense или income\", \"string\") }}\u0027) = \u0027expense\u0027\n  RETURNING id, amount, category, currency, date\n),\ndelete_income AS (\n  UPDATE income\n  SET deleted_at = NOW(),\n      deleted_by = {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}\n  WHERE id = (SELECT tid FROM found_transaction)\n    AND user_id = {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}\n    AND deleted_at IS NULL\n    AND LOWER(\u0027{{ $fromAI(\"transaction_type\", \"Тип: expense или income\", \"string\") }}\u0027) = \u0027income\u0027\n  RETURNING id, amount, category, currency, date\n),\nlog_deletion AS (\n  SELECT log_transaction_change(\n    LOWER(\u0027{{ $fromAI(\"transaction_type\", \"Тип: expense или income\", \"string\") }}\u0027),\n    (SELECT tid FROM found_transaction),\n    \u0027deleted\u0027,\n    NULL,\n    NULL,\n    NULL,\n    {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}\n  ) as history_id\n)\nSELECT \n  COALESCE(\n    (SELECT row_to_json(delete_expense.*) FROM delete_expense),\n    (SELECT row_to_json(delete_income.*) FROM delete_income)\n  ) as deleted_transaction,\n  (SELECT history_id FROM log_deletion) as history_id,\n  \u0027deleted\u0027 as status;",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgresTool",
                      "typeVersion":  2.6,
                      "position":  [
                                       2032,
                                       160
                                   ],
                      "id":  "4e992ea7-1ea8-4dbf-a109-01244e6fa72b",
                      "name":  "Delete_transaction",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "=WITH found_transaction AS (\n  SELECT \n    CASE \n      WHEN LOWER(\u0027{{ $fromAI(\"transaction_id\", \"ID удалённой транзакции или \u0027last\u0027\", \"string\") }}\u0027) = \u0027last\u0027 \n      THEN get_last_transaction({{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}, LOWER(\u0027{{ $fromAI(\"transaction_type\", \"Тип: expense или income\", \"string\") }}\u0027))\n      ELSE CAST(NULLIF(\u0027{{ $fromAI(\"transaction_id\", \"ID удалённой транзакции или \u0027last\u0027\", \"string\") }}\u0027, \u0027last\u0027) AS INTEGER)\n    END as tid\n),\nrestore_expense AS (\n  UPDATE expenses\n  SET deleted_at = NULL,\n      deleted_by = NULL\n  WHERE id = (SELECT tid FROM found_transaction)\n    AND user_id = {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}\n    AND deleted_at IS NOT NULL\n    AND LOWER(\u0027{{ $fromAI(\"transaction_type\", \"Тип: expense или income\", \"string\") }}\u0027) = \u0027expense\u0027\n  RETURNING id, amount, category, currency, date\n),\nrestore_income AS (\n  UPDATE income\n  SET deleted_at = NULL,\n      deleted_by = NULL\n  WHERE id = (SELECT tid FROM found_transaction)\n    AND user_id = {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}\n    AND deleted_at IS NOT NULL\n    AND LOWER(\u0027{{ $fromAI(\"transaction_type\", \"Тип: expense или income\", \"string\") }}\u0027) = \u0027income\u0027\n  RETURNING id, amount, category, currency, date\n),\nlog_restore AS (\n  SELECT log_transaction_change(\n    LOWER(\u0027{{ $fromAI(\"transaction_type\", \"Тип: expense или income\", \"string\") }}\u0027),\n    (SELECT tid FROM found_transaction),\n    \u0027restored\u0027,\n    NULL,\n    NULL,\n    NULL,\n    {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}\n  ) as history_id\n)\nSELECT \n  COALESCE(\n    (SELECT row_to_json(restore_expense.*) FROM restore_expense),\n    (SELECT row_to_json(restore_income.*) FROM restore_income)\n  ) as restored_transaction,\n  (SELECT history_id FROM log_restore) as history_id,\n  \u0027restored\u0027 as status;",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgresTool",
                      "typeVersion":  2.6,
                      "position":  [
                                       2128,
                                       304
                                   ],
                      "id":  "03c37d52-42d8-43c3-8e76-fe0d8dc1e0f3",
                      "name":  "Restore_transaction",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "=WITH found_transaction AS (\n  SELECT \n    CASE \n      WHEN LOWER(\u0027{{ $fromAI(\"transaction_id\", \"ID транзакции или \u0027last\u0027\", \"string\") }}\u0027) = \u0027last\u0027 \n      THEN get_last_transaction({{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}, LOWER(\u0027{{ $fromAI(\"transaction_type\", \"Тип: expense или income\", \"string\") }}\u0027))\n      ELSE CAST(NULLIF(\u0027{{ $fromAI(\"transaction_id\", \"ID транзакции или \u0027last\u0027\", \"string\") }}\u0027, \u0027last\u0027) AS INTEGER)\n    END as tid\n)\nSELECT \n  id,\n  action,\n  field_changed,\n  old_value,\n  new_value,\n  changed_by,\n  TO_CHAR(changed_at, \u0027DD.MM.YYYY HH24:MI:SS\u0027) as changed_at\nFROM transaction_history\nWHERE transaction_type = LOWER(\u0027{{ $fromAI(\"transaction_type\", \"Тип: expense или income\", \"string\") }}\u0027)\n  AND transaction_id = (SELECT tid FROM found_transaction)\nORDER BY changed_at DESC\nLIMIT 50;",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgresTool",
                      "typeVersion":  2.6,
                      "position":  [
                                       2288,
                                       224
                                   ],
                      "id":  "5938b065-2804-4274-b8e9-acd67e0f751c",
                      "name":  "Get_transaction_history",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "=SELECT * FROM create_recurring_payment(\n  {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}::BIGINT,\n  \u0027{{ $fromAI(\"title\", \"Название платежа (например Netflix, Аренда офиса)\", \"string\") }}\u0027::VARCHAR,\n  {{ $fromAI(\"amount\", \"Сумма платежа, только число\", \"number\") }}::NUMERIC,\n  UPPER(\u0027{{ $fromAI(\"currency\", \"Валюта: KGS/сом, USD/доллар, EUR/евро, RUB/рубль\", \"string\") }}\u0027)::VARCHAR,\n  \u0027{{ $fromAI(\"category\", \"Категория расхода: продукты, транспорт, аренда офиса, подписки и т.д.\", \"string\") }}\u0027::VARCHAR,\n  LOWER(\u0027{{ $fromAI(\"frequency\", \"Частота: daily (ежедневно), weekly (еженедельно), monthly (ежемесячно), yearly (ежегодно)\", \"string\") }}\u0027)::VARCHAR,\n  COALESCE(TO_DATE(NULLIF(\u0027{{ $fromAI(\"start_date\", \"Дата начала в формате DD.MM.YYYY (опционально, по умолчанию сегодня)\", \"string\", \"\") }}\u0027, \u0027\u0027), \u0027DD.MM.YYYY\u0027), CURRENT_DATE),\n  NULL::TEXT,\n  \u0027expense\u0027::VARCHAR,\n  {{ $fromAI(\"interval_value\", \"Каждые N периодов (например 1 для каждый месяц, 2 для каждые 2 недели)\", \"number\", 1) }}::INTEGER,\n  {{ $fromAI(\"remind_days_before\", \"За сколько дней напоминать (по умолчанию 3)\", \"number\", 3) }}::INTEGER,\n  {{ $fromAI(\"auto_create\", \"Создавать транзакцию автоматически: true или false (по умолчанию false)\", \"boolean\", false) }}::BOOLEAN\n);",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgresTool",
                      "typeVersion":  2.6,
                      "position":  [
                                       2416,
                                       352
                                   ],
                      "id":  "925d4075-48bc-4c66-9c20-01bf079a2fb1",
                      "name":  "Create_recurring_payment",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "=SELECT \n  id,\n  title,\n  amount,\n  currency,\n  category,\n  frequency,\n  interval_value,\n  TO_CHAR(next_payment_date, \u0027DD.MM.YYYY\u0027) as next_payment_date,\n  remind_days_before,\n  auto_create,\n  total_executions,\n  TO_CHAR(created_at, \u0027DD.MM.YYYY\u0027) as created_at\nFROM recurring_payments\nWHERE user_id = {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}\n  AND is_active = true\n  AND (end_date IS NULL OR end_date \u003e= CURRENT_DATE)\nORDER BY next_payment_date ASC;",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgresTool",
                      "typeVersion":  2.6,
                      "position":  [
                                       2544,
                                       160
                                   ],
                      "id":  "d9a4068b-144a-48e9-bb93-c851799bc316",
                      "name":  "List_recurring_payments",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "=UPDATE recurring_payments\nSET \n  is_active = false,\n  end_date = CURRENT_DATE,\n  updated_at = NOW()\nWHERE id = {{ $fromAI(\"payment_id\", \"ID подписки для отмены\", \"number\") }}\n  AND user_id = {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}\n  AND is_active = true\nRETURNING \n  id,\n  title,\n  amount,\n  currency,\n  \u0027cancelled\u0027 as status,\n  TO_CHAR(end_date, \u0027DD.MM.YYYY\u0027) as cancelled_date;",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgresTool",
                      "typeVersion":  2.6,
                      "position":  [
                                       2656,
                                       368
                                   ],
                      "id":  "24b919e5-9c5e-4f7d-b2b7-faebf41c3552",
                      "name":  "Cancel_recurring_payment",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "=SELECT * FROM get_budget_forecast(\n  {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}::BIGINT\n);",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgresTool",
                      "typeVersion":  2.6,
                      "position":  [
                                       2800,
                                       160
                                   ],
                      "id":  "ef73c36b-3984-4dc7-8ff3-b4082d0f3d09",
                      "name":  "Get_budget_forecast",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "=SELECT \n  id,\n  notification_type,\n  title,\n  message,\n  priority,\n  is_read,\n  TO_CHAR(created_at, \u0027DD.MM.YYYY HH24:MI\u0027) as created_at,\n  related_transaction_id,\n  metadata\nFROM notifications\nWHERE user_id = {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}\n  AND ({{ $fromAI(\"unread_only\", \"Показать только непрочитанные: true или false\", \"boolean\", true) }} = false OR is_read = false)\nORDER BY \n  CASE priority \n    WHEN \u0027urgent\u0027 THEN 1 \n    WHEN \u0027high\u0027 THEN 2 \n    WHEN \u0027normal\u0027 THEN 3 \n    ELSE 4 \n  END,\n  created_at DESC\nLIMIT {{ $fromAI(\"limit\", \"Количество уведомлений для показа\", \"number\", 10) }};",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgresTool",
                      "typeVersion":  2.6,
                      "position":  [
                                       2928,
                                       160
                                   ],
                      "id":  "8301336c-adaf-419f-a6a6-c38adf2f61d2",
                      "name":  "Get_notifications",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "=INSERT INTO budget_alerts_config (\n  user_id,\n  budget_warning_threshold,\n  budget_critical_threshold,\n  category_warning_threshold,\n  category_critical_threshold,\n  max_alerts_per_day,\n  updated_at\n) VALUES (\n  {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }},\n  {{ $fromAI(\"budget_warning\", \"Порог предупреждения о бюджете в % (например 75, 80, 90)\", \"number\", 80) }},\n  {{ $fromAI(\"budget_critical\", \"Критический порог бюджета в % (обычно 100)\", \"number\", 100) }},\n  {{ $fromAI(\"category_warning\", \"Порог предупреждения для лимитов категорий в %\", \"number\", 80) }},\n  {{ $fromAI(\"category_critical\", \"Критический порог для лимитов категорий в %\", \"number\", 100) }},\n  {{ $fromAI(\"max_alerts_per_day\", \"Максимальное количество уведомлений в день\", \"number\", 5) }},\n  NOW()\n)\nON CONFLICT (user_id) \nDO UPDATE SET\n  budget_warning_threshold = EXCLUDED.budget_warning_threshold,\n  budget_critical_threshold = EXCLUDED.budget_critical_threshold,\n  category_warning_threshold = EXCLUDED.category_warning_threshold,\n  category_critical_threshold = EXCLUDED.category_critical_threshold,\n  max_alerts_per_day = EXCLUDED.max_alerts_per_day,\n  updated_at = NOW()\nRETURNING \n  user_id,\n  budget_warning_threshold,\n  budget_critical_threshold,\n  category_warning_threshold,\n  category_critical_threshold,\n  max_alerts_per_day,\n  \u0027configured\u0027 as status;",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgresTool",
                      "typeVersion":  2.6,
                      "position":  [
                                       3056,
                                       160
                                   ],
                      "id":  "0238fa10-d749-4071-84a4-8faf6e1796ea",
                      "name":  "Configure_alerts",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n)\nSELECT * FROM get_income_expense_stats(\n  (SELECT workspace_id FROM user_workspace),\n  TO_DATE(\u0027{{ $fromAI(\"start_date\", \"Дата начала периода в формате DD.MM.YYYY (по умолчанию начало месяца)\", \"string\", TO_CHAR(DATE_TRUNC(\u0027month\u0027, CURRENT_DATE), \u0027DD.MM.YYYY\u0027)) }}\u0027, \u0027DD.MM.YYYY\u0027),\n  TO_DATE(\u0027{{ $fromAI(\"end_date\", \"Дата конца периода в формате DD.MM.YYYY (по умолчанию сегодня)\", \"string\", TO_CHAR(CURRENT_DATE, \u0027DD.MM.YYYY\u0027)) }}\u0027, \u0027DD.MM.YYYY\u0027)\n);",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgresTool",
                      "typeVersion":  2.6,
                      "position":  [
                                       3184,
                                       160
                                   ],
                      "id":  "eda68622-f5df-4f10-b359-83361f14ef25",
                      "name":  "Get_income_expense_stats",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n)\nSELECT * FROM get_top_expense_categories(\n  (SELECT workspace_id FROM user_workspace),\n  TO_DATE(\u0027{{ $fromAI(\"start_date\", \"Дата начала периода в формате DD.MM.YYYY (по умолчанию начало месяца)\", \"string\", TO_CHAR(DATE_TRUNC(\u0027month\u0027, CURRENT_DATE), \u0027DD.MM.YYYY\u0027)) }}\u0027, \u0027DD.MM.YYYY\u0027),\n  TO_DATE(\u0027{{ $fromAI(\"end_date\", \"Дата конца периода в формате DD.MM.YYYY (по умолчанию сегодня)\", \"string\", TO_CHAR(CURRENT_DATE, \u0027DD.MM.YYYY\u0027)) }}\u0027, \u0027DD.MM.YYYY\u0027),\n  {{ $fromAI(\"limit\", \"Количество топ категорий для показа (по умолчанию 10)\", \"number\", 10) }}\n);",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgresTool",
                      "typeVersion":  2.6,
                      "position":  [
                                       3312,
                                       160
                                   ],
                      "id":  "490d43ed-a02a-4f24-b16e-1dabf6cddc4e",
                      "name":  "Get_top_categories",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "=SELECT * FROM get_user_workspaces(\n  {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}::BIGINT\n);",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgresTool",
                      "typeVersion":  2.6,
                      "position":  [
                                       3440,
                                       160
                                   ],
                      "id":  "f5daefee-c872-4767-8872-74eecaf0edaa",
                      "name":  "Get_workspaces",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "=SELECT * FROM update_spending_patterns(\n  {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}::BIGINT\n);",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgresTool",
                      "typeVersion":  2.6,
                      "position":  [
                                       3568,
                                       160
                                   ],
                      "id":  "e4967d3b-1d3b-48ad-bf6f-63fa214596e2",
                      "name":  "Update_spending_patterns",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n)\nINSERT INTO budgets (user_id, workspace_id, month, budget_amount, currency)\nSELECT\n  {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }},\n  uw.workspace_id,\n  COALESCE(\n    \u0027{{ $fromAI(\"month\", \"Месяц в формате YYYY-MM (например 2025-11), если не указан - текущий месяц\", \"string\", \"\") }}\u0027,\n    TO_CHAR(CURRENT_DATE, \u0027YYYY-MM\u0027)\n  ),\n  {{ $fromAI(\"amount\", \"Сумма бюджета, только число\", \"number\") }},\n  UPPER(\u0027{{ $fromAI(\"currency\", \"Валюта бюджета: KGS/USD/EUR/RUB (по умолчанию KGS)\", \"string\", \"KGS\") }}\u0027)\nFROM user_workspace uw\nON CONFLICT (user_id, month) \nDO UPDATE SET \n  budget_amount = EXCLUDED.budget_amount,\n  currency = EXCLUDED.currency,\n  updated_at = NOW()\nRETURNING \n  id,\n  month,\n  budget_amount,\n  currency,\n  \u0027budget_set\u0027 as status;",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgresTool",
                      "typeVersion":  2.6,
                      "position":  [
                                       3696,
                                       160
                                   ],
                      "id":  "ebb30d02-cfb3-4c35-b475-c42124b25c63",
                      "name":  "Set_budget",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n)\nINSERT INTO limits (user_id, workspace_id, category, month, limit_amount, currency)\nSELECT\n  {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }},\n  uw.workspace_id,\n  \u0027{{ $fromAI(\"category\", \"Категория для лимита: продукты, транспорт, кафе/рестораны и т.д.\", \"string\") }}\u0027,\n  COALESCE(\n    \u0027{{ $fromAI(\"month\", \"Месяц в формате YYYY-MM (например 2025-11), если не указан - текущий месяц\", \"string\", \"\") }}\u0027,\n    TO_CHAR(CURRENT_DATE, \u0027YYYY-MM\u0027)\n  ),\n  {{ $fromAI(\"amount\", \"Сумма лимита, только число\", \"number\") }},\n  UPPER(\u0027{{ $fromAI(\"currency\", \"Валюта лимита: KGS/USD/EUR/RUB (по умолчанию KGS)\", \"string\", \"KGS\") }}\u0027)\nFROM user_workspace uw\nON CONFLICT (user_id, category, month) \nDO UPDATE SET \n  limit_amount = EXCLUDED.limit_amount,\n  currency = EXCLUDED.currency,\n  updated_at = NOW()\nRETURNING \n  id,\n  category,\n  month,\n  limit_amount,\n  currency,\n  \u0027limit_set\u0027 as status;",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgresTool",
                      "typeVersion":  2.6,
                      "position":  [
                                       3824,
                                       160
                                   ],
                      "id":  "8cbcc1f7-8719-4ad3-8a56-c2c23433025b",
                      "name":  "Set_category_limit",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "promptType":  "define",
                                         "text":  "={{ $json.message.text }}",
                                         "options":  {
                                                         "systemMessage":  "Ты финансист и менеджер по отчетам который реагирует на команду /get_week_report. Ты должен получать Отчеты за посленюю неделю используя базу данных get_last_week_report, делить эту неделю на дни, и сколько было потрачено в какой день"
                                                     }
                                     },
                      "type":  "@n8n/n8n-nodes-langchain.agent",
                      "typeVersion":  2.2,
                      "position":  [
                                       16,
                                       464
                                   ],
                      "id":  "6474cf77-b0ac-4a8f-be41-d5f28ec195d1",
                      "name":  "AI Agent"
                  },
                  {
                      "parameters":  {
                                         "model":  {
                                                       "__rl":  true,
                                                       "mode":  "list",
                                                       "value":  "gpt-4.1-mini"
                                                   },
                                         "options":  {

                                                     }
                                     },
                      "type":  "@n8n/n8n-nodes-langchain.lmChatOpenAi",
                      "typeVersion":  1.2,
                      "position":  [
                                       -160,
                                       688
                                   ],
                      "id":  "5a5ef7eb-29fd-4917-b967-d3139f9ab4fc",
                      "name":  "OpenAI Chat Model1",
                      "credentials":  {
                                          "openAiApi":  {
                                                            "id":  "SyI2pOUeSfbt1JRh",
                                                            "name":  "AIAccounter"
                                                        }
                                      }
                  },
                  {
                      "parameters":  {
                                         "sessionIdType":  "customKey",
                                         "sessionKey":  "={{ $json.message.text }}"
                                     },
                      "type":  "@n8n/n8n-nodes-langchain.memoryBufferWindow",
                      "typeVersion":  1.3,
                      "position":  [
                                       -32,
                                       688
                                   ],
                      "id":  "e2e2ba2f-0a26-4e57-8b9d-5662b204f5a3",
                      "name":  "Simple Memory"
                  },
                  {
                      "parameters":  {

                                     },
                      "type":  "@n8n/n8n-nodes-langchain.toolCalculator",
                      "typeVersion":  1,
                      "position":  [
                                       96,
                                       688
                                   ],
                      "id":  "d6a551c9-9807-4b2e-a859-63309375a941",
                      "name":  "Calculator"
                  },
                  {
                      "parameters":  {
                                         "resource":  "pdf",
                                         "pdfTemplateId":  "c1d77b23eda325b2",
                                         "jsonParameters":  true,
                                         "propertiesJson":  "{\n  \"name\": \"apitemplate.io\",\n  \"sales\": {\n    \"data\": [30,40,45,50,49,60,70,91,125],\n    \"categories\": [1991,1992,1993,1994,1995,1996,1997,1998,1999]\n  },\n  \"team\": {\n    \"data\": [44,55,13,43,22],\n    \"labels\": [\"Team A\",\"Team B\",\"Team C\",\"Team D\",\"Team E\"]\n  }\n}"
                                     },
                      "type":  "n8n-nodes-base.apiTemplateIo",
                      "typeVersion":  1,
                      "position":  [
                                       592,
                                       464
                                   ],
                      "id":  "b92bac80-3905-45fa-8bfe-8acdb2e5bdcd",
                      "name":  "Create a pdf",
                      "credentials":  {
                                          "apiTemplateIoApi":  {
                                                                   "id":  "WCFzWPXSnueTP8ef",
                                                                   "name":  "APITemplate.io Financer"
                                                               }
                                      }
                  },
                  {
                      "parameters":  {
                                         "descriptionType":  "manual",
                                         "toolDescription":  "Get many rows in Supabase for last week",
                                         "operation":  "getAll",
                                         "tableId":  "expenses",
                                         "returnAll":  true
                                     },
                      "type":  "n8n-nodes-base.supabaseTool",
                      "typeVersion":  1,
                      "position":  [
                                       256,
                                       688
                                   ],
                      "id":  "f03caf08-0868-480e-9c7d-b787898b55b4",
                      "name":  "get_last_week_report",
                      "credentials":  {
                                          "supabaseApi":  {
                                                              "id":  "4sTmVPkkZSWPshRg",
                                                              "name":  "Supabase account"
                                                          }
                                      }
                  },
                  {
                      "parameters":  {
                                         "jsCode":  "// Loop over input items and add a new field called \u0027myNewField\u0027 to the JSON of each one\nfor (const item of $input.all()) {\n  item.json.myNewField = 1;\n}\n\nreturn $input.all();"
                                     },
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  2,
                      "position":  [
                                       352,
                                       464
                                   ],
                      "id":  "832b6761-e922-4427-b0d6-b40a9d94fa10",
                      "name":  "Code in JavaScript"
                  },
                  {
                      "parameters":  {
                                         "rule":  {
                                                      "interval":  [
                                                                       {

                                                                       }
                                                                   ]
                                                  }
                                     },
                      "type":  "n8n-nodes-base.scheduleTrigger",
                      "typeVersion":  1.2,
                      "position":  [
                                       -256,
                                       464
                                   ],
                      "id":  "f9dbdff0-3f80-40dc-a075-17035a60f8f6",
                      "name":  "Schedule Trigger"
                  },
                  {
                      "parameters":  {
                                         "url":  "={{ $json.download_url }}",
                                         "sendBody":  true,
                                         "bodyParameters":  {
                                                                "parameters":  [
                                                                                   {

                                                                                   }
                                                                               ]
                                                            },
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.httpRequest",
                      "typeVersion":  4.2,
                      "position":  [
                                       800,
                                       464
                                   ],
                      "id":  "a9f364c2-b68d-4074-93a8-7f7cd8d9bbe0",
                      "name":  "HTTP Request"
                  },
                  {
                      "parameters":  {
                                         "operation":  "sendDocument",
                                         "chatId":  "={{ $(\u0027Telegram Bot Trigger\u0027).item.json.message.chat.id }}",
                                         "file":  "={{ $json.download_url }}",
                                         "additionalFields":  {

                                                              }
                                     },
                      "type":  "n8n-nodes-base.telegram",
                      "typeVersion":  1.2,
                      "position":  [
                                       1008,
                                       464
                                   ],
                      "id":  "7ba4bde6-c1d1-49d8-a5f6-61b16f1a7237",
                      "name":  "Send a document",
                      "webhookId":  "aacbbe26-503f-4111-bf0a-72c6df95e208",
                      "credentials":  {
                                          "telegramApi":  {
                                                              "id":  "WabnlnnS7XdATC3n",
                                                              "name":  "Alikbek Financer"
                                                          }
                                      }
                  },
                  {
                      "parameters":  {
                                         "rule":  {
                                                      "interval":  [
                                                                       {
                                                                           "field":  "cronExpression",
                                                                           "expression":  "0 21 * * *"
                                                                       }
                                                                   ]
                                                  }
                                     },
                      "type":  "n8n-nodes-base.scheduleTrigger",
                      "typeVersion":  1.2,
                      "position":  [
                                       -256,
                                       720
                                   ],
                      "id":  "daily-report-trigger",
                      "name":  "Daily Report Trigger"
                  },
                  {
                      "parameters":  {
                                         "rule":  {
                                                      "interval":  [
                                                                       {
                                                                           "field":  "cronExpression",
                                                                           "expression":  "0 9 * * 1"
                                                                       }
                                                                   ]
                                                  }
                                     },
                      "type":  "n8n-nodes-base.scheduleTrigger",
                      "typeVersion":  1.2,
                      "position":  [
                                       -256,
                                       960
                                   ],
                      "id":  "weekly-report-trigger",
                      "name":  "Weekly Report Trigger"
                  },
                  {
                      "parameters":  {
                                         "rule":  {
                                                      "interval":  [
                                                                       {
                                                                           "field":  "cronExpression",
                                                                           "expression":  "0 10 1 * *"
                                                                       }
                                                                   ]
                                                  }
                                     },
                      "type":  "n8n-nodes-base.scheduleTrigger",
                      "typeVersion":  1.2,
                      "position":  [
                                       -256,
                                       1200
                                   ],
                      "id":  "monthly-report-trigger",
                      "name":  "Monthly Report Trigger"
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "=-- Получить всех активных пользователей для отправки ежедневного отчета\nSELECT DISTINCT\n  u.user_id,\n  u.telegram_chat_id,\n  u.first_name,\n  w.id as workspace_id\nFROM users u\nJOIN workspace_members wm ON u.user_id = wm.user_id\nJOIN workspaces w ON wm.workspace_id = w.id\nWHERE u.telegram_chat_id IS NOT NULL\n  AND wm.is_active = true\n  AND w.is_active = true\n  AND u.last_activity \u003e= NOW() - INTERVAL \u00277 days\u0027\nORDER BY u.user_id;",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgres",
                      "typeVersion":  2.6,
                      "position":  [
                                       64,
                                       720
                                   ],
                      "id":  "get-active-users",
                      "name":  "Get Active Users",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "=-- Получить данные за сегодня для пользователя\nWITH today_expenses AS (\n  SELECT \n    COALESCE(SUM(amount), 0) as total_expenses,\n    COUNT(*) as expense_count,\n    json_agg(\n      json_build_object(\n        \u0027category\u0027, category,\n        \u0027amount\u0027, amount,\n        \u0027description\u0027, description\n      ) ORDER BY amount DESC\n    ) as expenses_detail\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    {{ $json.workspace_id ? \u0027AND workspace_id = \u0027 + $json.workspace_id : \u0027\u0027 }}\n    AND DATE(date) = (NOW() AT TIME ZONE \u0027Asia/Bishkek\u0027)::DATE\n    AND deleted_at IS NULL\n),\ntoday_income AS (\n  SELECT \n    COALESCE(SUM(amount), 0) as total_income,\n    COUNT(*) as income_count\n  FROM income\n  WHERE user_id = {{ $json.user_id }}\n    {{ $json.workspace_id ? \u0027AND workspace_id = \u0027 + $json.workspace_id : \u0027\u0027 }}\n    AND DATE(date) = (NOW() AT TIME ZONE \u0027Asia/Bishkek\u0027)::DATE\n    AND deleted_at IS NULL\n),\nmonth_stats AS (\n  SELECT \n    COALESCE(SUM(amount), 0) as month_expenses\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    {{ $json.workspace_id ? \u0027AND workspace_id = \u0027 + $json.workspace_id : \u0027\u0027 }}\n    AND DATE_TRUNC(\u0027month\u0027, date) = DATE_TRUNC(\u0027month\u0027, (NOW() AT TIME ZONE \u0027Asia/Bishkek\u0027)::DATE)\n    AND deleted_at IS NULL\n),\nbudget_info AS (\n  SELECT budget_amount, currency\n  FROM budgets\n  WHERE user_id = {{ $json.user_id }}\n    {{ $json.workspace_id ? \u0027AND workspace_id = \u0027 + $json.workspace_id : \u0027\u0027 }}\n    AND month = TO_CHAR((NOW() AT TIME ZONE \u0027Asia/Bishkek\u0027)::DATE, \u0027YYYY-MM\u0027)\n  LIMIT 1\n)\nSELECT \n  {{ $json.user_id }} as user_id,\n  {{ $json.telegram_chat_id }} as chat_id,\n  \u0027{{ $json.first_name }}\u0027 as user_name,\n  te.total_expenses,\n  te.expense_count,\n  te.expenses_detail,\n  ti.total_income,\n  ti.income_count,\n  ms.month_expenses,\n  bi.budget_amount,\n  COALESCE(bi.currency, \u0027KGS\u0027) as budget_currency,\n  CASE \n    WHEN bi.budget_amount \u003e 0 THEN ROUND((ms.month_expenses / bi.budget_amount) * 100, 1)\n    ELSE 0\n  END as budget_used_percent\nFROM today_expenses te\nCROSS JOIN today_income ti\nCROSS JOIN month_stats ms\nLEFT JOIN budget_info bi ON true;",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgres",
                      "typeVersion":  2.6,
                      "position":  [
                                       384,
                                       720
                                   ],
                      "id":  "get-daily-stats",
                      "name":  "Get Daily Stats",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "promptType":  "define",
                                         "text":  "=Создай краткий ежедневный финансовый отчет на основе этих данных:\n\n👤 Пользователь: {{ $json.user_name }}\n📅 Дата: {{ new Date().toLocaleDateString(\u0027ru-RU\u0027) }}\n\n💸 СЕГОДНЯ:\n- Расходы: {{ $json.total_expenses }} сом ({{ $json.expense_count }} транзакций)\n- Доходы: {{ $json.total_income }} сом ({{ $json.income_count }} транзакций)\n- Баланс дня: {{ $json.total_income - $json.total_expenses }} сом\n\n📊 МЕСЯЦ:\n- Потрачено: {{ $json.month_expenses }} сом\n- Бюджет: {{ $json.budget_amount || \u0027не установлен\u0027 }} {{ $json.budget_currency || \u0027\u0027 }}\n- Использовано бюджета: {{ $json.budget_used_percent }}%\n\n📋 Детали расходов за сегодня:\n{{ JSON.stringify($json.expenses_detail, null, 2) }}\n\nНапиши:\n1. Краткий итог дня (2-3 предложения)\n2. Анализ трат (что заметил)\n3. Один полезный совет или рекомендацию\n\nФормат: дружелюбный, мотивирующий, с эмодзи. Максимум 10 строк.",
                                         "options":  {
                                                         "systemMessage":  "Ты финансовый аналитик, который делает краткие ежедневные отчеты. Говори по-русски, используй эмодзи, будь позитивным и мотивирующим."
                                                     }
                                     },
                      "type":  "@n8n/n8n-nodes-langchain.agent",
                      "typeVersion":  1.7,
                      "position":  [
                                       704,
                                       720
                                   ],
                      "id":  "daily-report-ai",
                      "name":  "Daily Report AI"
                  },
                  {
                      "parameters":  {
                                         "model":  {
                                                       "__rl":  true,
                                                       "value":  "gpt-4o-mini",
                                                       "mode":  "list",
                                                       "cachedResultName":  "gpt-4o-mini"
                                                   },
                                         "options":  {

                                                     }
                                     },
                      "type":  "@n8n/n8n-nodes-langchain.lmChatOpenAi",
                      "typeVersion":  1.2,
                      "position":  [
                                       832,
                                       880
                                   ],
                      "id":  "daily-openai-model",
                      "name":  "OpenAI Daily Model",
                      "credentials":  {
                                          "openAiApi":  {
                                                            "id":  "SyI2pOUeSfbt1JRh",
                                                            "name":  "AIAccounter"
                                                        }
                                      }
                  },
                  {
                      "parameters":  {
                                         "chatId":  "={{ $(\u0027Get Daily Stats\u0027).first().json.chat_id }}",
                                         "text":  "=🌙 *Ежедневный отчет*\n\n{{ $(\u0027Daily Report AI\u0027).first().json.output }}",
                                         "additionalFields":  {
                                                                  "parse_mode":  "Markdown",
                                                                  "appendAttribution":  false
                                                              }
                                     },
                      "type":  "n8n-nodes-base.telegram",
                      "typeVersion":  1.2,
                      "position":  [
                                       1024,
                                       720
                                   ],
                      "id":  "send-daily-report",
                      "name":  "Send Daily Report",
                      "webhookId":  "daily-report-send",
                      "credentials":  {
                                          "telegramApi":  {
                                                              "id":  "WabnlnnS7XdATC3n",
                                                              "name":  "Alikbek Financer"
                                                          }
                                      }
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "=-- Получить данные за неделю для отчета\nWITH week_expenses AS (\n  SELECT \n    DATE(date) as expense_date,\n    category,\n    SUM(amount) as daily_total,\n    currency,\n    COUNT(*) as transaction_count\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    {{ $json.workspace_id ? \u0027AND workspace_id = \u0027 + $json.workspace_id : \u0027\u0027 }}\n    AND DATE(date) \u003e= CURRENT_DATE - INTERVAL \u00277 days\u0027\n    AND DATE(date) \u003c= CURRENT_DATE\n    AND deleted_at IS NULL\n  GROUP BY DATE(date), category, currency\n  ORDER BY DATE(date) DESC, daily_total DESC\n),\nweek_income AS (\n  SELECT \n    DATE(date) as income_date,\n    category,\n    SUM(amount) as daily_total,\n    currency\n  FROM income\n  WHERE user_id = {{ $json.user_id }}\n    {{ $json.workspace_id ? \u0027AND workspace_id = \u0027 + $json.workspace_id : \u0027\u0027 }}\n    AND DATE(date) \u003e= CURRENT_DATE - INTERVAL \u00277 days\u0027\n    AND DATE(date) \u003c= CURRENT_DATE\n    AND deleted_at IS NULL\n  GROUP BY DATE(date), category, currency\n  ORDER BY DATE(date) DESC\n),\nweek_summary AS (\n  SELECT \n    COALESCE(SUM(we.daily_total), 0) as total_expenses,\n    COALESCE(SUM(wi.daily_total), 0) as total_income,\n    (SELECT COUNT(*) FROM expenses WHERE user_id = {{ $json.user_id }} {{ $json.workspace_id ? \u0027AND workspace_id = \u0027 + $json.workspace_id : \u0027\u0027 }} AND DATE(date) \u003e= CURRENT_DATE - INTERVAL \u00277 days\u0027 AND DATE(date) \u003c= CURRENT_DATE AND deleted_at IS NULL) as expense_count,\n    (SELECT COUNT(*) FROM income WHERE user_id = {{ $json.user_id }} {{ $json.workspace_id ? \u0027AND workspace_id = \u0027 + $json.workspace_id : \u0027\u0027 }} AND DATE(date) \u003e= CURRENT_DATE - INTERVAL \u00277 days\u0027 AND DATE(date) \u003c= CURRENT_DATE AND deleted_at IS NULL) as income_count\n  FROM week_expenses we\n  FULL OUTER JOIN week_income wi ON we.expense_date = wi.income_date\n),\ntop_categories AS (\n  SELECT \n    category,\n    SUM(amount) as category_total,\n    ROUND((SUM(amount) / NULLIF((SELECT SUM(amount) FROM expenses WHERE user_id = {{ $json.user_id }} {{ $json.workspace_id ? \u0027AND workspace_id = \u0027 + $json.workspace_id : \u0027\u0027 }} AND DATE(date) \u003e= CURRENT_DATE - INTERVAL \u00277 days\u0027 AND DATE(date) \u003c= CURRENT_DATE AND deleted_at IS NULL), 0)) * 100, 1) as percentage\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    {{ $json.workspace_id ? \u0027AND workspace_id = \u0027 + $json.workspace_id : \u0027\u0027 }}\n    AND DATE(date) \u003e= CURRENT_DATE - INTERVAL \u00277 days\u0027\n    AND DATE(date) \u003c= CURRENT_DATE\n    AND deleted_at IS NULL\n  GROUP BY category\n  ORDER BY category_total DESC\n  LIMIT 5\n)\nSELECT \n  {{ $json.user_id }} as user_id,\n  {{ $json.telegram_chat_id }} as chat_id,\n  \u0027{{ $json.first_name }}\u0027 as user_name,\n  {{ $json.workspace_id || 0 }} as workspace_id,\n  (SELECT json_agg(row_to_json(we.*)) FROM week_expenses we) as expenses_by_day,\n  (SELECT json_agg(row_to_json(wi.*)) FROM week_income wi) as income_by_day,\n  ws.total_expenses,\n  ws.total_income,\n  ws.expense_count,\n  ws.income_count,\n  (SELECT json_agg(row_to_json(tc.*)) FROM top_categories tc) as top_categories,\n  TO_CHAR(CURRENT_DATE - INTERVAL \u00277 days\u0027, \u0027DD.MM.YYYY\u0027) as period_start,\n  TO_CHAR(CURRENT_DATE, \u0027DD.MM.YYYY\u0027) as period_end\nFROM week_summary ws;",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgres",
                      "typeVersion":  2.6,
                      "position":  [
                                       384,
                                       960
                                   ],
                      "id":  "get-weekly-data",
                      "name":  "Get Weekly Data",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "jsCode":  "// Подготовка данных для недельного PDF отчета\nconst data = $input.first().json;\n\n// Функция форматирования валюты\nfunction formatCurrency(amount, symbol = \u0027сом\u0027) {\n  return `${Math.round(amount)} ${symbol}`;\n}\n\n// Форматируем данные по дням для графика\nconst expensesByDay = data.expenses_by_day || [];\nconst incomeByDay = data.income_by_day || [];\n\n// Создаем массив дат и сумм для графика\nconst dates = [];\nconst expensesData = [];\nconst incomeData = [];\n\n// Группируем расходы по дням\nconst expenseMap = {};\nexpensesByDay.forEach(exp =\u003e {\n  const date = new Date(exp.expense_date).toLocaleDateString(\u0027ru-RU\u0027, { day: \u00272-digit\u0027, month: \u00272-digit\u0027 });\n  if (!expenseMap[date]) {\n    expenseMap[date] = 0;\n  }\n  expenseMap[date] += parseFloat(exp.daily_total || 0);\n});\n\n// Группируем доходы по дням\nconst incomeMap = {};\nincomeByDay.forEach(inc =\u003e {\n  const date = new Date(inc.income_date).toLocaleDateString(\u0027ru-RU\u0027, { day: \u00272-digit\u0027, month: \u00272-digit\u0027 });\n  if (!incomeMap[date]) {\n    incomeMap[date] = 0;\n  }\n  incomeMap[date] += parseFloat(inc.daily_total || 0);\n});\n\n// Получаем все уникальные даты\nconst allDates = [...new Set([...Object.keys(expenseMap), ...Object.keys(incomeMap)])];\nallDates.sort();\n\n// Заполняем массивы для графика\nallDates.forEach(date =\u003e {\n  dates.push(date);\n  expensesData.push(Math.round(expenseMap[date] || 0));\n  incomeData.push(Math.round(incomeMap[date] || 0));\n});\n\n// Топ категорий расходов с форматированием\nconst topCategories = (data.top_categories || []).map(cat =\u003e {\n  const value = Math.round(parseFloat(cat.category_total || 0));\n  return {\n    label: cat.category,\n    value: value,\n    value_formatted: formatCurrency(value),\n    percentage: parseFloat(cat.percentage || 0)\n  };\n});\n\n// Данные для круговой диаграммы\nconst categoryLabels = topCategories.map(c =\u003e c.label);\nconst categoryValues = topCategories.map(c =\u003e c.value);\n\n// Рассчитываем основные показатели\nconst totalExpenses = Math.round(parseFloat(data.total_expenses || 0));\nconst totalIncome = Math.round(parseFloat(data.total_income || 0));\nconst balance = totalIncome - totalExpenses;\nconst avgDailyExpense = Math.round(totalExpenses / 7);\nconst avgDailyIncome = Math.round(totalIncome / 7);\n\n// Итоговые данные\nconst result = {\n  // Заголовок и период\n  title: `📊 Недельный финансовый отчет`,\n  user_name: data.user_name || \u0027Пользователь\u0027,\n  period: `${data.period_start} - ${data.period_end}`,\n  currency_symbol: \u0027сом\u0027,\n  \n  // Основные показатели (числа для графиков)\n  total_expenses: totalExpenses,\n  total_income: totalIncome,\n  balance: balance,\n  transaction_count: parseInt(data.expense_count || 0) + parseInt(data.income_count || 0),\n  expense_count: parseInt(data.expense_count || 0),\n  income_count: parseInt(data.income_count || 0),\n  avg_daily_expense: avgDailyExpense,\n  avg_daily_income: avgDailyIncome,\n  \n  // Форматированные значения (для отображения)\n  total_expenses_formatted: formatCurrency(totalExpenses),\n  total_income_formatted: formatCurrency(totalIncome),\n  balance_formatted: formatCurrency(balance),\n  avg_daily_expense_formatted: formatCurrency(avgDailyExpense),\n  avg_daily_income_formatted: formatCurrency(avgDailyIncome),\n  \n  // График доходов/расходов по дням\n  daily_chart: {\n    labels: dates,\n    datasets: [\n      {\n        label: \u0027Расходы\u0027,\n        data: expensesData,\n        backgroundColor: \u0027rgba(255, 99, 132, 0.8)\u0027,\n        borderColor: \u0027rgb(255, 99, 132)\u0027\n      },\n      {\n        label: \u0027Доходы\u0027,\n        data: incomeData,\n        backgroundColor: \u0027rgba(75, 192, 192, 0.8)\u0027,\n        borderColor: \u0027rgb(75, 192, 192)\u0027\n      }\n    ]\n  },\n  \n  // Круговая диаграмма топ категорий\n  category_chart: {\n    labels: categoryLabels,\n    data: categoryValues\n  },\n  \n  // Таблица топ категорий (с форматированием)\n  top_categories_table: topCategories,\n  \n  // Детальная информация по дням\n  daily_details: allDates.map(date =\u003e ({\n    date: date,\n    expenses: expenseMap[date] || 0,\n    income: incomeMap[date] || 0,\n    balance: (incomeMap[date] || 0) - (expenseMap[date] || 0)\n  }))\n};\n\nreturn [{ json: result }];"
                                     },
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  2,
                      "position":  [
                                       560,
                                       960
                                   ],
                      "id":  "format-weekly-data",
                      "name":  "Format Weekly Data"
                  },
                  {
                      "parameters":  {
                                         "resource":  "pdf",
                                         "pdfTemplateId":  "5a677b23ed6c2fe6",
                                         "jsonParameters":  true,
                                         "propertiesJson":  "={{ JSON.stringify($json) }}"
                                     },
                      "type":  "n8n-nodes-base.apiTemplateIo",
                      "typeVersion":  1,
                      "position":  [
                                       704,
                                       960
                                   ],
                      "id":  "generate-weekly-pdf",
                      "name":  "Generate Weekly PDF",
                      "credentials":  {
                                          "apiTemplateIoApi":  {
                                                                   "id":  "WCFzWPXSnueTP8ef",
                                                                   "name":  "APITemplate.io Financer"
                                                               }
                                      }
                  },
                  {
                      "parameters":  {
                                         "operation":  "sendDocument",
                                         "chatId":  "={{ $(\u0027Get Weekly Data\u0027).first().json.chat_id }}",
                                         "file":  "={{ $json.download_url }}",
                                         "additionalFields":  {
                                                                  "caption":  "=📊 *Недельный отчет*\n\n📅 Период: {{ $(\u0027Format Weekly Data\u0027).first().json.period }}\n👤 {{ $(\u0027Format Weekly Data\u0027).first().json.user_name }}\n\n💸 Расходы: {{ $(\u0027Format Weekly Data\u0027).first().json.total_expenses_formatted }}\n💰 Доходы: {{ $(\u0027Format Weekly Data\u0027).first().json.total_income_formatted }}\n📈 Баланс: {{ $(\u0027Format Weekly Data\u0027).first().json.balance_formatted }}\n\n📝 Транзакций: {{ $(\u0027Format Weekly Data\u0027).first().json.transaction_count }}\n📊 Среднее в день: {{ $(\u0027Format Weekly Data\u0027).first().json.avg_daily_expense_formatted }}",
                                                                  "parse_mode":  "Markdown",
                                                                  "append_attribution":  false
                                                              }
                                     },
                      "type":  "n8n-nodes-base.telegram",
                      "typeVersion":  1.2,
                      "position":  [
                                       1024,
                                       960
                                   ],
                      "id":  "send-weekly-pdf",
                      "name":  "Send Weekly PDF",
                      "webhookId":  "weekly-pdf-send",
                      "credentials":  {
                                          "telegramApi":  {
                                                              "id":  "WabnlnnS7XdATC3n",
                                                              "name":  "Alikbek Financer"
                                                          }
                                      }
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "=-- Получить данные за месяц для отчета\nWITH month_expenses AS (\n  SELECT \n    DATE(date) as expense_date,\n    category,\n    SUM(amount) as daily_total,\n    currency,\n    COUNT(*) as transaction_count\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    {{ $json.workspace_id ? \u0027AND workspace_id = \u0027 + $json.workspace_id : \u0027\u0027 }}\n    AND DATE_TRUNC(\u0027month\u0027, date) = DATE_TRUNC(\u0027month\u0027, CURRENT_DATE - INTERVAL \u00271 month\u0027)\n    AND deleted_at IS NULL\n  GROUP BY DATE(date), category, currency\n  ORDER BY DATE(date) DESC, daily_total DESC\n),\nmonth_income AS (\n  SELECT \n    DATE(date) as income_date,\n    category,\n    SUM(amount) as daily_total,\n    currency\n  FROM income\n  WHERE user_id = {{ $json.user_id }}\n    {{ $json.workspace_id ? \u0027AND workspace_id = \u0027 + $json.workspace_id : \u0027\u0027 }}\n    AND DATE_TRUNC(\u0027month\u0027, date) = DATE_TRUNC(\u0027month\u0027, CURRENT_DATE - INTERVAL \u00271 month\u0027)\n    AND deleted_at IS NULL\n  GROUP BY DATE(date), category, currency\n  ORDER BY DATE(date) DESC\n),\nmonth_summary AS (\n  SELECT \n    COALESCE(SUM(amount), 0) as total_expenses,\n    COUNT(*) as expense_count\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    {{ $json.workspace_id ? \u0027AND workspace_id = \u0027 + $json.workspace_id : \u0027\u0027 }}\n    AND DATE_TRUNC(\u0027month\u0027, date) = DATE_TRUNC(\u0027month\u0027, CURRENT_DATE - INTERVAL \u00271 month\u0027)\n    AND deleted_at IS NULL\n),\nmonth_income_summary AS (\n  SELECT \n    COALESCE(SUM(amount), 0) as total_income,\n    COUNT(*) as income_count\n  FROM income\n  WHERE user_id = {{ $json.user_id }}\n    {{ $json.workspace_id ? \u0027AND workspace_id = \u0027 + $json.workspace_id : \u0027\u0027 }}\n    AND DATE_TRUNC(\u0027month\u0027, date) = DATE_TRUNC(\u0027month\u0027, CURRENT_DATE - INTERVAL \u00271 month\u0027)\n    AND deleted_at IS NULL\n),\ncategory_breakdown AS (\n  SELECT \n    category,\n    SUM(amount) as category_total,\n    COUNT(*) as category_count,\n    ROUND(AVG(amount), 2) as avg_transaction,\n    ROUND((SUM(amount) / NULLIF((SELECT total_expenses FROM month_summary), 0)) * 100, 1) as percentage\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    {{ $json.workspace_id ? \u0027AND workspace_id = \u0027 + $json.workspace_id : \u0027\u0027 }}\n    AND DATE_TRUNC(\u0027month\u0027, date) = DATE_TRUNC(\u0027month\u0027, CURRENT_DATE - INTERVAL \u00271 month\u0027)\n    AND deleted_at IS NULL\n  GROUP BY category\n  ORDER BY category_total DESC\n),\nbudget_comparison AS (\n  SELECT \n    budget_amount,\n    currency,\n    (SELECT total_expenses FROM month_summary) as actual_expenses,\n    CASE \n      WHEN budget_amount \u003e 0 THEN ROUND(((SELECT total_expenses FROM month_summary) / budget_amount) * 100, 1)\n      ELSE 0\n    END as budget_used_percent\n  FROM budgets\n  WHERE user_id = {{ $json.user_id }}\n    {{ $json.workspace_id ? \u0027AND workspace_id = \u0027 + $json.workspace_id : \u0027\u0027 }}\n    AND month = TO_CHAR(CURRENT_DATE - INTERVAL \u00271 month\u0027, \u0027YYYY-MM\u0027)\n  LIMIT 1\n)\nSELECT \n  {{ $json.user_id }} as user_id,\n  {{ $json.telegram_chat_id }} as chat_id,\n  \u0027{{ $json.first_name }}\u0027 as user_name,\n  {{ $json.workspace_id || 0 }} as workspace_id,\n  ms.total_expenses,\n  mis.total_income,\n  ms.expense_count,\n  mis.income_count,\n  (SELECT json_agg(row_to_json(me.*)) FROM month_expenses me) as expenses_by_day,\n  (SELECT json_agg(row_to_json(mi.*)) FROM month_income mi) as income_by_day,\n  (SELECT json_agg(row_to_json(cb.*)) FROM category_breakdown cb) as category_breakdown,\n  bc.budget_amount,\n  bc.currency as budget_currency,\n  bc.budget_used_percent,\n  TO_CHAR(DATE_TRUNC(\u0027month\u0027, CURRENT_DATE - INTERVAL \u00271 month\u0027), \u0027DD.MM.YYYY\u0027) as period_start,\n  TO_CHAR(DATE_TRUNC(\u0027month\u0027, CURRENT_DATE - INTERVAL \u00271 month\u0027) + INTERVAL \u00271 month\u0027 - INTERVAL \u00271 day\u0027, \u0027DD.MM.YYYY\u0027) as period_end,\n  TO_CHAR(DATE_TRUNC(\u0027month\u0027, CURRENT_DATE - INTERVAL \u00271 month\u0027), \u0027Month YYYY\u0027) as month_name\nFROM month_summary ms\nCROSS JOIN month_income_summary mis\nLEFT JOIN budget_comparison bc ON true;",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgres",
                      "typeVersion":  2.6,
                      "position":  [
                                       384,
                                       1200
                                   ],
                      "id":  "get-monthly-data",
                      "name":  "Get Monthly Data",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "jsCode":  "// Подготовка данных для месячного PDF отчета\nconst data = $input.first().json;\n\n// Функция форматирования валюты\nfunction formatCurrency(amount, symbol = \u0027сом\u0027) {\n  return `${Math.round(amount)} ${symbol}`;\n}\n\n// Форматируем категории с детализацией\nconst categoryBreakdown = (data.category_breakdown || []).map(cat =\u003e {\n  const total = Math.round(parseFloat(cat.category_total || 0));\n  return {\n    category: cat.category,\n    amount: total,\n    amount_formatted: formatCurrency(total),\n    count: parseInt(cat.category_count || 0),\n    percentage: parseFloat(cat.percentage || 0)\n  };\n});\n\n// Топ 5 категорий для графиков\nconst topCategories = categoryBreakdown.slice(0, 5).map(cat =\u003e ({\n  category: cat.category,\n  amount: cat.amount,\n  percentage: cat.percentage\n}));\n\n// Данные по неделям (группировка по неделям)\nconst expensesByDay = data.expenses_by_day || [];\nconst incomeByDay = data.income_by_day || [];\n\n// Группируем по неделям (примерно 7 дней в неделе)\nconst weeklyData = [];\nconst daysInMonth = 30;\nfor (let week = 1; week \u003c= 4; week++) {\n  const startDay = (week - 1) * 7 + 1;\n  const endDay = Math.min(week * 7, daysInMonth);\n  \n  let weekExpenses = 0;\n  let weekIncome = 0;\n  \n  expensesByDay.forEach(exp =\u003e {\n    const day = new Date(exp.expense_date).getDate();\n    if (day \u003e= startDay \u0026\u0026 day \u003c= endDay) {\n      weekExpenses += parseFloat(exp.daily_total || 0);\n    }\n  });\n  \n  incomeByDay.forEach(inc =\u003e {\n    const day = new Date(inc.income_date).getDate();\n    if (day \u003e= startDay \u0026\u0026 day \u003c= endDay) {\n      weekIncome += parseFloat(inc.daily_total || 0);\n    }\n  });\n  \n  weeklyData.push({\n    label: `Неделя ${week}`,\n    expenses: Math.round(weekExpenses),\n    income: Math.round(weekIncome)\n  });\n}\n\n// Расчет основных показателей\nconst totalExpenses = Math.round(parseFloat(data.total_expenses || 0));\nconst totalIncome = Math.round(parseFloat(data.total_income || 0));\nconst balance = totalIncome - totalExpenses;\nconst transactionCount = parseInt(data.expense_count || 0) + parseInt(data.income_count || 0);\n\n// Расчет бюджета\nconst budgetAmount = Math.round(parseFloat(data.budget_amount || 0));\nconst budgetUsedPercent = budgetAmount \u003e 0 ? Math.round((totalExpenses / budgetAmount) * 100) : 0;\nconst budgetRemaining = budgetAmount - totalExpenses;\n\n// Средние показатели\nconst avgDailyExpense = Math.round(totalExpenses / daysInMonth);\nconst avgDailyIncome = Math.round(totalIncome / daysInMonth);\n\n// Прогноз на следующий месяц (простая экстраполяция)\nconst forecastExpense = Math.round(totalExpenses * 1.05); // +5%\nconst forecastIncome = Math.round(totalIncome * 1.03); // +3%\nconst forecastBalance = forecastIncome - forecastExpense;\n\n// Итоговые данные\nconst result = {\n  // Заголовок\n  period: `${data.period_start || \u002701.10.2025\u0027} - ${data.period_end || \u002731.10.2025\u0027}`,\n  user_name: data.user_name || \u0027Пользователь\u0027,\n  currency_symbol: \u0027сом\u0027,\n  \n  // Основные показатели (числа для графиков)\n  total_expenses: totalExpenses,\n  total_income: totalIncome,\n  balance: balance,\n  transaction_count: transactionCount,\n  \n  // Форматированные основные показатели\n  total_expenses_formatted: formatCurrency(totalExpenses),\n  total_income_formatted: formatCurrency(totalIncome),\n  balance_formatted: formatCurrency(balance),\n  \n  // Бюджет\n  budget_amount: budgetAmount,\n  budget_used: totalExpenses,\n  budget_used_percent: budgetUsedPercent,\n  budget_remaining: budgetRemaining,\n  \n  // Форматированный бюджет\n  budget_amount_formatted: formatCurrency(budgetAmount),\n  budget_used_formatted: formatCurrency(totalExpenses),\n  budget_remaining_formatted: formatCurrency(budgetRemaining),\n  \n  // Средние показатели\n  avg_daily_expense: avgDailyExpense,\n  avg_daily_income: avgDailyIncome,\n  \n  // Форматированные средние\n  avg_daily_expense_formatted: formatCurrency(avgDailyExpense),\n  avg_daily_income_formatted: formatCurrency(avgDailyIncome),\n  \n  // Прогноз\n  forecast_expense: forecastExpense,\n  forecast_income: forecastIncome,\n  forecast_balance: forecastBalance,\n  \n  // Форматированный прогноз\n  forecast_expense_formatted: formatCurrency(forecastExpense),\n  forecast_income_formatted: formatCurrency(forecastIncome),\n  forecast_balance_formatted: formatCurrency(forecastBalance),\n  \n  // Данные по неделям для area chart\n  weekly_data: weeklyData,\n  \n  // Топ 5 категорий для графиков\n  top_categories: topCategories,\n  \n  // Детальная таблица категорий\n  expense_breakdown: categoryBreakdown\n};\n\nreturn [{ json: result }];"
                                     },
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  2,
                      "position":  [
                                       560,
                                       1200
                                   ],
                      "id":  "format-monthly-data",
                      "name":  "Format Monthly Data"
                  },
                  {
                      "parameters":  {
                                         "resource":  "pdf",
                                         "pdfTemplateId":  "c1177b23eddd4e88",
                                         "jsonParameters":  true,
                                         "propertiesJson":  "={{ JSON.stringify($json) }}"
                                     },
                      "type":  "n8n-nodes-base.apiTemplateIo",
                      "typeVersion":  1,
                      "position":  [
                                       704,
                                       1200
                                   ],
                      "id":  "generate-monthly-pdf",
                      "name":  "Generate Monthly PDF",
                      "credentials":  {
                                          "apiTemplateIoApi":  {
                                                                   "id":  "WCFzWPXSnueTP8ef",
                                                                   "name":  "APITemplate.io Financer"
                                                               }
                                      }
                  },
                  {
                      "parameters":  {
                                         "operation":  "sendDocument",
                                         "chatId":  "={{ $(\u0027Get Monthly Data\u0027).first().json.chat_id }}",
                                         "file":  "={{ $json.download_url }}",
                                         "additionalFields":  {
                                                                  "caption":  "=📊 *Месячный отчет* - {{ $(\u0027Format Monthly Data\u0027).first().json.month }}\n\n📅 Период: {{ $(\u0027Format Monthly Data\u0027).first().json.period }}\n👤 {{ $(\u0027Format Monthly Data\u0027).first().json.user_name }}\n\n💸 Расходы: {{ $(\u0027Format Monthly Data\u0027).first().json.total_expenses_formatted }}\n💰 Доходы: {{ $(\u0027Format Monthly Data\u0027).first().json.total_income_formatted }}\n📈 Баланс: {{ $(\u0027Format Monthly Data\u0027).first().json.balance_formatted }}\n\n💼 Бюджет: {{ $(\u0027Format Monthly Data\u0027).first().json.budget_amount_formatted }}\n📊 Использовано: {{ $(\u0027Format Monthly Data\u0027).first().json.budget_used_percent }}%\n{{ $(\u0027Format Monthly Data\u0027).first().json.budget_status }}\n\n📝 Транзакций: {{ $(\u0027Format Monthly Data\u0027).first().json.transaction_count }}",
                                                                  "parse_mode":  "Markdown",
                                                                  "append_attribution":  false
                                                              }
                                     },
                      "type":  "n8n-nodes-base.telegram",
                      "typeVersion":  1.2,
                      "position":  [
                                       1024,
                                       1200
                                   ],
                      "id":  "send-monthly-pdf",
                      "name":  "Send Monthly PDF",
                      "webhookId":  "monthly-pdf-send",
                      "credentials":  {
                                          "telegramApi":  {
                                                              "id":  "WabnlnnS7XdATC3n",
                                                              "name":  "Alikbek Financer"
                                                          }
                                      }
                  },
                  {
                      "parameters":  {
                                         "promptType":  "define",
                                         "text":  "={{ $json.text }}",
                                         "options":  {
                                                         "systemMessage":  "=Ты финансовый помощник, который помогает пользователю получать отчеты за указанный период. \n\nКогда пользователь просит отчет за период, ты должен:\n1. Распознать даты начала и конца периода из текста\n2. Использовать инструмент Get_period_report_data для получения данных\n3. Сформировать краткий текстовый ответ с основными цифрами\n4. Сгенерировать PDF через инструмент Generate_period_pdf\n\nПримеры запросов:\n- \u0027отчет за период с 1 октября по 31 октября\u0027\n- \u0027отчет с 15.10.2025 по 20.10.2025\u0027\n- \u0027покажи отчет за последний месяц\u0027\n- \u0027отчет за октябрь\u0027\n\nТекущая дата: {{ new Date().toLocaleDateString(\u0027ru-RU\u0027) }}"
                                                     }
                                     },
                      "type":  "@n8n/n8n-nodes-langchain.agent",
                      "typeVersion":  1.7,
                      "position":  [
                                       704,
                                       464
                                   ],
                      "id":  "period-report-agent",
                      "name":  "Period Report Agent"
                  },
                  {
                      "parameters":  {
                                         "assignments":  {
                                                             "assignments":  [
                                                                                 {
                                                                                     "id":  "period-text-field",
                                                                                     "name":  "text",
                                                                                     "value":  "={{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.text }}",
                                                                                     "type":  "string"
                                                                                 },
                                                                                 {
                                                                                     "id":  "period-user-id",
                                                                                     "name":  "user_id",
                                                                                     "value":  "={{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}",
                                                                                     "type":  "number"
                                                                                 },
                                                                                 {
                                                                                     "id":  "period-chat-id",
                                                                                     "name":  "chat_id",
                                                                                     "value":  "={{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.chat.id }}",
                                                                                     "type":  "number"
                                                                                 }
                                                                             ]
                                                         },
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.set",
                      "typeVersion":  3.4,
                      "position":  [
                                       384,
                                       464
                                   ],
                      "id":  "prepare-period-request",
                      "name":  "Prepare Period Request"
                  },
                  {
                      "parameters":  {
                                         "operation":  "executeQuery",
                                         "query":  "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n),\nperiod_expenses AS (\n  SELECT \n    DATE(date) as expense_date,\n    category,\n    SUM(amount) as daily_total,\n    currency,\n    COUNT(*) as transaction_count,\n    json_agg(\n      json_build_object(\n        \u0027amount\u0027, amount,\n        \u0027description\u0027, description,\n        \u0027date\u0027, TO_CHAR(date, \u0027DD.MM.YYYY\u0027)\n      )\n    ) as transactions\n  FROM expenses\n  WHERE user_id = {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}\n    AND workspace_id = (SELECT workspace_id FROM user_workspace)\n    AND date \u003e= TO_DATE(\u0027{{ $fromAI(\"start_date\", \"Дата начала периода в формате DD.MM.YYYY\", \"string\") }}\u0027, \u0027DD.MM.YYYY\u0027)\n    AND date \u003c= TO_DATE(\u0027{{ $fromAI(\"end_date\", \"Дата окончания периода в формате DD.MM.YYYY\", \"string\") }}\u0027, \u0027DD.MM.YYYY\u0027)\n    AND deleted_at IS NULL\n  GROUP BY DATE(date), category, currency\n  ORDER BY DATE(date) DESC\n),\nperiod_income AS (\n  SELECT \n    DATE(date) as income_date,\n    category,\n    SUM(amount) as daily_total,\n    currency\n  FROM income\n  WHERE user_id = {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}\n    AND workspace_id = (SELECT workspace_id FROM user_workspace)\n    AND date \u003e= TO_DATE(\u0027{{ $fromAI(\"start_date\", \"Дата начала периода в формате DD.MM.YYYY\", \"string\") }}\u0027, \u0027DD.MM.YYYY\u0027)\n    AND date \u003c= TO_DATE(\u0027{{ $fromAI(\"end_date\", \"Дата окончания периода в формате DD.MM.YYYY\", \"string\") }}\u0027, \u0027DD.MM.YYYY\u0027)\n    AND deleted_at IS NULL\n  GROUP BY DATE(date), category, currency\n),\nperiod_summary AS (\n  SELECT \n    COALESCE(SUM(amount), 0) as total_expenses,\n    COUNT(*) as expense_count\n  FROM expenses\n  WHERE user_id = {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}\n    AND workspace_id = (SELECT workspace_id FROM user_workspace)\n    AND date \u003e= TO_DATE(\u0027{{ $fromAI(\"start_date\", \"Дата начала периода в формате DD.MM.YYYY\", \"string\") }}\u0027, \u0027DD.MM.YYYY\u0027)\n    AND date \u003c= TO_DATE(\u0027{{ $fromAI(\"end_date\", \"Дата окончания периода в формате DD.MM.YYYY\", \"string\") }}\u0027, \u0027DD.MM.YYYY\u0027)\n    AND deleted_at IS NULL\n),\nperiod_income_summary AS (\n  SELECT \n    COALESCE(SUM(amount), 0) as total_income,\n    COUNT(*) as income_count\n  FROM income\n  WHERE user_id = {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}\n    AND workspace_id = (SELECT workspace_id FROM user_workspace)\n    AND date \u003e= TO_DATE(\u0027{{ $fromAI(\"start_date\", \"Дата начала периода в формате DD.MM.YYYY\", \"string\") }}\u0027, \u0027DD.MM.YYYY\u0027)\n    AND date \u003c= TO_DATE(\u0027{{ $fromAI(\"end_date\", \"Дата окончания периода в формате DD.MM.YYYY\", \"string\") }}\u0027, \u0027DD.MM.YYYY\u0027)\n    AND deleted_at IS NULL\n),\ncategory_totals AS (\n  SELECT \n    category,\n    SUM(amount) as category_total,\n    ROUND((SUM(amount) / (SELECT total_expenses FROM period_summary)) * 100, 1) as percentage\n  FROM expenses\n  WHERE user_id = {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}\n    AND workspace_id = (SELECT workspace_id FROM user_workspace)\n    AND date \u003e= TO_DATE(\u0027{{ $fromAI(\"start_date\", \"Дата начала периода в формате DD.MM.YYYY\", \"string\") }}\u0027, \u0027DD.MM.YYYY\u0027)\n    AND date \u003c= TO_DATE(\u0027{{ $fromAI(\"end_date\", \"Дата окончания периода в формате DD.MM.YYYY\", \"string\") }}\u0027, \u0027DD.MM.YYYY\u0027)\n    AND deleted_at IS NULL\n  GROUP BY category\n  ORDER BY category_total DESC\n)\nSELECT \n  {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }} as user_id,\n  {{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.chat.id }} as chat_id,\n  (SELECT workspace_id FROM user_workspace) as workspace_id,\n  ps.total_expenses,\n  pis.total_income,\n  ps.expense_count,\n  pis.income_count,\n  (SELECT json_agg(row_to_json(pe.*)) FROM period_expenses pe) as expenses_by_day,\n  (SELECT json_agg(row_to_json(pi.*)) FROM period_income pi) as income_by_day,\n  (SELECT json_agg(row_to_json(ct.*)) FROM category_totals ct) as category_totals,\n  \u0027{{ $fromAI(\"start_date\", \"Дата начала периода в формате DD.MM.YYYY\", \"string\") }}\u0027 as period_start,\n  \u0027{{ $fromAI(\"end_date\", \"Дата окончания периода в формате DD.MM.YYYY\", \"string\") }}\u0027 as period_end\nFROM period_summary ps\nCROSS JOIN period_income_summary pis;",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.postgresTool",
                      "typeVersion":  2.6,
                      "position":  [
                                       960,
                                       624
                                   ],
                      "id":  "get-period-data-tool",
                      "name":  "Get_period_report_data",
                      "credentials":  {
                                          "postgres":  {
                                                           "id":  "3CGZzcUsaAWp8nrl",
                                                           "name":  "Postgres account"
                                                       }
                                      }
                  },
                  {
                      "parameters":  {
                                         "resource":  "pdf",
                                         "pdfTemplateId":  "49c77b23ede0d4e6",
                                         "jsonParameters":  true,
                                         "propertiesJson":  "=// Получаем данные из Get_period_report_data\nconst data = $(\u0027Get_period_report_data\u0027).first().json;\n\n// Функция форматирования валюты\nfunction formatCurrency(amount, symbol = \u0027сом\u0027) {\n  return `${Math.round(amount)} ${symbol}`;\n}\n\n// Рассчитываем период дней\nconst startDate = new Date(data.period_start.split(\u0027.\u0027).reverse().join(\u0027-\u0027));\nconst endDate = new Date(data.period_end.split(\u0027.\u0027).reverse().join(\u0027-\u0027));\nconst periodDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;\n\n// Основные показатели\nconst totalExpenses = Math.round(parseFloat(data.total_expenses || 0));\nconst totalIncome = Math.round(parseFloat(data.total_income || 0));\nconst balance = totalIncome - totalExpenses;\nconst transactionCount = parseInt(data.expense_count || 0) + parseInt(data.income_count || 0);\n\n// Аналитические метрики\nconst avgExpensePerDay = Math.round(totalExpenses / periodDays);\nconst avgIncomePerDay = Math.round(totalIncome / periodDays);\n\n// Находим максимальный расход\nconst expensesByDay = data.expenses_by_day || [];\nlet maxExpense = 0;\nexpensesByDay.forEach(exp =\u003e {\n  const daily = parseFloat(exp.daily_total || 0);\n  if (daily \u003e maxExpense) maxExpense = daily;\n});\nmaxExpense = Math.round(maxExpense);\n\n// Форматируем daily_data для графика\nconst dailyMap = {};\nexpensesByDay.forEach(exp =\u003e {\n  const date = new Date(exp.expense_date).toLocaleDateString(\u0027ru-RU\u0027, {day: \u00272-digit\u0027, month: \u00272-digit\u0027});\n  if (!dailyMap[date]) dailyMap[date] = {date, expenses: 0, income: 0};\n  dailyMap[date].expenses += parseFloat(exp.daily_total || 0);\n});\n\nconst incomeByDay = data.income_by_day || [];\nincomeByDay.forEach(inc =\u003e {\n  const date = new Date(inc.income_date).toLocaleDateString(\u0027ru-RU\u0027, {day: \u00272-digit\u0027, month: \u00272-digit\u0027});\n  if (!dailyMap[date]) dailyMap[date] = {date, expenses: 0, income: 0};\n  dailyMap[date].income += parseFloat(inc.daily_total || 0);\n});\n\nconst dailyData = Object.values(dailyMap).map(d =\u003e ({\n  date: d.date,\n  expenses: Math.round(d.expenses),\n  income: Math.round(d.income)\n}));\n\n// Форматируем категории\nconst categoryTotals = (data.category_totals || []).map(cat =\u003e ({\n  category: cat.category,\n  category_total: Math.round(parseFloat(cat.category_total || 0)),\n  category_total_formatted: formatCurrency(parseFloat(cat.category_total || 0)),\n  percentage: parseFloat(cat.percentage || 0)\n}));\n\n// Собираем все транзакции для таблицы\nconst allTransactions = [];\n\n// Добавляем расходы\nexpensesByDay.forEach(exp =\u003e {\n  const transactions = exp.transactions || [];\n  transactions.forEach(tx =\u003e {\n    allTransactions.push({\n      date: tx.date,\n      category: exp.category,\n      description: tx.description || \u0027Без описания\u0027,\n      type: \u0027expense\u0027,\n      amount: Math.round(parseFloat(tx.amount || 0)),\n      amount_formatted: formatCurrency(parseFloat(tx.amount || 0))\n    });\n  });\n});\n\n// Добавляем доходы\nincomeByDay.forEach(inc =\u003e {\n  const date = new Date(inc.income_date).toLocaleDateString(\u0027ru-RU\u0027, {day: \u00272-digit\u0027, month: \u00272-digit\u0027});\n  allTransactions.push({\n    date: date,\n    category: inc.category,\n    description: inc.category,\n    type: \u0027income\u0027,\n    amount: Math.round(parseFloat(inc.daily_total || 0)),\n    amount_formatted: formatCurrency(parseFloat(inc.daily_total || 0))\n  });\n});\n\n// Сортируем транзакции по дате (новые первые)\nallTransactions.sort((a, b) =\u003e {\n  const dateA = a.date.split(\u0027.\u0027).reverse().join(\u0027\u0027);\n  const dateB = b.date.split(\u0027.\u0027).reverse().join(\u0027\u0027);\n  return dateB.localeCompare(dateA);\n});\n\n// Формируем итоговый объект\nJSON.stringify({\n  user_name: \u0027Пользователь\u0027,\n  period_start: data.period_start,\n  period_end: data.period_end,\n  period_days: periodDays,\n  currency_symbol: \u0027сом\u0027,\n  \n  // Основные метрики\n  total_expenses: totalExpenses,\n  total_expenses_formatted: formatCurrency(totalExpenses),\n  total_income: totalIncome,\n  total_income_formatted: formatCurrency(totalIncome),\n  balance: balance,\n  balance_formatted: formatCurrency(balance),\n  transaction_count: transactionCount,\n  \n  // Аналитика\n  avg_expense_per_day: avgExpensePerDay,\n  avg_expense_per_day_formatted: formatCurrency(avgExpensePerDay),\n  avg_income_per_day: avgIncomePerDay,\n  avg_income_per_day_formatted: formatCurrency(avgIncomePerDay),\n  max_expense: maxExpense,\n  max_expense_formatted: formatCurrency(maxExpense),\n  \n  // Данные для графиков\n  daily_data: dailyData,\n  category_totals: categoryTotals,\n  \n  // Таблица транзакций\n  all_transactions: allTransactions.slice(0, 50) // Ограничиваем 50 транзакциями\n});"
                                     },
                      "type":  "n8n-nodes-base.apiTemplateIoTool",
                      "typeVersion":  1,
                      "position":  [
                                       960,
                                       784
                                   ],
                      "id":  "generate-period-pdf-tool",
                      "name":  "Generate_period_pdf",
                      "credentials":  {
                                          "apiTemplateIoApi":  {
                                                                   "id":  "WCFzWPXSnueTP8ef",
                                                                   "name":  "APITemplate.io Financer"
                                                               }
                                      }
                  },
                  {
                      "parameters":  {
                                         "model":  {
                                                       "__rl":  true,
                                                       "value":  "gpt-4o-mini",
                                                       "mode":  "list",
                                                       "cachedResultName":  "gpt-4o-mini"
                                                   },
                                         "options":  {

                                                     }
                                     },
                      "type":  "@n8n/n8n-nodes-langchain.lmChatOpenAi",
                      "typeVersion":  1.2,
                      "position":  [
                                       832,
                                       624
                                   ],
                      "id":  "period-openai-model",
                      "name":  "OpenAI Period Model",
                      "credentials":  {
                                          "openAiApi":  {
                                                            "id":  "SyI2pOUeSfbt1JRh",
                                                            "name":  "AIAccounter"
                                                        }
                                      }
                  },
                  {
                      "parameters":  {
                                         "chatId":  "={{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.chat.id }}",
                                         "text":  "={{ $json.output }}",
                                         "additionalFields":  {
                                                                  "appendAttribution":  false,
                                                                  "reply_to_message_id":  "={{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.message_id }}"
                                                              }
                                     },
                      "type":  "n8n-nodes-base.telegram",
                      "typeVersion":  1.2,
                      "position":  [
                                       1024,
                                       464
                                   ],
                      "id":  "send-period-response",
                      "name":  "Send Period Response",
                      "webhookId":  "period-response-send",
                      "credentials":  {
                                          "telegramApi":  {
                                                              "id":  "WabnlnnS7XdATC3n",
                                                              "name":  "Alikbek Financer"
                                                          }
                                      }
                  },
                  {
                      "parameters":  {
                                         "rules":  {
                                                       "values":  [
                                                                      {
                                                                          "conditions":  {
                                                                                             "options":  {
                                                                                                             "caseSensitive":  false,
                                                                                                             "leftValue":  "",
                                                                                                             "typeValidation":  "strict",
                                                                                                             "version":  2
                                                                                                         },
                                                                                             "conditions":  [
                                                                                                                {
                                                                                                                    "id":  "voice-weekly",
                                                                                                                    "leftValue":  "={{ $json.text }}",
                                                                                                                    "rightValue":  "(недельный отчет|недельный отчёт|отчет за неделю|отчёт за неделю)",
                                                                                                                    "operator":  {
                                                                                                                                     "type":  "string",
                                                                                                                                     "operation":  "contains"
                                                                                                                                 }
                                                                                                                }
                                                                                                            ],
                                                                                             "combinator":  "and"
                                                                                         },
                                                                          "renameOutput":  true,
                                                                          "outputKey":  "Weekly Report Voice"
                                                                      },
                                                                      {
                                                                          "conditions":  {
                                                                                             "options":  {
                                                                                                             "caseSensitive":  false,
                                                                                                             "leftValue":  "",
                                                                                                             "typeValidation":  "strict",
                                                                                                             "version":  2
                                                                                                         },
                                                                                             "conditions":  [
                                                                                                                {
                                                                                                                    "id":  "voice-monthly",
                                                                                                                    "leftValue":  "={{ $json.text }}",
                                                                                                                    "rightValue":  "(месячный отчет|месячный отчёт|отчет за месяц|отчёт за месяц)",
                                                                                                                    "operator":  {
                                                                                                                                     "type":  "string",
                                                                                                                                     "operation":  "contains"
                                                                                                                                 }
                                                                                                                }
                                                                                                            ],
                                                                                             "combinator":  "and"
                                                                                         },
                                                                          "renameOutput":  true,
                                                                          "outputKey":  "Monthly Report Voice"
                                                                      },
                                                                      {
                                                                          "conditions":  {
                                                                                             "options":  {
                                                                                                             "caseSensitive":  false,
                                                                                                             "leftValue":  "",
                                                                                                             "typeValidation":  "strict",
                                                                                                             "version":  2
                                                                                                         },
                                                                                             "conditions":  [
                                                                                                                {
                                                                                                                    "id":  "voice-period",
                                                                                                                    "leftValue":  "={{ $json.text }}",
                                                                                                                    "rightValue":  "(отчет за период|отчёт за период|отчет с|отчёт с)",
                                                                                                                    "operator":  {
                                                                                                                                     "type":  "string",
                                                                                                                                     "operation":  "contains"
                                                                                                                                 }
                                                                                                                }
                                                                                                            ],
                                                                                             "combinator":  "and"
                                                                                         },
                                                                          "renameOutput":  true,
                                                                          "outputKey":  "Period Report Voice"
                                                                      },
                                                                      {
                                                                          "conditions":  {
                                                                                             "options":  {
                                                                                                             "caseSensitive":  false,
                                                                                                             "leftValue":  "",
                                                                                                             "typeValidation":  "strict",
                                                                                                             "version":  2
                                                                                                         },
                                                                                             "conditions":  [
                                                                                                                {
                                                                                                                    "id":  "voice-other",
                                                                                                                    "leftValue":  "={{ $json.text }}",
                                                                                                                    "rightValue":  "",
                                                                                                                    "operator":  {
                                                                                                                                     "type":  "string",
                                                                                                                                     "operation":  "exists",
                                                                                                                                     "singleValue":  true
                                                                                                                                 }
                                                                                                                }
                                                                                                            ],
                                                                                             "combinator":  "and"
                                                                                         },
                                                                          "renameOutput":  true,
                                                                          "outputKey":  "Regular Voice"
                                                                      }
                                                                  ]
                                                   },
                                         "options":  {

                                                     }
                                     },
                      "id":  "voice-command-router",
                      "name":  "Voice Command Router",
                      "type":  "n8n-nodes-base.switch",
                      "typeVersion":  3.2,
                      "position":  [
                                       752,
                                       -160
                                   ]
                  },
                  {
                      "parameters":  {
                                         "assignments":  {
                                                             "assignments":  [
                                                                                 {
                                                                                     "id":  "voice-text-assign",
                                                                                     "name":  "text",
                                                                                     "value":  "={{ $json.text }}",
                                                                                     "type":  "string"
                                                                                 }
                                                                             ]
                                                         },
                                         "includeOtherFields":  true,
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.set",
                      "typeVersion":  3.4,
                      "position":  [
                                       976,
                                       -160
                                   ],
                      "id":  "prepare-voice-text",
                      "name":  "Prepare Voice as Text"
                  },
                  {
                      "parameters":  {
                                         "assignments":  {
                                                             "assignments":  [
                                                                                 {
                                                                                     "id":  "user-id-assign",
                                                                                     "name":  "user_id",
                                                                                     "value":  "={{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}",
                                                                                     "type":  "number"
                                                                                 },
                                                                                 {
                                                                                     "id":  "chat-id-assign",
                                                                                     "name":  "telegram_chat_id",
                                                                                     "value":  "={{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.chat.id }}",
                                                                                     "type":  "number"
                                                                                 },
                                                                                 {
                                                                                     "id":  "first-name-assign",
                                                                                     "name":  "first_name",
                                                                                     "value":  "={{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.first_name }}",
                                                                                     "type":  "string"
                                                                                 }
                                                                             ]
                                                         },
                                         "includeOtherFields":  false,
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.set",
                      "typeVersion":  3.4,
                      "position":  [
                                       240,
                                       720
                                   ],
                      "id":  "prepare-user-daily",
                      "name":  "Prepare User for Daily"
                  },
                  {
                      "parameters":  {
                                         "assignments":  {
                                                             "assignments":  [
                                                                                 {
                                                                                     "id":  "user-id-assign-weekly",
                                                                                     "name":  "user_id",
                                                                                     "value":  "={{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}",
                                                                                     "type":  "number"
                                                                                 },
                                                                                 {
                                                                                     "id":  "chat-id-assign-weekly",
                                                                                     "name":  "telegram_chat_id",
                                                                                     "value":  "={{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.chat.id }}",
                                                                                     "type":  "number"
                                                                                 },
                                                                                 {
                                                                                     "id":  "first-name-assign-weekly",
                                                                                     "name":  "first_name",
                                                                                     "value":  "={{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.first_name }}",
                                                                                     "type":  "string"
                                                                                 }
                                                                             ]
                                                         },
                                         "includeOtherFields":  false,
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.set",
                      "typeVersion":  3.4,
                      "position":  [
                                       240,
                                       960
                                   ],
                      "id":  "prepare-user-weekly",
                      "name":  "Prepare User for Weekly"
                  },
                  {
                      "parameters":  {
                                         "assignments":  {
                                                             "assignments":  [
                                                                                 {
                                                                                     "id":  "user-id-assign-monthly",
                                                                                     "name":  "user_id",
                                                                                     "value":  "={{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.id }}",
                                                                                     "type":  "number"
                                                                                 },
                                                                                 {
                                                                                     "id":  "chat-id-assign-monthly",
                                                                                     "name":  "telegram_chat_id",
                                                                                     "value":  "={{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.chat.id }}",
                                                                                     "type":  "number"
                                                                                 },
                                                                                 {
                                                                                     "id":  "first-name-assign-monthly",
                                                                                     "name":  "first_name",
                                                                                     "value":  "={{ $(\u0027Telegram Bot Trigger\u0027).first().json.message.from.first_name }}",
                                                                                     "type":  "string"
                                                                                 }
                                                                             ]
                                                         },
                                         "includeOtherFields":  false,
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.set",
                      "typeVersion":  3.4,
                      "position":  [
                                       240,
                                       1200
                                   ],
                      "id":  "prepare-user-monthly",
                      "name":  "Prepare User for Monthly"
                  }
              ],
    "connections":  {
                        "OpenAI Chat Model":  {
                                                  "ai_languageModel":  [
                                                                           [
                                                                               {
                                                                                   "node":  "Financial Assistant",
                                                                                   "type":  "ai_languageModel",
                                                                                   "index":  0
                                                                               }
                                                                           ]
                                                                       ]
                                              },
                        "Telegram Bot Trigger":  {
                                                     "main":  [
                                                                  [
                                                                      {
                                                                          "node":  "Регистрация/обновление пользователя",
                                                                          "type":  "main",
                                                                          "index":  0
                                                                      }
                                                                  ]
                                                              ]
                                                 },
                        "Message Type Switch":  {
                                                    "main":  [
                                                                 [
                                                                     {
                                                                         "node":  "Download Voice File",
                                                                         "type":  "main",
                                                                         "index":  0
                                                                     }
                                                                 ],
                                                                 [
                                                                     {
                                                                         "node":  "Prepare User for Daily",
                                                                         "type":  "main",
                                                                         "index":  0
                                                                     }
                                                                 ],
                                                                 [
                                                                     {
                                                                         "node":  "Prepare User for Weekly",
                                                                         "type":  "main",
                                                                         "index":  0
                                                                     }
                                                                 ],
                                                                 [
                                                                     {
                                                                         "node":  "Prepare User for Monthly",
                                                                         "type":  "main",
                                                                         "index":  0
                                                                     }
                                                                 ],
                                                                 [
                                                                     {
                                                                         "node":  "Prepare Period Request",
                                                                         "type":  "main",
                                                                         "index":  0
                                                                     }
                                                                 ],
                                                                 [
                                                                     {
                                                                         "node":  "Prepare Text Data",
                                                                         "type":  "main",
                                                                         "index":  0
                                                                     }
                                                                 ]
                                                             ]
                                                },
                        "Download Voice File":  {
                                                    "main":  [
                                                                 [
                                                                     {
                                                                         "node":  "Transcribe Audio",
                                                                         "type":  "main",
                                                                         "index":  0
                                                                     }
                                                                 ]
                                                             ]
                                                },
                        "Transcribe Audio":  {
                                                 "main":  [
                                                              [
                                                                  {
                                                                      "node":  "Voice Command Router",
                                                                      "type":  "main",
                                                                      "index":  0
                                                                  }
                                                              ]
                                                          ]
                                             },
                        "Prepare Text Data":  {
                                                  "main":  [
                                                               [
                                                                   {
                                                                       "node":  "Financial Assistant",
                                                                       "type":  "main",
                                                                       "index":  0
                                                                   }
                                                               ]
                                                           ]
                                              },
                        "Conversation Memory":  {
                                                    "ai_memory":  [
                                                                      [
                                                                          {
                                                                              "node":  "Financial Assistant",
                                                                              "type":  "ai_memory",
                                                                              "index":  0
                                                                          }
                                                                      ]
                                                                  ]
                                                },
                        "Financial Assistant":  {
                                                    "main":  [
                                                                 [
                                                                     {
                                                                         "node":  "Send Telegram Response",
                                                                         "type":  "main",
                                                                         "index":  0
                                                                     }
                                                                 ]
                                                             ]
                                                },
                        "Проверка типа":  {
                                              "main":  [
                                                           [
                                                               {
                                                                   "node":  "Анализ расходов",
                                                                   "type":  "main",
                                                                   "index":  0
                                                               }
                                                           ],
                                                           [
                                                               {
                                                                   "node":  "Анализ доходов",
                                                                   "type":  "main",
                                                                   "index":  0
                                                               }
                                                           ]
                                                       ]
                                          },
                        "Регистрация/обновление пользователя":  {
                                                                    "main":  [
                                                                                 [
                                                                                     {
                                                                                         "node":  "Edit Fields",
                                                                                         "type":  "main",
                                                                                         "index":  0
                                                                                     }
                                                                                 ]
                                                                             ]
                                                                },
                        "Edit Fields":  {
                                            "main":  [
                                                         [
                                                             {
                                                                 "node":  "Check Onboarding Status",
                                                                 "type":  "main",
                                                                 "index":  0
                                                             }
                                                         ]
                                                     ]
                                        },
                        "Check Onboarding Status":  {
                                                        "main":  [
                                                                     [
                                                                         {
                                                                             "node":  "Onboarding Router",
                                                                             "type":  "main",
                                                                             "index":  0
                                                                         }
                                                                     ]
                                                                 ]
                                                    },
                        "Onboarding Router":  {
                                                  "main":  [
                                                               [
                                                                   {
                                                                       "node":  "Merge Onboarding Complete",
                                                                       "type":  "main",
                                                                       "index":  0
                                                                   }
                                                               ],
                                                               [
                                                                   {
                                                                       "node":  "Handle Onboarding Step",
                                                                       "type":  "main",
                                                                       "index":  0
                                                                   }
                                                               ]
                                                           ]
                                              },
                        "Get Current Onboarding Question":  {
                                                                "main":  [
                                                                             [
                                                                                 {
                                                                                     "node":  "Prepare Question",
                                                                                     "type":  "main",
                                                                                     "index":  0
                                                                                 }
                                                                             ]
                                                                         ]
                                                            },
                        "Prepare Question":  {
                                                 "main":  [
                                                              [
                                                                  {
                                                                      "node":  "Send Next Question",
                                                                      "type":  "main",
                                                                      "index":  0
                                                                  }
                                                              ]
                                                          ]
                                             },
                        "Handle Onboarding Step":  {
                                                       "main":  [
                                                                    [
                                                                        {
                                                                            "node":  "Parse Onboarding Answer",
                                                                            "type":  "main",
                                                                            "index":  0
                                                                        }
                                                                    ],
                                                                    [
                                                                        {
                                                                            "node":  "Parse Onboarding Answer",
                                                                            "type":  "main",
                                                                            "index":  0
                                                                        }
                                                                    ],
                                                                    [
                                                                        {
                                                                            "node":  "Parse Onboarding Answer",
                                                                            "type":  "main",
                                                                            "index":  0
                                                                        }
                                                                    ],
                                                                    [
                                                                        {
                                                                            "node":  "Parse Onboarding Answer",
                                                                            "type":  "main",
                                                                            "index":  0
                                                                        }
                                                                    ],
                                                                    [
                                                                        {
                                                                            "node":  "Parse Onboarding Answer",
                                                                            "type":  "main",
                                                                            "index":  0
                                                                        }
                                                                    ]
                                                                ]
                                                   },
                        "Parse Onboarding Answer":  {
                                                        "main":  [
                                                                     [
                                                                         {
                                                                             "node":  "Save Onboarding Answer",
                                                                             "type":  "main",
                                                                             "index":  0
                                                                         }
                                                                     ]
                                                                 ]
                                                    },
                        "Save Onboarding Answer":  {
                                                       "main":  [
                                                                    [
                                                                        {
                                                                            "node":  "Check If Onboarding Completed",
                                                                            "type":  "main",
                                                                            "index":  0
                                                                        }
                                                                    ]
                                                                ]
                                                   },
                        "Check If Onboarding Completed":  {
                                                              "main":  [
                                                                           [
                                                                               {
                                                                                   "node":  "Send Completion Message",
                                                                                   "type":  "main",
                                                                                   "index":  0
                                                                               }
                                                                           ],
                                                                           [
                                                                               {
                                                                                   "node":  "Prepare Question",
                                                                                   "type":  "main",
                                                                                   "index":  0
                                                                               }
                                                                           ]
                                                                       ]
                                                          },
                        "Merge Onboarding Complete":  {
                                                          "main":  [
                                                                       [
                                                                           {
                                                                               "node":  "Message Type Switch",
                                                                               "type":  "main",
                                                                               "index":  0
                                                                           }
                                                                       ]
                                                                   ]
                                                      },
                        "Add_income":  {
                                           "ai_tool":  [
                                                           [
                                                               {
                                                                   "node":  "Financial Assistant",
                                                                   "type":  "ai_tool",
                                                                   "index":  0
                                                               }
                                                           ]
                                                       ]
                                       },
                        "Parsing_of_the_month":  {
                                                     "ai_tool":  [
                                                                     [
                                                                         {
                                                                             "node":  "Financial Assistant",
                                                                             "type":  "ai_tool",
                                                                             "index":  0
                                                                         }
                                                                     ]
                                                                 ]
                                                 },
                        "Add_expense":  {
                                            "ai_tool":  [
                                                            [
                                                                {
                                                                    "node":  "Financial Assistant",
                                                                    "type":  "ai_tool",
                                                                    "index":  0
                                                                }
                                                            ]
                                                        ]
                                        },
                        "Checking_limits":  {
                                                "ai_tool":  [
                                                                [
                                                                    {
                                                                        "node":  "Financial Assistant",
                                                                        "type":  "ai_tool",
                                                                        "index":  0
                                                                    }
                                                                ]
                                                            ]
                                            },
                        "Calc":  {
                                     "ai_tool":  [
                                                     [
                                                         {
                                                             "node":  "Financial Assistant",
                                                             "type":  "ai_tool",
                                                             "index":  0
                                                         }
                                                     ]
                                                 ]
                                 },
                        "Convert_currency":  {
                                                 "ai_tool":  [
                                                                 [
                                                                     {
                                                                         "node":  "Financial Assistant",
                                                                         "type":  "ai_tool",
                                                                         "index":  0
                                                                     }
                                                                 ]
                                                             ]
                                             },
                        "Get_exchange_rates":  {
                                                   "ai_tool":  [
                                                                   [
                                                                       {
                                                                           "node":  "Financial Assistant",
                                                                           "type":  "ai_tool",
                                                                           "index":  0
                                                                       }
                                                                   ]
                                                               ]
                                               },
                        "Edit_transaction":  {
                                                 "ai_tool":  [
                                                                 [
                                                                     {
                                                                         "node":  "Financial Assistant",
                                                                         "type":  "ai_tool",
                                                                         "index":  0
                                                                     }
                                                                 ]
                                                             ]
                                             },
                        "Delete_transaction":  {
                                                   "ai_tool":  [
                                                                   [
                                                                       {
                                                                           "node":  "Financial Assistant",
                                                                           "type":  "ai_tool",
                                                                           "index":  0
                                                                       }
                                                                   ]
                                                               ]
                                               },
                        "Restore_transaction":  {
                                                    "ai_tool":  [
                                                                    [
                                                                        {
                                                                            "node":  "Financial Assistant",
                                                                            "type":  "ai_tool",
                                                                            "index":  0
                                                                        }
                                                                    ]
                                                                ]
                                                },
                        "Get_transaction_history":  {
                                                        "ai_tool":  [
                                                                        [
                                                                            {
                                                                                "node":  "Financial Assistant",
                                                                                "type":  "ai_tool",
                                                                                "index":  0
                                                                            }
                                                                        ]
                                                                    ]
                                                    },
                        "Create_recurring_payment":  {
                                                         "ai_tool":  [
                                                                         [
                                                                             {
                                                                                 "node":  "Financial Assistant",
                                                                                 "type":  "ai_tool",
                                                                                 "index":  0
                                                                             }
                                                                         ]
                                                                     ]
                                                     },
                        "List_recurring_payments":  {
                                                        "ai_tool":  [
                                                                        [
                                                                            {
                                                                                "node":  "Financial Assistant",
                                                                                "type":  "ai_tool",
                                                                                "index":  0
                                                                            }
                                                                        ]
                                                                    ]
                                                    },
                        "Cancel_recurring_payment":  {
                                                         "ai_tool":  [
                                                                         [
                                                                             {
                                                                                 "node":  "Financial Assistant",
                                                                                 "type":  "ai_tool",
                                                                                 "index":  0
                                                                             }
                                                                         ]
                                                                     ]
                                                     },
                        "Get_budget_forecast":  {
                                                    "ai_tool":  [
                                                                    [
                                                                        {
                                                                            "node":  "Financial Assistant",
                                                                            "type":  "ai_tool",
                                                                            "index":  0
                                                                        }
                                                                    ]
                                                                ]
                                                },
                        "Get_notifications":  {
                                                  "ai_tool":  [
                                                                  [
                                                                      {
                                                                          "node":  "Financial Assistant",
                                                                          "type":  "ai_tool",
                                                                          "index":  0
                                                                      }
                                                                  ]
                                                              ]
                                              },
                        "Configure_alerts":  {
                                                 "ai_tool":  [
                                                                 [
                                                                     {
                                                                         "node":  "Financial Assistant",
                                                                         "type":  "ai_tool",
                                                                         "index":  0
                                                                     }
                                                                 ]
                                                             ]
                                             },
                        "Get_income_expense_stats":  {
                                                         "ai_tool":  [
                                                                         [
                                                                             {
                                                                                 "node":  "Financial Assistant",
                                                                                 "type":  "ai_tool",
                                                                                 "index":  0
                                                                             }
                                                                         ]
                                                                     ]
                                                     },
                        "Get_top_categories":  {
                                                   "ai_tool":  [
                                                                   [
                                                                       {
                                                                           "node":  "Financial Assistant",
                                                                           "type":  "ai_tool",
                                                                           "index":  0
                                                                       }
                                                                   ]
                                                               ]
                                               },
                        "Get_workspaces":  {
                                               "ai_tool":  [
                                                               [
                                                                   {
                                                                       "node":  "Financial Assistant",
                                                                       "type":  "ai_tool",
                                                                       "index":  0
                                                                   }
                                                               ]
                                                           ]
                                           },
                        "Update_spending_patterns":  {
                                                         "ai_tool":  [
                                                                         [
                                                                             {
                                                                                 "node":  "Financial Assistant",
                                                                                 "type":  "ai_tool",
                                                                                 "index":  0
                                                                             }
                                                                         ]
                                                                     ]
                                                     },
                        "Set_budget":  {
                                           "ai_tool":  [
                                                           [
                                                               {
                                                                   "node":  "Financial Assistant",
                                                                   "type":  "ai_tool",
                                                                   "index":  0
                                                               }
                                                           ]
                                                       ]
                                       },
                        "Set_category_limit":  {
                                                   "ai_tool":  [
                                                                   [
                                                                       {
                                                                           "node":  "Financial Assistant",
                                                                           "type":  "ai_tool",
                                                                           "index":  0
                                                                       }
                                                                   ]
                                                               ]
                                               },
                        "AI Agent":  {
                                         "main":  [
                                                      [
                                                          {
                                                              "node":  "Code in JavaScript",
                                                              "type":  "main",
                                                              "index":  0
                                                          }
                                                      ]
                                                  ]
                                     },
                        "OpenAI Chat Model1":  {
                                                   "ai_languageModel":  [
                                                                            [
                                                                                {
                                                                                    "node":  "AI Agent",
                                                                                    "type":  "ai_languageModel",
                                                                                    "index":  0
                                                                                }
                                                                            ]
                                                                        ]
                                               },
                        "Simple Memory":  {
                                              "ai_memory":  [
                                                                [
                                                                    {
                                                                        "node":  "AI Agent",
                                                                        "type":  "ai_memory",
                                                                        "index":  0
                                                                    }
                                                                ]
                                                            ]
                                          },
                        "Calculator":  {
                                           "ai_tool":  [
                                                           [
                                                               {
                                                                   "node":  "AI Agent",
                                                                   "type":  "ai_tool",
                                                                   "index":  0
                                                               }
                                                           ]
                                                       ]
                                       },
                        "Create a pdf":  {
                                             "main":  [
                                                          [
                                                              {
                                                                  "node":  "HTTP Request",
                                                                  "type":  "main",
                                                                  "index":  0
                                                              }
                                                          ]
                                                      ]
                                         },
                        "get_last_week_report":  {
                                                     "ai_tool":  [
                                                                     [
                                                                         {
                                                                             "node":  "AI Agent",
                                                                             "type":  "ai_tool",
                                                                             "index":  0
                                                                         }
                                                                     ]
                                                                 ]
                                                 },
                        "Code in JavaScript":  {
                                                   "main":  [
                                                                [
                                                                    {
                                                                        "node":  "Create a pdf",
                                                                        "type":  "main",
                                                                        "index":  0
                                                                    }
                                                                ]
                                                            ]
                                               },
                        "Schedule Trigger":  {
                                                 "main":  [
                                                              [
                                                                  {
                                                                      "node":  "AI Agent",
                                                                      "type":  "main",
                                                                      "index":  0
                                                                  }
                                                              ]
                                                          ]
                                             },
                        "HTTP Request":  {
                                             "main":  [
                                                          [
                                                              {
                                                                  "node":  "Send a document",
                                                                  "type":  "main",
                                                                  "index":  0
                                                              }
                                                          ]
                                                      ]
                                         },
                        "Daily Report Trigger":  {
                                                     "main":  [
                                                                  [
                                                                      {
                                                                          "node":  "Get Active Users",
                                                                          "type":  "main",
                                                                          "index":  0
                                                                      }
                                                                  ]
                                                              ]
                                                 },
                        "Weekly Report Trigger":  {
                                                      "main":  [
                                                                   [
                                                                       {
                                                                           "node":  "Get Active Users",
                                                                           "type":  "main",
                                                                           "index":  0
                                                                       }
                                                                   ]
                                                               ]
                                                  },
                        "Monthly Report Trigger":  {
                                                       "main":  [
                                                                    [
                                                                        {
                                                                            "node":  "Get Active Users",
                                                                            "type":  "main",
                                                                            "index":  0
                                                                        }
                                                                    ]
                                                                ]
                                                   },
                        "Get Active Users":  {
                                                 "main":  [
                                                              [
                                                                  {
                                                                      "node":  "Get Daily Stats",
                                                                      "type":  "main",
                                                                      "index":  0
                                                                  },
                                                                  {
                                                                      "node":  "Get Weekly Data",
                                                                      "type":  "main",
                                                                      "index":  0
                                                                  },
                                                                  {
                                                                      "node":  "Get Monthly Data",
                                                                      "type":  "main",
                                                                      "index":  0
                                                                  }
                                                              ]
                                                          ]
                                             },
                        "Get Daily Stats":  {
                                                "main":  [
                                                             [
                                                                 {
                                                                     "node":  "Daily Report AI",
                                                                     "type":  "main",
                                                                     "index":  0
                                                                 }
                                                             ]
                                                         ]
                                            },
                        "Daily Report AI":  {
                                                "main":  [
                                                             [
                                                                 {
                                                                     "node":  "Send Daily Report",
                                                                     "type":  "main",
                                                                     "index":  0
                                                                 }
                                                             ]
                                                         ]
                                            },
                        "OpenAI Daily Model":  {
                                                   "ai_languageModel":  [
                                                                            [
                                                                                {
                                                                                    "node":  "Daily Report AI",
                                                                                    "type":  "ai_languageModel",
                                                                                    "index":  0
                                                                                }
                                                                            ]
                                                                        ]
                                               },
                        "Get Weekly Data":  {
                                                "main":  [
                                                             [
                                                                 {
                                                                     "node":  "Format Weekly Data",
                                                                     "type":  "main",
                                                                     "index":  0
                                                                 }
                                                             ]
                                                         ]
                                            },
                        "Format Weekly Data":  {
                                                   "main":  [
                                                                [
                                                                    {
                                                                        "node":  "Generate Weekly PDF",
                                                                        "type":  "main",
                                                                        "index":  0
                                                                    }
                                                                ]
                                                            ]
                                               },
                        "Generate Weekly PDF":  {
                                                    "main":  [
                                                                 [
                                                                     {
                                                                         "node":  "Send Weekly PDF",
                                                                         "type":  "main",
                                                                         "index":  0
                                                                     }
                                                                 ]
                                                             ]
                                                },
                        "Get Monthly Data":  {
                                                 "main":  [
                                                              [
                                                                  {
                                                                      "node":  "Format Monthly Data",
                                                                      "type":  "main",
                                                                      "index":  0
                                                                  }
                                                              ]
                                                          ]
                                             },
                        "Format Monthly Data":  {
                                                    "main":  [
                                                                 [
                                                                     {
                                                                         "node":  "Generate Monthly PDF",
                                                                         "type":  "main",
                                                                         "index":  0
                                                                     }
                                                                 ]
                                                             ]
                                                },
                        "Generate Monthly PDF":  {
                                                     "main":  [
                                                                  [
                                                                      {
                                                                          "node":  "Send Monthly PDF",
                                                                          "type":  "main",
                                                                          "index":  0
                                                                      }
                                                                  ]
                                                              ]
                                                 },
                        "Prepare Period Request":  {
                                                       "main":  [
                                                                    [
                                                                        {
                                                                            "node":  "Period Report Agent",
                                                                            "type":  "main",
                                                                            "index":  0
                                                                        }
                                                                    ]
                                                                ]
                                                   },
                        "Period Report Agent":  {
                                                    "main":  [
                                                                 [
                                                                     {
                                                                         "node":  "Send Period Response",
                                                                         "type":  "main",
                                                                         "index":  0
                                                                     }
                                                                 ]
                                                             ]
                                                },
                        "OpenAI Period Model":  {
                                                    "ai_languageModel":  [
                                                                             [
                                                                                 {
                                                                                     "node":  "Period Report Agent",
                                                                                     "type":  "ai_languageModel",
                                                                                     "index":  0
                                                                                 }
                                                                             ]
                                                                         ]
                                                },
                        "Get_period_report_data":  {
                                                       "ai_tool":  [
                                                                       [
                                                                           {
                                                                               "node":  "Period Report Agent",
                                                                               "type":  "ai_tool",
                                                                               "index":  0
                                                                           }
                                                                       ]
                                                                   ]
                                                   },
                        "Generate_period_pdf":  {
                                                    "ai_tool":  [
                                                                    [
                                                                        {
                                                                            "node":  "Period Report Agent",
                                                                            "type":  "ai_tool",
                                                                            "index":  0
                                                                        }
                                                                    ]
                                                                ]
                                                },
                        "Voice Command Router":  {
                                                     "main":  [
                                                                  [
                                                                      {
                                                                          "node":  "Get Active Users",
                                                                          "type":  "main",
                                                                          "index":  0
                                                                      }
                                                                  ],
                                                                  [
                                                                      {
                                                                          "node":  "Get Active Users",
                                                                          "type":  "main",
                                                                          "index":  0
                                                                      }
                                                                  ],
                                                                  [
                                                                      {
                                                                          "node":  "Prepare Voice as Text",
                                                                          "type":  "main",
                                                                          "index":  0
                                                                      }
                                                                  ],
                                                                  [
                                                                      {
                                                                          "node":  "Prepare Voice as Text",
                                                                          "type":  "main",
                                                                          "index":  0
                                                                      }
                                                                  ]
                                                              ]
                                                 },
                        "Prepare Voice as Text":  {
                                                      "main":  [
                                                                   [
                                                                       {
                                                                           "node":  "Period Report Agent",
                                                                           "type":  "main",
                                                                           "index":  0
                                                                       },
                                                                       {
                                                                           "node":  "Financial Assistant",
                                                                           "type":  "main",
                                                                           "index":  0
                                                                       }
                                                                   ]
                                                               ]
                                                  },
                        "Prepare User for Daily":  {
                                                       "main":  [
                                                                    [
                                                                        {
                                                                            "node":  "Get Daily Stats",
                                                                            "type":  "main",
                                                                            "index":  0
                                                                        }
                                                                    ]
                                                                ]
                                                   },
                        "Prepare User for Weekly":  {
                                                        "main":  [
                                                                     [
                                                                         {
                                                                             "node":  "Get Weekly Data",
                                                                             "type":  "main",
                                                                             "index":  0
                                                                         }
                                                                     ]
                                                                 ]
                                                    },
                        "Prepare User for Monthly":  {
                                                         "main":  [
                                                                      [
                                                                          {
                                                                              "node":  "Get Monthly Data",
                                                                              "type":  "main",
                                                                              "index":  0
                                                                          }
                                                                      ]
                                                                  ]
                                                     }
                    },
    "pinData":  {

                },
    "meta":  {
                 "templateCredsSetupCompleted":  true,
                 "instanceId":  "bcdca7003a882ee2cf9d975eab94cc02ba456a1ed2ac37511421cb2edeb80c62"
             }
}
