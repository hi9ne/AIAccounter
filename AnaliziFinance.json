{
  "name": "AnaliziFinance",
  "nodes": [
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "maxRetries": 3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        1856,
        -608
      ],
      "id": "ae075a9e-aea5-4870-b241-9641858ac4aa",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "SyI2pOUeSfbt1JRh",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "id": "a9b3a9f7-e9a8-42c7-b046-82aef9f10554",
      "name": "Telegram Bot Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.1,
      "position": [
        16,
        -736
      ],
      "webhookId": "b8605f3e-0f52-4ffc-a4c9-1728eb0e09e2",
      "credentials": {
        "telegramApi": {
          "id": "WabnlnnS7XdATC3n",
          "name": "Alikbek Financer"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message.voice.file_id }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    },
                    "id": "d697a3d5-018a-4cf0-867e-a877c10d6267"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Voice"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "57c00950-88c8-4c71-bfe1-5e243b0b71dc",
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "/get_week_report",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8c844924-b2ed-48b0-935c-c66a8fd0c778",
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Text"
            }
          ]
        },
        "options": {}
      },
      "id": "af0d7d9c-eb12-4384-8c24-6cd58f91475a",
      "name": "Message Type Switch",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        688,
        -752
      ]
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $json.message.voice.file_id }}",
        "additionalFields": {}
      },
      "id": "b73ad234-bade-498b-85d7-364c6946727f",
      "name": "Download Voice File",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1168,
        -928
      ],
      "webhookId": "8fa0a59a-be53-4897-83bb-5b18ed71b529",
      "credentials": {
        "telegramApi": {
          "id": "WabnlnnS7XdATC3n",
          "name": "Alikbek Financer"
        }
      }
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "id": "e21002cb-1a02-46a2-a5ac-f79847ec73f9",
      "name": "Transcribe Audio",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.6,
      "position": [
        1632,
        -928
      ],
      "credentials": {
        "openAiApi": {
          "id": "SyI2pOUeSfbt1JRh",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d6af7fa1-c31a-4514-ae63-397699bf8b21",
              "name": "text",
              "value": "={{ $('Telegram Bot Trigger').first().json.message.text }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1632,
        -736
      ],
      "id": "a91c6bc9-f952-49bb-b706-435e4d64f283",
      "name": "Prepare Text Data"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.text }}\n\n",
        "options": {
          "systemMessage": "=Вы — финансовый ассистент и наставник. Ваша задача — помогать пользователю эффективно управлять расходами, обеспечивая точность и структурированность записей. Ваша манера общения должна быть профессиональной, но при этом дружелюбной, с небольшим использованием эмодзи для улучшения восприятия.\n\nВходящее сообщение от пользователя: {{ $json.text }}\nТекущая дата: {{ $now }}\n\n\n\nИнструменты управления финансами\n\nВы имеете доступ к следующим инструментам:\n\n1. `get_transactions`\n\nНазначение: Используйте этот инструмент, когда пользователь запрашивает информацию о своих недавних расходах или жее доходах.\nИнструкции:\nОпределите дату из запроса пользователя. Если конкретная дата не названа, используйте текущую дату {{ $now }}.\nЗапросите из базы данных все расходы пользователя за указанную дату.\nТы должен использовать `calculator` суммировать все суммы которые были за расходы или доходы, исходя от того про что запросил пользователь, и выдать ответ с общей суммой расходов или же доходов.\nСформируйте ответ, строго следуя указанному ниже формату, без использования символов Markdown (например, решеток `###`). Суммы указываются в сомах:\n\n<!-- end list -->\n\n\nЗаписанные транзакции:\n\n- Категория (К примеру еда):\n- Имя расхода 1 - сумма расхода\n- Имя расхода 2 - сумма расхода\nВсего потрачено в категории: [сумма расходов в категории] в сомах.\n\n- Категория 2 (К примеру одежда):\n- Имя расхода 1 - сумма расхода\n- Имя расхода 2 - сумма расхода\nВсего потрачено в категории: [сумма расходов в категории] в сомах.\n\n\n2. `add_transaction`\n\n\n\nНазначение: Используйте этот инструмент, когда пользователь сообщает о новой покупке или расходе. Вы всегда должны использовать эту функцию при добавлении.\n\nИнструкции:\n\nПеред вызовом убедитесь, что пользователь назвал предмет покупки/оплаченную услугу и точную сумму.\n\nДо вызова инструмента add_transaction, обязательно определите, к какой категории относится данная покупка, используя только список ниже.\n\nОбязательно определите, какой из двух доступных кошельков (`МБанк` или `Наличка`) был использован для транзакции, если не удалось определить то запишите что было по Мбанк на время, потом после уточнения запиши правильный вид транзакции, запомни это.\n\n-----\n\nДоступные статьи доходов и расходов\n\nИспользуйте только эти категории для классификации трат. Не создавайте новые категории. Каждая категория снабжена описанием для более точного понимания.\n\nКатегории доходов:\n\nВыручка с ИИ агентов: Доход, полученный от продаж или внедрения ИИ-агентов.\nВыручка с Fusion: Доход, полученный от проектов, связанных с Fusion.\nПрочие поступления: Любые доходы, которые не подходят под другие категории.\nДолг поступление: Возврат долга, который вам вернули.\nЗарплата: Основной доход от работы.\nПоступление от проектов: Доход от выполнения сторонних проектов или фриланса.\nПроценты с депозита: Доход от процентов по банковским вкладам.\nПеремещение средств (поступление): Поступление денег при переводе между своими кошельками (не является доходом).\n\nКатегории расходов:\n\nОплата услуг: Оплата различных услуг (например, химчистка, парикмахер, и т.д.).\nАренда помещения: Ежемесячные платежи за аренду жилья или офиса.\nОплата за сервисы: Подписки на онлайн-сервисы, облачные хранилища, и т.д.\nТранспорт: Затраты на бензин, такси, общественный транспорт.\nПитание: Расходы на продукты, походы в кафе и рестораны.\nЛичные расходы: Небольшие, ежедневные траты, которые не подходят под другие категории.\nШоппинг: Покупки одежды, обуви и других непродовольственных товаров.\nРазвлечения/отдых: Затраты на кино, концерты, хобби, путешествия.\nДолг расходы: Выплата долга или кредита.\nРасходы на связь: Оплата мобильной связи и интернета.\nПеремещение средств (списание): Перевод денег между своими кошельками (не является расходом).\nПрочие расходы: Любые расходы, которые не подходят под другие категории.\nДивиденды: Выплаты акционерам от прибыли компании.\nПополнение Депозита: Перевод средств на накопительный счет (не является расходом).\n\n-----\n\nДоступные кошельки\n\nВы можете использовать только два кошелька для транзакций:\n\nМБанк\nНаличка\n\n-----\n\nВ колонку Тип Доход/Расход нужно вписать только одно значение: доход или расход, вы должны определить это через контекст сообщения пользователя.\nСтиль общения\n\nВаше финальное сообщение должно быть от лица финансового наставника. Используйте короткие и четкие предложения. Подтверждайте или одобряйте транзакции. В случае необдуманных расходов, вы можете тактично высказать свое профессиональное мнение, напоминая о важности финансовой дисциплины. Допускается использование 1-2 уместных эмодзи, чтобы сделать сообщение более наглядным."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        2368,
        -832
      ],
      "id": "fdf36915-cfb3-4002-8ed7-5ecd83553fa7",
      "name": "Financial Assistant",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Bot Trigger').first().json.message.chat.id }}",
        "text": "={{ $json.output }}",
        "additionalFields": {
          "appendAttribution": false,
          "reply_to_message_id": "={{ $('Telegram Bot Trigger').first().json.message.message_id }}"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        3216,
        -832
      ],
      "id": "8a5279fc-1345-481c-ab35-5b8b03f45885",
      "name": "Send Telegram Response",
      "webhookId": "a2f9609c-4b7a-4d51-aaa6-c889f56aefc9",
      "credentials": {
        "telegramApi": {
          "id": "WabnlnnS7XdATC3n",
          "name": "Alikbek Financer"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO users (user_id, username, first_name, last_name, telegram_chat_id)\nVALUES (\n  {{ $json.message.from.id }},\n  '{{ $json.message.from.username || \"\" }}',\n  '{{ $json.message.from.first_name || \"\" }}',\n  '{{ $json.message.from.last_name || \"\" }}',\n  {{ $json.message.chat.id }}\n)\nON CONFLICT (user_id) \nDO UPDATE SET \n  username = EXCLUDED.username,\n  last_activity = NOW()\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        240,
        -736
      ],
      "id": "9b8dcb08-d558-49b2-a860-840665c97aac",
      "name": "Регистрация/обновление пользователя",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6cb77ab8-f045-4576-b673-6ead0a3a5da6",
              "name": "message",
              "value": "={{ $node[\"Telegram Bot Trigger\"].json[\"message\"] || {} }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        464,
        -736
      ],
      "id": "c5b3bfe7-a187-4942-89d1-4720145bbe59",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO income (user_id, date, category, amount, currency, description, operation_type, source)\nVALUES (\n  1109421300,\n  COALESCE(\n    TO_DATE('{{ $fromAI(\"date\", \"Дата операции в формате DD.MM.YYYY, если не указана то пустая строка\", \"string\", \"\") }}', 'DD.MM.YYYY'),\n    CURRENT_DATE\n  ),\n  '{{ $fromAI(\"category\", \"Категория дохода: зарплата, продажи, инвестиции, подработка, кэшбек, прочее\", \"string\") }}',\n  {{ $fromAI(\"amount\", \"Сумма дохода, только число\", \"number\") }},\n  UPPER('{{ $fromAI(\"currency\", \"Валюта: сом/KGS, доллар/USD, евро/EUR, рубль/RUB. Если не указана - KGS\", \"string\", \"KGS\") }}'),\n  '{{ $fromAI(\"description\", \"Описание дохода, если есть\", \"string\", \"\") }}',\n  'доход',\n  'telegram'\n)\nRETURNING id, TO_CHAR(date, 'DD.MM.YYYY') as date, category, amount, currency, description;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        2112,
        -608
      ],
      "id": "47d02cab-f4e5-40bf-8b5b-a79f11ff696f",
      "name": "Add_income",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH month_mapping AS (\n  SELECT * FROM (VALUES\n    ('январь', 1), ('февраль', 2), ('март', 3), ('апрель', 4),\n    ('май', 5), ('июнь', 6), ('июль', 7), ('август', 8),\n    ('сентябрь', 9), ('октябрь', 10), ('ноябрь', 11), ('декабрь', 12)\n  ) AS m(month_name, month_num)\n),\nfiltered_data AS (\n  SELECT\n    TO_CHAR(t.date, 'DD.MM.YYYY') as date,\n    t.category,\n    t.amount,\n    COALESCE(t.description, '') as description\n  FROM {{ $fromAI(\"type\", \"Тип операции: 'расход' или 'доход'\", \"string\") === 'расход' ? 'expenses' : 'income' }} t\n  INNER JOIN month_mapping mm ON EXTRACT(MONTH FROM t.date) = mm.month_num\n  WHERE t.user_id = 1109421300\n    AND EXTRACT(YEAR FROM t.date) = EXTRACT(YEAR FROM CURRENT_DATE)\n    AND LOWER(mm.month_name) = LOWER('{{ $fromAI(\"month\", \"Название месяца на русском языке (например: октябрь, ноябрь)\", \"string\") }}')\n    AND (NULLIF('{{ $fromAI(\"filter_category\", \"Категория для фильтрации опционально\", \"string\", \"\") }}', '') IS NULL OR t.category = '{{ $fromAI(\"filter_category\", \"Категория для фильтрации опционально\", \"string\", \"\") }}')\n)\nSELECT \n  *,\n  (SELECT COUNT(*) FROM filtered_data) as total_rows,\n  (SELECT SUM(amount) FROM filtered_data) as total_amount\nFROM filtered_data\nORDER BY date DESC;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        2240,
        -608
      ],
      "id": "a4ae5d96-afad-43b0-b187-432a36feaf5d",
      "name": "Parsing_of_the_month",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO expenses (user_id, date, category, amount, currency, description, operation_type, source)\nVALUES (\n  1109421300,\n  COALESCE(\n    TO_DATE('{{ $fromAI(\"date\", \"Дата операции в формате DD.MM.YYYY, если не указана то пустая строка\", \"string\", \"\") }}', 'DD.MM.YYYY'),\n    CURRENT_DATE\n  ),\n  '{{ $fromAI(\"category\", \"Категория расхода: продукты, транспорт, кафе/рестораны, аренда офиса, зарплата, налоги, маркетинг, канцтовары, интернет/связь, коммунальные услуги, обучение, подписки, прочее\", \"string\") }}',\n  {{ $fromAI(\"amount\", \"Сумма расхода, только число\", \"number\") }},\n  UPPER('{{ $fromAI(\"currency\", \"Валюта: сом/KGS, доллар/USD, евро/EUR, рубль/RUB. Если не указана - KGS\", \"string\", \"KGS\") }}'),\n  '{{ $fromAI(\"description\", \"Описание расхода, если есть\", \"string\", \"\") }}',\n  'расход',\n  'telegram'\n)\nRETURNING id, TO_CHAR(date, 'DD.MM.YYYY') as date, category, amount, currency, description;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        2368,
        -608
      ],
      "id": "7ebeb8ef-2e0c-42ed-9983-98317f09230a",
      "name": "Add_expense",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        2496,
        -608
      ],
      "id": "117aa963-256c-40f2-91ce-1832439f3fbf",
      "name": "Calc"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH conversion AS (\n  SELECT \n    {{ $fromAI(\"amount\", \"Сумма для конвертации, только число\", \"number\") }} as original_amount,\n    UPPER('{{ $fromAI(\"from_currency\", \"Из какой валюты конвертировать: сом/KGS, доллар/USD, евро/EUR, рубль/RUB\", \"string\") }}') as from_currency,\n    UPPER('{{ $fromAI(\"to_currency\", \"В какую валюту конвертировать: сом/KGS, доллар/USD, евро/EUR, рубль/RUB\", \"string\") }}') as to_currency,\n    get_exchange_rate(\n      UPPER('{{ $fromAI(\"from_currency\", \"Из какой валюты конвертировать: сом/KGS, доллар/USD, евро/EUR, рубль/RUB\", \"string\") }}'),\n      UPPER('{{ $fromAI(\"to_currency\", \"В какую валюту конвертировать: сом/KGS, доллар/USD, евро/EUR, рубль/RUB\", \"string\") }}'),\n      CURRENT_DATE\n    ) as rate\n)\nSELECT \n  original_amount,\n  from_currency,\n  to_currency,\n  rate,\n  ROUND(original_amount * rate, 2) as converted_amount,\n  CURRENT_DATE as conversion_date\nFROM conversion;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        2624,
        -608
      ],
      "id": "7df81fcf-49f2-44d0-bb6a-9f55161cc36f",
      "name": "Convert_currency",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT \n  from_currency,\n  to_currency,\n  rate,\n  TO_CHAR(date, 'DD.MM.YYYY') as rate_date,\n  source\nFROM v_latest_rates\nWHERE from_currency IN ('KGS', 'USD', 'EUR', 'RUB')\n  AND to_currency IN ('KGS', 'USD', 'EUR', 'RUB')\n  AND from_currency != to_currency\nORDER BY from_currency, to_currency;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        2752,
        -608
      ],
      "id": "afc2ba5f-e51e-4c74-9cbb-9683f845c252",
      "name": "Get_exchange_rates",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM safe_update_transaction(\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }},\n  '{{ $fromAI(\"transaction_type\", \"Тип: expense или income\", \"string\") }}',\n  '{{ $fromAI(\"transaction_id\", \"ID транзакции или 'last' для последней\", \"string\") }}',\n  '{{ $fromAI(\"field\", \"Поле для изменения: amount, category, description, date, currency\", \"string\") }}',\n  '{{ $fromAI(\"new_value\", \"Новое значение\", \"string\") }}'\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        2880,
        -608
      ],
      "id": "a45592cc-234a-4e27-a5d6-91cbedd0882c",
      "name": "Edit_transaction",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH found_transaction AS (\n  SELECT \n    CASE \n      WHEN LOWER('{{ $fromAI(\"transaction_id\", \"ID удалённой транзакции или 'last'\", \"string\") }}') = 'last' \n      THEN get_last_transaction({{ $('Telegram Bot Trigger').first().json.message.from.id }}, LOWER('{{ $fromAI(\"transaction_type\", \"Тип: expense или income\", \"string\") }}'))\n      ELSE CAST(NULLIF('{{ $fromAI(\"transaction_id\", \"ID удалённой транзакции или 'last'\", \"string\") }}', 'last') AS INTEGER)\n    END as tid\n),\nrestore_expense AS (\n  UPDATE expenses\n  SET deleted_at = NULL,\n      deleted_by = NULL\n  WHERE id = (SELECT tid FROM found_transaction)\n    AND user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND deleted_at IS NOT NULL\n    AND LOWER('{{ $fromAI(\"transaction_type\", \"Тип: expense или income\", \"string\") }}') = 'expense'\n  RETURNING id, amount, category, currency, date\n),\nrestore_income AS (\n  UPDATE income\n  SET deleted_at = NULL,\n      deleted_by = NULL\n  WHERE id = (SELECT tid FROM found_transaction)\n    AND user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND deleted_at IS NOT NULL\n    AND LOWER('{{ $fromAI(\"transaction_type\", \"Тип: expense или income\", \"string\") }}') = 'income'\n  RETURNING id, amount, category, currency, date\n),\nlog_restore AS (\n  SELECT log_transaction_change(\n    LOWER('{{ $fromAI(\"transaction_type\", \"Тип: expense или income\", \"string\") }}'),\n    (SELECT tid FROM found_transaction),\n    'restored',\n    NULL,\n    NULL,\n    NULL,\n    {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n  ) as history_id\n)\nSELECT \n  COALESCE(\n    (SELECT row_to_json(restore_expense.*) FROM restore_expense),\n    (SELECT row_to_json(restore_income.*) FROM restore_income)\n  ) as restored_transaction,\n  (SELECT history_id FROM log_restore) as history_id,\n  'restored' as status;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        3008,
        -608
      ],
      "id": "e313972e-8519-498f-8f4f-9e46ef0fdd6a",
      "name": "Restore_transaction",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.message.text }}",
        "options": {
          "systemMessage": "Ты финансист и менеджер по отчетам который реагирует на команду /get_week_report. Ты должен получать Отчеты за посленюю неделю используя базу данных Get_transaction_history1, делить эту неделю на дни, и сколько было потрачено в какой день"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        1104,
        -592
      ],
      "id": "7d0708b8-867e-46c0-b233-fd3c06eaf90c",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        912,
        -368
      ],
      "id": "48c9ae37-5f87-4765-80b8-3d21f83f6565",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "SyI2pOUeSfbt1JRh",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.message.text }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        1040,
        -368
      ],
      "id": "e0af4b9d-7f87-4624-ae23-f0dfa57720a8",
      "name": "Simple Memory"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        1168,
        -368
      ],
      "id": "e4426882-bdae-4892-8d3e-8b65d0c046b2",
      "name": "Calculator"
    },
    {
      "parameters": {
        "resource": "pdf",
        "pdfTemplateId": "c1d77b23eda325b2",
        "jsonParameters": true,
        "propertiesJson": "{\n  \"name\": \"apitemplate.io\",\n  \"sales\": {\n    \"data\": [30,40,45,50,49,60,70,91,125],\n    \"categories\": [1991,1992,1993,1994,1995,1996,1997,1998,1999]\n  },\n  \"team\": {\n    \"data\": [44,55,13,43,22],\n    \"labels\": [\"Team A\",\"Team B\",\"Team C\",\"Team D\",\"Team E\"]\n  }\n}"
      },
      "type": "n8n-nodes-base.apiTemplateIo",
      "typeVersion": 1,
      "position": [
        1632,
        -480
      ],
      "id": "dc45df34-7343-4ae3-aeb5-d130c8ea6af6",
      "name": "Create a pdf",
      "credentials": {
        "apiTemplateIoApi": {
          "id": "WCFzWPXSnueTP8ef",
          "name": "APITemplate.io Financer"
        }
      }
    },
    {
      "parameters": {
        "description": "Используй данную ноду для того чтобы свормировать анные в нормальный json формат",
        "jsCode": "// Получаем JSON данные из входящего запроса\nlet jsonData = $input.item.json.body.data;\n\n// Извлекаем данные из структуры JSON\nlet result = {\n  \"name\": jsonData.name,\n  \"sales\": {\n    \"data\": jsonData.sales.data,\n    \"categories\": jsonData.sales.categories\n  },\n  \"team\": {\n    \"data\": jsonData.team.data,\n    \"labels\": jsonData.team.labels\n  }\n};\n\nreturn result;"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        1296,
        -368
      ],
      "id": "47e0f7d7-21f7-47b9-8ea9-8783560f7422",
      "name": "Code Tool"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH week_range AS (\n  SELECT \n    DATE_TRUNC('week', CURRENT_DATE AT TIME ZONE 'Asia/Bishkek') as week_start,\n    DATE_TRUNC('week', CURRENT_DATE AT TIME ZONE 'Asia/Bishkek') + INTERVAL '6 days' as week_end\n),\nincome_sum AS (\n  SELECT COALESCE(SUM(amount), 0) as total\n  FROM income\n  WHERE user_id = {{ $('Регистрация/обновление пользователя').item.json.user_id }}\n    AND date >= (SELECT week_start FROM week_range)::date\n    AND date <= (SELECT week_end FROM week_range)::date\n),\nexpense_sum AS (\n  SELECT COALESCE(SUM(amount), 0) as total\n  FROM expenses\n  WHERE user_id = {{ $('Регистрация/обновление пользователя').item.json.user_id }}\n    AND date >= (SELECT week_start FROM week_range)::date\n    AND date <= (SELECT week_end FROM week_range)::date\n),\ntop_categories AS (\n  SELECT \n    category,\n    SUM(amount) as total,\n    COUNT(*) as count\n  FROM expenses\n  WHERE user_id = {{ $('Регистрация/обновление пользователя').item.json.user_id }}\n    AND date >= (SELECT week_start FROM week_range)::date\n    AND date <= (SELECT week_end FROM week_range)::date\n  GROUP BY category\n  ORDER BY total DESC\n  LIMIT 3\n),\ntransaction_count AS (\n  SELECT \n    (SELECT COUNT(*) FROM income WHERE user_id = {{ $('Регистрация/обновление пользователя').item.json.user_id }} \n     AND date >= (SELECT week_start FROM week_range)::date\n     AND date <= (SELECT week_end FROM week_range)::date) as income_count,\n    (SELECT COUNT(*) FROM expenses WHERE user_id = {{ $('Регистрация/обновление пользователя').item.json.user_id }}\n     AND date >= (SELECT week_start FROM week_range)::date\n     AND date <= (SELECT week_end FROM week_range)::date) as expense_count\n)\nSELECT \n  TO_CHAR((SELECT week_start FROM week_range), 'DD.MM.YYYY') as week_start_formatted,\n  TO_CHAR((SELECT week_end FROM week_range), 'DD.MM.YYYY') as week_end_formatted,\n  (SELECT total FROM income_sum) as total_income,\n  (SELECT total FROM expense_sum) as total_expenses,\n  (SELECT total FROM income_sum) - (SELECT total FROM expense_sum) as profit,\n  (SELECT income_count FROM transaction_count) as income_count,\n  (SELECT expense_count FROM transaction_count) as expense_count,\n  (SELECT income_count + expense_count FROM transaction_count) as total_transactions,\n  COALESCE((SELECT JSON_AGG(JSON_BUILD_OBJECT(\n    'category', category,\n    'total', total,\n    'count', count\n  )) FROM top_categories), '[]'::json) as top_categories;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        1424,
        -368
      ],
      "id": "29639fef-a0a1-478f-bd88-296f5e79e260",
      "name": "Get_week_statistic",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.text }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        1984,
        -608
      ],
      "id": "fe2a8d54-f563-4990-9bc8-ee146b8dea41",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Bot Trigger": {
      "main": [
        [
          {
            "node": "Регистрация/обновление пользователя",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message Type Switch": {
      "main": [
        [
          {
            "node": "Download Voice File",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Text Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Voice File": {
      "main": [
        [
          {
            "node": "Transcribe Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe Audio": {
      "main": [
        [
          {
            "node": "Financial Assistant",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Text Data": {
      "main": [
        [
          {
            "node": "Financial Assistant",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Financial Assistant": {
      "main": [
        [
          {
            "node": "Send Telegram Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Регистрация/обновление пользователя": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Message Type Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add_income": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Parsing_of_the_month": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Add_expense": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Calc": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Convert_currency": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get_exchange_rates": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Edit_transaction": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Restore_transaction": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Calculator": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Create a pdf",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Tool": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get_week_statistic": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "c89965a4-99b1-4428-8aaf-7efc6f370a57",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "bcdca7003a882ee2cf9d975eab94cc02ba456a1ed2ac37511421cb2edeb80c62"
  },
  "id": "2a2MkaY2pl1itHZ2",
  "tags": []
}