{
  "nodes": [
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "maxRetries": 3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        752,
        160
      ],
      "id": "93fb1cd1-c0bd-4941-b00c-ceaf7b55d5ac",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "SyI2pOUeSfbt1JRh",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "id": "42e54c46-7c81-4d95-91be-052ba0328ddb",
      "name": "Telegram Bot Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.1,
      "position": [
        -1088,
        32
      ],
      "webhookId": "b8605f3e-0f52-4ffc-a4c9-1728eb0e09e2",
      "credentials": {
        "telegramApi": {
          "id": "WabnlnnS7XdATC3n",
          "name": "Alikbek Financer"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message.voice.file_id }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    },
                    "id": "d697a3d5-018a-4cf0-867e-a877c10d6267"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Voice"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "57c00950-88c8-4c71-bfe1-5e243b0b71dc",
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "^(/weekly_report|–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç|–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç|–æ—Ç—á–µ—Ç –∑–∞ –Ω–µ–¥–µ–ª—é|–æ—Ç—á—ë—Ç –∑–∞ –Ω–µ–¥–µ–ª—é)",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Weekly Report"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "monthly-report-cmd",
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "^(/monthly_report|–º–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç|–º–µ—Å—è—á–Ω—ã–π –æ—Ç—á–µ—Ç|–æ—Ç—á–µ—Ç –∑–∞ –º–µ—Å—è—Ü|–æ—Ç—á—ë—Ç –∑–∞ –º–µ—Å—è—Ü)",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Monthly Report"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "period-report-cmd",
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "^(–æ—Ç—á–µ—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥|–æ—Ç—á—ë—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥|–æ—Ç—á–µ—Ç —Å|–æ—Ç—á—ë—Ç —Å|–ø–µ—Ä–∏–æ–¥)",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Period Report"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "monthly-report-cmd",
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "^(/monthly_report|–º–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç|–º–µ—Å—è—á–Ω—ã–π –æ—Ç—á–µ—Ç|–æ—Ç—á–µ—Ç –∑–∞ –º–µ—Å—è—Ü|–æ—Ç—á—ë—Ç –∑–∞ –º–µ—Å—è—Ü)",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Monthly Report"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "period-report-cmd",
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "(–æ—Ç—á–µ—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥|–æ—Ç—á—ë—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥|–æ—Ç—á–µ—Ç —Å|–æ—Ç—á—ë—Ç —Å)",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Period Report"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8c844924-b2ed-48b0-935c-c66a8fd0c778",
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Text"
            }
          ]
        },
        "options": {}
      },
      "id": "054f1261-076b-4f08-946e-6c5ac2672e37",
      "name": "Message Type Switch",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -416,
        16
      ]
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $json.message.voice.file_id }}",
        "additionalFields": {}
      },
      "id": "448a77fd-85de-40b3-87c6-2eaf363618d0",
      "name": "Download Voice File",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        64,
        -160
      ],
      "webhookId": "8fa0a59a-be53-4897-83bb-5b18ed71b529",
      "credentials": {
        "telegramApi": {
          "id": "WabnlnnS7XdATC3n",
          "name": "Alikbek Financer"
        }
      }
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "id": "c9cf8898-0bed-4b1c-b450-3a2beb89954b",
      "name": "Transcribe Audio",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.6,
      "position": [
        528,
        -160
      ],
      "credentials": {
        "openAiApi": {
          "id": "SyI2pOUeSfbt1JRh",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d6af7fa1-c31a-4514-ae63-397699bf8b21",
              "name": "text",
              "value": "={{ $('Telegram Bot Trigger').first().json.message.text }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        528,
        32
      ],
      "id": "c28a8557-ed9a-499d-803e-5b03e2710218",
      "name": "Prepare Text Data"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{$('Telegram Bot Trigger').first().json.message.message_id }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        880,
        160
      ],
      "id": "d94ff864-a4e8-424b-ac20-d2216ce3de7a",
      "name": "Conversation Memory"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.text }}\n\n",
        "options": {
          "systemMessage": "=–¢—ã ‚Äî AI —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫ —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ Supabase –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–∏—á–Ω—ã–º–∏ –∏ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–º–∏ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏ –≤ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–µ.\n–í–∞–ª—é—Ç—ã: —Å–æ–º (KGS), –¥–æ–ª–ª–∞—Ä (USD), –µ–≤—Ä–æ (EUR), —Ä—É–±–ª—å (RUB). –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞: {{ new Date().toLocaleDateString('ru-RU') }}\n\nüè¢ –°–ò–°–¢–ï–ú–ê WORKSPACE:\n–£ –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å workspace_id. –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ workspace. –ò—Å–ø–æ–ª—å–∑—É–π —Ñ—É–Ω–∫—Ü–∏–∏:\n- get_user_workspaces() - –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ workspace –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n- create_workspace_with_owner() - —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π workspace\n- check_workspace_permission() - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞\n\n---\nüí∏ –†–ê–°–•–û–î–´: –∏—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç Add_expense —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:\n- workspace_id: ID —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)\n- category: –ø—Ä–æ–¥—É–∫—Ç—ã, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –∫–∞—Ñ–µ/—Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã, –∞—Ä–µ–Ω–¥–∞ –æ—Ñ–∏—Å–∞, –∑–∞—Ä–ø–ª–∞—Ç–∞, –Ω–∞–ª–æ–≥–∏, –º–∞—Ä–∫–µ—Ç–∏–Ω–≥, –∫–∞–Ω—Ü—Ç–æ–≤–∞—Ä—ã, –∏–Ω—Ç–µ—Ä–Ω–µ—Ç/—Å–≤—è–∑—å, –∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏, –æ–±—É—á–µ–Ω–∏–µ, –ø–æ–¥–ø–∏—Å–∫–∏, –ø—Ä–æ—á–µ–µ\n- amount: —Å—É–º–º–∞ (—Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ)\n- currency: –≤–∞–ª—é—Ç–∞ (KGS/—Å–æ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, USD/–¥–æ–ª–ª–∞—Ä, EUR/–µ–≤—Ä–æ, RUB/—Ä—É–±–ª—å)\n- description: –æ–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)\n- date: DD.MM.YYYY (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ - –±—É–¥–µ—Ç —Å–µ–≥–æ–¥–Ω—è)\n\nüí∞ –î–û–•–û–î–´: –∏—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç Add_income —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:\n- workspace_id: ID —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)\n- category: –∑–∞—Ä–ø–ª–∞—Ç–∞, –ø—Ä–æ–¥–∞–∂–∏, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏, –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∞, –∫—ç—à–±–µ–∫, –ø—Ä–æ—á–µ–µ\n- amount, currency, description, date (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ)\n\nüìä –ê–ù–ê–õ–ò–ó: –∏—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç Parsing_of_the_month —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:\n- workspace_id: ID —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞\n- month: –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—è—Ü–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä '–æ–∫—Ç—è–±—Ä—å')\n- type: '—Ä–∞—Å—Ö–æ–¥' –∏–ª–∏ '–¥–æ—Ö–æ–¥'\n- filter_category: –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ\n\nüí± –ö–û–ù–í–ï–†–¢–ê–¶–ò–Ø –í–ê–õ–Æ–¢:\n–ò—Å–ø–æ–ª—å–∑—É–π —Ñ—É–Ω–∫—Ü–∏—é convert_amount() –∏–ª–∏ get_exchange_rate() –∏–∑ –±–∞–∑—ã:\n- '–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–π X —Å–æ–º –≤ –¥–æ–ª–ª–∞—Ä—ã' ‚Üí convert_amount(X, 'KGS', 'USD', CURRENT_DATE)\n- '–ö–∞–∫–æ–π –∫—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞?' ‚Üí get_exchange_rate('USD', 'KGS', CURRENT_DATE)\n\n–ü—Ä–∏ –ø–æ–∫–∞–∑–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–∞–ª—é—Ç–µ:\n1. –ü–æ–ª—É—á–∏ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ get_income_expense_stats()\n2. –ò—Å–ø–æ–ª—å–∑—É–π convert_amount() –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Å—É–º–º\n3. –°—É–º–º–∏—Ä—É–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–π –≤–∞–ª—é—Ç–µ\n\nüìà –ê–ù–ê–õ–ò–¢–ò–ö–ê:\n–ò—Å–ø–æ–ª—å–∑—É–π –≥–æ—Ç–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:\n- get_income_expense_stats(workspace_id, start_date, end_date) - –æ—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n- get_top_expense_categories(workspace_id, start_date, end_date, limit) - —Ç–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π\n- get_spending_patterns(workspace_id) - –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Ç—Ä–∞—Ç\n- get_category_analytics(workspace_id, period) - –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º\n- get_cached_analytics(workspace_id, cache_key) - –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\n\n---\n–í–ê–ñ–ù–û: –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–π –≤–∞–ª—é—Ç—É –∏–∑ —Ç–µ–∫—Å—Ç–∞:\n- '—Å–æ–º', '—Å–æ–º–æ–≤', 'KGS' ‚Üí currency: KGS\n- '–¥–æ–ª–ª–∞—Ä', '–¥–æ–ª–ª–∞—Ä–æ–≤', '$', 'USD' ‚Üí currency: USD\n- '–µ–≤—Ä–æ', 'EUR' ‚Üí currency: EUR\n- '—Ä—É–±–ª—å', '—Ä—É–±–ª–µ–π', 'RUB' ‚Üí currency: RUB\n- –ï—Å–ª–∏ –≤–∞–ª—é—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ ‚Üí –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é KGS\n\n‚úÖ –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ñ–æ—Ä–º–∏—Ä—É–π —á–∏—Ç–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç.\n–ü—Ä–∏–º–µ—Ä: \"‚úÖ –†–∞—Å—Ö–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω: 100 USD –Ω–∞ '–ø—Ä–æ–¥—É–∫—Ç—ã' (30.10.2025)\"\n\nüìù –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –¢–†–ê–ù–ó–ê–ö–¶–ò–ô:\n–ò—Å–ø–æ–ª—å–∑—É–π —Ñ—É–Ω–∫—Ü–∏—é safe_update_transaction():\n- '–ò–∑–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥ –Ω–∞ 1500 —Å–æ–º' ‚Üí safe_update_transaction(user_id, 'expense', 'last', 'amount', '1500')\n- '–ü–æ–º–µ–Ω—è–π –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ 15 –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç—ã' ‚Üí safe_update_transaction(user_id, 'expense', '15', 'category', '–ø—Ä–æ–¥—É–∫—Ç—ã')\n\nüóëÔ∏è –£–î–ê–õ–ï–ù–ò–ï/–í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï:\n–ò—Å–ø–æ–ª—å–∑—É–π –º—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø–æ–ª–µ deleted_at –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö expenses/income\n\nÔøΩ –ò–°–¢–û–†–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô:\n–ò—Å–ø–æ–ª—å–∑—É–π —Ç–∞–±–ª–∏—Ü—É transaction_history —Å —Ñ—É–Ω–∫—Ü–∏–µ–π log_transaction_change()\n\n---\nÔøΩ –ü–û–í–¢–û–†–Ø–Æ–©–ò–ï–°–Ø –ü–õ–ê–¢–ï–ñ–ò (–ü–û–î–ü–ò–°–ö–ò):\n\nüìå –°–û–ó–î–ê–ù–ò–ï: –∏—Å–ø–æ–ª—å–∑—É–π create_recurring_payment()\nüìã –°–ü–ò–°–û–ö: SELECT –∏–∑ —Ç–∞–±–ª–∏—Ü—ã recurring_payments WHERE user_id = X AND is_active = true\n‚ùå –û–¢–ú–ï–ù–ê: UPDATE recurring_payments SET is_active = false\n‚ö° –í–´–ü–û–õ–ù–ï–ù–ò–ï: execute_recurring_payment()\nüîî –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø: get_pending_reminders()\n\n---\nÔøΩ –ë–Æ–î–ñ–ï–¢ –ò –õ–ò–ú–ò–¢–´:\n\nÔøΩ –ë–Æ–î–ñ–ï–¢:\n- –¢–∞–±–ª–∏—Ü–∞: budgets (user_id, workspace_id, month, budget_amount)\n- –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≥–Ω–æ–∑–∞: get_budget_forecast(user_id)\n- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤: check_budget_alerts(user_id, new_expense_amount)\n\nüéØ –õ–ò–ú–ò–¢–´ –ö–ê–¢–ï–ì–û–†–ò–ô:\n- –¢–∞–±–ª–∏—Ü–∞: limits (user_id, category, month, limit_amount)\n- –ü—Ä–æ–≤–µ—Ä–∫–∞: check_category_limit_alert(user_id, category, new_amount)\n\n‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –ê–õ–ï–†–¢–û–í:\n- –¢–∞–±–ª–∏—Ü–∞: budget_alerts_config\n- –ü–æ—Ä–æ–≥–∏: budget_warning_threshold, budget_critical_threshold\n\n---\nüîî –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø:\n\nüì¨ –¢–∞–±–ª–∏—Ü–∞ notifications —Å –ø–æ–ª—è–º–∏:\n- notification_type: budget_warning, budget_exceeded, limit_warning, limit_exceeded, recurring_reminder, unusual_spending\n- priority: urgent, high, normal, low\n- is_read, is_sent\n\nüìä ML –ê–ù–ê–õ–ò–ó:\n- detect_unusual_spending() - –¥–µ—Ç–µ–∫—Ü–∏—è –Ω–µ–æ–±—ã—á–Ω—ã—Ö —Ç—Ä–∞—Ç\n- update_spending_patterns() - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤\n- –¢–∞–±–ª–∏—Ü–∞: spending_patterns —Å confidence_score\n\n---\nüè¢ WORKSPACE –§–£–ù–ö–¶–ò–ò:\n\nüë• –£–ß–ê–°–¢–ù–ò–ö–ò:\n- accept_workspace_invite() - –ø—Ä–∏–Ω—è—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ\n- remove_workspace_member() - —É–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞\n- –¢–∞–±–ª–∏—Ü–∞ workspace_members —Å —Ä–æ–ª—è–º–∏: owner, admin, editor, viewer\n\nüìä –ê–ù–ê–õ–ò–¢–ò–ö–ê:\n- get_chart_data() - –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤\n- get_income_expense_chart_data() - –≥—Ä–∞—Ñ–∏–∫–∏ –¥–æ—Ö–æ–¥–æ–≤/—Ä–∞—Å—Ö–æ–¥–æ–≤\n- update_analytics_cache() - –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ\n\nÔøΩ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:\n- –¢–∞–±–ª–∏—Ü–∞ audit_logs –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π\n- log_audit_event() –¥–ª—è –∑–∞–ø–∏—Å–∏ —Å–æ–±—ã—Ç–∏–π\n- check_workspace_permission() –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤\n\n---\nÔøΩÔ∏è –û–°–ù–û–í–ù–´–ï –¢–ê–ë–õ–ò–¶–´ SUPABASE:\n\nÔøΩ –¢–†–ê–ù–ó–ê–ö–¶–ò–ò:\n- expenses: —Ä–∞—Å—Ö–æ–¥—ã —Å workspace_id, user_id, amount, currency, category, date, deleted_at\n- income: –¥–æ—Ö–æ–¥—ã —Å –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π\n- transaction_history: –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π\n\nüë§ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò:\n- users: –æ—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n- user_preferences: –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n- workspace_members: —É—á–∞—Å—Ç–Ω–∏–∫–∏ workspace —Å —Ä–æ–ª—è–º–∏\n\nüí∞ –§–ò–ù–ê–ù–°–´:\n- budgets: –±—é–¥–∂–µ—Ç—ã –ø–æ –º–µ—Å—è—Ü–∞–º\n- limits: –ª–∏–º–∏—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º\n- exchange_rates: –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç\n- recurring_payments: —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏\n\nüìà –ê–ù–ê–õ–ò–¢–ò–ö–ê:\n- analytics_cache: –∫–µ—à –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏\n- category_analytics: –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º\n- spending_patterns: –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Ç—Ä–∞—Ç\n- chart_configs: –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤\n\nüîî –°–ò–°–¢–ï–ú–ê:\n- notifications: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\n- audit_logs: –ª–æ–≥–∏ –¥–µ–π—Å—Ç–≤–∏–π\n- error_logs: –ª–æ–≥–∏ –æ—à–∏–±–æ–∫\n- reports: –æ—Ç—á–µ—Ç—ã\n\nüí± –í–ê–õ–Æ–¢–´:\n- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –æ–±—Ä–∞—Ç–Ω—ã—Ö –∫—É—Ä—Å–æ–≤ —á–µ—Ä–µ–∑ trigger calculate_reverse_rate\n- –§—É–Ω–∫—Ü–∏—è cleanup_old_rates() –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –∫—É—Ä—Å–æ–≤\n\n---\n–û–ë–©–ò–ï –ü–†–ê–í–ò–õ–ê:\n\n1. –í–°–ï–ì–î–ê —É–∫–∞–∑—ã–≤–∞–π workspace_id –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö –∫ –±–∞–∑–µ\n2. –ò—Å–ø–æ–ª—å–∑—É–π —Ñ—É–Ω–∫—Ü–∏–∏ Supabase –≤–º–µ—Å—Ç–æ –ø—Ä—è–º—ã—Ö SQL –∑–∞–ø—Ä–æ—Å–æ–≤ –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ\n3. –ü—Ä–æ–≤–µ—Ä—è–π –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ check_workspace_permission()\n4. –õ–æ–≥–∏—Ä—É–π –≤–∞–∂–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è —á–µ—Ä–µ–∑ audit_logs\n5. –ö–µ—à–∏—Ä—É–π –∞–Ω–∞–ª–∏—Ç–∏–∫—É —á–µ—Ä–µ–∑ analytics_cache –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏\n6. –ò—Å–ø–æ–ª—å–∑—É–π soft delete (deleted_at) –≤–º–µ—Å—Ç–æ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è\n7. –í—Å–µ —Å—É–º–º—ã —Ö—Ä–∞–Ω–∏ –≤ NUMERIC(12,2) –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏\n8. –î–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ DATE, –≤—Ä–µ–º–µ–Ω–∞ –≤ TIMESTAMP WITH TIME ZONE\n9. –í–∞–ª—é—Ç—ã –≤—Å–µ–≥–¥–∞ –≤ –≤–µ—Ä—Ö–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ (KGS, USD, EUR, RUB)\n10. –î–ª—è ML –∞–Ω–∞–ª–∏–∑–∞ –∏—Å–ø–æ–ª—å–∑—É–π spending_patterns –∏ ml_forecasts —Ç–∞–±–ª–∏—Ü—ã\n\n---\nüéØ –ù–û–í–´–ï –ò–ù–°–¢–†–£–ú–ï–ù–¢–´:\n\nüìä –†–ê–°–®–ò–†–ï–ù–ù–ê–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ê:\n- Get_income_expense_stats() - –¥–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ—Ö–æ–¥–æ–≤/—Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥\n- Get_top_categories() - —Ç–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ä–∞—Å—Ö–æ–¥–æ–≤ —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏\n- Update_spending_patterns() - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ ML –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ —Ç—Ä–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n\nüè¢ –£–ü–†–ê–í–õ–ï–ù–ò–ï WORKSPACE:\n- Get_workspaces() - —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö workspace –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ä–æ–ª—è–º–∏\n- –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–µ—Ä–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–π workspace\n\nüí∞ –ë–Æ–î–ñ–ï–¢ –ò –õ–ò–ú–ò–¢–´:\n- Set_budget(amount, currency, month) - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–µ—Å—è—á–Ω—ã–π –±—é–¥–∂–µ—Ç\n- Set_category_limit(category, amount, currency, month) - –ª–∏–º–∏—Ç –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é\n\n–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:\n- \"–£—Å—Ç–∞–Ω–æ–≤–∏ –±—é–¥–∂–µ—Ç 50000 —Å–æ–º –Ω–∞ –Ω–æ—è–±—Ä—å\" ‚Üí Set_budget(amount: 50000, currency: 'KGS', month: '2025-11')\n- \"–õ–∏–º–∏—Ç –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç—ã 15000 —Å–æ–º\" ‚Üí Set_category_limit(category: '–ø—Ä–æ–¥—É–∫—Ç—ã', amount: 15000)\n- \"–ü–æ–∫–∞–∂–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ –æ–∫—Ç—è–±—Ä—å\" ‚Üí Get_income_expense_stats(start_date: '01.10.2025', end_date: '31.10.2025')\n- \"–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∑–∞ –º–µ—Å—è—Ü\" ‚Üí Get_top_categories(limit: 5)\n- \"–û–±–Ω–æ–≤–∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Ç—Ä–∞—Ç\" ‚Üí Update_spending_patterns()\n\n–í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –≤–º–µ—Å—Ç–æ –ø—Ä—è–º—ã—Ö SQL –∑–∞–ø—Ä–æ—Å–æ–≤!"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        2224,
        -64
      ],
      "id": "be9ba531-5b63-4547-a8a0-6ee5270e28d3",
      "name": "Financial Assistant",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Bot Trigger').first().json.message.chat.id }}",
        "text": "={{ $json.output }}",
        "additionalFields": {
          "appendAttribution": false,
          "reply_to_message_id": "={{ $('Telegram Bot Trigger').first().json.message.message_id }}"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        4032,
        -64
      ],
      "id": "81d9fe3d-d21a-473d-b3e3-f6d489fd2880",
      "name": "Send Telegram Response",
      "webhookId": "a2f9609c-4b7a-4d51-aaa6-c889f56aefc9",
      "credentials": {
        "telegramApi": {
          "id": "WabnlnnS7XdATC3n",
          "name": "Alikbek Financer"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH monthly_data AS (\n  SELECT \n    category,\n    COUNT(*) as transaction_count,\n    SUM(amount) as total_amount,\n    AVG(amount) as avg_amount\n  FROM income\n  WHERE user_id = {{ $json.user_id }}\n    AND TO_CHAR(date, 'YYYY-MM') = '{{ $json.year_month }}'\n    {{ $json.category ? \"AND category = '\" + $json.category + \"'\" : \"\" }}\n  GROUP BY category\n  ORDER BY total_amount DESC\n)\nSELECT \n  *,\n  (SELECT SUM(total_amount) FROM monthly_data) as grand_total\nFROM monthly_data;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -864,
        1024
      ],
      "id": "99b72a7d-9f35-410c-b5fd-f711ec06cfe5",
      "name": "–ê–Ω–∞–ª–∏–∑ –¥–æ—Ö–æ–¥–æ–≤",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "9af39ade-d2ac-4587-b4cd-bccb18fece32",
              "leftValue": "={{ $json.type }}",
              "rightValue": "—Ä–∞—Å—Ö–æ–¥",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1088,
        928
      ],
      "id": "af909326-07ca-4025-91b6-d22c81e42261",
      "name": "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH monthly_data AS (\n  SELECT \n    category,\n    COUNT(*) as transaction_count,\n    SUM(amount) as total_amount,\n    AVG(amount) as avg_amount\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    AND TO_CHAR(date, 'YYYY-MM') = '{{ $json.year_month }}'\n    {{ $json.category ? \"AND category = '\" + $json.category + \"'\" : \"\" }}\n  GROUP BY category\n  ORDER BY total_amount DESC\n)\nSELECT \n  *,\n  (SELECT SUM(total_amount) FROM monthly_data) as grand_total\nFROM monthly_data;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -864,
        832
      ],
      "id": "4f597868-0cc7-47c7-bd83-0fef71d8e4ad",
      "name": "–ê–Ω–∞–ª–∏–∑ —Ä–∞—Å—Ö–æ–¥–æ–≤",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO users (user_id, username, first_name, last_name, telegram_chat_id)\nVALUES (\n  {{ $json.message.from.id }},\n  '{{ $json.message.from.username || \"\" }}',\n  '{{ $json.message.from.first_name || \"\" }}',\n  '{{ $json.message.from.last_name || \"\" }}',\n  {{ $json.message.chat.id }}\n)\nON CONFLICT (user_id) \nDO UPDATE SET \n  username = EXCLUDED.username,\n  last_activity = NOW()\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -864,
        32
      ],
      "id": "7ad7337c-c2f8-477f-9056-fbb738782de0",
      "name": "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6cb77ab8-f045-4576-b673-6ead0a3a5da6",
              "name": "message",
              "value": "={{ $node[\"Telegram Bot Trigger\"].json[\"message\"] || {} }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -640,
        32
      ],
      "id": "71e38656-63ae-44a6-b757-c7bafec41aee",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n)\nINSERT INTO income (user_id, workspace_id, date, category, amount, currency, description, operation_type, source)\nSELECT\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }},\n  uw.workspace_id,\n  COALESCE(\n    TO_DATE('{{ $fromAI(\"date\", \"–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ —Ç–æ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞\", \"string\", \"\") }}', 'DD.MM.YYYY'),\n    CURRENT_DATE\n  ),\n  '{{ $fromAI(\"category\", \"–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ—Ö–æ–¥–∞: –∑–∞—Ä–ø–ª–∞—Ç–∞, –ø—Ä–æ–¥–∞–∂–∏, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏, –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∞, –∫—ç—à–±–µ–∫, –ø—Ä–æ—á–µ–µ\", \"string\") }}',\n  {{ $fromAI(\"amount\", \"–°—É–º–º–∞ –¥–æ—Ö–æ–¥–∞, —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ\", \"number\") }},\n  UPPER('{{ $fromAI(\"currency\", \"–í–∞–ª—é—Ç–∞: —Å–æ–º/KGS, –¥–æ–ª–ª–∞—Ä/USD, –µ–≤—Ä–æ/EUR, —Ä—É–±–ª—å/RUB. –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ - KGS\", \"string\", \"KGS\") }}'),\n  '{{ $fromAI(\"description\", \"–û–ø–∏—Å–∞–Ω–∏–µ –¥–æ—Ö–æ–¥–∞, –µ—Å–ª–∏ –µ—Å—Ç—å\", \"string\", \"\") }}',\n  '–¥–æ—Ö–æ–¥',\n  'telegram'\nFROM user_workspace uw\nRETURNING id, workspace_id, TO_CHAR(date, 'DD.MM.YYYY') as date, category, amount, currency, description;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        1008,
        160
      ],
      "id": "2208d832-bc4b-4faf-9b1e-13f4b579257b",
      "name": "Add_income",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n),\nmonth_mapping AS (\n  SELECT * FROM (VALUES\n    ('—è–Ω–≤–∞—Ä—å', 1), ('—Ñ–µ–≤—Ä–∞–ª—å', 2), ('–º–∞—Ä—Ç', 3), ('–∞–ø—Ä–µ–ª—å', 4),\n    ('–º–∞–π', 5), ('–∏—é–Ω—å', 6), ('–∏—é–ª—å', 7), ('–∞–≤–≥—É—Å—Ç', 8),\n    ('—Å–µ–Ω—Ç—è–±—Ä—å', 9), ('–æ–∫—Ç—è–±—Ä—å', 10), ('–Ω–æ—è–±—Ä—å', 11), ('–¥–µ–∫–∞–±—Ä—å', 12)\n  ) AS m(month_name, month_num)\n),\nfiltered_data AS (\n  SELECT\n    TO_CHAR(t.date, 'DD.MM.YYYY') as date,\n    t.category,\n    t.amount,\n    t.currency,\n    COALESCE(t.description, '') as description\n  FROM {{ $fromAI(\"type\", \"–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏: '—Ä–∞—Å—Ö–æ–¥' –∏–ª–∏ '–¥–æ—Ö–æ–¥'\", \"string\") === '—Ä–∞—Å—Ö–æ–¥' ? 'expenses' : 'income' }} t\n  INNER JOIN month_mapping mm ON EXTRACT(MONTH FROM t.date) = mm.month_num\n  INNER JOIN user_workspace uw ON t.workspace_id = uw.workspace_id\n  WHERE t.user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND EXTRACT(YEAR FROM t.date) = EXTRACT(YEAR FROM CURRENT_DATE)\n    AND LOWER(mm.month_name) = LOWER('{{ $fromAI(\"month\", \"–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—è—Ü–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –æ–∫—Ç—è–±—Ä—å, –Ω–æ—è–±—Ä—å)\", \"string\") }}')\n    AND (NULLIF('{{ $fromAI(\"filter_category\", \"–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ\", \"string\", \"\") }}', '') IS NULL OR t.category = '{{ $fromAI(\"filter_category\", \"–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ\", \"string\", \"\") }}')\n    AND t.deleted_at IS NULL\n)\nSELECT \n  *,\n  (SELECT COUNT(*) FROM filtered_data) as total_rows,\n  (SELECT SUM(amount) FROM filtered_data) as total_amount,\n  (SELECT COUNT(DISTINCT currency) FROM filtered_data) as currency_count\nFROM filtered_data\nORDER BY date DESC\nLIMIT 100;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        1136,
        160
      ],
      "id": "4272e08c-07e7-4163-b75a-d67207502193",
      "name": "Parsing_of_the_month",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n)\nINSERT INTO expenses (user_id, workspace_id, date, category, amount, currency, description, operation_type, source)\nSELECT\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }},\n  uw.workspace_id,\n  COALESCE(\n    TO_DATE('{{ $fromAI(\"date\", \"–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ —Ç–æ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞\", \"string\", \"\") }}', 'DD.MM.YYYY'),\n    CURRENT_DATE\n  ),\n  '{{ $fromAI(\"category\", \"–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ä–∞—Å—Ö–æ–¥–∞: –ø—Ä–æ–¥—É–∫—Ç—ã, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –∫–∞—Ñ–µ/—Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã, –∞—Ä–µ–Ω–¥–∞ –æ—Ñ–∏—Å–∞, –∑–∞—Ä–ø–ª–∞—Ç–∞, –Ω–∞–ª–æ–≥–∏, –º–∞—Ä–∫–µ—Ç–∏–Ω–≥, –∫–∞–Ω—Ü—Ç–æ–≤–∞—Ä—ã, –∏–Ω—Ç–µ—Ä–Ω–µ—Ç/—Å–≤—è–∑—å, –∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏, –æ–±—É—á–µ–Ω–∏–µ, –ø–æ–¥–ø–∏—Å–∫–∏, –ø—Ä–æ—á–µ–µ\", \"string\") }}',\n  {{ $fromAI(\"amount\", \"–°—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–∞, —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ\", \"number\") }},\n  UPPER('{{ $fromAI(\"currency\", \"–í–∞–ª—é—Ç–∞: —Å–æ–º/KGS, –¥–æ–ª–ª–∞—Ä/USD, –µ–≤—Ä–æ/EUR, —Ä—É–±–ª—å/RUB. –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ - KGS\", \"string\", \"KGS\") }}'),\n  '{{ $fromAI(\"description\", \"–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞, –µ—Å–ª–∏ –µ—Å—Ç—å\", \"string\", \"\") }}',\n  '—Ä–∞—Å—Ö–æ–¥',\n  'telegram'\nFROM user_workspace uw\nRETURNING id, workspace_id, TO_CHAR(date, 'DD.MM.YYYY') as date, category, amount, currency, description;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        1264,
        160
      ],
      "id": "81e22fd9-965a-4f94-9f5d-7dccd54a4b6c",
      "name": "Add_expense",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏\nWITH expense_sum AS (\n  SELECT COALESCE(SUM(amount), 0) as total_spent\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    AND category = '{{ $json.category }}'\n    AND date >= DATE_TRUNC('month', CURRENT_DATE)\n),\ncategory_limit AS (\n  SELECT limit_amount\n  FROM limits\n  WHERE user_id = {{ $json.user_id }}\n    AND category = '{{ $json.category }}'\n    AND month = TO_CHAR(CURRENT_DATE, 'YYYY-MM')\n  LIMIT 1\n)\nSELECT \n  e.total_spent,\n  l.limit_amount,\n  CASE \n    WHEN l.limit_amount IS NULL THEN NULL\n    WHEN e.total_spent > l.limit_amount THEN 'exceeded'\n    WHEN e.total_spent > (l.limit_amount * 0.8) THEN 'warning'\n    ELSE 'ok'\n  END as limit_status,\n  CASE\n    WHEN l.limit_amount IS NOT NULL THEN ROUND((e.total_spent / l.limit_amount) * 100)\n    ELSE NULL\n  END as percent_used\nFROM expense_sum e\nLEFT JOIN category_limit l ON true;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        1392,
        160
      ],
      "id": "cf03a04c-f106-489f-86c4-4c63e00ca967",
      "name": "Checking_limits",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        1520,
        160
      ],
      "id": "dca47059-6491-4a57-abc3-06675e42a639",
      "name": "Calc"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT \n  {{ $fromAI(\"amount\", \"–°—É–º–º–∞ –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏, —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ\", \"number\") }} as original_amount,\n  UPPER('{{ $fromAI(\"from_currency\", \"–ò–∑ –∫–∞–∫–æ–π –≤–∞–ª—é—Ç—ã –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å: —Å–æ–º/KGS, –¥–æ–ª–ª–∞—Ä/USD, –µ–≤—Ä–æ/EUR, —Ä—É–±–ª—å/RUB\", \"string\") }}') as from_currency,\n  UPPER('{{ $fromAI(\"to_currency\", \"–í –∫–∞–∫—É—é –≤–∞–ª—é—Ç—É –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å: —Å–æ–º/KGS, –¥–æ–ª–ª–∞—Ä/USD, –µ–≤—Ä–æ/EUR, —Ä—É–±–ª—å/RUB\", \"string\") }}') as to_currency,\n  get_exchange_rate(\n    UPPER('{{ $fromAI(\"from_currency\", \"–ò–∑ –∫–∞–∫–æ–π –≤–∞–ª—é—Ç—ã –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å: —Å–æ–º/KGS, –¥–æ–ª–ª–∞—Ä/USD, –µ–≤—Ä–æ/EUR, —Ä—É–±–ª—å/RUB\", \"string\") }}'),\n    UPPER('{{ $fromAI(\"to_currency\", \"–í –∫–∞–∫—É—é –≤–∞–ª—é—Ç—É –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å: —Å–æ–º/KGS, –¥–æ–ª–ª–∞—Ä/USD, –µ–≤—Ä–æ/EUR, —Ä—É–±–ª—å/RUB\", \"string\") }}'),\n    CURRENT_DATE\n  ) as rate,\n  convert_amount(\n    {{ $fromAI(\"amount\", \"–°—É–º–º–∞ –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏, —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ\", \"number\") }},\n    UPPER('{{ $fromAI(\"from_currency\", \"–ò–∑ –∫–∞–∫–æ–π –≤–∞–ª—é—Ç—ã –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å: —Å–æ–º/KGS, –¥–æ–ª–ª–∞—Ä/USD, –µ–≤—Ä–æ/EUR, —Ä—É–±–ª—å/RUB\", \"string\") }}'),\n    UPPER('{{ $fromAI(\"to_currency\", \"–í –∫–∞–∫—É—é –≤–∞–ª—é—Ç—É –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å: —Å–æ–º/KGS, –¥–æ–ª–ª–∞—Ä/USD, –µ–≤—Ä–æ/EUR, —Ä—É–±–ª—å/RUB\", \"string\") }}'),\n    CURRENT_DATE\n  ) as converted_amount,\n  TO_CHAR(CURRENT_DATE, 'DD.MM.YYYY') as conversion_date;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        1648,
        160
      ],
      "id": "28493685-51e8-4f2f-8adf-ae837898bbe4",
      "name": "Convert_currency",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH latest_rates AS (\n  SELECT DISTINCT ON (from_currency, to_currency)\n    from_currency,\n    to_currency,\n    rate,\n    date,\n    source\n  FROM exchange_rates\n  WHERE from_currency IN ('KGS', 'USD', 'EUR', 'RUB')\n    AND to_currency IN ('KGS', 'USD', 'EUR', 'RUB')\n    AND from_currency != to_currency\n  ORDER BY from_currency, to_currency, date DESC\n)\nSELECT \n  from_currency,\n  to_currency,\n  rate,\n  TO_CHAR(date, 'DD.MM.YYYY') as rate_date,\n  source,\n  CASE \n    WHEN from_currency = 'USD' AND to_currency = 'KGS' THEN 'üíµ –î–æ–ª–ª–∞—Ä ‚Üí –°–æ–º'\n    WHEN from_currency = 'EUR' AND to_currency = 'KGS' THEN 'üí∂ –ï–≤—Ä–æ ‚Üí –°–æ–º'\n    WHEN from_currency = 'RUB' AND to_currency = 'KGS' THEN 'üí∑ –†—É–±–ª—å ‚Üí –°–æ–º'\n    ELSE from_currency || ' ‚Üí ' || to_currency\n  END as display_name\nFROM latest_rates\nORDER BY \n  CASE from_currency \n    WHEN 'USD' THEN 1 \n    WHEN 'EUR' THEN 2 \n    WHEN 'RUB' THEN 3 \n    ELSE 4 \n  END, to_currency;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        1776,
        160
      ],
      "id": "a75df156-38cd-4e39-b8af-38b91c5b0e9d",
      "name": "Get_exchange_rates",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM safe_update_transaction(\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }}::BIGINT,\n  '{{ $fromAI(\"transaction_type\", \"–¢–∏–ø: expense –∏–ª–∏ income (–ù–ï '—Ä–∞—Å—Ö–æ–¥' –∏–ª–∏ '–¥–æ—Ö–æ–¥'!)\", \"string\") }}',\n  '{{ $fromAI(\"transaction_id\", \"ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–ª–∏ 'last' –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–π\", \"string\") }}',\n  '{{ $fromAI(\"field\", \"–ü–æ–ª–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è: amount, category, description, date, currency\", \"string\") }}',\n  '{{ $fromAI(\"new_value\", \"–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–¥–ª—è –¥–∞—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–π DD.MM.YYYY)\", \"string\") }}'\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        1904,
        160
      ],
      "id": "a1c8a433-cac6-490b-b6b0-b77a8ef7cbe0",
      "name": "Edit_transaction",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH found_transaction AS (\n  SELECT \n    CASE \n      WHEN LOWER('{{ $fromAI(\"transaction_id\", \"ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–ª–∏ 'last' –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–π\", \"string\") }}') = 'last' \n      THEN get_last_transaction({{ $('Telegram Bot Trigger').first().json.message.from.id }}, LOWER('{{ $fromAI(\"transaction_type\", \"–¢–∏–ø: expense –∏–ª–∏ income\", \"string\") }}'))\n      ELSE CAST(NULLIF('{{ $fromAI(\"transaction_id\", \"ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–ª–∏ 'last' –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–π\", \"string\") }}', 'last') AS INTEGER)\n    END as tid\n),\ndelete_expense AS (\n  UPDATE expenses\n  SET deleted_at = NOW(),\n      deleted_by = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n  WHERE id = (SELECT tid FROM found_transaction)\n    AND user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND deleted_at IS NULL\n    AND LOWER('{{ $fromAI(\"transaction_type\", \"–¢–∏–ø: expense –∏–ª–∏ income\", \"string\") }}') = 'expense'\n  RETURNING id, amount, category, currency, date\n),\ndelete_income AS (\n  UPDATE income\n  SET deleted_at = NOW(),\n      deleted_by = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n  WHERE id = (SELECT tid FROM found_transaction)\n    AND user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND deleted_at IS NULL\n    AND LOWER('{{ $fromAI(\"transaction_type\", \"–¢–∏–ø: expense –∏–ª–∏ income\", \"string\") }}') = 'income'\n  RETURNING id, amount, category, currency, date\n),\nlog_deletion AS (\n  SELECT log_transaction_change(\n    LOWER('{{ $fromAI(\"transaction_type\", \"–¢–∏–ø: expense –∏–ª–∏ income\", \"string\") }}'),\n    (SELECT tid FROM found_transaction),\n    'deleted',\n    NULL,\n    NULL,\n    NULL,\n    {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n  ) as history_id\n)\nSELECT \n  COALESCE(\n    (SELECT row_to_json(delete_expense.*) FROM delete_expense),\n    (SELECT row_to_json(delete_income.*) FROM delete_income)\n  ) as deleted_transaction,\n  (SELECT history_id FROM log_deletion) as history_id,\n  'deleted' as status;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        2032,
        160
      ],
      "id": "4e992ea7-1ea8-4dbf-a109-01244e6fa72b",
      "name": "Delete_transaction",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH found_transaction AS (\n  SELECT \n    CASE \n      WHEN LOWER('{{ $fromAI(\"transaction_id\", \"ID —É–¥–∞–ª—ë–Ω–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–ª–∏ 'last'\", \"string\") }}') = 'last' \n      THEN get_last_transaction({{ $('Telegram Bot Trigger').first().json.message.from.id }}, LOWER('{{ $fromAI(\"transaction_type\", \"–¢–∏–ø: expense –∏–ª–∏ income\", \"string\") }}'))\n      ELSE CAST(NULLIF('{{ $fromAI(\"transaction_id\", \"ID —É–¥–∞–ª—ë–Ω–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–ª–∏ 'last'\", \"string\") }}', 'last') AS INTEGER)\n    END as tid\n),\nrestore_expense AS (\n  UPDATE expenses\n  SET deleted_at = NULL,\n      deleted_by = NULL\n  WHERE id = (SELECT tid FROM found_transaction)\n    AND user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND deleted_at IS NOT NULL\n    AND LOWER('{{ $fromAI(\"transaction_type\", \"–¢–∏–ø: expense –∏–ª–∏ income\", \"string\") }}') = 'expense'\n  RETURNING id, amount, category, currency, date\n),\nrestore_income AS (\n  UPDATE income\n  SET deleted_at = NULL,\n      deleted_by = NULL\n  WHERE id = (SELECT tid FROM found_transaction)\n    AND user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND deleted_at IS NOT NULL\n    AND LOWER('{{ $fromAI(\"transaction_type\", \"–¢–∏–ø: expense –∏–ª–∏ income\", \"string\") }}') = 'income'\n  RETURNING id, amount, category, currency, date\n),\nlog_restore AS (\n  SELECT log_transaction_change(\n    LOWER('{{ $fromAI(\"transaction_type\", \"–¢–∏–ø: expense –∏–ª–∏ income\", \"string\") }}'),\n    (SELECT tid FROM found_transaction),\n    'restored',\n    NULL,\n    NULL,\n    NULL,\n    {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n  ) as history_id\n)\nSELECT \n  COALESCE(\n    (SELECT row_to_json(restore_expense.*) FROM restore_expense),\n    (SELECT row_to_json(restore_income.*) FROM restore_income)\n  ) as restored_transaction,\n  (SELECT history_id FROM log_restore) as history_id,\n  'restored' as status;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        2128,
        304
      ],
      "id": "03c37d52-42d8-43c3-8e76-fe0d8dc1e0f3",
      "name": "Restore_transaction",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH found_transaction AS (\n  SELECT \n    CASE \n      WHEN LOWER('{{ $fromAI(\"transaction_id\", \"ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–ª–∏ 'last'\", \"string\") }}') = 'last' \n      THEN get_last_transaction({{ $('Telegram Bot Trigger').first().json.message.from.id }}, LOWER('{{ $fromAI(\"transaction_type\", \"–¢–∏–ø: expense –∏–ª–∏ income\", \"string\") }}'))\n      ELSE CAST(NULLIF('{{ $fromAI(\"transaction_id\", \"ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–ª–∏ 'last'\", \"string\") }}', 'last') AS INTEGER)\n    END as tid\n)\nSELECT \n  id,\n  action,\n  field_changed,\n  old_value,\n  new_value,\n  changed_by,\n  TO_CHAR(changed_at, 'DD.MM.YYYY HH24:MI:SS') as changed_at\nFROM transaction_history\nWHERE transaction_type = LOWER('{{ $fromAI(\"transaction_type\", \"–¢–∏–ø: expense –∏–ª–∏ income\", \"string\") }}')\n  AND transaction_id = (SELECT tid FROM found_transaction)\nORDER BY changed_at DESC\nLIMIT 50;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        2288,
        224
      ],
      "id": "5938b065-2804-4274-b8e9-acd67e0f751c",
      "name": "Get_transaction_history",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM create_recurring_payment(\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }}::BIGINT,\n  '{{ $fromAI(\"title\", \"–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä Netflix, –ê—Ä–µ–Ω–¥–∞ –æ—Ñ–∏—Å–∞)\", \"string\") }}'::VARCHAR,\n  {{ $fromAI(\"amount\", \"–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞, —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ\", \"number\") }}::NUMERIC,\n  UPPER('{{ $fromAI(\"currency\", \"–í–∞–ª—é—Ç–∞: KGS/—Å–æ–º, USD/–¥–æ–ª–ª–∞—Ä, EUR/–µ–≤—Ä–æ, RUB/—Ä—É–±–ª—å\", \"string\") }}')::VARCHAR,\n  '{{ $fromAI(\"category\", \"–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ä–∞—Å—Ö–æ–¥–∞: –ø—Ä–æ–¥—É–∫—Ç—ã, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –∞—Ä–µ–Ω–¥–∞ –æ—Ñ–∏—Å–∞, –ø–æ–¥–ø–∏—Å–∫–∏ –∏ —Ç.–¥.\", \"string\") }}'::VARCHAR,\n  LOWER('{{ $fromAI(\"frequency\", \"–ß–∞—Å—Ç–æ—Ç–∞: daily (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ), weekly (–µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ), monthly (–µ–∂–µ–º–µ—Å—è—á–Ω–æ), yearly (–µ–∂–µ–≥–æ–¥–Ω–æ)\", \"string\") }}')::VARCHAR,\n  COALESCE(TO_DATE(NULLIF('{{ $fromAI(\"start_date\", \"–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–µ–≥–æ–¥–Ω—è)\", \"string\", \"\") }}', ''), 'DD.MM.YYYY'), CURRENT_DATE),\n  NULL::TEXT,\n  'expense'::VARCHAR,\n  {{ $fromAI(\"interval_value\", \"–ö–∞–∂–¥—ã–µ N –ø–µ—Ä–∏–æ–¥–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä 1 –¥–ª—è –∫–∞–∂–¥—ã–π –º–µ—Å—è—Ü, 2 –¥–ª—è –∫–∞–∂–¥—ã–µ 2 –Ω–µ–¥–µ–ª–∏)\", \"number\", 1) }}::INTEGER,\n  {{ $fromAI(\"remind_days_before\", \"–ó–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3)\", \"number\", 3) }}::INTEGER,\n  {{ $fromAI(\"auto_create\", \"–°–æ–∑–¥–∞–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: true –∏–ª–∏ false (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é false)\", \"boolean\", false) }}::BOOLEAN\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        2416,
        352
      ],
      "id": "925d4075-48bc-4c66-9c20-01bf079a2fb1",
      "name": "Create_recurring_payment",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT \n  id,\n  title,\n  amount,\n  currency,\n  category,\n  frequency,\n  interval_value,\n  TO_CHAR(next_payment_date, 'DD.MM.YYYY') as next_payment_date,\n  remind_days_before,\n  auto_create,\n  total_executions,\n  TO_CHAR(created_at, 'DD.MM.YYYY') as created_at\nFROM recurring_payments\nWHERE user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n  AND is_active = true\n  AND (end_date IS NULL OR end_date >= CURRENT_DATE)\nORDER BY next_payment_date ASC;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        2544,
        160
      ],
      "id": "d9a4068b-144a-48e9-bb93-c851799bc316",
      "name": "List_recurring_payments",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE recurring_payments\nSET \n  is_active = false,\n  end_date = CURRENT_DATE,\n  updated_at = NOW()\nWHERE id = {{ $fromAI(\"payment_id\", \"ID –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è –æ—Ç–º–µ–Ω—ã\", \"number\") }}\n  AND user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n  AND is_active = true\nRETURNING \n  id,\n  title,\n  amount,\n  currency,\n  'cancelled' as status,\n  TO_CHAR(end_date, 'DD.MM.YYYY') as cancelled_date;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        2656,
        368
      ],
      "id": "24b919e5-9c5e-4f7d-b2b7-faebf41c3552",
      "name": "Cancel_recurring_payment",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM get_budget_forecast(\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }}::BIGINT\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        2800,
        160
      ],
      "id": "ef73c36b-3984-4dc7-8ff3-b4082d0f3d09",
      "name": "Get_budget_forecast",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT \n  id,\n  notification_type,\n  title,\n  message,\n  priority,\n  is_read,\n  TO_CHAR(created_at, 'DD.MM.YYYY HH24:MI') as created_at,\n  related_transaction_id,\n  metadata\nFROM notifications\nWHERE user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n  AND ({{ $fromAI(\"unread_only\", \"–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ: true –∏–ª–∏ false\", \"boolean\", true) }} = false OR is_read = false)\nORDER BY \n  CASE priority \n    WHEN 'urgent' THEN 1 \n    WHEN 'high' THEN 2 \n    WHEN 'normal' THEN 3 \n    ELSE 4 \n  END,\n  created_at DESC\nLIMIT {{ $fromAI(\"limit\", \"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –ø–æ–∫–∞–∑–∞\", \"number\", 10) }};",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        2928,
        160
      ],
      "id": "8301336c-adaf-419f-a6a6-c38adf2f61d2",
      "name": "Get_notifications",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO budget_alerts_config (\n  user_id,\n  budget_warning_threshold,\n  budget_critical_threshold,\n  category_warning_threshold,\n  category_critical_threshold,\n  max_alerts_per_day,\n  updated_at\n) VALUES (\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }},\n  {{ $fromAI(\"budget_warning\", \"–ü–æ—Ä–æ–≥ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –±—é–¥–∂–µ—Ç–µ –≤ % (–Ω–∞–ø—Ä–∏–º–µ—Ä 75, 80, 90)\", \"number\", 80) }},\n  {{ $fromAI(\"budget_critical\", \"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ä–æ–≥ –±—é–¥–∂–µ—Ç–∞ –≤ % (–æ–±—ã—á–Ω–æ 100)\", \"number\", 100) }},\n  {{ $fromAI(\"category_warning\", \"–ü–æ—Ä–æ–≥ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –¥–ª—è –ª–∏–º–∏—Ç–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –≤ %\", \"number\", 80) }},\n  {{ $fromAI(\"category_critical\", \"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ä–æ–≥ –¥–ª—è –ª–∏–º–∏—Ç–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –≤ %\", \"number\", 100) }},\n  {{ $fromAI(\"max_alerts_per_day\", \"–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –¥–µ–Ω—å\", \"number\", 5) }},\n  NOW()\n)\nON CONFLICT (user_id) \nDO UPDATE SET\n  budget_warning_threshold = EXCLUDED.budget_warning_threshold,\n  budget_critical_threshold = EXCLUDED.budget_critical_threshold,\n  category_warning_threshold = EXCLUDED.category_warning_threshold,\n  category_critical_threshold = EXCLUDED.category_critical_threshold,\n  max_alerts_per_day = EXCLUDED.max_alerts_per_day,\n  updated_at = NOW()\nRETURNING \n  user_id,\n  budget_warning_threshold,\n  budget_critical_threshold,\n  category_warning_threshold,\n  category_critical_threshold,\n  max_alerts_per_day,\n  'configured' as status;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        3056,
        160
      ],
      "id": "0238fa10-d749-4071-84a4-8faf6e1796ea",
      "name": "Configure_alerts",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n)\nSELECT * FROM get_income_expense_stats(\n  (SELECT workspace_id FROM user_workspace),\n  '{{ $fromAI(\"start_date\", \"–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∞—á–∞–ª–æ –º–µ—Å—è—Ü–∞)\", \"string\", DATE_TRUNC('month', CURRENT_DATE)::TEXT) }}'::DATE,\n  '{{ $fromAI(\"end_date\", \"–î–∞—Ç–∞ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–∏–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–µ–≥–æ–¥–Ω—è)\", \"string\", CURRENT_DATE::TEXT) }}'::DATE\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        3184,
        160
      ],
      "id": "eda68622-f5df-4f10-b359-83361f14ef25",
      "name": "Get_income_expense_stats",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n)\nSELECT * FROM get_top_expense_categories(\n  (SELECT workspace_id FROM user_workspace),\n  '{{ $fromAI(\"start_date\", \"–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∞—á–∞–ª–æ –º–µ—Å—è—Ü–∞)\", \"string\", DATE_TRUNC('month', CURRENT_DATE)::TEXT) }}'::DATE,\n  '{{ $fromAI(\"end_date\", \"–î–∞—Ç–∞ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–∏–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–µ–≥–æ–¥–Ω—è)\", \"string\", CURRENT_DATE::TEXT) }}'::DATE,\n  {{ $fromAI(\"limit\", \"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è –ø–æ–∫–∞–∑–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10)\", \"number\", 10) }}\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        3312,
        160
      ],
      "id": "490d43ed-a02a-4f24-b16e-1dabf6cddc4e",
      "name": "Get_top_categories",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM get_user_workspaces(\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }}::BIGINT\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        3440,
        160
      ],
      "id": "f5daefee-c872-4767-8872-74eecaf0edaa",
      "name": "Get_workspaces",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM update_spending_patterns(\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }}::BIGINT\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        3568,
        160
      ],
      "id": "e4967d3b-1d3b-48ad-bf6f-63fa214596e2",
      "name": "Update_spending_patterns",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n)\nINSERT INTO budgets (user_id, workspace_id, month, budget_amount, currency)\nSELECT\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }},\n  uw.workspace_id,\n  COALESCE(\n    '{{ $fromAI(\"month\", \"–ú–µ—Å—è—Ü –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM (–Ω–∞–ø—Ä–∏–º–µ—Ä 2025-11), –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω - —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü\", \"string\", \"\") }}',\n    TO_CHAR(CURRENT_DATE, 'YYYY-MM')\n  ),\n  {{ $fromAI(\"amount\", \"–°—É–º–º–∞ –±—é–¥–∂–µ—Ç–∞, —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ\", \"number\") }},\n  UPPER('{{ $fromAI(\"currency\", \"–í–∞–ª—é—Ç–∞ –±—é–¥–∂–µ—Ç–∞: KGS/USD/EUR/RUB (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é KGS)\", \"string\", \"KGS\") }}')\nFROM user_workspace uw\nON CONFLICT (user_id, month) \nDO UPDATE SET \n  budget_amount = EXCLUDED.budget_amount,\n  currency = EXCLUDED.currency,\n  updated_at = NOW()\nRETURNING \n  id,\n  month,\n  budget_amount,\n  currency,\n  'budget_set' as status;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        3696,
        160
      ],
      "id": "ebb30d02-cfb3-4c35-b475-c42124b25c63",
      "name": "Set_budget",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n)\nINSERT INTO limits (user_id, workspace_id, category, month, limit_amount, currency)\nSELECT\n  {{ $('Telegram Bot Trigger').first().json.message.from.id }},\n  uw.workspace_id,\n  '{{ $fromAI(\"category\", \"–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–ª—è –ª–∏–º–∏—Ç–∞: –ø—Ä–æ–¥—É–∫—Ç—ã, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –∫–∞—Ñ–µ/—Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã –∏ —Ç.–¥.\", \"string\") }}',\n  COALESCE(\n    '{{ $fromAI(\"month\", \"–ú–µ—Å—è—Ü –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM (–Ω–∞–ø—Ä–∏–º–µ—Ä 2025-11), –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω - —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü\", \"string\", \"\") }}',\n    TO_CHAR(CURRENT_DATE, 'YYYY-MM')\n  ),\n  {{ $fromAI(\"amount\", \"–°—É–º–º–∞ –ª–∏–º–∏—Ç–∞, —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ\", \"number\") }},\n  UPPER('{{ $fromAI(\"currency\", \"–í–∞–ª—é—Ç–∞ –ª–∏–º–∏—Ç–∞: KGS/USD/EUR/RUB (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é KGS)\", \"string\", \"KGS\") }}')\nFROM user_workspace uw\nON CONFLICT (user_id, category, month) \nDO UPDATE SET \n  limit_amount = EXCLUDED.limit_amount,\n  currency = EXCLUDED.currency,\n  updated_at = NOW()\nRETURNING \n  id,\n  category,\n  month,\n  limit_amount,\n  currency,\n  'limit_set' as status;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        3824,
        160
      ],
      "id": "8cbcc1f7-8719-4ad3-8a56-c2c23433025b",
      "name": "Set_category_limit",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.message.text }}",
        "options": {
          "systemMessage": "–¢—ã —Ñ–∏–Ω–∞–Ω—Å–∏—Å—Ç –∏ –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –æ—Ç—á–µ—Ç–∞–º –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—É /get_week_report. –¢—ã –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∞—Ç—å –û—Ç—á–µ—Ç—ã –∑–∞ –ø–æ—Å–ª–µ–Ω—é—é –Ω–µ–¥–µ–ª—é –∏—Å–ø–æ–ª—å–∑—É—è –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö get_last_week_report, –¥–µ–ª–∏—Ç—å —ç—Ç—É –Ω–µ–¥–µ–ª—é –Ω–∞ –¥–Ω–∏, –∏ —Å–∫–æ–ª—å–∫–æ –±—ã–ª–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ –≤ –∫–∞–∫–æ–π –¥–µ–Ω—å"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        16,
        464
      ],
      "id": "6474cf77-b0ac-4a8f-be41-d5f28ec195d1",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -160,
        688
      ],
      "id": "5a5ef7eb-29fd-4917-b967-d3139f9ab4fc",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "SyI2pOUeSfbt1JRh",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.message.text }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -32,
        688
      ],
      "id": "e2e2ba2f-0a26-4e57-8b9d-5662b204f5a3",
      "name": "Simple Memory"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        96,
        688
      ],
      "id": "d6a551c9-9807-4b2e-a859-63309375a941",
      "name": "Calculator"
    },
    {
      "parameters": {
        "resource": "pdf",
        "pdfTemplateId": "c1d77b23eda325b2",
        "jsonParameters": true,
        "propertiesJson": "{\n  \"name\": \"apitemplate.io\",\n  \"sales\": {\n    \"data\": [30,40,45,50,49,60,70,91,125],\n    \"categories\": [1991,1992,1993,1994,1995,1996,1997,1998,1999]\n  },\n  \"team\": {\n    \"data\": [44,55,13,43,22],\n    \"labels\": [\"Team A\",\"Team B\",\"Team C\",\"Team D\",\"Team E\"]\n  }\n}"
      },
      "type": "n8n-nodes-base.apiTemplateIo",
      "typeVersion": 1,
      "position": [
        592,
        464
      ],
      "id": "b92bac80-3905-45fa-8bfe-8acdb2e5bdcd",
      "name": "Create a pdf",
      "credentials": {
        "apiTemplateIoApi": {
          "id": "WCFzWPXSnueTP8ef",
          "name": "APITemplate.io Financer"
        }
      }
    },
    {
      "parameters": {
        "resource": "pdf",
        "pdfTemplateId": "c1d77b23eda325b2",
        "jsonParameters": true,
        "propertiesJson": "{\n  \"name\": \"apitemplate.io\",\n  \"sales\": {\n    \"data\": [30,40,45,50,49,60,70,91,125],\n    \"categories\": [1991,1992,1993,1994,1995,1996,1997,1998,1999]\n  },\n  \"team\": {\n    \"data\": [44,55,13,43,22],\n    \"labels\": [\"Team A\",\"Team B\",\"Team C\",\"Team D\",\"Team E\"]\n  }\n}"
      },
      "type": "n8n-nodes-base.apiTemplateIoTool",
      "typeVersion": 1,
      "position": [
        -1088,
        1472
      ],
      "id": "d3dcdaf7-c08e-4901-b0d3-8fc6ee5dd9bf",
      "name": "Create a pdf in APITemplate.io",
      "credentials": {
        "apiTemplateIoApi": {
          "id": "WCFzWPXSnueTP8ef",
          "name": "APITemplate.io Financer"
        }
      }
    },
    {
      "parameters": {
        "fieldsToSummarize": {
          "values": [
            {}
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.summarize",
      "typeVersion": 1.1,
      "position": [
        -1088,
        1248
      ],
      "id": "abae57a4-79e5-4eb9-8c30-6d76cbac81d6",
      "name": "Summarize"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -1088,
        608
      ],
      "id": "750996e1-1af5-4d2c-ae99-088f3b537304",
      "name": "Create a row"
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Get many rows in Supabase for last week",
        "operation": "getAll",
        "tableId": "expenses",
        "returnAll": true
      },
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [
        256,
        688
      ],
      "id": "f03caf08-0868-480e-9c7d-b787898b55b4",
      "name": "get_last_week_report",
      "credentials": {
        "supabaseApi": {
          "id": "4sTmVPkkZSWPshRg",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nfor (const item of $input.all()) {\n  item.json.myNewField = 1;\n}\n\nreturn $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        352,
        464
      ],
      "id": "832b6761-e922-4427-b0d6-b40a9d94fa10",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {}
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -256,
        464
      ],
      "id": "f9dbdff0-3f80-40dc-a075-17035a60f8f6",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "operation": "sendAndWait",
        "options": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        48,
        192
      ],
      "id": "07dc5571-2582-41d4-9b02-599f7d556652",
      "name": "Send message and wait for response",
      "webhookId": "b4d6a181-4071-49c8-9504-488e7d1b8d14",
      "credentials": {
        "telegramApi": {
          "id": "SO5qHfnQFuR8HmVU",
          "name": "UGC"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "url": "={{ $json.download_url }}",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {}
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        800,
        464
      ],
      "id": "a9f364c2-b68d-4074-93a8-7f7cd8d9bbe0",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "operation": "sendDocument",
        "chatId": "={{ $('Telegram Bot Trigger').item.json.message.chat.id }}",
        "file": "={{ $json.download_url }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1008,
        464
      ],
      "id": "7ba4bde6-c1d1-49d8-a5f6-61b16f1a7237",
      "name": "Send a document",
      "webhookId": "aacbbe26-503f-4111-bf0a-72c6df95e208",
      "credentials": {
        "telegramApi": {
          "id": "WabnlnnS7XdATC3n",
          "name": "Alikbek Financer"
        }
      }
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 21 * * *"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -256,
        720
      ],
      "id": "daily-report-trigger",
      "name": "Daily Report Trigger"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 9 * * 1"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -256,
        960
      ],
      "id": "weekly-report-trigger",
      "name": "Weekly Report Trigger"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 10 1 * *"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -256,
        1200
      ],
      "id": "monthly-report-trigger",
      "name": "Monthly Report Trigger"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞\nSELECT DISTINCT\n  u.user_id,\n  u.telegram_chat_id,\n  u.first_name,\n  w.id as workspace_id\nFROM users u\nJOIN workspace_members wm ON u.user_id = wm.user_id\nJOIN workspaces w ON wm.workspace_id = w.id\nWHERE u.telegram_chat_id IS NOT NULL\n  AND wm.is_active = true\n  AND w.is_active = true\n  AND u.last_activity >= NOW() - INTERVAL '7 days'\nORDER BY u.user_id;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        64,
        720
      ],
      "id": "get-active-users",
      "name": "Get Active Users",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ —Å–µ–≥–æ–¥–Ω—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\nWITH today_expenses AS (\n  SELECT \n    COALESCE(SUM(amount), 0) as total_expenses,\n    COUNT(*) as expense_count,\n    json_agg(\n      json_build_object(\n        'category', category,\n        'amount', amount,\n        'currency', currency,\n        'description', description\n      ) ORDER BY amount DESC\n    ) as expenses_detail\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    AND workspace_id = {{ $json.workspace_id }}\n    AND DATE(date) = CURRENT_DATE\n    AND deleted_at IS NULL\n),\ntoday_income AS (\n  SELECT \n    COALESCE(SUM(amount), 0) as total_income,\n    COUNT(*) as income_count\n  FROM income\n  WHERE user_id = {{ $json.user_id }}\n    AND workspace_id = {{ $json.workspace_id }}\n    AND DATE(date) = CURRENT_DATE\n    AND deleted_at IS NULL\n),\nmonth_stats AS (\n  SELECT \n    COALESCE(SUM(amount), 0) as month_expenses\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    AND workspace_id = {{ $json.workspace_id }}\n    AND DATE_TRUNC('month', date) = DATE_TRUNC('month', CURRENT_DATE)\n    AND deleted_at IS NULL\n),\nbudget_info AS (\n  SELECT budget_amount, currency\n  FROM budgets\n  WHERE user_id = {{ $json.user_id }}\n    AND workspace_id = {{ $json.workspace_id }}\n    AND month = TO_CHAR(CURRENT_DATE, 'YYYY-MM')\n  LIMIT 1\n)\nSELECT \n  {{ $json.user_id }} as user_id,\n  {{ $json.telegram_chat_id }} as chat_id,\n  '{{ $json.first_name }}' as user_name,\n  te.total_expenses,\n  te.expense_count,\n  te.expenses_detail,\n  ti.total_income,\n  ti.income_count,\n  ms.month_expenses,\n  bi.budget_amount,\n  bi.currency as budget_currency,\n  CASE \n    WHEN bi.budget_amount > 0 THEN ROUND((ms.month_expenses / bi.budget_amount) * 100, 1)\n    ELSE 0\n  END as budget_used_percent\nFROM today_expenses te\nCROSS JOIN today_income ti\nCROSS JOIN month_stats ms\nLEFT JOIN budget_info bi ON true;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        384,
        720
      ],
      "id": "get-daily-stats",
      "name": "Get Daily Stats",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=–°–æ–∑–¥–∞–π –∫—Ä–∞—Ç–∫–∏–π –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–∏—Ö –¥–∞–Ω–Ω—ã—Ö:\n\nüë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {{ $json.user_name }}\nüìÖ –î–∞—Ç–∞: {{ new Date().toLocaleDateString('ru-RU') }}\n\nüí∏ –°–ï–ì–û–î–ù–Ø:\n- –†–∞—Å—Ö–æ–¥—ã: {{ $json.total_expenses }} —Å–æ–º ({{ $json.expense_count }} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)\n- –î–æ—Ö–æ–¥—ã: {{ $json.total_income }} —Å–æ–º ({{ $json.income_count }} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)\n- –ë–∞–ª–∞–Ω—Å –¥–Ω—è: {{ $json.total_income - $json.total_expenses }} —Å–æ–º\n\nüìä –ú–ï–°–Ø–¶:\n- –ü–æ—Ç—Ä–∞—á–µ–Ω–æ: {{ $json.month_expenses }} —Å–æ–º\n- –ë—é–¥–∂–µ—Ç: {{ $json.budget_amount || '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' }} {{ $json.budget_currency || '' }}\n- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –±—é–¥–∂–µ—Ç–∞: {{ $json.budget_used_percent }}%\n\nüìã –î–µ—Ç–∞–ª–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è:\n{{ JSON.stringify($json.expenses_detail, null, 2) }}\n\n–ù–∞–ø–∏—à–∏:\n1. –ö—Ä–∞—Ç–∫–∏–π –∏—Ç–æ–≥ –¥–Ω—è (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)\n2. –ê–Ω–∞–ª–∏–∑ —Ç—Ä–∞—Ç (—á—Ç–æ –∑–∞–º–µ—Ç–∏–ª)\n3. –û–¥–∏–Ω –ø–æ–ª–µ–∑–Ω—ã–π —Å–æ–≤–µ—Ç –∏–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é\n\n–§–æ—Ä–º–∞—Ç: –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π, —Å —ç–º–æ–¥–∑–∏. –ú–∞–∫—Å–∏–º—É–º 10 —Å—Ç—Ä–æ–∫.",
        "options": {
          "systemMessage": "–¢—ã —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –¥–µ–ª–∞–µ—Ç –∫—Ä–∞—Ç–∫–∏–µ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –æ—Ç—á–µ—Ç—ã. –ì–æ–≤–æ—Ä–∏ –ø–æ-—Ä—É—Å—Å–∫–∏, –∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏, –±—É–¥—å –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–º –∏ –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–º."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        704,
        720
      ],
      "id": "daily-report-ai",
      "name": "Daily Report AI"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        832,
        880
      ],
      "id": "daily-openai-model",
      "name": "OpenAI Daily Model",
      "credentials": {
        "openAiApi": {
          "id": "SyI2pOUeSfbt1JRh",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "=üåô *–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç*\n\n{{ $('Daily Report AI').item.json.output }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1024,
        720
      ],
      "id": "send-daily-report",
      "name": "Send Daily Report",
      "webhookId": "daily-report-send",
      "credentials": {
        "telegramApi": {
          "id": "WabnlnnS7XdATC3n",
          "name": "Alikbek Financer"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ –Ω–µ–¥–µ–ª—é –¥–ª—è –æ—Ç—á–µ—Ç–∞\nWITH week_expenses AS (\n  SELECT \n    DATE(date) as expense_date,\n    category,\n    SUM(amount) as daily_total,\n    currency,\n    COUNT(*) as transaction_count\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    AND workspace_id = {{ $json.workspace_id }}\n    AND date >= CURRENT_DATE - INTERVAL '7 days'\n    AND deleted_at IS NULL\n  GROUP BY DATE(date), category, currency\n  ORDER BY DATE(date) DESC, daily_total DESC\n),\nweek_income AS (\n  SELECT \n    DATE(date) as income_date,\n    category,\n    SUM(amount) as daily_total,\n    currency\n  FROM income\n  WHERE user_id = {{ $json.user_id }}\n    AND workspace_id = {{ $json.workspace_id }}\n    AND date >= CURRENT_DATE - INTERVAL '7 days'\n    AND deleted_at IS NULL\n  GROUP BY DATE(date), category, currency\n  ORDER BY DATE(date) DESC\n),\nweek_summary AS (\n  SELECT \n    COALESCE(SUM(we.daily_total), 0) as total_expenses,\n    COALESCE(SUM(wi.daily_total), 0) as total_income,\n    (SELECT COUNT(*) FROM expenses WHERE user_id = {{ $json.user_id }} AND workspace_id = {{ $json.workspace_id }} AND date >= CURRENT_DATE - INTERVAL '7 days' AND deleted_at IS NULL) as expense_count,\n    (SELECT COUNT(*) FROM income WHERE user_id = {{ $json.user_id }} AND workspace_id = {{ $json.workspace_id }} AND date >= CURRENT_DATE - INTERVAL '7 days' AND deleted_at IS NULL) as income_count\n  FROM week_expenses we\n  FULL OUTER JOIN week_income wi ON we.expense_date = wi.income_date\n),\ntop_categories AS (\n  SELECT \n    category,\n    SUM(amount) as category_total,\n    ROUND((SUM(amount) / (SELECT SUM(amount) FROM expenses WHERE user_id = {{ $json.user_id }} AND workspace_id = {{ $json.workspace_id }} AND date >= CURRENT_DATE - INTERVAL '7 days' AND deleted_at IS NULL)) * 100, 1) as percentage\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    AND workspace_id = {{ $json.workspace_id }}\n    AND date >= CURRENT_DATE - INTERVAL '7 days'\n    AND deleted_at IS NULL\n  GROUP BY category\n  ORDER BY category_total DESC\n  LIMIT 5\n)\nSELECT \n  {{ $json.user_id }} as user_id,\n  {{ $json.telegram_chat_id }} as chat_id,\n  '{{ $json.first_name }}' as user_name,\n  {{ $json.workspace_id }} as workspace_id,\n  (SELECT json_agg(row_to_json(we.*)) FROM week_expenses we) as expenses_by_day,\n  (SELECT json_agg(row_to_json(wi.*)) FROM week_income wi) as income_by_day,\n  ws.total_expenses,\n  ws.total_income,\n  ws.expense_count,\n  ws.income_count,\n  (SELECT json_agg(row_to_json(tc.*)) FROM top_categories tc) as top_categories,\n  TO_CHAR(CURRENT_DATE - INTERVAL '7 days', 'DD.MM.YYYY') as period_start,\n  TO_CHAR(CURRENT_DATE, 'DD.MM.YYYY') as period_end\nFROM week_summary ws;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        384,
        960
      ],
      "id": "get-weekly-data",
      "name": "Get Weekly Data",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ PDF –æ—Ç—á–µ—Ç–∞\nconst data = $input.first().json;\n\n// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –¥–Ω—è–º –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞\nconst expensesByDay = data.expenses_by_day || [];\nconst incomeByDay = data.income_by_day || [];\n\n// –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –¥–∞—Ç –∏ —Å—É–º–º –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞\nconst dates = [];\nconst expensesData = [];\nconst incomeData = [];\n\n// –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –¥–Ω—è–º\nconst expenseMap = {};\nexpensesByDay.forEach(exp => {\n  const date = new Date(exp.expense_date).toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });\n  if (!expenseMap[date]) {\n    expenseMap[date] = 0;\n  }\n  expenseMap[date] += parseFloat(exp.daily_total || 0);\n});\n\n// –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–æ—Ö–æ–¥—ã –ø–æ –¥–Ω—è–º\nconst incomeMap = {};\nincomeByDay.forEach(inc => {\n  const date = new Date(inc.income_date).toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });\n  if (!incomeMap[date]) {\n    incomeMap[date] = 0;\n  }\n  incomeMap[date] += parseFloat(inc.daily_total || 0);\n});\n\n// –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –¥–∞—Ç—ã\nconst allDates = [...new Set([...Object.keys(expenseMap), ...Object.keys(incomeMap)])];\nallDates.sort();\n\n// –ó–∞–ø–æ–ª–Ω—è–µ–º –º–∞—Å—Å–∏–≤—ã –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞\nallDates.forEach(date => {\n  dates.push(date);\n  expensesData.push(Math.round(expenseMap[date] || 0));\n  incomeData.push(Math.round(incomeMap[date] || 0));\n});\n\n// –¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ä–∞—Å—Ö–æ–¥–æ–≤\nconst topCategories = (data.top_categories || []).map(cat => ({\n  label: cat.category,\n  value: Math.round(parseFloat(cat.category_total || 0)),\n  percentage: parseFloat(cat.percentage || 0)\n}));\n\n// –î–∞–Ω–Ω—ã–µ –¥–ª—è –∫—Ä—É–≥–æ–≤–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã\nconst categoryLabels = topCategories.map(c => c.label);\nconst categoryValues = topCategories.map(c => c.value);\n\n// –ò—Ç–æ–≥–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ\nconst result = {\n  // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –ø–µ—Ä–∏–æ–¥\n  title: `üìä –ù–µ–¥–µ–ª—å–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç`,\n  user_name: data.user_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',\n  period: `${data.period_start} - ${data.period_end}`,\n  \n  // –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏\n  total_expenses: Math.round(parseFloat(data.total_expenses || 0)),\n  total_income: Math.round(parseFloat(data.total_income || 0)),\n  balance: Math.round(parseFloat(data.total_income || 0) - parseFloat(data.total_expenses || 0)),\n  transaction_count: parseInt(data.expense_count || 0) + parseInt(data.income_count || 0),\n  expense_count: parseInt(data.expense_count || 0),\n  income_count: parseInt(data.income_count || 0),\n  \n  // –ì—Ä–∞—Ñ–∏–∫ –¥–æ—Ö–æ–¥–æ–≤/—Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –¥–Ω—è–º\n  daily_chart: {\n    labels: dates,\n    datasets: [\n      {\n        label: '–†–∞—Å—Ö–æ–¥—ã',\n        data: expensesData,\n        backgroundColor: 'rgba(255, 99, 132, 0.8)',\n        borderColor: 'rgb(255, 99, 132)'\n      },\n      {\n        label: '–î–æ—Ö–æ–¥—ã',\n        data: incomeData,\n        backgroundColor: 'rgba(75, 192, 192, 0.8)',\n        borderColor: 'rgb(75, 192, 192)'\n      }\n    ]\n  },\n  \n  // –ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ —Ç–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π\n  category_chart: {\n    labels: categoryLabels,\n    data: categoryValues\n  },\n  \n  // –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π\n  top_categories_table: topCategories,\n  \n  // –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –¥–Ω—è–º\n  daily_details: allDates.map(date => ({\n    date: date,\n    expenses: expenseMap[date] || 0,\n    income: incomeMap[date] || 0,\n    balance: (incomeMap[date] || 0) - (expenseMap[date] || 0)\n  })),\n  \n  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏\n  avg_daily_expense: Math.round(parseFloat(data.total_expenses || 0) / 7),\n  avg_daily_income: Math.round(parseFloat(data.total_income || 0) / 7)\n};\n\nreturn [{ json: result }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        560,
        960
      ],
      "id": "format-weekly-data",
      "name": "Format Weekly Data"
    },
    {
      "parameters": {
        "resource": "pdf",
        "pdfTemplateId": "5a677b23ed6c2fe6",
        "jsonParameters": true,
        "propertiesJson": "={{ JSON.stringify($json) }}"
      },
      "type": "n8n-nodes-base.apiTemplateIo",
      "typeVersion": 1,
      "position": [
        704,
        960
      ],
      "id": "generate-weekly-pdf",
      "name": "Generate Weekly PDF",
      "credentials": {
        "apiTemplateIoApi": {
          "id": "WCFzWPXSnueTP8ef",
          "name": "APITemplate.io Financer"
        }
      }
    },
    {
      "parameters": {
        "operation": "sendDocument",
        "chatId": "={{ $('Get Weekly Data').item.json.chat_id }}",
        "file": "={{ $json.download_url }}",
        "additionalFields": {
          "caption": "=üìä *–ù–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç*\n\nüìÖ –ü–µ—Ä–∏–æ–¥: {{ $('Format Weekly Data').item.json.period }}\nüë§ {{ $('Format Weekly Data').item.json.user_name }}\n\nüí∏ –†–∞—Å—Ö–æ–¥—ã: {{ $('Format Weekly Data').item.json.total_expenses }} —Å–æ–º\nüí∞ –î–æ—Ö–æ–¥—ã: {{ $('Format Weekly Data').item.json.total_income }} —Å–æ–º\nüìà –ë–∞–ª–∞–Ω—Å: {{ $('Format Weekly Data').item.json.balance }} —Å–æ–º\n\nüìù –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: {{ $('Format Weekly Data').item.json.transaction_count }}\nüìä –°—Ä–µ–¥–Ω–µ–µ –≤ –¥–µ–Ω—å: {{ $('Format Weekly Data').item.json.avg_daily_expense }} —Å–æ–º",
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1024,
        960
      ],
      "id": "send-weekly-pdf",
      "name": "Send Weekly PDF",
      "webhookId": "weekly-pdf-send",
      "credentials": {
        "telegramApi": {
          "id": "WabnlnnS7XdATC3n",
          "name": "Alikbek Financer"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ –º–µ—Å—è—Ü –¥–ª—è –æ—Ç—á–µ—Ç–∞\nWITH month_expenses AS (\n  SELECT \n    DATE(date) as expense_date,\n    category,\n    SUM(amount) as daily_total,\n    currency,\n    COUNT(*) as transaction_count\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    AND workspace_id = {{ $json.workspace_id }}\n    AND DATE_TRUNC('month', date) = DATE_TRUNC('month', CURRENT_DATE - INTERVAL '1 month')\n    AND deleted_at IS NULL\n  GROUP BY DATE(date), category, currency\n  ORDER BY DATE(date) DESC, daily_total DESC\n),\nmonth_income AS (\n  SELECT \n    DATE(date) as income_date,\n    category,\n    SUM(amount) as daily_total,\n    currency\n  FROM income\n  WHERE user_id = {{ $json.user_id }}\n    AND workspace_id = {{ $json.workspace_id }}\n    AND DATE_TRUNC('month', date) = DATE_TRUNC('month', CURRENT_DATE - INTERVAL '1 month')\n    AND deleted_at IS NULL\n  GROUP BY DATE(date), category, currency\n  ORDER BY DATE(date) DESC\n),\nmonth_summary AS (\n  SELECT \n    COALESCE(SUM(amount), 0) as total_expenses,\n    COUNT(*) as expense_count\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    AND workspace_id = {{ $json.workspace_id }}\n    AND DATE_TRUNC('month', date) = DATE_TRUNC('month', CURRENT_DATE - INTERVAL '1 month')\n    AND deleted_at IS NULL\n),\nmonth_income_summary AS (\n  SELECT \n    COALESCE(SUM(amount), 0) as total_income,\n    COUNT(*) as income_count\n  FROM income\n  WHERE user_id = {{ $json.user_id }}\n    AND workspace_id = {{ $json.workspace_id }}\n    AND DATE_TRUNC('month', date) = DATE_TRUNC('month', CURRENT_DATE - INTERVAL '1 month')\n    AND deleted_at IS NULL\n),\ncategory_breakdown AS (\n  SELECT \n    category,\n    SUM(amount) as category_total,\n    COUNT(*) as category_count,\n    ROUND(AVG(amount), 2) as avg_transaction,\n    ROUND((SUM(amount) / (SELECT total_expenses FROM month_summary)) * 100, 1) as percentage\n  FROM expenses\n  WHERE user_id = {{ $json.user_id }}\n    AND workspace_id = {{ $json.workspace_id }}\n    AND DATE_TRUNC('month', date) = DATE_TRUNC('month', CURRENT_DATE - INTERVAL '1 month')\n    AND deleted_at IS NULL\n  GROUP BY category\n  ORDER BY category_total DESC\n),\nbudget_comparison AS (\n  SELECT \n    budget_amount,\n    currency,\n    (SELECT total_expenses FROM month_summary) as actual_expenses,\n    CASE \n      WHEN budget_amount > 0 THEN ROUND(((SELECT total_expenses FROM month_summary) / budget_amount) * 100, 1)\n      ELSE 0\n    END as budget_used_percent\n  FROM budgets\n  WHERE user_id = {{ $json.user_id }}\n    AND workspace_id = {{ $json.workspace_id }}\n    AND month = TO_CHAR(CURRENT_DATE - INTERVAL '1 month', 'YYYY-MM')\n  LIMIT 1\n)\nSELECT \n  {{ $json.user_id }} as user_id,\n  {{ $json.telegram_chat_id }} as chat_id,\n  '{{ $json.first_name }}' as user_name,\n  {{ $json.workspace_id }} as workspace_id,\n  ms.total_expenses,\n  mis.total_income,\n  ms.expense_count,\n  mis.income_count,\n  (SELECT json_agg(row_to_json(me.*)) FROM month_expenses me) as expenses_by_day,\n  (SELECT json_agg(row_to_json(mi.*)) FROM month_income mi) as income_by_day,\n  (SELECT json_agg(row_to_json(cb.*)) FROM category_breakdown cb) as category_breakdown,\n  bc.budget_amount,\n  bc.currency as budget_currency,\n  bc.budget_used_percent,\n  TO_CHAR(DATE_TRUNC('month', CURRENT_DATE - INTERVAL '1 month'), 'DD.MM.YYYY') as period_start,\n  TO_CHAR(DATE_TRUNC('month', CURRENT_DATE - INTERVAL '1 month') + INTERVAL '1 month' - INTERVAL '1 day', 'DD.MM.YYYY') as period_end,\n  TO_CHAR(DATE_TRUNC('month', CURRENT_DATE - INTERVAL '1 month'), 'Month YYYY') as month_name\nFROM month_summary ms\nCROSS JOIN month_income_summary mis\nLEFT JOIN budget_comparison bc ON true;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        384,
        1200
      ],
      "id": "get-monthly-data",
      "name": "Get Monthly Data",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –º–µ—Å—è—á–Ω–æ–≥–æ PDF –æ—Ç—á–µ—Ç–∞\nconst data = $input.first().json;\n\n// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π\nconst categoryBreakdown = (data.category_breakdown || []).map(cat => ({\n  category: cat.category,\n  total: Math.round(parseFloat(cat.category_total || 0)),\n  count: parseInt(cat.category_count || 0),\n  avg: Math.round(parseFloat(cat.avg_transaction || 0)),\n  percentage: parseFloat(cat.percentage || 0)\n}));\n\n// –î–∞–Ω–Ω—ã–µ –¥–ª—è –∫—Ä—É–≥–æ–≤–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π\nconst categoryLabels = categoryBreakdown.map(c => c.category);\nconst categoryValues = categoryBreakdown.map(c => c.total);\n\n// –î–∞–Ω–Ω—ã–µ –ø–æ –¥–Ω—è–º –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞\nconst expensesByDay = data.expenses_by_day || [];\nconst incomeByDay = data.income_by_day || [];\n\n// –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –¥–Ω—è–º\nconst dayMap = {};\nexpensesByDay.forEach(exp => {\n  const day = new Date(exp.expense_date).getDate();\n  if (!dayMap[day]) dayMap[day] = { expenses: 0, income: 0 };\n  dayMap[day].expenses += parseFloat(exp.daily_total || 0);\n});\n\nincomeByDay.forEach(inc => {\n  const day = new Date(inc.income_date).getDate();\n  if (!dayMap[day]) dayMap[day] = { expenses: 0, income: 0 };\n  dayMap[day].income += parseFloat(inc.daily_total || 0);\n});\n\n// –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤—ã –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞\nconst days = Object.keys(dayMap).sort((a, b) => a - b);\nconst expensesData = days.map(d => Math.round(dayMap[d].expenses));\nconst incomeData = days.map(d => Math.round(dayMap[d].income));\n\n// –†–∞—Å—á–µ—Ç –±—é–¥–∂–µ—Ç–∞\nconst budgetAmount = parseFloat(data.budget_amount || 0);\nconst totalExpenses = parseFloat(data.total_expenses || 0);\nconst budgetUsedPercent = parseFloat(data.budget_used_percent || 0);\nconst budgetRemaining = Math.round(budgetAmount - totalExpenses);\n\n// –°—Ç–∞—Ç—É—Å –±—é–¥–∂–µ—Ç–∞\nlet budgetStatus = '–í –ø—Ä–µ–¥–µ–ª–∞—Ö –±—é–¥–∂–µ—Ç–∞';\nlet budgetStatusColor = '#4CAF50';\nif (budgetUsedPercent >= 100) {\n  budgetStatus = '‚ö†Ô∏è –ë—é–¥–∂–µ—Ç –ø—Ä–µ–≤—ã—à–µ–Ω';\n  budgetStatusColor = '#F44336';\n} else if (budgetUsedPercent >= 80) {\n  budgetStatus = '‚ö° –ë–ª–∏–∑–∫–æ –∫ –ª–∏–º–∏—Ç—É';\n  budgetStatusColor = '#FF9800';\n}\n\n// –ò—Ç–æ–≥–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ\nconst result = {\n  // –ó–∞–≥–æ–ª–æ–≤–æ–∫\n  title: `üìä –ú–µ—Å—è—á–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç`,\n  month: data.month_name || '–ú–µ—Å—è—Ü',\n  user_name: data.user_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',\n  period: `${data.period_start} - ${data.period_end}`,\n  generated_date: new Date().toLocaleDateString('ru-RU'),\n  \n  // –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏\n  total_expenses: Math.round(totalExpenses),\n  total_income: Math.round(parseFloat(data.total_income || 0)),\n  balance: Math.round(parseFloat(data.total_income || 0) - totalExpenses),\n  transaction_count: parseInt(data.expense_count || 0) + parseInt(data.income_count || 0),\n  expense_count: parseInt(data.expense_count || 0),\n  income_count: parseInt(data.income_count || 0),\n  \n  // –ë—é–¥–∂–µ—Ç\n  budget_amount: Math.round(budgetAmount),\n  budget_currency: data.budget_currency || 'KGS',\n  budget_used: Math.round(totalExpenses),\n  budget_used_percent: Math.round(budgetUsedPercent),\n  budget_remaining: budgetRemaining,\n  budget_status: budgetStatus,\n  budget_status_color: budgetStatusColor,\n  \n  // –ì—Ä–∞—Ñ–∏–∫ –¥–æ—Ö–æ–¥–æ–≤/—Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –¥–Ω—è–º\n  monthly_chart: {\n    labels: days,\n    datasets: [\n      {\n        label: '–†–∞—Å—Ö–æ–¥—ã',\n        data: expensesData,\n        backgroundColor: 'rgba(255, 99, 132, 0.8)',\n        borderColor: 'rgb(255, 99, 132)',\n        borderWidth: 2\n      },\n      {\n        label: '–î–æ—Ö–æ–¥—ã',\n        data: incomeData,\n        backgroundColor: 'rgba(75, 192, 192, 0.8)',\n        borderColor: 'rgb(75, 192, 192)',\n        borderWidth: 2\n      }\n    ]\n  },\n  \n  // –ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π\n  category_chart: {\n    labels: categoryLabels,\n    data: categoryValues,\n    colors: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF']\n  },\n  \n  // –î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π\n  category_breakdown_table: categoryBreakdown,\n  \n  // –°—Ä–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏\n  avg_daily_expense: Math.round(totalExpenses / days.length),\n  avg_daily_income: Math.round(parseFloat(data.total_income || 0) / days.length),\n  avg_transaction_expense: Math.round(totalExpenses / parseInt(data.expense_count || 1)),\n  \n  // –°–∞–º—ã–µ –¥–æ—Ä–æ–≥–∏–µ –¥–Ω–∏\n  top_expense_days: days\n    .map(d => ({ day: d, amount: dayMap[d].expenses }))\n    .sort((a, b) => b.amount - a.amount)\n    .slice(0, 5)\n    .map(d => ({ day: d.day, amount: Math.round(d.amount) })),\n  \n  // –¢–æ–ø-3 –∫–∞—Ç–µ–≥–æ—Ä–∏–∏\n  top_3_categories: categoryBreakdown.slice(0, 3)\n};\n\nreturn [{ json: result }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        560,
        1200
      ],
      "id": "format-monthly-data",
      "name": "Format Monthly Data"
    },
    {
      "parameters": {
        "resource": "pdf",
        "pdfTemplateId": "c1177b23eddd4e88",
        "jsonParameters": true,
        "propertiesJson": "={{ JSON.stringify($json) }}"
      },
      "type": "n8n-nodes-base.apiTemplateIo",
      "typeVersion": 1,
      "position": [
        704,
        1200
      ],
      "id": "generate-monthly-pdf",
      "name": "Generate Monthly PDF",
      "credentials": {
        "apiTemplateIoApi": {
          "id": "WCFzWPXSnueTP8ef",
          "name": "APITemplate.io Financer"
        }
      }
    },
    {
      "parameters": {
        "operation": "sendDocument",
        "chatId": "={{ $('Get Monthly Data').item.json.chat_id }}",
        "file": "={{ $json.download_url }}",
        "additionalFields": {
          "caption": "=üìä *–ú–µ—Å—è—á–Ω—ã–π –æ—Ç—á–µ—Ç* - {{ $('Format Monthly Data').item.json.month }}\n\nüìÖ –ü–µ—Ä–∏–æ–¥: {{ $('Format Monthly Data').item.json.period }}\nüë§ {{ $('Format Monthly Data').item.json.user_name }}\n\nüí∏ –†–∞—Å—Ö–æ–¥—ã: {{ $('Format Monthly Data').item.json.total_expenses }} —Å–æ–º\nüí∞ –î–æ—Ö–æ–¥—ã: {{ $('Format Monthly Data').item.json.total_income }} —Å–æ–º\nüìà –ë–∞–ª–∞–Ω—Å: {{ $('Format Monthly Data').item.json.balance }} —Å–æ–º\n\nüíº –ë—é–¥–∂–µ—Ç: {{ $('Format Monthly Data').item.json.budget_amount }} —Å–æ–º\nüìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: {{ $('Format Monthly Data').item.json.budget_used_percent }}%\n{{ $('Format Monthly Data').item.json.budget_status }}\n\nüìù –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: {{ $('Format Monthly Data').item.json.transaction_count }}",
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1024,
        1200
      ],
      "id": "send-monthly-pdf",
      "name": "Send Monthly PDF",
      "webhookId": "monthly-pdf-send",
      "credentials": {
        "telegramApi": {
          "id": "WabnlnnS7XdATC3n",
          "name": "Alikbek Financer"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.text }}",
        "options": {
          "systemMessage": "=–¢—ã —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–ª—É—á–∞—Ç—å –æ—Ç—á–µ—Ç—ã –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥. \n\n–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –æ—Ç—á–µ—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥, —Ç—ã –¥–æ–ª–∂–µ–Ω:\n1. –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–∏–æ–¥–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞\n2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç Get_period_report_data –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö\n3. –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∫—Ä–∞—Ç–∫–∏–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ —Ü–∏—Ñ—Ä–∞–º–∏\n4. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å PDF —á–µ—Ä–µ–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç Generate_period_pdf\n\n–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤:\n- '–æ—Ç—á–µ—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥ —Å 1 –æ–∫—Ç—è–±—Ä—è –ø–æ 31 –æ–∫—Ç—è–±—Ä—è'\n- '–æ—Ç—á–µ—Ç —Å 15.10.2025 –ø–æ 20.10.2025'\n- '–ø–æ–∫–∞–∂–∏ –æ—Ç—á–µ—Ç –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü'\n- '–æ—Ç—á–µ—Ç –∑–∞ –æ–∫—Ç—è–±—Ä—å'\n\n–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞: {{ new Date().toLocaleDateString('ru-RU') }}"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        704,
        464
      ],
      "id": "period-report-agent",
      "name": "Period Report Agent"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "period-text-field",
              "name": "text",
              "value": "={{ $('Telegram Bot Trigger').first().json.message.text }}",
              "type": "string"
            },
            {
              "id": "period-user-id",
              "name": "user_id",
              "value": "={{ $('Telegram Bot Trigger').first().json.message.from.id }}",
              "type": "number"
            },
            {
              "id": "period-chat-id",
              "name": "chat_id",
              "value": "={{ $('Telegram Bot Trigger').first().json.message.chat.id }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        384,
        464
      ],
      "id": "prepare-period-request",
      "name": "Prepare Period Request"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH user_workspace AS (\n  SELECT w.id as workspace_id\n  FROM workspaces w\n  JOIN workspace_members wm ON w.id = wm.workspace_id\n  WHERE wm.user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND wm.is_active = true\n    AND w.is_active = true\n  ORDER BY wm.joined_at DESC\n  LIMIT 1\n),\nperiod_expenses AS (\n  SELECT \n    DATE(date) as expense_date,\n    category,\n    SUM(amount) as daily_total,\n    currency,\n    COUNT(*) as transaction_count,\n    json_agg(\n      json_build_object(\n        'amount', amount,\n        'description', description,\n        'date', TO_CHAR(date, 'DD.MM.YYYY')\n      )\n    ) as transactions\n  FROM expenses\n  WHERE user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND workspace_id = (SELECT workspace_id FROM user_workspace)\n    AND date >= TO_DATE('{{ $fromAI(\"start_date\", \"–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY\", \"string\") }}', 'DD.MM.YYYY')\n    AND date <= TO_DATE('{{ $fromAI(\"end_date\", \"–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY\", \"string\") }}', 'DD.MM.YYYY')\n    AND deleted_at IS NULL\n  GROUP BY DATE(date), category, currency\n  ORDER BY DATE(date) DESC\n),\nperiod_income AS (\n  SELECT \n    DATE(date) as income_date,\n    category,\n    SUM(amount) as daily_total,\n    currency\n  FROM income\n  WHERE user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND workspace_id = (SELECT workspace_id FROM user_workspace)\n    AND date >= TO_DATE('{{ $fromAI(\"start_date\", \"–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY\", \"string\") }}', 'DD.MM.YYYY')\n    AND date <= TO_DATE('{{ $fromAI(\"end_date\", \"–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY\", \"string\") }}', 'DD.MM.YYYY')\n    AND deleted_at IS NULL\n  GROUP BY DATE(date), category, currency\n),\nperiod_summary AS (\n  SELECT \n    COALESCE(SUM(amount), 0) as total_expenses,\n    COUNT(*) as expense_count\n  FROM expenses\n  WHERE user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND workspace_id = (SELECT workspace_id FROM user_workspace)\n    AND date >= TO_DATE('{{ $fromAI(\"start_date\", \"–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY\", \"string\") }}', 'DD.MM.YYYY')\n    AND date <= TO_DATE('{{ $fromAI(\"end_date\", \"–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY\", \"string\") }}', 'DD.MM.YYYY')\n    AND deleted_at IS NULL\n),\nperiod_income_summary AS (\n  SELECT \n    COALESCE(SUM(amount), 0) as total_income,\n    COUNT(*) as income_count\n  FROM income\n  WHERE user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND workspace_id = (SELECT workspace_id FROM user_workspace)\n    AND date >= TO_DATE('{{ $fromAI(\"start_date\", \"–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY\", \"string\") }}', 'DD.MM.YYYY')\n    AND date <= TO_DATE('{{ $fromAI(\"end_date\", \"–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY\", \"string\") }}', 'DD.MM.YYYY')\n    AND deleted_at IS NULL\n),\ncategory_totals AS (\n  SELECT \n    category,\n    SUM(amount) as category_total,\n    ROUND((SUM(amount) / (SELECT total_expenses FROM period_summary)) * 100, 1) as percentage\n  FROM expenses\n  WHERE user_id = {{ $('Telegram Bot Trigger').first().json.message.from.id }}\n    AND workspace_id = (SELECT workspace_id FROM user_workspace)\n    AND date >= TO_DATE('{{ $fromAI(\"start_date\", \"–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY\", \"string\") }}', 'DD.MM.YYYY')\n    AND date <= TO_DATE('{{ $fromAI(\"end_date\", \"–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY\", \"string\") }}', 'DD.MM.YYYY')\n    AND deleted_at IS NULL\n  GROUP BY category\n  ORDER BY category_total DESC\n)\nSELECT \n  {{ $('Telegram Bot Trigger').first().json.message.from.id }} as user_id,\n  {{ $('Telegram Bot Trigger').first().json.message.chat.id }} as chat_id,\n  (SELECT workspace_id FROM user_workspace) as workspace_id,\n  ps.total_expenses,\n  pis.total_income,\n  ps.expense_count,\n  pis.income_count,\n  (SELECT json_agg(row_to_json(pe.*)) FROM period_expenses pe) as expenses_by_day,\n  (SELECT json_agg(row_to_json(pi.*)) FROM period_income pi) as income_by_day,\n  (SELECT json_agg(row_to_json(ct.*)) FROM category_totals ct) as category_totals,\n  '{{ $fromAI(\"start_date\", \"–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY\", \"string\") }}' as period_start,\n  '{{ $fromAI(\"end_date\", \"–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY\", \"string\") }}' as period_end\nFROM period_summary ps\nCROSS JOIN period_income_summary pis;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        960,
        624
      ],
      "id": "get-period-data-tool",
      "name": "Get_period_report_data",
      "credentials": {
        "postgres": {
          "id": "3CGZzcUsaAWp8nrl",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "resource": "pdf",
        "pdfTemplateId": "49c77b23ede0d4e6",
        "jsonParameters": true,
        "propertiesJson": "={\n  \"title\": \"–û—Ç—á–µ—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥\",\n  \"period\": \"{{ $fromAI('period_start', '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞', 'string') }} - {{ $fromAI('period_end', '–î–∞—Ç–∞ –∫–æ–Ω—Ü–∞', 'string') }}\",\n  \"total_expenses\": {{ $fromAI('total_expenses', '–°—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤', 'number') }},\n  \"total_income\": {{ $fromAI('total_income', '–°—É–º–º–∞ –¥–æ—Ö–æ–¥–æ–≤', 'number') }},\n  \"balance\": {{ $fromAI('total_income', '–î–æ—Ö–æ–¥—ã', 'number') - $fromAI('total_expenses', '–†–∞—Å—Ö–æ–¥—ã', 'number') }},\n  \"expense_count\": {{ $fromAI('expense_count', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞—Å—Ö–æ–¥–æ–≤', 'number') }},\n  \"income_count\": {{ $fromAI('income_count', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ—Ö–æ–¥–æ–≤', 'number') }},\n  \"category_totals\": \"{{ $fromAI('category_breakdown_json', 'JSON –∫–∞—Ç–µ–≥–æ—Ä–∏–π', 'string', '[]') }}\"\n}"
      },
      "type": "n8n-nodes-base.apiTemplateIoTool",
      "typeVersion": 1,
      "position": [
        960,
        784
      ],
      "id": "generate-period-pdf-tool",
      "name": "Generate_period_pdf",
      "credentials": {
        "apiTemplateIoApi": {
          "id": "WCFzWPXSnueTP8ef",
          "name": "APITemplate.io Financer"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        832,
        624
      ],
      "id": "period-openai-model",
      "name": "OpenAI Period Model",
      "credentials": {
        "openAiApi": {
          "id": "SyI2pOUeSfbt1JRh",
          "name": "AIAccounter"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Bot Trigger').first().json.message.chat.id }}",
        "text": "={{ $json.output }}",
        "additionalFields": {
          "appendAttribution": false,
          "reply_to_message_id": "={{ $('Telegram Bot Trigger').first().json.message.message_id }}"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1024,
        464
      ],
      "id": "send-period-response",
      "name": "Send Period Response",
      "webhookId": "period-response-send",
      "credentials": {
        "telegramApi": {
          "id": "WabnlnnS7XdATC3n",
          "name": "Alikbek Financer"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "voice-weekly",
                    "leftValue": "={{ $json.text }}",
                    "rightValue": "(–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç|–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç|–æ—Ç—á–µ—Ç –∑–∞ –Ω–µ–¥–µ–ª—é|–æ—Ç—á—ë—Ç –∑–∞ –Ω–µ–¥–µ–ª—é)",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Weekly Report Voice"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "voice-monthly",
                    "leftValue": "={{ $json.text }}",
                    "rightValue": "(–º–µ—Å—è—á–Ω—ã–π –æ—Ç—á–µ—Ç|–º–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç|–æ—Ç—á–µ—Ç –∑–∞ –º–µ—Å—è—Ü|–æ—Ç—á—ë—Ç –∑–∞ –º–µ—Å—è—Ü)",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Monthly Report Voice"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "voice-period",
                    "leftValue": "={{ $json.text }}",
                    "rightValue": "(–æ—Ç—á–µ—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥|–æ—Ç—á—ë—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥|–æ—Ç—á–µ—Ç —Å|–æ—Ç—á—ë—Ç —Å)",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Period Report Voice"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "voice-other",
                    "leftValue": "={{ $json.text }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Regular Voice"
            }
          ]
        },
        "options": {}
      },
      "id": "voice-command-router",
      "name": "Voice Command Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        752,
        -160
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "voice-text-assign",
              "name": "text",
              "value": "={{ $json.text }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        976,
        -160
      ],
      "id": "prepare-voice-text",
      "name": "Prepare Voice as Text"
    }
  ],
  "connections": {
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Bot Trigger": {
      "main": [
        [
          {
            "node": "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message Type Switch": {
      "main": [
        [
          {
            "node": "Download Voice File",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Active Users",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Active Users",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Period Request",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Text Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Voice File": {
      "main": [
        [
          {
            "node": "Transcribe Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe Audio": {
      "main": [
        [
          {
            "node": "Voice Command Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Text Data": {
      "main": [
        [
          {
            "node": "Financial Assistant",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Conversation Memory": {
      "ai_memory": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Financial Assistant": {
      "main": [
        [
          {
            "node": "Send Telegram Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞": {
      "main": [
        [
          {
            "node": "–ê–Ω–∞–ª–∏–∑ —Ä–∞—Å—Ö–æ–¥–æ–≤",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "–ê–Ω–∞–ª–∏–∑ –¥–æ—Ö–æ–¥–æ–≤",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Message Type Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add_income": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Parsing_of_the_month": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Add_expense": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Checking_limits": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Calc": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Convert_currency": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get_exchange_rates": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Edit_transaction": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Delete_transaction": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Restore_transaction": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get_transaction_history": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Create_recurring_payment": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "List_recurring_payments": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Cancel_recurring_payment": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get_budget_forecast": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get_notifications": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Configure_alerts": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get_income_expense_stats": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get_top_categories": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get_workspaces": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Update_spending_patterns": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Set_budget": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Set_category_limit": {
      "ai_tool": [
        [
          {
            "node": "Financial Assistant",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Calculator": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Create a pdf": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get_last_week_report": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Create a pdf",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Send a document",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Daily Report Trigger": {
      "main": [
        [
          {
            "node": "Get Active Users",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Weekly Report Trigger": {
      "main": [
        [
          {
            "node": "Get Active Users",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Monthly Report Trigger": {
      "main": [
        [
          {
            "node": "Get Active Users",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Active Users": {
      "main": [
        [
          {
            "node": "Get Daily Stats",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Weekly Data",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Monthly Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Daily Stats": {
      "main": [
        [
          {
            "node": "Daily Report AI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Daily Report AI": {
      "main": [
        [
          {
            "node": "Send Daily Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Daily Model": {
      "ai_languageModel": [
        [
          {
            "node": "Daily Report AI",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Get Weekly Data": {
      "main": [
        [
          {
            "node": "Format Weekly Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Weekly Data": {
      "main": [
        [
          {
            "node": "Generate Weekly PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Weekly PDF": {
      "main": [
        [
          {
            "node": "Send Weekly PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Monthly Data": {
      "main": [
        [
          {
            "node": "Format Monthly Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Monthly Data": {
      "main": [
        [
          {
            "node": "Generate Monthly PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Monthly PDF": {
      "main": [
        [
          {
            "node": "Send Monthly PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Period Request": {
      "main": [
        [
          {
            "node": "Period Report Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Period Report Agent": {
      "main": [
        [
          {
            "node": "Send Period Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Period Model": {
      "ai_languageModel": [
        [
          {
            "node": "Period Report Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Get_period_report_data": {
      "ai_tool": [
        [
          {
            "node": "Period Report Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Generate_period_pdf": {
      "ai_tool": [
        [
          {
            "node": "Period Report Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Voice Command Router": {
      "main": [
        [
          {
            "node": "Get Active Users",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Active Users",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Voice as Text",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Voice as Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Voice as Text": {
      "main": [
        [
          {
            "node": "Period Report Agent",
            "type": "main",
            "index": 0
          },
          {
            "node": "Financial Assistant",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "bcdca7003a882ee2cf9d975eab94cc02ba456a1ed2ac37511421cb2edeb80c62"
  }
}
